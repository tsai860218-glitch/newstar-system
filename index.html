<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰éº—æœˆçµçé‡‘èˆ‡æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç®¡ç†ç³»çµ±</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #1abc9c;
            --accent-hover: #16a085;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --success: #27ae60;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --border: #bdc3c7;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background-color: #f4f7f6; color: #333; overflow: hidden; }

        /* Sidebar */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s; }
        aside h2 { padding: 20px; margin: 0; font-size: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        aside nav { flex: 1; overflow-y: auto; padding-top: 10px; }
        aside nav a { display: block; padding: 15px 20px; color: #bdc3c7; text-decoration: none; transition: 0.2s; border-left: 4px solid transparent; cursor: pointer; }
        aside nav a:hover, aside nav a.active { background: var(--secondary); color: white; border-left-color: var(--accent); }
        aside .footer { padding: 15px; font-size: 0.8rem; color: #7f8c8d; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--dark); font-size: 1.8rem; }
        
        /* Components */
        .card { background: white; border-radius: 8px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--secondary); }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 1rem; }
        .form-control:focus { outline: none; border-color: var(--accent); }
        .row { display: flex; gap: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--secondary); position: sticky; top: 0; }
        tr:hover { background-color: #f1f1f1; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .status-active { background: #e8f8f5; color: var(--success); }
        .status-inactive { background: #fdedec; color: var(--danger); }
        .status-paid { background: #d4efdf; color: var(--success); }
        .status-unpaid { background: #fce4ec; color: #c0392b; }

        /* Org Chart */
        .org-container { overflow: auto; padding: 20px; height: 600px; background: white; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); position: relative; }
        .tree ul { padding-top: 20px; position: relative; transition: all 0.5s; display: flex; justify-content: center; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; transition: all 0.5s; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #ccc; width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 1px solid #ccc; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 1px solid #ccc; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #ccc; width: 0; height: 20px; }
        
        .node { 
            border: 1px solid #ccc; padding: 10px; text-decoration: none; color: #666; font-family: arial, verdana, tahoma; font-size: 12px; display: inline-block; 
            background: white; border-radius: 5px; transition: all 0.3s; min-width: 120px; position: relative; cursor: pointer;
        }
        .node:hover { background: #e8f6f3; border-color: var(--accent); transform: scale(1.05); z-index: 10; }
        .node .name { font-weight: bold; color: var(--dark); font-size: 14px; margin-bottom: 5px; }
        .node .role { font-size: 11px; color: #888; margin-bottom: 3px; }
        .node .metric { font-size: 11px; color: var(--primary); }
        .node.in-scope { border: 2px solid var(--warning); background-color: #fcf3cf; }
        .node.scope-root { border: 3px solid var(--warning); background-color: #f9e79f; box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        .node.graduate { border-color: var(--success); }
        .node.unpaid::after { content: 'â—'; color: var(--danger); position: absolute; top: 5px; right: 5px; font-size: 10px; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5vh auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 900px; border-radius: 8px; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }

        /* Utility */
        .hidden { display: none !important; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .divider { border-top: 1px solid #eee; margin: 20px 0; }
        .money { font-family: monospace; font-weight: bold; }
        .summary-box { background: var(--secondary); color: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: flex; justify-content: space-around; }
        .summary-item div:first-child { font-size: 0.8rem; opacity: 0.8; }
        .summary-item div:last-child { font-size: 1.5rem; font-weight: bold; }

        @media print {
            aside, .no-print { display: none; }
            main { padding: 0; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>

<aside>
    <h2>ğŸš€ å®‰éº—çé‡‘ç®¡ç†</h2>
    <nav>
        <a onclick="router('dashboard')" id="nav-dashboard" class="active">ğŸ“Š ç¸½è¦½å„€è¡¨æ¿</a>
        <a onclick="router('payout')" id="nav-payout">ğŸ’° æœ¬æœˆç™¼æ”¾ç¸½è¡¨</a>
        <a onclick="router('partners')" id="nav-partners">ğŸ‘¥ å¤¥ä¼´åå–®ç®¡ç†</a>
        <a onclick="router('initiators')" id="nav-initiators">ğŸ‘” ç™¼èµ·äººç®¡ç†</a>
        <a onclick="router('records')" id="nav-records">ğŸ“ æœˆä»½æ¥­ç¸¾ç´€éŒ„</a>
        <a onclick="router('org')" id="nav-org">ğŸŒ³ çµ„ç¹”é—œè¯åœ–</a>
        <a onclick="router('versions')" id="nav-versions">âš™ï¸ è¨ˆç•«ç‰ˆæœ¬æ§ç®¡</a>
        <a onclick="router('settings')" id="nav-settings">ğŸ› ï¸ ç³»çµ±è¨­å®š</a>
    </nav>
    <div class="footer">å…§éƒ¨å°ˆç”¨ç³»çµ± v1.0</div>
</aside>

<main id="app">
    </main>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modal-body"></div>
    </div>
</div>

<script>
/**
 * æ ¸å¿ƒè³‡æ–™çµæ§‹èˆ‡ LocalStorage ç®¡ç†
 */
const DB_KEY = 'amway_bonus_sys_v1';

const defaultPlanParams = {
    rate_0_3_base: 0.03,
    rate_0_3_rec: 0.04,
    rate_6_base: 0.01,
    rate_6_rec: 0.02,
    rate_recruit_bv: 0.01,
    rate_learning: 0.03
};

const store = {
    data: {
        partners: [],   // { id, code, name, sponsorId, initiatorId, status, joinDate }
        initiators: [], // { id, code, name, note }
        records: [],    // { id, partnerId, month, ppv, pbv, gpv, legs:[], newRecruits:[], learningDone, status, payoutDate, payoutStatus, planVersionId, products:[], customFields:{} }
        versions: [],   // { id, name, createdAt, params: {} }
        coachingScopes: [], // { initiatorId, roots: [id, id, id], month: 'YYYY-MM' (optional, let's keep it global for now for simplicity or by month) } -> Let's do per initiator (global/latest)
        customProductColumns: [] // ['å–®åƒ¹', 'å‚™è¨»']
    },
    init() {
        const saved = localStorage.getItem(DB_KEY);
        if (saved) {
            this.data = JSON.parse(saved);
        } else {
            // åˆå§‹åŒ–é è¨­ç‰ˆæœ¬
            this.data.versions.push({
                id: generateUUID(),
                name: 'é è¨­ç‰ˆæœ¬ (Default)',
                createdAt: new Date().toISOString(),
                params: { ...defaultPlanParams }
            });
            this.save();
        }
        // Migration check if needed
        if (!this.data.customProductColumns) this.data.customProductColumns = [];
        if (!this.data.coachingScopes) this.data.coachingScopes = [];
    },
    save() {
        localStorage.setItem(DB_KEY, JSON.stringify(this.data));
    },
    // Helpers
    getPartner(id) { return this.data.partners.find(p => p.id === id); },
    getInitiator(id) { return this.data.initiators.find(i => i.id === id); },
    getRecord(id) { return this.data.records.find(r => r.id === id); },
    getRecordsByMonth(month) { return this.data.records.filter(r => r.month === month); },
    getVersion(id) { return this.data.versions.find(v => v.id === id) || this.data.versions[0]; },
    getCoachingScope(initiatorId) { return this.data.coachingScopes.find(c => c.initiatorId === initiatorId) || { initiatorId, roots: [], depth: 5 }; }
};

store.init();

// å·¥å…·å‡½å¼
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function formatMoney(num) {
    return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num);
}

function getBonusPercent(pv) {
    if (pv >= 10000) return 0.21;
    if (pv >= 7000) return 0.18;
    if (pv >= 4000) return 0.15;
    if (pv >= 2000) return 0.12;
    if (pv >= 1000) return 0.09;
    if (pv >= 600) return 0.06;
    if (pv >= 200) return 0.03;
    return 0;
}

// æ ¸å¿ƒè¨ˆç®—é‚è¼¯
function calculateRecord(record) {
    const partner = store.getPartner(record.partnerId);
    if (!partner) return null;

    const version = store.getVersion(record.planVersionId);
    const params = version.params;

    // 1. å…¬å¸çé‡‘
    const myRate = getBonusPercent(record.gpv);
    const personalBonus = record.pbv * myRate;

    // å·®é¡çé‡‘
    let diffBonusTotal = 0;
    const legDetails = (record.legs || []).map(leg => {
        const legRate = getBonusPercent(leg.pv);
        const diffRate = Math.max(0, myRate - legRate);
        const bonus = diffRate * leg.bv;
        diffBonusTotal += bonus;
        return { ...leg, legRate, diffRate, bonus };
    });

    const companyTotal = personalBonus + diffBonusTotal;

    // 2. æ–°æ˜Ÿè¨ˆç•«
    // æ¢ä»¶ï¼šPV < 1000 ä¸” åƒèˆ‡ç‹€æ…‹ != 'inactive'
    let starTotal = 0;
    let baseBonus = 0;
    let recruitBonus = 0;
    let learningBonus = 0;
    let isGraduated = record.gpv >= 1000;
    let isEligible = !isGraduated && record.participation !== 'inactive';

    if (isEligible) {
        // åˆ¤æ–·å›é¥‹ç‡
        let hasRecruit = (record.newRecruits || []).length > 0;
        let appliedRate = 0;
        
        if (myRate <= 0.03) {
            appliedRate = hasRecruit ? params.rate_0_3_rec : params.rate_0_3_base;
        } else if (myRate === 0.06) {
            appliedRate = hasRecruit ? params.rate_6_rec : params.rate_6_base;
        }
        // è‹¥ PV rate > 6% (å³ 9%ä»¥ä¸Š) æœƒè¢«è¦–ç‚ºç•¢æ¥­ï¼Œé€™è£¡é‚è¼¯å·²åœ¨ isGraduated æ’é™¤
        
        // è¨ˆç®—åŸºæ•¸ï¼šå°çµ„BV - ç¨ç«‹åƒèˆ‡è…¿çš„BV
        let baseBV = record.gpv * 50; // é è¨­ç”¨å°çµ„PVè½‰BVï¼Œæˆ–ä½¿ç”¨ record.gbv (å‡è¨­ record.gbv = record.gpv * 50)
        // æ›´ç²¾ç¢ºï¼šä½¿ç”¨è¼¸å…¥çš„ Group BV (å‡è¨­ UI æœ‰æä¾›ï¼Œè‹¥ç„¡å‰‡ PV*50)
        // é€™è£¡æˆ‘å€‘å‡è¨­ç³»çµ±é‚è¼¯ä»¥ GPV ç‚ºä¸»ï¼Œä½†è‹¥æœ‰ç´€éŒ„ç¨ç«‹ BV æ¬„ä½æ›´å¥½ã€‚
        // ç‚ºäº†ç›¸å®¹ï¼Œæˆ‘å€‘é‡æ–°è¨ˆç®— Group BV = Personal BV + Sum(Legs BV)
        // ä½†é€šå¸¸ä½¿ç”¨è€…è¼¸å…¥ "Group PV/BV"ï¼Œé€™è£¡ç°¡åŒ–ï¼šBase BV = Group PV * 50
        // æ‰£é™¤ç¨ç«‹è…¿
        const independentLegsBV = legDetails.filter(l => l.isIndependent).reduce((sum, l) => sum + (Number(l.bv) || 0), 0);
        
        // ä¿®æ­£ï¼šå°çµ„BVæ‡‰ä»¥ä½¿ç”¨è€…è¼¸å…¥ç‚ºæº–ï¼Œè‹¥ç„¡å‰‡ç®—ã€‚
        // åœ¨ UI ä¸­æˆ‘å€‘è®“ä½¿ç”¨è€…è¼¸å…¥ Group PVï¼Œè‡ªå‹•æ¨ç®— Group BVã€‚
        // å¯¦éš›ä¸Šå·®é¡çé‡‘è¨ˆç®—éœ€è¦ç²¾ç¢ºçš„ BVã€‚
        // é€™è£¡å‡è¨­ï¼šåƒèˆ‡æ–°æ˜Ÿè¨ˆç®—çš„åŸºæ•¸ = (Group PV * 50) - ç¨ç«‹è…¿ BVã€‚
        // **ä¿®æ­£é‚è¼¯**ï¼šä½¿ç”¨ record.gpv * 50 ä½œç‚ºç¸½å°çµ„BVä¼°ç®— (æˆ–è‹¥æœ‰è¼¸å…¥GBVæ¬„ä½)
        
        const totalGroupBV = record.gpv * 50; 
        const calcBaseBV = Math.max(0, totalGroupBV - independentLegsBV);
        
        baseBonus = calcBaseBV * appliedRate;

        // æ–°äººæ¶ˆè²»å›é¥‹
        const newRecruitTotalBV = (record.newRecruits || []).reduce((sum, r) => sum + (Number(r.bv)||0), 0);
        recruitBonus = newRecruitTotalBV * params.rate_recruit_bv;

        // å­¸ç¿’åŠ ç¢¼
        if (record.learningDone) {
            learningBonus = (baseBonus + recruitBonus) * params.rate_learning;
        }

        starTotal = baseBonus + recruitBonus + learningBonus;
    }

    // ç¸½æ”¶å…¥
    const totalIncome = companyTotal + starTotal;

    return {
        ...record,
        partnerName: partner.name + ' ' + partner.code,
        initiatorId: partner.initiatorId,
        myRate,
        personalBonus,
        legDetails,
        diffBonusTotal,
        companyTotal,
        isGraduated,
        isEligible,
        baseBonus,
        recruitBonus,
        learningBonus,
        starTotal,
        totalIncome
    };
}

/**
 * è·¯ç”±èˆ‡è¦–åœ–æ¸²æŸ“
 */
const app = document.getElementById('app');
const navLinks = document.querySelectorAll('aside nav a');

function router(page) {
    navLinks.forEach(a => a.classList.remove('active'));
    document.getElementById('nav-' + page).classList.add('active');
    
    app.innerHTML = '';
    
    switch(page) {
        case 'dashboard': renderDashboard(); break;
        case 'payout': renderPayout(); break;
        case 'partners': renderPartners(); break;
        case 'initiators': renderInitiators(); break;
        case 'records': renderRecords(); break;
        case 'org': renderOrgChart(); break;
        case 'versions': renderVersions(); break;
        case 'settings': renderSettings(); break;
        default: renderDashboard();
    }
}

// 1. Dashboard
function renderDashboard() {
    const currentMonth = new Date().toISOString().slice(0, 7);
    const records = store.getRecordsByMonth(currentMonth).map(calculateRecord);
    
    const totalCompany = records.reduce((s, r) => s + r.companyTotal, 0);
    const totalStar = records.reduce((s, r) => s + r.starTotal, 0);
    const unpaidCount = records.filter(r => r.payoutStatus !== 'paid' && r.totalIncome > 0).length;

    app.innerHTML = `
        <header>
            <h1>ğŸ“Š ç¸½è¦½å„€è¡¨æ¿ (${currentMonth})</h1>
        </header>
        <div class="row">
            <div class="summary-box col" style="background:#2980b9">
                <div class="summary-item"><div>å…¬å¸çé‡‘é ä¼°</div><div>${formatMoney(totalCompany)}</div></div>
            </div>
            <div class="summary-box col" style="background:#27ae60">
                <div class="summary-item"><div>æ–°æ˜Ÿåœ˜éšŠå›é¥‹</div><div>${formatMoney(totalStar)}</div></div>
            </div>
            <div class="summary-box col" style="background:#c0392b">
                <div class="summary-item"><div>å¾…ç™¼æ”¾äººæ•¸</div><div>${unpaidCount} äºº</div></div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ ç³»çµ±èªªæ˜</h3>
            <p>æ­¡è¿ä½¿ç”¨å…§éƒ¨æœˆçµçé‡‘ç³»çµ±ã€‚</p>
            <ul>
                <li>è«‹å…ˆè‡³ <b>ç™¼èµ·äººç®¡ç†</b> èˆ‡ <b>å¤¥ä¼´åå–®ç®¡ç†</b> å»ºç«‹åŸºæœ¬è³‡æ–™ã€‚</li>
                <li>æ¯æœˆçµç®—æ™‚ï¼Œè‡³ <b>æœˆä»½æ¥­ç¸¾ç´€éŒ„</b> è¼¸å…¥æ¯ä½å¤¥ä¼´æ•¸æ“šã€‚</li>
                <li>é€é <b>æœ¬æœˆç™¼æ”¾ç¸½è¡¨</b> é€²è¡Œæ ¸éŠ·èˆ‡åŒ¯å‡ºã€‚</li>
            </ul>
            <p style="color: #e74c3c; font-size: 0.9rem;">âš ï¸ å…è²¬è²æ˜ï¼šæœ¬ç³»çµ±åƒ…ä¾›å…§éƒ¨è©¦ç®—èˆ‡ç´€éŒ„ï¼Œå¯¦éš›çé‡‘ä»¥å…¬å¸å…¬å‘Šç‚ºæº–ã€‚</p>
        </div>
    `;
}

// 2. Partners
function renderPartners() {
    const list = store.data.partners;
    const initiators = store.data.initiators;
    
    let html = `
        <header>
            <h1>ğŸ‘¥ å¤¥ä¼´åå–®ç®¡ç†</h1>
            <button class="btn btn-primary" onclick="editPartner()">+ æ–°å¢å¤¥ä¼´</button>
        </header>
        <div class="card">
            <table>
                <thead>
                    <tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>æ¨è–¦äºº(ä¸Šç·š)</th><th>ç™¼èµ·äºº(å‡ºè³‡)</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody>
                ${list.map(p => {
                    const sponsor = store.getPartner(p.sponsorId);
                    const init = store.getInitiator(p.initiatorId);
                    return `
                    <tr>
                        <td>${p.code}</td>
                        <td>${p.name}</td>
                        <td>${sponsor ? sponsor.code + ' ' + sponsor.name : '-'}</td>
                        <td>${init ? init.code + ' ' + init.name : '<span style="color:red">æœªè¨­å®š</span>'}</td>
                        <td><span class="status-badge ${p.status === 'inactive' ? 'status-inactive' : 'status-active'}">${p.status==='inactive'?'åœç”¨':'å•Ÿç”¨'}</span></td>
                        <td>
                            <button class="btn btn-secondary" onclick="editPartner('${p.id}')">ç·¨è¼¯</button>
                        </td>
                    </tr>
                    `
                }).join('')}
                </tbody>
            </table>
        </div>
    `;
    app.innerHTML = html;
}

function editPartner(id) {
    const p = id ? store.getPartner(id) : { id: '', code: '', name: '', sponsorId: '', initiatorId: '', status: 'active' };
    const partners = store.data.partners.filter(x => x.id !== p.id); // Exclude self
    const initiators = store.data.initiators;

    const modalHtml = `
        <h2>${id ? 'ç·¨è¼¯' : 'æ–°å¢'}å¤¥ä¼´</h2>
        <form onsubmit="savePartner(event, '${id}')">
            <div class="row">
                <div class="col form-group">
                    <label>ç·¨è™Ÿ (Code) *</label>
                    <input type="text" class="form-control" name="code" value="${p.code}" required>
                </div>
                <div class="col form-group">
                    <label>å§“å *</label>
                    <input type="text" class="form-control" name="name" value="${p.name}" required>
                </div>
            </div>
            <div class="form-group">
                <label>æ¨è–¦äºº (ä¸Šç·š)</label>
                <select class="form-control" name="sponsorId">
                    <option value="">-- ç„¡ (é ‚å±¤) --</option>
                    ${partners.map(opt => `<option value="${opt.id}" ${opt.id === p.sponsorId ? 'selected' : ''}>${opt.code} ${opt.name}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label>ç™¼èµ·äºº (å‡ºè³‡è€…) *</label>
                <select class="form-control" name="initiatorId" required>
                    <option value="">-- è«‹é¸æ“‡ --</option>
                    ${initiators.map(opt => `<option value="${opt.id}" ${opt.id === p.initiatorId ? 'selected' : ''}>${opt.code} ${opt.name}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label>ç‹€æ…‹</label>
                <select class="form-control" name="status">
                    <option value="active" ${p.status === 'active' ? 'selected' : ''}>å•Ÿç”¨</option>
                    <option value="inactive" ${p.status === 'inactive' ? 'selected' : ''}>åœç”¨</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">å„²å­˜</button>
        </form>
    `;
    openModal(modalHtml);
}

function savePartner(e, id) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Basic Validation
    if (!data.code || !data.name) return alert('ç·¨è™Ÿèˆ‡å§“åå¿…å¡«');
    if (store.data.partners.some(p => p.code === data.code && p.id !== id)) return alert('ç·¨è™Ÿé‡è¤‡');
    
    // Cycle check for sponsor
    if (data.sponsorId) {
        let current = data.sponsorId;
        while (current) {
            if (current === id) return alert('ä¸å¯é¸æ“‡ä¸‹ç·šä½œç‚ºæ¨è–¦äºº (å¾ªç’°åƒç…§)');
            const parent = store.getPartner(current);
            current = parent ? parent.sponsorId : null;
        }
    }

    if (id) {
        const idx = store.data.partners.findIndex(p => p.id === id);
        store.data.partners[idx] = { ...store.data.partners[idx], ...data };
    } else {
        store.data.partners.push({ ...data, id: generateUUID(), joinDate: new Date().toISOString() });
    }
    store.save();
    closeModal();
    renderPartners();
}

// 3. Initiators
function renderInitiators() {
    let html = `
        <header>
            <h1>ğŸ‘” ç™¼èµ·äººç®¡ç†</h1>
            <button class="btn btn-primary" onclick="editInitiator()">+ æ–°å¢ç™¼èµ·äºº</button>
        </header>
        <div class="card">
            <table>
                <thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                ${store.data.initiators.map(i => `
                    <tr>
                        <td>${i.code}</td><td>${i.name}</td><td>${i.note||''}</td>
                        <td><button class="btn btn-secondary" onclick="editInitiator('${i.id}')">ç·¨è¼¯</button></td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
    `;
    app.innerHTML = html;
}

function editInitiator(id) {
    const i = id ? store.getInitiator(id) : { id:'', code:'', name:'', note:'' };
    openModal(`
        <h2>${id?'ç·¨è¼¯':'æ–°å¢'}ç™¼èµ·äºº</h2>
        <form onsubmit="saveInitiator(event, '${id}')">
            <div class="row">
                <div class="col form-group"><label>ç·¨è™Ÿ</label><input name="code" value="${i.code}" class="form-control" required></div>
                <div class="col form-group"><label>å§“å</label><input name="name" value="${i.name}" class="form-control" required></div>
            </div>
            <div class="form-group"><label>å‚™è¨»</label><input name="note" value="${i.note}" class="form-control"></div>
            <button type="submit" class="btn btn-primary">å„²å­˜</button>
        </form>
    `);
}

function saveInitiator(e, id) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    if (store.data.initiators.some(i => i.code === data.code && i.id !== id)) return alert('ç·¨è™Ÿé‡è¤‡');
    
    if (id) {
        const idx = store.data.initiators.findIndex(i => i.id === id);
        store.data.initiators[idx] = { ...store.data.initiators[idx], ...data };
    } else {
        store.data.initiators.push({ ...data, id: generateUUID() });
    }
    store.save();
    closeModal();
    renderInitiators();
}

// 4. Records
function renderRecords() {
    const today = new Date();
    const defaultMonth = today.toISOString().slice(0, 7);
    const month = localStorage.getItem('last_view_month') || defaultMonth;

    const rawRecords = store.getRecordsByMonth(month);
    const calculatedRecords = rawRecords.map(calculateRecord);

    app.innerHTML = `
        <header>
            <h1>ğŸ“ æœˆä»½æ¥­ç¸¾ç´€éŒ„</h1>
            <div style="display:flex; gap:10px;">
                <input type="month" id="record-month-select" value="${month}" class="form-control" onchange="changeRecordMonth(this.value)">
                <button class="btn btn-primary" onclick="editRecord(null, '${month}')">+ å»ºç«‹ç´€éŒ„</button>
            </div>
        </header>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>å¤¥ä¼´</th>
                        <th>å°çµ„ PV</th>
                        <th>å…¬å¸çé‡‘</th>
                        <th>æ–°æ˜Ÿå›é¥‹</th>
                        <th>åˆè¨ˆ</th>
                        <th>ç™¼æ”¾ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                ${calculatedRecords.length === 0 ? '<tr><td colspan="7" class="text-center">æœ¬æœˆå°šç„¡ç´€éŒ„</td></tr>' : 
                  calculatedRecords.map(r => `
                    <tr>
                        <td>${r.partnerName}</td>
                        <td>${r.gpv} <small>(${ (r.myRate*100).toFixed(0) }%)</small></td>
                        <td>${formatMoney(r.companyTotal)}</td>
                        <td>${r.isGraduated ? '<span class="status-badge status-active">ç•¢æ¥­</span>' : formatMoney(r.starTotal)}</td>
                        <td class="money">${formatMoney(r.totalIncome)}</td>
                        <td>
                            <span class="status-badge ${r.payoutStatus === 'paid' ? 'status-paid' : 'status-unpaid'}">
                                ${r.payoutStatus === 'paid' ? 'å·²ç™¼æ”¾' : 'æœªç™¼æ”¾'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="editRecord('${r.id}')">ç·¨è¼¯</button>
                        </td>
                    </tr>
                  `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function changeRecordMonth(m) {
    localStorage.setItem('last_view_month', m);
    renderRecords();
}

let tempRecord = {};
function editRecord(id, month) {
    const r = id ? store.getRecord(id) : {
        id: '',
        partnerId: '',
        month: month,
        ppv: 0, pbv: 0, gpv: 0,
        legs: [],
        newRecruits: [],
        products: [],
        learningDone: false,
        participation: 'active',
        payoutStatus: 'unpaid',
        payoutDate: month + '-18',
        planVersionId: store.data.versions[0].id // default to first/latest
    };
    
    // é–å®šæª¢æŸ¥
    if (r.payoutStatus === 'paid' && id) {
        if(!confirm('æ­¤ç´€éŒ„å·²æ¨™è¨˜ç‚ºã€Œå·²ç™¼æ”¾ã€ï¼Œç·¨è¼¯å°‡è§£é™¤é–å®šã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) return;
    }

    tempRecord = JSON.parse(JSON.stringify(r));

    const partners = store.data.partners.filter(p => p.status === 'active');
    const versions = store.data.versions;
    const customCols = store.data.customProductColumns;

    const modalHtml = `
        <h2>${id ? 'ç·¨è¼¯' : 'æ–°å¢'}æ¥­ç¸¾ç´€éŒ„ (${r.month})</h2>
        <form id="recordForm" onsubmit="saveRecord(event, '${id}')">
            <div class="row">
                <div class="col form-group">
                    <label>å¤¥ä¼´ *</label>
                    <select class="form-control" name="partnerId" required onchange="tempRecord.partnerId=this.value">
                        <option value="">-- è«‹é¸æ“‡ --</option>
                        ${partners.map(p => `<option value="${p.id}" ${p.id === r.partnerId ? 'selected' : ''}>${p.code} ${p.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col form-group">
                    <label>é©ç”¨è¨ˆç•«ç‰ˆæœ¬</label>
                    <select class="form-control" name="planVersionId" required>
                        ${versions.map(v => `<option value="${v.id}" ${v.id === r.planVersionId ? 'selected' : ''}>${v.name}</option>`).join('')}
                    </select>
                </div>
            </div>

            <fieldset style="border:1px solid #ddd; padding:10px; margin-bottom:15px;">
                <legend>å€‹äººèˆ‡å°çµ„æ¥­ç¸¾</legend>
                <div class="row">
                    <div class="col form-group">
                        <label>å€‹äºº PV</label>
                        <input type="number" class="form-control" name="ppv" value="${r.ppv}" oninput="syncBV(this, 'pbv')">
                    </div>
                    <div class="col form-group">
                        <label>å€‹äºº BV (PV x 50)</label>
                        <input type="number" class="form-control" name="pbv" value="${r.pbv}" oninput="syncPV(this, 'ppv')">
                    </div>
                    <div class="col form-group">
                        <label>å°çµ„ PV (æ±ºå®šçé‡‘%)</label>
                        <input type="number" class="form-control" name="gpv" value="${r.gpv}" required>
                    </div>
                </div>
            </fieldset>

            <fieldset style="border:1px solid #ddd; padding:10px; margin-bottom:15px;">
                <legend>ç¬¬ä¸€ä»£è…¿ (å·®é¡çé‡‘è¨ˆç®—)</legend>
                <div id="legs-container"></div>
                <button type="button" class="btn btn-outline" onclick="addLeg()">+ æ–°å¢è…¿</button>
            </fieldset>

            <fieldset style="border:1px solid #ddd; padding:10px; margin-bottom:15px;">
                <legend>æ–°æ˜Ÿè¨ˆç•«åƒæ•¸</legend>
                 <div class="row">
                    <div class="col form-group">
                        <label>åƒèˆ‡ç‹€æ…‹</label>
                        <select class="form-control" name="participation">
                            <option value="active" ${r.participation==='active'?'selected':''}>æœ¬æœˆåƒèˆ‡</option>
                            <option value="inactive" ${r.participation==='inactive'?'selected':''}>åœç”¨(åƒ…é ˜å…¬å¸çé‡‘)</option>
                        </select>
                    </div>
                    <div class="col form-group">
                        <label style="display:flex;align-items:center;height:100%;">
                            <input type="checkbox" name="learningDone" ${r.learningDone ? 'checked' : ''} style="margin-right:5px;"> å®Œæˆå­¸ç¿’ä»»å‹™ (åŠ ç¢¼)
                        </label>
                    </div>
                </div>
                <div>
                    <label>æ–°æ¨è–¦æœƒå“¡æ¸…å–®</label>
                    <div id="recruits-container"></div>
                    <button type="button" class="btn btn-outline" onclick="addRecruit()">+ æ–°å¢æ–°äºº</button>
                </div>
            </fieldset>

            <fieldset style="border:1px solid #ddd; padding:10px; margin-bottom:15px;">
                <legend>ç”¢å“éŠ·å”®æ˜ç´° (é¸å¡«) <button type="button" class="btn" style="font-size:0.8rem" onclick="addCustomCol()">+ è‡ªè¨‚æ¬„ä½</button></legend>
                <div id="products-container"></div>
                <button type="button" class="btn btn-outline" onclick="addProduct()">+ æ–°å¢ç”¢å“</button>
            </fieldset>
            
            <div class="row">
                <div class="col form-group">
                    <label>ç™¼æ”¾æ—¥æœŸ</label>
                    <input type="date" class="form-control" name="payoutDate" value="${r.payoutDate}">
                </div>
                 <div class="col form-group">
                    <label>ç™¼æ”¾ç‹€æ…‹</label>
                    <select class="form-control" name="payoutStatus">
                        <option value="unpaid" ${r.payoutStatus==='unpaid'?'selected':''}>æœªç™¼æ”¾</option>
                        <option value="paid" ${r.payoutStatus==='paid'?'selected':''}>å·²ç™¼æ”¾</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">å„²å­˜ç´€éŒ„</button>
        </form>
    `;
    openModal(modalHtml);
    renderLegs();
    renderRecruits();
    renderProducts();
}

function syncBV(el, targetName) {
    const form = document.getElementById('recordForm');
    const target = form.querySelector(`[name="${targetName}"]`);
    target.value = el.value * 50;
}
function syncPV(el, targetName) {
    const form = document.getElementById('recordForm');
    const target = form.querySelector(`[name="${targetName}"]`);
    target.value = el.value / 50;
}

// Dynamic Fields Rendering
function renderLegs() {
    const container = document.getElementById('legs-container');
    container.innerHTML = tempRecord.legs.map((l, i) => `
        <div class="row" style="margin-bottom:5px; align-items:flex-end;">
            <div class="col"><input placeholder="è…¿å" class="form-control" value="${l.name}" onchange="tempRecord.legs[${i}].name=this.value"></div>
            <div class="col"><input type="number" placeholder="PV" class="form-control" value="${l.pv}" onchange="tempRecord.legs[${i}].pv=Number(this.value)"></div>
            <div class="col"><input type="number" placeholder="BV" class="form-control" value="${l.bv}" onchange="tempRecord.legs[${i}].bv=Number(this.value)"></div>
            <div class="col" style="flex:0.5; display:flex; align-items:center;">
                <label><input type="checkbox" ${l.isIndependent?'checked':''} onchange="tempRecord.legs[${i}].isIndependent=this.checked"> ç¨ç«‹</label>
            </div>
            <button type="button" class="btn btn-danger" onclick="removeLeg(${i})">X</button>
        </div>
    `).join('');
}
function addLeg() { tempRecord.legs.push({ name: '', pv: 0, bv: 0, isIndependent: false }); renderLegs(); }
function removeLeg(i) { tempRecord.legs.splice(i, 1); renderLegs(); }

function renderRecruits() {
    const container = document.getElementById('recruits-container');
    container.innerHTML = tempRecord.newRecruits.map((r, i) => `
        <div class="row" style="margin-bottom:5px;">
            <div class="col"><input placeholder="æ–°äººå§“å" class="form-control" value="${r.name}" onchange="tempRecord.newRecruits[${i}].name=this.value"></div>
            <div class="col"><input type="number" placeholder="BV" class="form-control" value="${r.bv}" onchange="tempRecord.newRecruits[${i}].bv=Number(this.value)"></div>
            <button type="button" class="btn btn-danger" onclick="removeRecruit(${i})">X</button>
        </div>
    `).join('');
}
function addRecruit() { tempRecord.newRecruits.push({ name: '', bv: 0 }); renderRecruits(); }
function removeRecruit(i) { tempRecord.newRecruits.splice(i, 1); renderRecruits(); }

function renderProducts() {
    const container = document.getElementById('products-container');
    const cols = store.data.customProductColumns;
    
    // Header
    let html = `<div style="display:flex; font-weight:bold; margin-bottom:5px;">
        <div style="flex:2">å“é …</div>
        <div style="flex:1">æ•¸é‡</div>
        ${cols.map(c => `<div style="flex:1">${c}</div>`).join('')}
        <div style="width:40px"></div>
    </div>`;

    html += tempRecord.products.map((p, i) => `
        <div style="display:flex; margin-bottom:5px; gap:5px;">
            <input style="flex:2" class="form-control" value="${p.name||''}" placeholder="å“å" onchange="updateProd(${i}, 'name', this.value)">
            <input type="number" style="flex:1" class="form-control" value="${p.qty||0}" placeholder="æ•¸é‡" onchange="updateProd(${i}, 'qty', this.value)">
            ${cols.map(c => `
                <input style="flex:1" class="form-control" value="${(p.custom||{})[c]||''}" onchange="updateProdCustom(${i}, '${c}', this.value)">
            `).join('')}
            <button type="button" class="btn btn-danger" style="width:40px" onclick="removeProduct(${i})">X</button>
        </div>
    `).join('');
    container.innerHTML = html;
}
function addProduct() { tempRecord.products.push({ name: '', qty: 0, custom: {} }); renderProducts(); }
function removeProduct(i) { tempRecord.products.splice(i, 1); renderProducts(); }
function updateProd(i, f, v) { tempRecord.products[i][f] = v; }
function updateProdCustom(i, field, val) { 
    if(!tempRecord.products[i].custom) tempRecord.products[i].custom = {}; 
    tempRecord.products[i].custom[field] = val; 
}
function addCustomCol() {
    const name = prompt('è«‹è¼¸å…¥æ–°æ¬„ä½åç¨± (ä¾‹å¦‚ï¼šå–®åƒ¹)ï¼š');
    if(name && !store.data.customProductColumns.includes(name)) {
        store.data.customProductColumns.push(name);
        store.save();
        renderProducts();
    }
}

function saveRecord(e, id) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    const record = {
        ...tempRecord,
        partnerId: formData.get('partnerId'),
        planVersionId: formData.get('planVersionId'),
        month: tempRecord.month, // keep original month
        ppv: Number(formData.get('ppv')),
        pbv: Number(formData.get('pbv')),
        gpv: Number(formData.get('gpv')),
        participation: formData.get('participation'),
        learningDone: formData.get('learningDone') === 'on',
        payoutDate: formData.get('payoutDate'),
        payoutStatus: formData.get('payoutStatus')
    };

    if (id) {
        const idx = store.data.records.findIndex(r => r.id === id);
        store.data.records[idx] = record;
    } else {
        record.id = generateUUID();
        store.data.records.push(record);
    }
    store.save();
    closeModal();
    renderRecords();
}

// 5. Payout Dashboard (æœ¬æœˆç™¼æ”¾ç¸½è¡¨)
function renderPayout() {
    const month = localStorage.getItem('last_payout_view_month') || new Date().toISOString().slice(0, 7);
    const records = store.getRecordsByMonth(month).map(calculateRecord);
    const initiators = store.data.initiators;
    
    // Group by Initiator
    const groups = {};
    initiators.forEach(init => {
        groups[init.id] = { 
            info: init, 
            records: records.filter(r => r.initiatorId === init.id),
            total: 0, paid: 0, unpaid: 0
        };
    });
    // Add 'No Initiator' group
    const orphanRecords = records.filter(r => !r.initiatorId);
    if(orphanRecords.length > 0) groups['none'] = { info: { name: 'æœªæŒ‡å®šç™¼èµ·äºº', code: 'N/A' }, records: orphanRecords, total:0, paid:0, unpaid:0 };

    // Calculate totals
    Object.values(groups).forEach(g => {
        g.records.forEach(r => {
            g.total += r.totalIncome;
            if(r.payoutStatus === 'paid') g.paid += r.totalIncome;
            else g.unpaid += r.totalIncome;
        });
    });

    app.innerHTML = `
        <header>
            <h1>ğŸ’° æœ¬æœˆæ‡‰ç™¼æ”¾ç¸½è¡¨</h1>
            <input type="month" value="${month}" class="form-control" style="width:auto" onchange="localStorage.setItem('last_payout_view_month', this.value); renderPayout();">
        </header>

        <div class="row">
             <div class="col">
                <button class="btn btn-primary" onclick="bulkMarkPaid('${month}')">æ‰¹æ¬¡æ¨™è¨˜å·²ç™¼æ”¾</button>
                <button class="btn btn-secondary" onclick="exportPayoutCSV('${month}')">åŒ¯å‡º CSV</button>
             </div>
        </div>
        <br>

        ${Object.values(groups).filter(g => g.records.length > 0).map(g => `
            <div class="card">
                <h3 style="border-bottom:2px solid var(--accent); padding-bottom:10px; display:flex; justify-content:space-between;">
                    <span>${g.info.code} ${g.info.name}</span>
                    <span style="font-size:0.9rem">æ‡‰ä»˜ï¼š${formatMoney(g.unpaid)} / å·²ä»˜ï¼š${formatMoney(g.paid)}</span>
                </h3>
                <table>
                    <thead>
                        <tr>
                            <th width="40"><input type="checkbox" onchange="toggleGroupCheck(this, '${g.info.id}')"></th>
                            <th>å¤¥ä¼´</th>
                            <th>ç‹€æ…‹</th>
                            <th>å…¬å¸çé‡‘</th>
                            <th>åœ˜éšŠå›é¥‹</th>
                            <th>ç¸½è¨ˆ</th>
                            <th>ç™¼æ”¾ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${g.records.map(r => `
                            <tr>
                                <td><input type="checkbox" class="payout-check group-${g.info.id}" value="${r.id}" ${r.payoutStatus === 'paid' ? 'disabled' : ''}></td>
                                <td>${r.partnerName}</td>
                                <td>${r.participation === 'inactive' ? '<span class="status-badge status-inactive">åœç”¨</span>' : 'åƒèˆ‡'}</td>
                                <td>${formatMoney(r.companyTotal)}</td>
                                <td>${formatMoney(r.starTotal)}</td>
                                <td class="money">${formatMoney(r.totalIncome)}</td>
                                <td><span class="status-badge ${r.payoutStatus==='paid'?'status-paid':'status-unpaid'}">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `).join('')}
    `;
}

function toggleGroupCheck(master, groupId) {
    document.querySelectorAll(`.group-${groupId}`).forEach(c => {
        if(!c.disabled) c.checked = master.checked;
    });
}

function bulkMarkPaid(month) {
    const selected = Array.from(document.querySelectorAll('.payout-check:checked')).map(c => c.value);
    if (selected.length === 0) return alert('è«‹å…ˆå‹¾é¸æœªç™¼æ”¾çš„é …ç›®');
    
    if(!confirm(`ç¢ºå®šå°‡ ${selected.length} ç­†ç´€éŒ„æ¨™è¨˜ç‚ºã€Œå·²ç™¼æ”¾ã€ï¼Ÿ\né€™å°‡é–å®šè³‡æ–™ä¸å¯ä¿®æ”¹ã€‚`)) return;

    selected.forEach(id => {
        const r = store.getRecord(id);
        if (r) r.payoutStatus = 'paid';
    });
    store.save();
    renderPayout();
}

function exportPayoutCSV(month) {
    const records = store.getRecordsByMonth(month).map(calculateRecord);
    let csv = '\uFEFF'; // BOM
    csv += 'æœˆä»½,ç™¼èµ·äºº,å¤¥ä¼´ç·¨è™Ÿ,å¤¥ä¼´å§“å,åƒèˆ‡ç‹€æ…‹,ç™¼æ”¾ç‹€æ…‹,ç™¼æ”¾æ—¥,å…¬å¸çé‡‘,åœ˜éšŠå›é¥‹,ç¸½åˆè¨ˆ,å‚™è¨»\n';
    
    records.forEach(r => {
        const init = store.getInitiator(r.initiatorId);
        const initName = init ? `${init.code} ${init.name}` : 'æœªè¨­å®š';
        const partner = store.getPartner(r.partnerId);
        csv += `${r.month},${initName},${partner.code},${partner.name},${r.participation},${r.payoutStatus},${r.payoutDate},${r.companyTotal},${r.starTotal},${r.totalIncome},\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Payout_${month}.csv`;
    link.click();
}

// 6. Organization Chart (3-Wide 5-Deep Scope)
function renderOrgChart() {
    const month = localStorage.getItem('last_org_view_month') || new Date().toISOString().slice(0, 7);
    const partners = store.data.partners;
    const records = store.getRecordsByMonth(month).map(calculateRecord);
    const initiators = store.data.initiators;

    // Build Tree Structure
    const partnerMap = {};
    partners.forEach(p => {
        partnerMap[p.id] = { ...p, children: [], record: records.find(r => r.partnerId === p.id) };
    });
    
    const roots = [];
    partners.forEach(p => {
        if (p.sponsorId && partnerMap[p.sponsorId]) {
            partnerMap[p.sponsorId].children.push(partnerMap[p.id]);
        } else {
            roots.push(partnerMap[p.id]);
        }
    });

    // Coaching Scope Logic
    const activeScopeId = localStorage.getItem('active_scope_initiator');
    let scopeSet = new Set();
    
    if (activeScopeId) {
        const scope = store.getCoachingScope(activeScopeId);
        if (scope.roots && scope.roots.length > 0) {
            // BFS/DFS to mark scope
            function mark(pid, depth) {
                if (depth > 5) return;
                scopeSet.add(pid);
                const p = partnerMap[pid];
                if(p && p.children) {
                    p.children.forEach(c => mark(c.id, depth + 1));
                }
            }
            scope.roots.forEach(rid => mark(rid, 1));
        }
    }

    // Recursive Render
    function renderNode(node) {
        const r = node.record;
        let classes = ['node'];
        if (scopeSet.has(node.id)) classes.push('in-scope');
        if (activeScopeId) {
             const scope = store.getCoachingScope(activeScopeId);
             if(scope.roots.includes(node.id)) classes.push('scope-root');
        }
        if (r && r.isGraduated) classes.push('graduate');
        if (r && r.payoutStatus === 'unpaid' && r.totalIncome > 0) classes.push('unpaid');

        let metric = r ? `${formatMoney(r.totalIncome)}` : 'ç„¡ç´€éŒ„';
        if (r && r.participation === 'inactive') metric = '(åœç”¨)';

        return `
            <li>
                <div class="${classes.join(' ')}" onclick="showNodeDetails('${node.id}', '${month}')">
                    <div class="name">${node.code} ${node.name}</div>
                    <div class="metric">${metric}</div>
                </div>
                ${node.children.length > 0 ? `<ul>${node.children.map(renderNode).join('')}</ul>` : ''}
            </li>
        `;
    }

    app.innerHTML = `
        <header>
            <h1>ğŸŒ³ çµ„ç¹”é—œè¯åœ–</h1>
            <div style="display:flex; gap:10px;">
                <input type="month" value="${month}" class="form-control" style="width:auto" onchange="localStorage.setItem('last_org_view_month', this.value); renderOrgChart();">
                <button class="btn btn-secondary" onclick="openScopeSettings()">ğŸ¯ è¨­å®šè¼”å°ç¯„åœ</button>
            </div>
        </header>
        
        <div style="margin-bottom:10px; padding:10px; background:white; border-radius:4px; display:flex; align-items:center; gap:15px;">
            <span>é¡¯ç¤ºè¼”å°ç¯„åœï¼š</span>
            <select class="form-control" style="width:auto" onchange="localStorage.setItem('active_scope_initiator', this.value); renderOrgChart();">
                <option value="">-- ç„¡ --</option>
                ${initiators.map(i => `<option value="${i.id}" ${i.id === activeScopeId ? 'selected' : ''}>${i.name}</option>`).join('')}
            </select>
            <span style="font-size:0.8rem; color:#888;">é»ƒæ¡†: ç¬¬ä¸€å±¤é‡é»(3ä½) | é»ƒåº•: 5ä»£è¼”å°ç¯„åœ</span>
        </div>

        <div class="org-container">
            <div class="tree">
                <ul>
                    ${roots.map(renderNode).join('')}
                </ul>
            </div>
        </div>
    `;
}

function openScopeSettings() {
    const initiators = store.data.initiators;
    const partners = store.data.partners;
    
    // UI logic to select initiator then select 3 roots
    // Simplified for single file: Select Initiator -> Show List of checkboxes
    
    const modalHtml = `
        <h2>è¨­å®šè¼”å°ç¯„åœ (3å¯¬5æ·±)</h2>
        <div class="form-group">
            <label>é¸æ“‡ç™¼èµ·äºº</label>
            <select id="scope-init-select" class="form-control" onchange="renderScopeSelector(this.value)">
                <option value="">-- è«‹é¸æ“‡ --</option>
                ${initiators.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}
            </select>
        </div>
        <div id="scope-selector-area"></div>
    `;
    openModal(modalHtml);
}

function renderScopeSelector(initId) {
    if (!initId) { document.getElementById('scope-selector-area').innerHTML = ''; return; }
    
    const scope = store.getCoachingScope(initId);
    const partners = store.data.partners;
    
    const html = `
        <p>è«‹é¸æ“‡æœ€å¤š 3 ä½ç¬¬ä¸€å±¤è¼”å°å°è±¡ï¼š</p>
        <div style="max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:10px;">
            ${partners.map(p => `
                <div style="margin-bottom:5px;">
                    <label>
                        <input type="checkbox" class="scope-root-check" value="${p.id}" 
                        ${scope.roots.includes(p.id) ? 'checked' : ''}
                        onchange="validateScopeLimit(this, '${initId}')">
                        ${p.code} ${p.name}
                    </label>
                </div>
            `).join('')}
        </div>
        <button class="btn btn-primary" style="margin-top:10px" onclick="saveScope('${initId}')">å„²å­˜è¨­å®š</button>
    `;
    document.getElementById('scope-selector-area').innerHTML = html;
}

function validateScopeLimit(checkbox, initId) {
    const checked = document.querySelectorAll('.scope-root-check:checked');
    if (checked.length > 3) {
        alert('æœ€å¤šåªèƒ½é¸æ“‡ 3 ä½ç¬¬ä¸€å±¤è¼”å°å°è±¡');
        checkbox.checked = false;
    }
}

function saveScope(initId) {
    const checked = Array.from(document.querySelectorAll('.scope-root-check:checked')).map(c => c.value);
    
    let scopeIdx = store.data.coachingScopes.findIndex(c => c.initiatorId === initId);
    if (scopeIdx === -1) {
        store.data.coachingScopes.push({ initiatorId: initId, roots: checked, depth: 5 });
    } else {
        store.data.coachingScopes[scopeIdx].roots = checked;
    }
    store.save();
    closeModal();
    renderOrgChart(); // Refresh view
}

function showNodeDetails(pid, month) {
    const r = store.data.records.find(rec => rec.partnerId === pid && rec.month === month);
    const p = store.getPartner(pid);
    if(!r) {
        if(confirm(`${p.name} æœ¬æœˆç„¡ç´€éŒ„ï¼Œè¦å‰å¾€å»ºç«‹å—ï¼Ÿ`)) {
            closeModal();
            router('records');
            setTimeout(() => {
                localStorage.setItem('last_view_month', month);
                renderRecords();
                editRecord(null, month);
                // Pre-select partner in the form
                tempRecord.partnerId = pid;
                document.querySelector('[name="partnerId"]').value = pid;
            }, 100);
        }
        return;
    }
    
    const calc = calculateRecord(r);
    
    openModal(`
        <h2>${p.code} ${p.name} - ${month}</h2>
        <table class="table">
            <tr><th>å°çµ„ PV</th><td>${calc.gpv}</td></tr>
            <tr><th>å€‹äººçé‡‘</th><td>${formatMoney(calc.personalBonus)}</td></tr>
            <tr><th>å·®é¡çé‡‘</th><td>${formatMoney(calc.diffBonusTotal)}</td></tr>
            <tr><th>å…¬å¸åˆè¨ˆ</th><td>${formatMoney(calc.companyTotal)}</td></tr>
            <tr style="border-top:2px solid #ddd"><th>æ–°æ˜Ÿåœ˜éšŠå›é¥‹</th><td>${formatMoney(calc.starTotal)}</td></tr>
            <tr style="background:#eee"><th>ç¸½æ”¶å…¥</th><td style="font-weight:bold;color:red">${formatMoney(calc.totalIncome)}</td></tr>
        </table>
        <div style="margin-top:15px; text-align:right;">
             <button class="btn btn-primary" onclick="closeModal(); router('records'); setTimeout(()=>editRecord('${r.id}', '${month}'), 100)">å‰å¾€ç·¨è¼¯</button>
        </div>
    `);
}

// 7. Plan Versions
function renderVersions() {
    app.innerHTML = `
        <header>
            <h1>âš™ï¸ è¨ˆç•«ç‰ˆæœ¬æ§ç®¡</h1>
            <button class="btn btn-primary" onclick="editVersion()">+ æ–°å¢ç‰ˆæœ¬</button>
        </header>
        <div class="card">
            <table>
                <thead><tr><th>ç‰ˆæœ¬åç¨±</th><th>å»ºç«‹æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                    ${store.data.versions.map(v => `
                        <tr>
                            <td>${v.name}</td>
                            <td>${new Date(v.createdAt).toLocaleDateString()}</td>
                            <td><button class="btn btn-secondary" onclick="editVersion('${v.id}')">æŸ¥çœ‹/ç·¨è¼¯</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function editVersion(id) {
    const v = id ? store.getVersion(id) : { 
        id: '', name: '2026 QX æ–°åˆ¶', createdAt: '', 
        params: { ...defaultPlanParams } 
    };
    const p = v.params;

    // Check usage
    const isUsed = id && store.data.records.some(r => r.planVersionId === id);

    openModal(`
        <h2>${id ? 'ç·¨è¼¯' : 'æ–°å¢'}ç‰ˆæœ¬</h2>
        ${isUsed ? '<p style="color:red">æ­¤ç‰ˆæœ¬å·²è¢«ç´€éŒ„ä½¿ç”¨ï¼Œå»ºè­°å»ºç«‹æ–°ç‰ˆæœ¬è€Œéä¿®æ”¹ã€‚</p>' : ''}
        <form onsubmit="saveVersion(event, '${id}')">
            <div class="form-group"><label>ç‰ˆæœ¬åç¨±</label><input name="name" value="${v.name}" class="form-control" required></div>
            
            <h3>åƒæ•¸è¨­å®š</h3>
            <div class="row">
                <div class="col form-group"><label>0-3% åŸºç¤å›é¥‹ç‡</label><input type="number" step="0.01" name="rate_0_3_base" value="${p.rate_0_3_base}" class="form-control"></div>
                <div class="col form-group"><label>0-3% æœ‰æ¨è–¦å›é¥‹ç‡</label><input type="number" step="0.01" name="rate_0_3_rec" value="${p.rate_0_3_rec}" class="form-control"></div>
            </div>
            <div class="row">
                <div class="col form-group"><label>6% åŸºç¤å›é¥‹ç‡</label><input type="number" step="0.01" name="rate_6_base" value="${p.rate_6_base}" class="form-control"></div>
                <div class="col form-group"><label>6% æœ‰æ¨è–¦å›é¥‹ç‡</label><input type="number" step="0.01" name="rate_6_rec" value="${p.rate_6_rec}" class="form-control"></div>
            </div>
            <div class="row">
                <div class="col form-group"><label>æ–°äººæ¶ˆè²»å›é¥‹ç‡</label><input type="number" step="0.01" name="rate_recruit_bv" value="${p.rate_recruit_bv}" class="form-control"></div>
                <div class="col form-group"><label>å­¸ç¿’åŠ ç¢¼ç‡</label><input type="number" step="0.01" name="rate_learning" value="${p.rate_learning}" class="form-control"></div>
            </div>

            <button type="submit" class="btn btn-primary">å„²å­˜ç‰ˆæœ¬</button>
        </form>
    `);
}

function saveVersion(e, id) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const params = {
        rate_0_3_base: Number(formData.get('rate_0_3_base')),
        rate_0_3_rec: Number(formData.get('rate_0_3_rec')),
        rate_6_base: Number(formData.get('rate_6_base')),
        rate_6_rec: Number(formData.get('rate_6_rec')),
        rate_recruit_bv: Number(formData.get('rate_recruit_bv')),
        rate_learning: Number(formData.get('rate_learning'))
    };
    
    if (id) {
        const idx = store.data.versions.findIndex(v => v.id === id);
        store.data.versions[idx] = { ...store.data.versions[idx], name: formData.get('name'), params };
    } else {
        store.data.versions.unshift({ // Add to top
            id: generateUUID(),
            name: formData.get('name'),
            createdAt: new Date().toISOString(),
            params
        });
    }
    store.save();
    closeModal();
    renderVersions();
}

// 8. Settings
function renderSettings() {
    app.innerHTML = `
        <header><h1>ğŸ› ï¸ ç³»çµ±è¨­å®š</h1></header>
        <div class="card">
            <h3>è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
            <p>å°‡æ‰€æœ‰ç³»çµ±è³‡æ–™åŒ¯å‡ºç‚º JSON æª”ï¼Œæˆ–å¾ JSON æª”é‚„åŸã€‚</p>
            <button class="btn btn-primary" onclick="exportData()">åŒ¯å‡ºå‚™ä»½ (JSON)</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">åŒ¯å…¥é‚„åŸ</button>
            <br><br>
            <button class="btn btn-danger" onclick="clearData()">âš ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
    `;
}

function exportData() {
    const blob = new Blob([JSON.stringify(store.data, null, 2)], { type: 'application/json' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Amway_Backup_${new Date().toISOString().slice(0,10)}.json`;
    link.click();
}

function importData(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if(confirm('ç¢ºå®šè¦é‚„åŸè³‡æ–™å—ï¼Ÿç¾æœ‰è³‡æ–™å°‡è¢«è¦†è“‹ã€‚')) {
                store.data = data;
                store.save();
                location.reload();
            }
        } catch(err) {
            alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
        }
    };
    reader.readAsText(file);
}

function clearData() {
    if(prompt('è«‹è¼¸å…¥ "DELETE" ç¢ºèªæ¸…é™¤æ‰€æœ‰è³‡æ–™') === 'DELETE') {
        localStorage.removeItem(DB_KEY);
        location.reload();
    }
}

// UI Helper
function openModal(content) {
    document.getElementById('modal-body').innerHTML = content;
    document.getElementById('modal').style.display = 'block';
}
function closeModal() {
    document.getElementById('modal').style.display = 'none';
}
window.onclick = function(event) {
    if (event.target == document.getElementById('modal')) closeModal();
}

// Initial Render
router('dashboard');

</script>
</body>
</html>
