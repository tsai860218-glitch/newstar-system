<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ± (v3.4 çµ„ç¹”æ¶æ§‹é‚è¼¯ç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #1abc9c;
            --accent-hover: #16a085;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --success: #27ae60;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --border: #e0e0e0;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --bg: #f8f9fa;
        }

        * { box-sizing: border-box; font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background-color: var(--bg); color: #333; overflow: hidden; }

        /* Sidebar */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: all 0.3s ease; z-index: 100; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        aside.collapsed { width: 0; opacity: 0; padding: 0; overflow: hidden; }
        aside h2 { padding: 20px; margin: 0; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; height: 60px; background: rgba(0,0,0,0.1); }
        aside nav { flex: 1; overflow-y: auto; padding: 10px 0; }
        aside nav a { display: block; padding: 12px 20px; color: #bdc3c7; text-decoration: none; transition: 0.2s; border-left: 4px solid transparent; cursor: pointer; font-size: 0.95rem; }
        aside nav a:hover, aside nav a.active { background: rgba(255,255,255,0.1); color: white; border-left-color: var(--accent); }
        aside .footer { padding: 15px; font-size: 0.75rem; color: #95a5a6; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 20px; position: relative; transition: margin 0.3s; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .menu-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; margin-right: 15px; color: var(--dark); padding: 0; width: 30px; text-align: center; }
        h1 { margin: 0; color: var(--dark); font-size: 1.6rem; display: flex; align-items: center; font-weight: 700; }
        .page-desc { font-size: 0.9rem; color: #7f8c8d; margin-top: -15px; margin-bottom: 20px; display: block; line-height: 1.5; }
        
        /* UI Components */
        .card { background: white; border-radius: 10px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; font-weight: 500; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: var(--accent); color: white; } .btn-primary:hover { background: var(--accent-hover); }
        .btn-danger { background: var(--danger); color: white; } .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #95a5a6; color: white; } .btn-secondary:hover { background: #7f8c8d; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); } .btn-outline:hover { background: var(--accent); color: white; }
        
        .form-group { margin-bottom: 15px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; transition: border 0.2s; }
        .row { display: flex; gap: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }

        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: inline-block; text-align: center; min-width: 60px; margin-right: 5px; }
        .status-active { background: #e8f8f5; color: var(--success); }
        .status-inactive { background: #f2f3f4; color: #95a5a6; border: 1px solid #ddd; }
        .status-paid { background: #d4efdf; color: var(--success); }
        .status-unpaid { background: #fce4ec; color: #c0392b; }
        .status-month-inactive { background: #fff3e0; color: #e67e22; border: 1px solid #ffe0b2; }

        /* Tables */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
        th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 700; color: var(--secondary); position: sticky; top: 0; border-bottom: 2px solid #ddd; }
        tr:hover td { background-color: #fcfcfc; }

        /* Dashboard Cards */
        .summary-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .summary-card { flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 10px; box-shadow: var(--shadow); border-left: 5px solid transparent; display: flex; flex-direction: column; justify-content: space-between; }
        .summary-card.green { border-left-color: var(--success); }
        .summary-card.red { border-left-color: var(--danger); }
        .summary-val { font-size: 2rem; font-weight: 800; color: var(--dark); margin: 5px 0; }
        .summary-label { font-size: 0.9rem; color: #7f8c8d; font-weight: 500; }
        .summary-hint { font-size: 0.8rem; color: #aaa; margin-top: 5px; }

        /* Modal & Layout */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fefefe; margin: 3vh auto; padding: 0; border: none; width: 95%; max-width: 1100px; border-radius: 12px; max-height: 94vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-header h2 { margin: 0; font-size: 1.2rem; }
        .close { font-size: 24px; cursor: pointer; color: #aaa; transition: 0.2s; } .close:hover { color: #333; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; background: #f9f9f9; }
        
        /* Edit Record 2-Col */
        .record-modal-grid { display: flex; gap: 25px; align-items: flex-start; }
        .record-form-col { flex: 1.6; min-width: 320px; }
        .record-preview-col { flex: 1; min-width: 280px; position: sticky; top: 0; }
        fieldset { border: none; background: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
        legend { font-weight: 700; color: var(--primary); font-size: 1.05rem; padding: 0; margin-bottom: 15px; width: 100%; border-bottom: 1px solid #eee; padding-bottom: 8px; display: block; }

        /* Preview Card */
        .preview-card { background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 25px; border-top: 5px solid var(--accent); }
        .preview-header { font-size: 1rem; font-weight: 600; color: #7f8c8d; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .preview-amount-big { font-size: 2.5rem; font-weight: 800; color: var(--success); text-align: right; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; line-height: 1; }
        .preview-amount-big.zero { color: #bdc3c7; }
        .preview-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; color: #555; }
        .preview-details { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; font-size: 0.85rem; color: #888; }
        .status-tag { padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; background: #eee; font-weight: bold; }

        /* FAQ */
        .faq-item { border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; overflow: hidden; background: white; }
        .faq-question { padding: 15px; background: #fff; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .faq-question:hover { background: #f8f9fa; color: var(--accent); }
        .faq-answer { display: none; padding: 15px; border-top: 1px solid #eee; color: #555; font-size: 0.95rem; line-height: 1.6; background: #fdfdfd; }
        .faq-item.active .faq-answer { display: block; }
        .faq-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }

        /* ğŸ”¥ Org Chart Visuals - Updated for 3x5 Scope */
        .org-container { overflow: auto; padding: 40px 20px; height: 650px; background: white; border-radius: 8px; box-shadow: inset 0 0 20px rgba(0,0,0,0.03); position: relative; text-align: center; }
        
        .tree ul { padding-top: 20px; position: relative; transition: all 0.5s; display: inline-flex; justify-content: center; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; transition: all 0.5s; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #ccc; width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 1px solid #ccc; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 1px solid #ccc; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #ccc; width: 0; height: 20px; }

        .node { border: 2px solid #ccc; padding: 8px 12px; text-decoration: none; color: #333; font-size: 13px; display: inline-block; border-radius: 8px; transition: all 0.3s; min-width: 140px; position: relative; cursor: pointer; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .node:hover { transform: scale(1.05); z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .node .name { font-weight: 800; font-size: 14px; margin-bottom: 4px; display: block; }
        .node .status { font-size: 12px; font-weight: bold; }
        .node .level-badge { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #34495e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; z-index: 2; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .node .icon { position: absolute; top: -8px; right: -8px; width: 22px; height: 22px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        /* Node States */
        .node.unpaid { border-color: #e74c3c; background-color: #fdedec; }
        .node.unpaid .name { color: #c0392b; }
        .node.unpaid .status { color: #e74c3c; }
        .node.unpaid .icon { background-color: #e74c3c; }
        
        .node.paid { border-color: #27ae60; background-color: #e8f8f5; }
        .node.paid .name { color: #1e8449; }
        .node.paid .status { color: #27ae60; }
        .node.paid .icon { background-color: #27ae60; }
        
        .node.inactive { border-color: #bdc3c7; background-color: #f0f0f0; color: #95a5a6; }
        .node.inactive .name { color: #7f8c8d; text-decoration: line-through; }
        
        .node.graduate { border-color: #16a085; background-color: #e0f2f1; }
        .node.graduate .name { color: #0e6655; }
        .node.graduate .icon { background-color: #1abc9c; }

        .node.month-inactive { border: 2px dashed #95a5a6; background-color: #fff; }
        .node.no-record { border: 2px dashed #bdc3c7; background-color: white; opacity: 0.8; }
        
        /* Scope & Independent System Styles */
        .node.scope-root { border: 3px solid #f1c40f; transform: scale(1.05); }
        .node.out-of-scope { opacity: 0.5; filter: grayscale(1); border-style: dotted; }
        .node.out-of-scope .level-badge { background: #95a5a6; }
        
        .node.independent-sys { border-color: #8e44ad; background-color: #f4ecf7; }
        .node.independent-sys .name { color: #8e44ad; }
        .node.independent-sys .level-badge { background: #8e44ad; }
        .node.independent-sys::after { content: 'â­ ç¨ç«‹ç™¼èµ·äºº'; display: block; font-size: 10px; color: #8e44ad; margin-top: 3px; font-weight: bold; }

        .node .tooltip { visibility: hidden; width: 200px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 100; bottom: 120%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 11px; line-height: 1.4; pointer-events: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .node:hover .tooltip { visibility: visible; opacity: 1; }

        .legend { margin-top: 15px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; font-size: 0.85rem; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-box { width: 15px; height: 15px; border-radius: 3px; border: 1px solid #ccc; }

        /* Toolbar */
        .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; background: white; padding: 10px 15px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .toolbar input, .toolbar select { width: auto; min-width: 120px; flex: 1; border: 1px solid #ddd; border-radius: 6px; padding: 8px; }

        @media (max-width: 768px) {
            .record-modal-grid { flex-direction: column-reverse; }
            .record-preview-col { position: static; width: 100%; margin-bottom: 10px; }
            .modal-actions-bar { position: sticky; bottom: 0; background: white; padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
            .modal-actions-bar .btn { flex: 1; padding: 12px; font-size: 1rem; }
            .desktop-actions { display: none; }
        }

        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--accent); animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #sync-status { position: fixed; bottom: 20px; right: 20px; padding: 8px 16px; background: rgba(0,0,0,0.8); color: white; border-radius: 30px; font-size: 0.85rem; pointer-events: none; display: flex; align-items: center; gap: 8px; z-index: 999; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
        .dot.connected { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
    </style>
</head>
<body>

<div id="loading-screen"><div class="spinner"></div><div>é€£ç·šä¸­...</div></div>
<div id="sync-status"><div class="dot" id="sync-dot"></div><span id="sync-text">é›¢ç·š</span></div>

<aside id="sidebar">
    <h2>ğŸš€ æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«</h2>
    <nav>
        <a onclick="router('dashboard')" id="nav-dashboard" class="active">ğŸ“Š ç¸½è¦½å„€è¡¨æ¿</a>
        <a onclick="router('records')" id="nav-records">ğŸ“ æœˆä»½æ¥­ç¸¾ç´€éŒ„</a>
        <a onclick="router('payout')" id="nav-payout">ğŸ’° æœ¬æœˆç™¼æ”¾ç¸½è¡¨</a>
        <a onclick="router('partners')" id="nav-partners">ğŸ‘¥ å¤¥ä¼´åå–®ç®¡ç†</a>
        <a onclick="router('initiators')" id="nav-initiators">ğŸ‘” ç™¼èµ·äººç®¡ç†</a>
        <a onclick="router('org')" id="nav-org">ğŸŒ³ çµ„ç¹”é—œè¯åœ–</a>
        <a onclick="router('versions')" id="nav-versions">âš™ï¸ è¨ˆç•«ç‰ˆæœ¬æ§ç®¡</a>
        <a onclick="router('settings')" id="nav-settings">ğŸ› ï¸ ç³»çµ±è¨­å®š</a>
        <a onclick="router('faq')" id="nav-faq">â“ ç³»çµ±èªªæ˜ (FAQ)</a>
    </nav>
    <div class="footer">v3.4 çµ„ç¹”æ¶æ§‹é‚è¼¯ç‰ˆ</div>
</aside>

<main id="app"></main>

<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="modal-title"></h2><span class="close" onclick="closeModalSafe()">&times;</span></div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<script>
/**
 * FIREBASE CONFIG (ä½¿ç”¨æ‚¨çš„ Key)
 */
const firebaseConfig = {
    apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
    authDomain: "newstar-system.firebaseapp.com",
    projectId: "newstar-system",
    storageBucket: "newstar-system.firebasestorage.app",
    messagingSenderId: "889699172174",
    appId: "1:889699172174:web:0ff42757035a879cb3281f",
    databaseURL: "https://newstar-system-default-rtdb.asia-southeast1.firebasedatabase.app" 
};

let isFirebaseReady = false;
let db = null;

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    isFirebaseReady = true;
} catch (e) {
    document.getElementById('loading-screen').innerHTML = '<h3 style="color:red">âš ï¸ é€£ç·šéŒ¯èª¤</h3>';
}

const defaultPlanParams = { rate_0_3_base: 0.03, rate_0_3_rec: 0.04, rate_6_base: 0.01, rate_6_rec: 0.02, rate_recruit_bv: 0.01, rate_learning: 0.03 };
let appData = { partners: [], initiators: [], records: [], versions: [], coachingScopes: [] };

const store = {
    data: appData, 
    init() {
        if (!isFirebaseReady) return;
        const syncDot = document.getElementById('sync-dot');
        const syncText = document.getElementById('sync-text');
        db.ref(".info/connected").on("value", (snap) => {
            if (snap.val() === true) { syncDot.classList.add('connected'); syncText.innerText = "å·²é€£ç·š"; } 
            else { syncDot.classList.remove('connected'); syncText.innerText = "é›¢ç·š"; }
        });
        db.ref('AmwaySystem/v1').on('value', (snapshot) => {
            const val = snapshot.val();
            if (val) {
                this.data = val;
                if(!this.data.partners) this.data.partners = [];
                if(!this.data.initiators) this.data.initiators = [];
                if(!this.data.records) this.data.records = [];
                if(!this.data.versions) this.data.versions = [];
                if(!this.data.coachingScopes) this.data.coachingScopes = [];
            } else {
                this.data.versions.push({ id: generateUUID(), name: 'é è¨­ç‰ˆæœ¬', createdAt: new Date().toISOString(), params: { ...defaultPlanParams } });
                this.save();
            }
            document.getElementById('loading-screen').style.display = 'none';
            const activeNav = document.querySelector('aside nav a.active');
            router(activeNav ? activeNav.id.replace('nav-', '') : 'dashboard');
        });
    },
    save() { if (isFirebaseReady) db.ref('AmwaySystem/v1').set(this.data).catch(err => alert("å„²å­˜å¤±æ•—")); },
    getPartner(id) { return this.data.partners.find(p => p.id === id); },
    getInitiator(id) { return this.data.initiators.find(i => i.id === id); },
    getRecord(id) { return this.data.records.find(r => r.id === id); },
    getRecordsByMonth(month) { return this.data.records.filter(r => r.month === month); },
    getVersion(id) { return this.data.versions.find(v => v.id === id) || this.data.versions[0]; },
    getCoachingScope(initiatorId) { return this.data.coachingScopes.find(c => c.initiatorId === initiatorId) || { initiatorId, roots: [], depth: 5 }; }
};

store.init();

/* Utils */
function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
function formatMoney(num) { return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num); }
function getBonusPercent(pv) { return pv>=10000?0.21:pv>=7000?0.18:pv>=4000?0.15:pv>=2000?0.12:pv>=1000?0.09:pv>=600?0.06:pv>=200?0.03:0; }
function getDefaultPayoutDate(month) { const d = new Date(); return (d.toISOString().slice(0,7)===month && d.getDate()<18) ? month+'-18' : d.toISOString().slice(0,10); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
function getHeaderHtml(title) { return `<h1><button class="menu-btn" onclick="toggleSidebar()">â˜°</button> ${title}</h1>`; }

/* Calculate Logic */
function calculateCore(r, partner) {
    if (!partner) return null;
    const version = store.getVersion(r.planVersionId);
    const params = version.params;
    const myRate = getBonusPercent(r.gpv);
    
    let starTotal=0, baseBonus=0, recruitBonus=0, learningBonus=0;
    let isGraduated = r.gpv >= 1000;
    
    let isPartnerInactive = partner.status === 'inactive';
    let isMonthlyInactive = r.participation === 'inactive';
    let isEligible = !isGraduated && !isMonthlyInactive && !isPartnerInactive;
    
    let appliedRate = 0, appliedRateText = '0%';
    let calcBaseBV = 0;

    if (isEligible) {
        const hasRecruit = (r.newRecruits || []).length > 0;
        if (myRate <= 0.03) { appliedRate = hasRecruit ? params.rate_0_3_rec : params.rate_0_3_base; appliedRateText = hasRecruit ? 'å«æ¨è–¦ (0-3%)' : 'åŸºç¤ (0-3%)'; }
        else if (myRate === 0.06) { appliedRate = hasRecruit ? params.rate_6_rec : params.rate_6_base; appliedRateText = hasRecruit ? 'å«æ¨è–¦ (6%)' : 'åŸºç¤ (6%)'; }
        else { isEligible = false; }

        if (isEligible) {
            const independentLegsBV = (r.legs||[]).filter(l => l.isIndependent).reduce((sum, l) => sum + (Number(l.bv)||0), 0);
            calcBaseBV = Math.max(0, (r.gpv * 50) - independentLegsBV);
            baseBonus = calcBaseBV * appliedRate;
            const newRecruitTotalBV = (r.newRecruits||[]).reduce((sum, nr) => sum + (Number(nr.bv)||0), 0);
            recruitBonus = newRecruitTotalBV * params.rate_recruit_bv;
            if (r.learningDone) learningBonus = (baseBonus + recruitBonus) * params.rate_learning;
            starTotal = baseBonus + recruitBonus + learningBonus;
        }
    }
    return { ...r, partnerName: partner.name+' '+partner.code, initiatorId: partner.initiatorId, myRate, isGraduated, isPartnerInactive, isMonthlyInactive, isEligible, appliedRate, appliedRateText, calcBaseBV, baseBonus, recruitBonus, learningBonus, starTotal, totalIncome: starTotal };
}
function calculateRecord(r) { return calculateCore(r, store.getPartner(r.partnerId)); }
function calculatePreview(r) { 
    let p = store.getPartner(r.partnerId);
    if (!p) p = { name:'', code:'', initiatorId:'', status:'active' }; 
    return calculateCore(r, p); 
}

/* Routing */
function router(page) {
    document.querySelectorAll('aside nav a').forEach(a => a.classList.remove('active'));
    if(document.getElementById('nav-'+page)) document.getElementById('nav-'+page).classList.add('active');
    app.innerHTML = '';
    switch(page) {
        case 'dashboard': renderDashboard(); break;
        case 'faq': renderFAQ(); break;
        case 'org': renderOrgChart(); break;
        default: if(window['render'+page.charAt(0).toUpperCase()+page.slice(1)]) window['render'+page.charAt(0).toUpperCase()+page.slice(1)]();
    }
}

/* 1. Dashboard */
function renderDashboard() {
    const month = new Date().toISOString().slice(0, 7);
    const records = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x); 
    const total = records.reduce((s, r) => s + r.starTotal, 0);
    const unpaid = records.filter(r => r.payoutStatus !== 'paid' && r.totalIncome > 0).length;
    app.innerHTML = `<header>${getHeaderHtml(`ç¸½è¦½ (${month})`)}</header>
        <div class="summary-row">
            <div class="summary-card green"><div class="summary-label">æœ¬æœˆé ä¼°</div><div class="summary-val">${formatMoney(total)}</div></div>
            <div class="summary-card red"><div class="summary-label">å¾…ç™¼æ”¾</div><div class="summary-val">${unpaid} äºº</div></div>
        </div>`;
}

/* 2. Partners */
function renderPartners() {
    const term = localStorage.getItem('p_search') || '';
    const list = store.data.partners.filter(p => p.code.includes(term)||p.name.includes(term));
    app.innerHTML = `<header>${getHeaderHtml('å¤¥ä¼´åå–®ç®¡ç†')}</header>
    <div class="toolbar"><input type="text" placeholder="ğŸ” æœå°‹" value="${term}" oninput="localStorage.setItem('p_search',this.value);renderPartners()">
    <button class="btn btn-primary" onclick="editPartner()">+ æ–°å¢</button></div>
    <div class="card"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>æ¨è–¦äºº</th><th>ç™¼èµ·äºº</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>
    ${list.map(p => `<tr><td>${p.code}</td><td>${p.name}</td><td>${store.getPartner(p.sponsorId)?.name||'-'}</td><td>${store.getInitiator(p.initiatorId)?.name||'<span style="color:red">æœªè¨­å®š</span>'}</td>
    <td><span class="status-badge ${p.status==='inactive'?'status-inactive':'status-active'}">${p.status==='active'?'å•Ÿç”¨':'åœç”¨'}</span></td>
    <td><button class="btn btn-secondary" onclick="editPartner('${p.id}')">ç·¨è¼¯</button> <button class="btn btn-danger" onclick="deletePartner('${p.id}')">åˆªé™¤</button></td></tr>`).join('')}</tbody></table></div>`;
}
function editPartner(id) {
    const p = id ? store.getPartner(id) : {id:'', code:'', name:'', sponsorId:'', initiatorId:'', status:'active'};
    const partners = store.data.partners.filter(x => x.id !== p.id);
    const initiators = store.data.initiators;
    openModal(id?'ç·¨è¼¯å¤¥ä¼´':'æ–°å¢å¤¥ä¼´', `<form onsubmit="savePartner(event,'${id||''}')">
    <div class="row"><div class="col"><label>ç·¨è™Ÿ</label><input class="form-control" name="code" value="${p.code}" required></div><div class="col"><label>å§“å</label><input class="form-control" name="name" value="${p.name}" required></div></div>
    <div class="form-group"><label>æ¨è–¦äºº</label><select class="form-control" name="sponsorId"><option value="">-- ç„¡ --</option>${partners.map(o=>`<option value="${o.id}" ${o.id===p.sponsorId?'selected':''}>${o.code} ${o.name}</option>`).join('')}</select></div>
    <div class="form-group"><label>ç™¼èµ·äºº</label><select class="form-control" name="initiatorId" required><option value="">-- è«‹é¸æ“‡ --</option>${initiators.map(o=>`<option value="${o.id}" ${o.id===p.initiatorId?'selected':''}>${o.name}</option>`).join('')}</select></div>
    <div class="form-group"><label>ç‹€æ…‹</label><select class="form-control" name="status"><option value="active" ${p.status==='active'?'selected':''}>å•Ÿç”¨</option><option value="inactive" ${p.status==='inactive'?'selected':''}>åœç”¨</option></select></div>
    <button type="submit" class="btn btn-primary" style="width:100%">å„²å­˜</button></form>`);
}
function savePartner(e,id) { e.preventDefault(); const d = Object.fromEntries(new FormData(e.target)); if(store.data.partners.some(p=>p.code===d.code&&p.id!==id)) return alert('ç·¨è™Ÿé‡è¤‡'); if(id){const i=store.data.partners.findIndex(x=>x.id===id);store.data.partners[i]={...store.data.partners[i],...d}}else{store.data.partners.push({...d,id:generateUUID()})} store.save(); closeModal(); }
function deletePartner(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿé€™å°‡é€£å‹•åˆªé™¤è©²å¤¥ä¼´æ‰€æœ‰æœˆç´€éŒ„ï¼Œä¸¦å°‡ä¸‹ç·šèˆ‡ç™¼èµ·äººé—œè¯æ¸…ç©ºã€‚')){ store.data.records=store.data.records.filter(r=>r.partnerId!==id); store.data.partners.forEach(p=>{if(p.sponsorId===id)p.sponsorId='';}); store.data.partners=store.data.partners.filter(x=>x.id!==id); store.save(); renderPartners(); } }

/* 3. Records */
function renderRecords() {
    const month = localStorage.getItem('r_month') || new Date().toISOString().slice(0, 7);
    const search = localStorage.getItem('r_search') || '';
    const filters = JSON.parse(localStorage.getItem('r_filters')||'[]');
    let list = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x);
    if(search) list = list.filter(r=>r.partnerName.includes(search));
    if(filters.includes('unpaid')) list = list.filter(r=>r.payoutStatus!=='paid'&&r.totalIncome>0);
    const toggle = f => { const i=filters.indexOf(f); i>-1?filters.splice(i,1):filters.push(f); localStorage.setItem('r_filters',JSON.stringify(filters)); renderRecords(); };
    app.innerHTML = `<header>${getHeaderHtml('æœˆä»½æ¥­ç¸¾')}</header>
    <div class="toolbar"><input type="month" value="${month}" onchange="localStorage.setItem('r_month',this.value);renderRecords()">
    <input type="text" placeholder="ğŸ” æœå°‹" value="${search}" oninput="localStorage.setItem('r_search',this.value);renderRecords()">
    <label><input type="checkbox" ${filters.includes('unpaid')?'checked':''} onchange="toggle('unpaid')"> æœªç™¼æ”¾</label>
    <button class="btn btn-primary" onclick="editRecord(null,'${month}')">ï¼‹ ç´€éŒ„</button></div>
    <div class="card"><table><thead><tr><th>å¤¥ä¼´</th><th>ç‹€æ…‹</th><th>PV</th><th>å›é¥‹</th><th>ç™¼æ”¾</th><th>æ“ä½œ</th></tr></thead><tbody>
    ${list.map(r => `<tr><td>${r.partnerName}</td><td>${r.isPartnerInactive?'<span class="status-badge status-inactive">åœç”¨</span>':r.isGraduated?'<span class="status-badge status-active">ğŸ“ ç•¢æ¥­</span>':r.isMonthlyInactive?'<span class="status-badge status-month-inactive">æœ¬æœˆä¸è¨ˆ</span>':'<span class="status-badge status-active">åƒèˆ‡ä¸­</span>'}</td>
    <td>${r.gpv}</td><td style="font-weight:bold">${formatMoney(r.totalIncome)}</td>
    <td><span class="status-badge ${r.payoutStatus==='paid'?'status-paid':'status-unpaid'}">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</span></td>
    <td><button class="btn btn-secondary" onclick="editRecord('${r.id}')">ç·¨è¼¯</button></td></tr>`).join('')}</tbody></table></div>`;
}

let isModalDirty = false;
let tempRecord = {};
function markDirty() { isModalDirty = true; }

function editRecord(id, month) {
    isModalDirty = false;
    const r = id ? store.getRecord(id) : { id:'', partnerId:'', month, ppv:0, pbv:0, gpv:0, legs:[], newRecruits:[], learningDone:false, participation:'active', payoutStatus:'unpaid', payoutDate: getDefaultPayoutDate(month), planVersionId: store.data.versions.find(v=>!v.archived)?.id, note:'' };
    if(r.payoutStatus==='paid' && id && !confirm('å·²ç™¼æ”¾ï¼Œç¢ºå®šç·¨è¼¯ï¼Ÿ')) return;
    tempRecord = JSON.parse(JSON.stringify(r));
    
    const partnerOptions = store.data.partners.map(p => `<option value="${p.id}" ${p.id===r.partnerId?'selected':''} style="${p.status==='inactive'?'color:gray':''}">${p.code} ${p.name} ${p.status==='inactive'?'(åœç”¨)':''}</option>`).join('');
    const versionOptions = store.data.versions.filter(v => !v.archived || v.id === r.planVersionId).map(v => `<option value="${v.id}" ${v.id===r.planVersionId?'selected':''}>${v.name} ${v.archived?'(å°å­˜)':''}</option>`).join('');

    const modalHtml = `
        <form id="recordForm" onsubmit="saveRecord(event, '${id||''}')">
            <div class="record-modal-grid">
                <div class="record-form-col">
                    <fieldset><legend>åŸºæœ¬</legend>
                        <div class="row"><div class="col"><label>å¤¥ä¼´</label><select class="form-control" name="partnerId" required onchange="tempRecord.partnerId=this.value;renderPreview()"><option value="">-- è«‹é¸æ“‡ --</option>${partnerOptions}</select></div>
                        <div class="col"><label>ç‰ˆæœ¬</label><select class="form-control" name="planVersionId" onchange="tempRecord.planVersionId=this.value;renderPreview()">${versionOptions}</select></div></div>
                    </fieldset>
                    <fieldset><legend>æ¥­ç¸¾ (PV/BV)</legend>
                        <div class="row"><div class="col"><label>å€‹äººPV</label><input type="number" class="form-control" name="ppv" value="${r.ppv}" oninput="document.getElementsByName('pbv')[0].value=this.value*50"></div>
                        <div class="col"><label>å€‹äººBV</label><input type="number" class="form-control" name="pbv" value="${r.pbv}"></div>
                        <div class="col"><label>å°çµ„PV *</label><input type="number" class="form-control" name="gpv" value="${r.gpv}" required oninput="tempRecord.gpv=Number(this.value);renderPreview()"></div></div>
                    </fieldset>
                    <fieldset><legend>è…¿ (åˆ¤æ–·ç¨ç«‹)</legend><div id="legs-container"></div><button type="button" class="btn btn-outline" style="margin-top:5px" onclick="addLeg()">+ è…¿</button></fieldset>
                    <fieldset><legend>æ¢ä»¶</legend>
                        <div class="row"><div class="col"><label>ç‹€æ…‹</label><select class="form-control" onchange="tempRecord.participation=this.value;renderPreview()"><option value="active" ${r.participation==='active'?'selected':''}>åƒèˆ‡</option><option value="inactive" ${r.participation==='inactive'?'selected':''}>æœ¬æœˆä¸è¨ˆ</option></select></div>
                        <div class="col"><label style="padding-top:30px"><input type="checkbox" ${r.learningDone?'checked':''} onchange="tempRecord.learningDone=this.checked;renderPreview()"> å­¸ç¿’ä»»å‹™</label></div></div>
                        <div><label>æ–°äººæ¸…å–®</label><div id="recruits-container"></div><button type="button" class="btn btn-outline" style="margin-top:5px" onclick="addRecruit()">+ æ–°äºº</button></div>
                    </fieldset>
                    <fieldset><legend>å…¶ä»–</legend>
                        <div class="form-group"><label>å‚™è¨»</label><textarea name="note" class="form-control">${r.note||''}</textarea></div>
                        <div class="row"><div class="col"><label>æ—¥æœŸ</label><input type="date" class="form-control" name="payoutDate" value="${r.payoutDate}"></div>
                        <div class="col"><label>ç™¼æ”¾</label><select class="form-control" name="payoutStatus"><option value="unpaid" ${r.payoutStatus==='unpaid'?'selected':''}>æœªç™¼æ”¾</option><option value="paid" ${r.payoutStatus==='paid'?'selected':''}>å·²ç™¼æ”¾</option></select></div></div>
                    </fieldset>
                </div>
                <div class="record-preview-col">
                    <div id="preview-box" class="preview-card"></div>
                    <div class="desktop-actions" style="margin-top:15px; display:flex; gap:10px;">
                        <button type="submit" class="btn btn-primary" style="flex:1; padding:12px;">å„²å­˜</button>
                        ${id?`<button type="button" class="btn btn-danger" onclick="deleteRecord('${id}')">åˆªé™¤</button>`:''}
                    </div>
                </div>
            </div>
            <div class="modal-actions-bar">
                <button type="button" class="btn btn-secondary" onclick="closeModalSafe()">é—œé–‰</button>
                ${id?`<button type="button" class="btn btn-danger" onclick="deleteRecord('${id}')">åˆªé™¤</button>`:''}
                <button type="submit" class="btn btn-primary">å„²å­˜</button>
            </div>
        </form>`;
    
    openModal(id?'ç·¨è¼¯ç´€éŒ„':'æ–°å¢ç´€éŒ„', modalHtml);
    document.getElementById('recordForm').addEventListener('input', markDirty);
    document.getElementById('recordForm').addEventListener('change', markDirty);
    renderLegs(); renderRecruits(); renderPreview();
}

function renderPreview() {
    const res = calculatePreview(tempRecord);
    const box = document.getElementById('preview-box');
    if(!box || !res) return;
    let statusHtml = '<span class="status-tag" style="background:#e8f8f5;color:#27ae60">ğŸŸ¢ å¯ç™¼æ”¾</span>';
    if(res.isPartnerInactive) statusHtml = '<span class="status-tag" style="background:#f0f0f0;color:#7f8c8d">â¸ å¤¥ä¼´å·²åœç”¨</span>';
    else if(res.isMonthlyInactive) statusHtml = '<span class="status-tag" style="background:#fff3e0;color:#e67e22">âšª æœ¬æœˆä¸è¨ˆ</span>';
    else if(res.isGraduated) statusHtml = '<span class="status-tag" style="background:#e8f8f5;color:#27ae60">ğŸ“ ç•¢æ¥­</span>';
    else if(!res.isEligible) statusHtml = '<span class="status-tag" style="background:#fef9e7;color:#f39c12">ğŸš« ä¸é©ç”¨</span>';

    box.innerHTML = `<div class="preview-header"><span>æœ¬æœˆé ä¼°</span> ${statusHtml}</div>
    <div class="preview-amount-big ${res.starTotal===0?'zero':''}">${formatMoney(res.starTotal)}</div>
    ${(res.isEligible) ? `<div class="preview-row"><span>æ¯”ä¾‹</span><span>${res.appliedRateText}</span></div>
    <div class="preview-row"><span>åŸºç¤</span><span>${formatMoney(res.baseBonus)}</span></div>
    <div class="preview-row"><span>æ–°äºº</span><span>${formatMoney(res.recruitBonus)}</span></div>
    <div class="preview-row"><span>å­¸ç¿’</span><span>${formatMoney(res.learningBonus)}</span></div>` : `<div style="text-align:center;color:#999;">æœ¬æœˆä¸ç¬¦åˆæ¢ä»¶</div>`}`;
}

function renderLegs() { document.getElementById('legs-container').innerHTML = tempRecord.legs.map((l, i) => `<div style="display:flex;gap:5px;margin-bottom:5px;"><input style="flex:2" class="form-control" placeholder="è…¿å" value="${l.name}" oninput="tempRecord.legs[${i}].name=this.value"><input style="flex:1.5" type="number" class="form-control" placeholder="BV" value="${l.bv}" oninput="tempRecord.legs[${i}].bv=Number(this.value);renderPreview()"><label style="flex:1;display:flex;align-items:center;font-size:0.8rem"><input type="checkbox" ${l.isIndependent?'checked':''} onchange="tempRecord.legs[${i}].isIndependent=this.checked;renderPreview()"> ç¨ç«‹</label><button type="button" class="btn btn-danger" onclick="tempRecord.legs.splice(${i},1);renderLegs();renderPreview();markDirty()">X</button></div>`).join(''); }
function addLeg() { tempRecord.legs.push({ name: '', pv: 0, bv: 0, isIndependent: false }); renderLegs(); renderPreview(); markDirty(); }
function renderRecruits() { document.getElementById('recruits-container').innerHTML = tempRecord.newRecruits.map((r, i) => `<div style="display:flex;gap:5px;margin-bottom:5px;"><input style="flex:2" class="form-control" placeholder="å§“å" value="${r.name}" oninput="tempRecord.newRecruits[${i}].name=this.value"><input style="flex:1.5" type="number" class="form-control" placeholder="BV" value="${r.bv}" oninput="tempRecord.newRecruits[${i}].bv=Number(this.value);renderPreview()"><button type="button" class="btn btn-danger" onclick="tempRecord.newRecruits.splice(${i},1);renderRecruits();renderPreview();markDirty()">X</button></div>`).join(''); }
function addRecruit() { tempRecord.newRecruits.push({ name: '', bv: 0 }); renderRecruits(); renderPreview(); markDirty(); }

function saveRecord(e, id) {
    e.preventDefault(); const fd = new FormData(e.target);
    const partnerId = fd.get('partnerId'); const month = tempRecord.month;
    if (!id) { const exist = store.data.records.find(r => r.month === month && r.partnerId === partnerId); if (exist) { if(confirm('æœ¬æœˆå·²æœ‰ç´€éŒ„ï¼ç·¨è¼¯ï¼Ÿ')) { closeModal(); setTimeout(() => editRecord(exist.id, month), 200); } return; } }
    const p = store.getPartner(partnerId);
    if (p && p.status === 'inactive') {
        if(confirm(`æ­¤å¤¥ä¼´ (${p.name}) ç›®å‰ç‚ºã€åœç”¨ã€‘ç‹€æ…‹ï¼Œæœ¬æœˆä¸æœƒè¨ˆç®—æ–°æ˜Ÿçé‡‘ã€‚\n\næ˜¯å¦è¦å…ˆå°‡å¤¥ä¼´æ”¹ç‚ºã€Œå•Ÿç”¨ã€ï¼Ÿ`)) { p.status = 'active'; store.save(); } 
        else { tempRecord.participation = 'inactive'; }
    }
    const record = { ...tempRecord, partnerId, planVersionId: fd.get('planVersionId'), month, ppv: Number(fd.get('ppv')), pbv: Number(fd.get('pbv')), gpv: Number(fd.get('gpv')), note: fd.get('note'), payoutDate: fd.get('payoutDate'), payoutStatus: fd.get('payoutStatus') };
    if(id) { const idx = store.data.records.findIndex(r => r.id === id); store.data.records[idx] = record; }
    else { record.id = generateUUID(); store.data.records.push(record); }
    isModalDirty = false; store.save(); closeModal();
}
function deleteRecord(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { store.data.records = store.data.records.filter(r => r.id !== id); store.save(); closeModal(); router('records'); } }

/* 5. Payout */
function renderPayout() {
    const month = localStorage.getItem('pay_month') || new Date().toISOString().slice(0, 7);
    const search = localStorage.getItem('pay_search') || '';
    let records = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x);
    if(search) records = records.filter(r => r.partnerName.includes(search) || (store.getInitiator(r.initiatorId)||{}).name?.includes(search));
    const initiators = store.data.initiators; const groups = {};
    initiators.forEach(init => { groups[init.id] = { info: init, records: records.filter(r => r.initiatorId === init.id), total: 0, paid: 0, unpaid: 0 }; });
    const orphans = records.filter(r => !r.initiatorId || !store.getInitiator(r.initiatorId));
    if(orphans.length > 0) groups['none'] = { info: { name: 'æœªæŒ‡å®š', code: 'N/A' }, records: orphans, total:0, paid:0, unpaid:0 };
    Object.values(groups).forEach(g => { g.records.forEach(r => { g.total += r.totalIncome; if(r.payoutStatus === 'paid') g.paid += r.totalIncome; else g.unpaid += r.totalIncome; }); });
    app.innerHTML = `<header>${getHeaderHtml('æœ¬æœˆç™¼æ”¾')}</header>
    <div class="toolbar"><input type="month" value="${month}" onchange="localStorage.setItem('pay_month',this.value);renderPayout()">
    <input type="text" placeholder="ğŸ” æœå°‹" value="${search}" oninput="localStorage.setItem('pay_search',this.value);renderPayout()">
    <button class="btn btn-primary" onclick="bulkMarkPaid('${month}')">æ‰¹æ¬¡ç™¼æ”¾</button> 
    <button class="btn btn-secondary" onclick="exportPayoutCSV('${month}')">åŒ¯å‡º CSV</button></div>
    ${Object.values(groups).filter(g => g.records.length > 0).map(g => `<div class="card">
        <h3 style="border-bottom:2px solid var(--accent);padding-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
        <span>${g.info.name}</span> <span style="font-size:0.9rem;color:#7f8c8d">æ‡‰ä»˜ï¼š${formatMoney(g.unpaid)} / å·²ä»˜ï¼š${formatMoney(g.paid)}</span></h3>
        <table><thead><tr><th width="40"><input type="checkbox" onchange="toggleGroupCheck(this, '${g.info.id}')"></th><th>å¤¥ä¼´</th><th>å›é¥‹</th><th>ç™¼æ”¾</th></tr></thead><tbody>
        ${g.records.map(r => `<tr><td><input type="checkbox" class="payout-check group-${g.info.id}" value="${r.id}" ${r.payoutStatus==='paid'?'disabled':''}></td>
        <td>${r.partnerName}</td><td style="font-weight:bold">${formatMoney(r.totalIncome)}</td>
        <td><button class="btn ${r.payoutStatus==='paid'?'btn-primary':'btn-outline'}" style="padding:4px 10px;font-size:0.8rem" onclick="togglePaid('${r.id}','${r.payoutStatus}','${month}')">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</button></td></tr>`).join('')}</tbody></table></div>`).join('')}`;
}
function toggleGroupCheck(m, id) { document.querySelectorAll(`.group-${id}`).forEach(c => { if(!c.disabled) c.checked = m.checked; }); }
function bulkMarkPaid(month) { const sel = Array.from(document.querySelectorAll('.payout-check:checked')).map(c => c.value); if(!sel.length || !confirm('ç¢ºèªæ¨™è¨˜ï¼Ÿ')) return; const date = getDefaultPayoutDate(month); sel.forEach(id => { const r = store.getRecord(id); if(r) { r.payoutStatus = 'paid'; r.payoutDate = date; } }); store.save(); }
function togglePaid(id, status, month) { const r = store.getRecord(id); if(status === 'unpaid') { r.payoutStatus = 'paid'; r.payoutDate = getDefaultPayoutDate(month); } else if(confirm('å–æ¶ˆç™¼æ”¾ï¼Ÿ')) { r.payoutStatus = 'unpaid'; } store.save(); }
function exportPayoutCSV(month) { const records = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob(['\uFEFFæœˆä»½,ç™¼èµ·äºº,å¤¥ä¼´,é‡‘é¡,å‚™è¨»,ç‹€æ…‹,æ—¥æœŸ\n'+records.map(r=>`${r.month},${store.getInitiator(r.initiatorId)?.name||''},${r.partnerName},${r.starTotal},${r.note||''},${r.payoutStatus},${r.payoutDate}`).join('\n')], { type: 'text/csv;charset=utf-8;' })); link.download = `Payout_${month}.csv`; link.click(); }

/* 6. Org Chart (Logic Updated: 3x5 Scope) */
function renderOrgChart() {
    const month = localStorage.getItem('org_month') || new Date().toISOString().slice(0, 7);
    const mode = localStorage.getItem('org_mode') || 'status';
    const activeScopeId = localStorage.getItem('active_scope_initiator');

    // 1. Build Hierarchy
    const partners = store.data.partners; 
    const records = store.getRecordsByMonth(month).map(calculateRecord);
    const partnerMap = {}; 
    
    partners.forEach(p => { 
        partnerMap[p.id] = { ...p, children: [], record: records.find(r => r && r.partnerId === p.id) }; 
    });

    const roots = []; 
    partners.forEach(p => { 
        if(p.sponsorId && partnerMap[p.sponsorId]) {
            // Check for self-circular logic
            if(p.sponsorId !== p.id) partnerMap[p.sponsorId].children.push(partnerMap[p.id]);
        } else { 
            roots.push(partnerMap[p.id]); 
        } 
    });

    // 2. Determine Scope Set (3-Wide, 5-Deep)
    let scopeSet = new Set();
    let scopeRoots = [];
    if(activeScopeId) {
        const scope = store.getCoachingScope(activeScopeId);
        scopeRoots = scope.roots || [];
        function markScope(pid, depth) {
            if(depth > 5) return; // 5-Deep Limit
            scopeSet.add(pid);
            const node = partnerMap[pid];
            if(node && node.children) {
                node.children.forEach(child => markScope(child.id, depth + 1));
            }
        }
        // Start from roots defined in settings
        scopeRoots.forEach(rid => { if(partnerMap[rid]) markScope(rid, 1); });
    }

    // 3. Recursive Render
    function renderNode(node, level = 1) {
        const r = node.record;
        
        // --- Class Logic ---
        let classes = ['node']; 
        
        // A. Independent System Logic: If this partner is ALSO an initiator in the system
        const isIndepInitiator = store.data.initiators.some(i => i.id === node.initiatorId && node.id !== node.initiatorId); // Basic logic check, refined below:
        // Better logic: Is this person defined in the 'initiators' list?
        // Note: The prompt says "If a1 participates... independent".
        // We check if this partner ID exists in the initiators array (meaning they have their own budget/team).
        const isSelfInitiator = store.data.initiators.some(i => i.code === node.code); 
        if(isSelfInitiator) classes.push('independent-sys');

        // B. Scope Logic
        if(activeScopeId) {
            if(scopeRoots.includes(node.id)) classes.push('scope-root');
            if(!scopeSet.has(node.id)) classes.push('out-of-scope');
        }

        // C. Status Logic
        let label = '', icon = '', subClass = '', tooltipHtml = '';
        if (node.status === 'inactive') {
            subClass = 'inactive'; icon = 'â¸'; label = 'åœç”¨';
        } else if (r) {
            if (r.isMonthlyInactive) { subClass = 'month-inactive'; label = 'æœ¬æœˆåœç”¨'; }
            else if (r.isGraduated) { subClass = 'graduate'; icon = 'ğŸ“'; label = 'ç•¢æ¥­'; }
            else if (r.payoutStatus === 'paid') { subClass = 'paid'; icon = 'âœ”'; label = 'å·²ç™¼æ”¾'; }
            else if (r.totalIncome > 0) { subClass = 'unpaid'; icon = 'â—'; label = 'æœªç™¼æ”¾'; }
            else { subClass = 'no-record'; label = 'ç„¡çé‡‘'; }
            if (mode === 'money' && !r.isMonthlyInactive) label = formatMoney(r.totalIncome);
            tooltipHtml = `<div class="tooltip"><strong>${r.month}</strong><br>é‡‘é¡ï¼š${formatMoney(r.totalIncome)}<br>ç‹€æ…‹ï¼š${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}<br>å‚™è¨»ï¼š${r.note||'-'}</div>`;
        } else {
            subClass = 'no-record'; label = 'æœ¬æœˆç„¡ç´€éŒ„';
        }
        classes.push(subClass);

        return `<li>
            <div class="${classes.join(' ')}" onclick="showNodeDetails('${node.id}','${month}')">
                <span class="level-badge">${level}ä»£</span>
                ${icon ? `<div class="icon">${icon}</div>` : ''}
                <div class="name">${node.name}</div>
                <div class="status">${label}</div>
                ${tooltipHtml}
            </div>
            ${node.children.length > 0 ? `<ul>${node.children.map(c => renderNode(c, level + 1)).join('')}</ul>` : ''}
        </li>`;
    }

    app.innerHTML = `<header>${getHeaderHtml('çµ„ç¹”é—œè¯åœ–')}</header>
    <div class="toolbar">
        <input type="month" value="${month}" style="max-width:150px" onchange="localStorage.setItem('org_month',this.value);renderOrgChart();">
        <select onchange="localStorage.setItem('org_mode',this.value);renderOrgChart()" style="max-width:150px">
            <option value="status" ${mode==='status'?'selected':''}>ğŸš¦ ç‹€æ…‹æ¨¡å¼</option>
            <option value="money" ${mode==='money'?'selected':''}>ğŸ§® é‡‘é¡æ¨¡å¼</option>
        </select>
        <select onchange="localStorage.setItem('active_scope_initiator',this.value);renderOrgChart();" style="max-width:200px">
            <option value="">é¡¯ç¤ºè¼”å°ç¯„åœ...</option>${store.data.initiators.map(i=>`<option value="${i.id}" ${i.id===activeScopeId?'selected':''}>${i.name}</option>`).join('')}
        </select>
        <button class="btn btn-secondary" onclick="openScopeSettings()">âš™ï¸ è¨­å®šç¯„åœ</button>
    </div>
    
    <div class="legend">
        <div class="legend-item"><div class="legend-box" style="border:3px solid #f1c40f"></div><span>ç¬¬ä¸€ä»£(3å¯¬)</span></div>
        <div class="legend-item"><div class="legend-box" style="opacity:0.5;filter:grayscale(1);border-style:dotted"></div><span>è¶…å‡ºç¯„åœ(5æ·±)</span></div>
        <div class="legend-item"><div class="legend-box" style="border-color:#8e44ad;background:#f4ecf7"></div><span>ç¨ç«‹ç™¼èµ·äºº</span></div>
        <div class="legend-item"><div class="legend-box" style="background:#fdedec;border-color:#e74c3c"></div><span>æœªç™¼æ”¾</span></div>
        <div class="legend-item"><div class="legend-box" style="background:#e8f8f5;border-color:#27ae60"></div><span>å·²ç™¼æ”¾</span></div>
    </div>

    <div class="org-container"><div class="tree"><ul>${roots.map(n => renderNode(n, 1)).join('')}</ul></div></div>`;
}

function openScopeSettings() {
    const initiators = store.data.initiators;
    openModal('è¨­å®šè¼”å°ç¯„åœ (3å¯¬5æ·±)', `<div class="form-group"><label>é¸æ“‡ç™¼èµ·äºº</label><select id="scope-init-select" class="form-control" onchange="renderScopeSelector(this.value)"><option value="">-- è«‹é¸æ“‡ --</option>${initiators.map(i=>`<option value="${i.id}">${i.name}</option>`).join('')}</select></div><div id="scope-selector-area" style="margin-top:15px;border-top:1px solid #eee;padding-top:15px;">è«‹å…ˆé¸æ“‡ç™¼èµ·äºº...</div>`);
}

function renderScopeSelector(initId) {
    if(!initId) { document.getElementById('scope-selector-area').innerHTML = ''; return; }
    const scope = store.getCoachingScope(initId);
    
    // Logic: List all PARTNERS who have this initiator set as their initiatorId
    // AND who are likely "Level 1" (no sponsor or sponsor is not in this group? Simpler: Just list all potential starts)
    // For simplicity in this UI, we allow selecting ANY partner to be a 'Root' for the scope visualization.
    const candidates = store.data.partners.filter(p => p.initiatorId === initId);
    
    document.getElementById('scope-selector-area').innerHTML = `
        <p><strong>è«‹å‹¾é¸ 3 ä½ç¬¬ä¸€ä»£è¼”å°å°è±¡ï¼š</strong><br><small style="color:#7f8c8d">ç³»çµ±å°‡è‡ªå‹•å¾€ä¸‹è¿½è¹¤ 5 ä»£æ·±åº¦ã€‚</small></p>
        <div style="max-height:300px;overflow-y:auto;border:1px solid #ddd;padding:10px;background:#fff;border-radius:6px;">
            ${candidates.length === 0 ? '<div style="padding:10px;color:#999">æ­¤ç™¼èµ·äººå°šç„¡ç¶å®šå¤¥ä¼´</div>' : ''}
            ${candidates.map(p => `
                <div style="margin-bottom:8px;">
                    <label style="display:flex;align-items:center;cursor:pointer">
                        <input type="checkbox" class="scope-root-check" value="${p.id}" 
                        ${scope.roots.includes(p.id)?'checked':''} 
                        onchange="checkScopeLimit(this)"> 
                        <span style="margin-left:8px;font-weight:500">${p.code} ${p.name}</span>
                        ${p.sponsorId ? `<small style="color:#aaa;margin-left:5px">(ä¸Šç·š: ${store.getPartner(p.sponsorId)?.name})</small>` : ''}
                    </label>
                </div>
            `).join('')}
        </div>
        <button class="btn btn-primary" style="margin-top:15px;width:100%" onclick="saveScope('${initId}')">å„²å­˜è¨­å®š</button>
    `;
}

function checkScopeLimit(cb) {
    const checked = document.querySelectorAll('.scope-root-check:checked');
    if(checked.length > 3) {
        alert('âŒ è¶…å‡ºé™åˆ¶ï¼\næ ¹æ“šè¦å‰‡ï¼Œè¼”å°ç¯„åœæœ€å¤šåªèƒ½è¨­å®š 3 ä½å¯¬åº¦ (ç¬¬ä¸€ä»£)ã€‚\n\nè‹¥æœ‰ç¬¬ 4 ä½ï¼Œè«‹å°‡å…¶è¨­ç‚ºç¨ç«‹ç™¼èµ·é«”ç³»ã€‚');
        cb.checked = false;
    }
}

function saveScope(id) {
    const checked = Array.from(document.querySelectorAll('.scope-root-check:checked')).map(c => c.value);
    let idx = store.data.coachingScopes.findIndex(c => c.initiatorId === id);
    if(idx === -1) store.data.coachingScopes.push({ initiatorId: id, roots: checked, depth: 5 }); 
    else store.data.coachingScopes[idx].roots = checked;
    store.save(); closeModal(); renderOrgChart();
}

function showNodeDetails(pid, month) {
    const r = store.data.records.find(r => r.partnerId === pid && r.month === month);
    const p = store.getPartner(pid);
    if(!r) return confirm('ç„¡ç´€éŒ„ï¼Œå»ºç«‹ï¼Ÿ') ? (closeModal(), router('records'), setTimeout(() => { editRecord(null, month); tempRecord.partnerId = pid; document.getElementsByName('partnerId')[0].value = pid; }, 100)) : null;
    const calc = calculateRecord(r);
    openModal(`${p.name} - ${month}`, `<table class="table">
    <tr><th>å°çµ„PV</th><td>${calc.gpv}</td></tr><tr><th>æ–°æ˜Ÿå›é¥‹</th><td>${formatMoney(calc.starTotal)}</td></tr>
    <tr><th>ç‹€æ…‹</th><td>${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</td></tr>
    ${r.note ? `<tr><th>å‚™è¨»</th><td>${r.note}</td></tr>` : ''}
    </table><div style="margin-top:15px;text-align:right"><button class="btn btn-primary" onclick="closeModal(); router('records'); setTimeout(()=>editRecord('${r.id}', '${month}'), 100)">ç·¨è¼¯</button></div>`);
}

/* 7. Initiators & Versions & Settings */
function renderInitiators() {
    app.innerHTML = `<header>${getHeaderHtml('ç™¼èµ·äººç®¡ç†')} <button class="btn btn-primary" onclick="editInitiator()">+ æ–°å¢</button></header>
    <div class="card"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>æ“ä½œ</th></tr></thead><tbody>${store.data.initiators.map(i => `<tr><td>${i.code}</td><td>${i.name}</td><td><button class="btn btn-secondary" onclick="editInitiator('${i.id}')">ç·¨è¼¯</button> <button class="btn btn-danger" onclick="deleteInitiator('${i.id}')">åˆªé™¤</button></td></tr>`).join('')}</tbody></table></div>`;
}
function editInitiator(id) { const i = id?store.getInitiator(id):{id:'',code:'',name:'',note:''}; openModal(id?'ç·¨è¼¯':'æ–°å¢', `<form onsubmit="saveInitiator(event,'${id||''}')"><div class="row"><div class="col form-group"><label>ç·¨è™Ÿ</label><input class="form-control" name="code" value="${i.code}" required></div><div class="col form-group"><label>å§“å</label><input class="form-control" name="name" value="${i.name}" required></div></div><div class="form-group"><label>å‚™è¨»</label><input class="form-control" name="note" value="${i.note}"></div><button type="submit" class="btn btn-primary" style="width:100%">å„²å­˜</button></form>`); }
function saveInitiator(e,id){e.preventDefault();const d=Object.fromEntries(new FormData(e.target));if(store.data.initiators.some(i=>i.code===d.code&&i.id!==id))return alert('é‡è¤‡');if(id){const x=store.data.initiators.findIndex(k=>k.id===id);store.data.initiators[x]={...store.data.initiators[x],...d}}else{store.data.initiators.push({...d,id:generateUUID()})}store.save();closeModal();}
function deleteInitiator(id){if(confirm('åˆªé™¤ï¼Ÿé€™å°‡ç§»é™¤è©²ç™¼èµ·äººçš„è¼”å°è¨­å®šï¼Œä¸¦å°‡æ——ä¸‹å¤¥ä¼´è¨­ç‚ºæœªæŒ‡å®šã€‚')){store.data.partners.forEach(p=>{if(p.initiatorId===id)p.initiatorId=''});store.data.initiators=store.data.initiators.filter(i=>i.id!==id);store.data.coachingScopes=store.data.coachingScopes.filter(c=>c.initiatorId!==id);store.save();renderInitiators();}}

function renderVersions() { app.innerHTML = `<header>${getHeaderHtml('ç‰ˆæœ¬æ§ç®¡')} <button class="btn btn-primary" onclick="editVersion()">+ æ–°å¢</button></header><div class="card"><table><thead><tr><th>åç¨±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>${store.data.versions.map(v => `<tr><td>${v.name}</td><td>${v.archived?'å°å­˜':'ä½¿ç”¨ä¸­'}</td><td><button class="btn btn-secondary" onclick="editVersion('${v.id}')">æŸ¥çœ‹</button> ${!v.archived?`<button class="btn btn-danger" onclick="deleteVersion('${v.id}')">åˆªé™¤</button>`:''}</td></tr>`).join('')}</tbody></table></div>`; }
function editVersion(id) { const v = id?store.getVersion(id):{id:'',name:'New',createdAt:'',params:{...defaultPlanParams}}; const p=v.params; openModal(id?'ç‰ˆæœ¬':'æ–°å¢', `<form onsubmit="saveVersion(event,'${id||''}')"><div class="form-group"><label>åç¨±</label><input class="form-control" name="name" value="${v.name}" required ${v.archived?'disabled':''}></div><fieldset><legend>åƒæ•¸</legend><div class="row"><div class="col"><label>0-3% åŸºç¤</label><input type="number" step="0.01" name="rate_0_3_base" value="${p.rate_0_3_base}" class="form-control" ${v.archived?'disabled':''}></div><div class="col"><label>0-3% æ¨è–¦</label><input type="number" step="0.01" name="rate_0_3_rec" value="${p.rate_0_3_rec}" class="form-control" ${v.archived?'disabled':''}></div></div><div class="row"><div class="col"><label>6% åŸºç¤</label><input type="number" step="0.01" name="rate_6_base" value="${p.rate_6_base}" class="form-control" ${v.archived?'disabled':''}></div><div class="col"><label>6% æ¨è–¦</label><input type="number" step="0.01" name="rate_6_rec" value="${p.rate_6_rec}" class="form-control" ${v.archived?'disabled':''}></div></div><div class="row"><div class="col"><label>æ–°äººå›é¥‹</label><input type="number" step="0.01" name="rate_recruit_bv" value="${p.rate_recruit_bv}" class="form-control" ${v.archived?'disabled':''}></div><div class="col"><label>å­¸ç¿’åŠ ç¢¼</label><input type="number" step="0.01" name="rate_learning" value="${p.rate_learning}" class="form-control" ${v.archived?'disabled':''}></div></div></fieldset>${!v.archived?'<button type="submit" class="btn btn-primary" style="width:100%">å„²å­˜</button>':''}</form>`); }
function saveVersion(e,id){e.preventDefault();const fd=new FormData(e.target);const params={rate_0_3_base:Number(fd.get('rate_0_3_base')),rate_0_3_rec:Number(fd.get('rate_0_3_rec')),rate_6_base:0.01,rate_6_rec:0.02,rate_recruit_bv:Number(fd.get('rate_recruit_bv')),rate_learning:Number(fd.get('rate_learning'))}; if(id){const x=store.data.versions.findIndex(v=>v.id===id);store.data.versions[x]={...store.data.versions[x],name:fd.get('name'),params}}else{store.data.versions.unshift({id:generateUUID(),name:fd.get('name'),createdAt:new Date().toISOString(),params})} store.save();closeModal();renderVersions();}
function deleteVersion(id){if(!confirm('åˆªé™¤ï¼Ÿ'))return;const used=store.data.records.some(r=>r.planVersionId===id);if(used){if(confirm('å·²è¢«ä½¿ç”¨ï¼Œæ”¹ç‚ºå°å­˜ï¼Ÿ')){store.getVersion(id).archived=true;store.save();renderVersions()}}else{store.data.versions=store.data.versions.filter(v=>v.id!==id);store.save();renderVersions()}}

function renderSettings() { app.innerHTML = `<header>${getHeaderHtml('ç³»çµ±è¨­å®š')}</header><div class="card"><h3>ğŸ“¦ å‚™ä»½</h3><button class="btn btn-primary" onclick="exportData()">â¬‡ï¸ ä¸‹è¼‰å‚™ä»½</button> <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">â¬†ï¸ åŒ¯å…¥é‚„åŸ</button><input type="file" id="importFile" style="display:none" onchange="importData(this)"></div><div class="card"><h3>âš ï¸ å±éšª</h3><button class="btn btn-danger" onclick="if(prompt('è¼¸å…¥ DELETE ç¢ºèª')==='DELETE'){db.ref('AmwaySystem/v1').remove();location.reload();}">ğŸ”¥ æ¸…é™¤è³‡æ–™</button></div>`; }
function exportData() { const l=document.createElement("a");l.href=URL.createObjectURL(new Blob([JSON.stringify(store.data,null,2)],{type:'application/json'}));l.download=`NewStarBackup_${new Date().toISOString().slice(0,10)}.json`;l.click();}
function importData(input) { const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(d.partners&&confirm('è¦†è“‹è³‡æ–™ï¼Ÿ')){store.data=d;store.save();location.reload()}}catch(x){alert('æ ¼å¼éŒ¯èª¤')}};r.readAsText(f);}
function renderFAQ() {
    app.innerHTML = `<header>${getHeaderHtml('ç³»çµ±èªªæ˜ (FAQ)')}</header>
    <div class="faq-item"><div class="faq-question" onclick="toggleFAQ(this)">ã€ä¸€ã€‘è¼”å°ç¯„åœè¦å‰‡ (3å¯¬5æ·±)</div><div class="faq-answer">æœ¬ç³»çµ±åœ¨çµ„ç¹”é—œè¯åœ–ä¸­ï¼Œæœƒæ ¹æ“šæ‚¨åœ¨ã€Œâš™ï¸ è¨­å®šç¯„åœã€ä¸­å‹¾é¸çš„ç¬¬ 1 ä»£åå–®ï¼ˆæœ€å¤š 3 ä½ï¼‰ï¼Œè‡ªå‹•å¾€ä¸‹è¿½è¹¤ 5 ä»£ã€‚<br>è¶…éç¬¬ 5 ä»£çš„ç¯€é»å°‡ä»¥ç°è‰²é¡¯ç¤ºï¼Œä»£è¡¨è¶…å‡ºè¼”å°ç¯„åœã€‚</div></div>
    <div class="faq-item"><div class="faq-question" onclick="toggleFAQ(this)">ã€äºŒã€‘ç¨ç«‹ç™¼èµ·äºº</div><div class="faq-answer">è‹¥æŸä½å¤¥ä¼´æœ¬èº«ä¹Ÿæ˜¯ç³»çµ±ä¸­çš„ã€Œç™¼èµ·äººã€ï¼Œå…¶ç¯€é»æœƒæ¨™ç¤ºã€Œâ­ ç¨ç«‹ç™¼èµ·äººã€ã€‚å…¶åœ˜éšŠçé‡‘æ‡‰ç”±å…¶è‡ªè¡Œç™¼æ”¾ï¼Œä¸åˆ—å…¥ä¸Šç·šçš„è¼”å°ç¯„åœè¨ˆç®—ã€‚</div></div>`;
}
function toggleFAQ(el) { el.parentElement.classList.toggle('active'); }

/* Modal & CloseSafe */
function openModal(title, content) { document.getElementById('modal-title').innerText = title; document.getElementById('modal-body').innerHTML = content; document.getElementById('modal').style.display = 'block'; }
function closeModalSafe() { if(isModalDirty && !confirm('æœ‰æœªå„²å­˜è®Šæ›´ï¼Œç¢ºå®šé›¢é–‹ï¼Ÿ')) return; isModalDirty = false; document.getElementById('modal').style.display = 'none'; }
function closeModal() { document.getElementById('modal').style.display = 'none'; }
window.onclick = null; 
</script>
</body>
</html>
