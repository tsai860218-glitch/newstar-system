<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ± (é›²ç«¯åŒæ­¥ç‰ˆ v2.5)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #1abc9c;
            --accent-hover: #16a085;
            --danger: #e74c3c;
            --danger-hover: #c0392b;
            --warning: #f1c40f;
            --success: #27ae60;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --border: #bdc3c7;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background-color: #f4f7f6; color: #333; overflow: hidden; }

        /* Sidebar */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: all 0.3s ease; overflow: hidden; white-space: nowrap; z-index: 100; }
        aside.collapsed { width: 0; padding: 0; opacity: 0; }
        aside h2 { padding: 20px; margin: 0; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; height: 64px;}
        aside nav { flex: 1; overflow-y: auto; padding-top: 10px; }
        aside nav a { display: block; padding: 15px 20px; color: #bdc3c7; text-decoration: none; transition: 0.2s; border-left: 4px solid transparent; cursor: pointer; }
        aside nav a:hover, aside nav a.active { background: var(--secondary); color: white; border-left-color: var(--accent); }
        aside .footer { padding: 15px; font-size: 0.8rem; color: #7f8c8d; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 20px; position: relative; transition: margin 0.3s; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .menu-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; margin-right: 15px; color: var(--dark); line-height: 1; vertical-align: middle; padding: 0; width: 30px; text-align: center; }
        .menu-btn:hover { color: var(--accent); }
        h1 { margin: 0; color: var(--dark); font-size: 1.8rem; display: flex; align-items: center; }
        
        /* UI Components */
        .card { background: white; border-radius: 8px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: var(--danger-hover); }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        
        .form-group { margin-bottom: 15px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 1rem; }
        .row { display: flex; gap: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }

        /* Status Badges */
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .status-active { background: #e8f8f5; color: var(--success); }
        .status-inactive { background: #fdedec; color: var(--danger); }
        .status-paid { background: #d4efdf; color: var(--success); }
        .status-unpaid { background: #fce4ec; color: #c0392b; }
        .status-archived { background: #eee; color: #7f8c8d; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--secondary); position: sticky; top: 0; }

        /* Modal & Layout */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5vh auto; padding: 20px; border: 1px solid #888; width: 95%; max-width: 1100px; border-radius: 8px; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        /* ğŸ”¥ Record Edit Modal - 2 Column Layout */
        .record-modal-grid { display: flex; gap: 20px; align-items: flex-start; }
        .record-form-col { flex: 1.6; min-width: 320px; }
        .record-preview-col { flex: 1; min-width: 280px; position: sticky; top: 0; }
        
        fieldset { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 6px; background: #fff; }
        legend { font-weight: bold; color: var(--primary); padding: 0 10px; }

        /* ğŸ”¥ Preview Card */
        .preview-card { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 20px; border-top: 4px solid var(--accent); }
        .preview-header { font-size: 1.1rem; font-weight: bold; color: var(--dark); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .preview-amount-big { font-size: 2rem; font-weight: bold; color: var(--success); text-align: right; margin: 10px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .preview-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; color: #555; }
        .preview-row.total { font-weight: bold; color: #000; border-top: 1px solid #eee; pt: 10px; margin-top: 5px; }
        .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; background: #eee; }
        
        /* Mobile Layout for Modal */
        @media (max-width: 768px) {
            .record-modal-grid { flex-direction: column-reverse; } /* Form bottom, Preview top */
            .record-preview-col { position: static; width: 100%; margin-bottom: 15px; }
            .preview-amount-big { font-size: 1.8rem; }
        }

        /* Loading & Sync */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; transition: opacity 0.5s; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--accent); animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #sync-status { position: fixed; bottom: 20px; right: 20px; padding: 8px 15px; background: rgba(0,0,0,0.7); color: white; border-radius: 20px; font-size: 0.8rem; pointer-events: none; display: flex; align-items: center; gap: 8px; z-index: 999; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .dot.connected { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        @media print { aside, .no-print, #sync-status { display: none; } main { padding: 0; } }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="spinner"></div>
    <div>æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</div>
    <div style="font-size:0.8rem; color:#888; margin-top:5px;">è«‹ç¨å€™</div>
</div>

<div id="sync-status"><div class="dot" id="sync-dot"></div> <span id="sync-text">é›¢ç·š</span></div>

<aside id="sidebar">
    <h2>ğŸš€ æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ±</h2>
    <nav>
        <a onclick="router('dashboard')" id="nav-dashboard" class="active">ğŸ“Š ç¸½è¦½å„€è¡¨æ¿</a>
        <a onclick="router('payout')" id="nav-payout">ğŸ’° æœ¬æœˆç™¼æ”¾ç¸½è¡¨</a>
        <a onclick="router('partners')" id="nav-partners">ğŸ‘¥ å¤¥ä¼´åå–®ç®¡ç†</a>
        <a onclick="router('initiators')" id="nav-initiators">ğŸ‘” ç™¼èµ·äººç®¡ç†</a>
        <a onclick="router('records')" id="nav-records">ğŸ“ æœˆä»½æ¥­ç¸¾ç´€éŒ„</a>
        <a onclick="router('org')" id="nav-org">ğŸŒ³ çµ„ç¹”é—œè¯åœ–</a>
        <a onclick="router('versions')" id="nav-versions">âš™ï¸ è¨ˆç•«ç‰ˆæœ¬æ§ç®¡</a>
        <a onclick="router('settings')" id="nav-settings">ğŸ› ï¸ ç³»çµ±è¨­å®š</a>
    </nav>
    <div class="footer">æ–°æ˜Ÿç³»çµ± v2.5 (å®‰éº—å°ˆç”¨)</div>
</aside>

<main id="app">
    </main>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modal-body"></div>
    </div>
</div>

<script>
/**
 * ğŸ”¥ FIREBASE è¨­å®šå€
 */
const firebaseConfig = {
    apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
    authDomain: "newstar-system.firebaseapp.com",
    projectId: "newstar-system",
    storageBucket: "newstar-system.firebasestorage.app",
    messagingSenderId: "889699172174",
    appId: "1:889699172174:web:0ff42757035a879cb3281f",
    databaseURL: "https://newstar-system-default-rtdb.asia-southeast1.firebasedatabase.app" 
};

let isFirebaseReady = false;
let db = null;

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    isFirebaseReady = true;
} catch (e) {
    console.error(e);
    alert("Firebase é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚");
    document.getElementById('loading-screen').innerHTML = '<h3 style="color:red">âš ï¸ é€£ç·šéŒ¯èª¤</h3>';
}

/**
 * è³‡æ–™é‚è¼¯
 */
const defaultPlanParams = {
    rate_0_3_base: 0.03, rate_0_3_rec: 0.04, rate_6_base: 0.01, rate_6_rec: 0.02, rate_recruit_bv: 0.01, rate_learning: 0.03
};

let appData = {
    partners: [], initiators: [], records: [], versions: [], coachingScopes: []
};

const store = {
    data: appData, 
    init() {
        if (!isFirebaseReady) return;
        const syncDot = document.getElementById('sync-dot');
        const syncText = document.getElementById('sync-text');
        const connectedRef = db.ref(".info/connected");
        connectedRef.on("value", (snap) => {
            if (snap.val() === true) { syncDot.classList.add('connected'); syncText.innerText = "å·²é€£ç·š"; } 
            else { syncDot.classList.remove('connected'); syncText.innerText = "é›¢ç·š"; }
        });
        const dataRef = db.ref('AmwaySystem/v1');
        dataRef.on('value', (snapshot) => {
            const val = snapshot.val();
            if (val) {
                this.data = val;
                if(!this.data.partners) this.data.partners = [];
                if(!this.data.initiators) this.data.initiators = [];
                if(!this.data.records) this.data.records = [];
                if(!this.data.versions) this.data.versions = [];
                if(!this.data.coachingScopes) this.data.coachingScopes = [];
            } else {
                this.data.versions.push({
                    id: generateUUID(), name: 'é è¨­ç‰ˆæœ¬ (Default)', createdAt: new Date().toISOString(), params: { ...defaultPlanParams }
                });
                this.save();
            }
            document.getElementById('loading-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);
            const activeNav = document.querySelector('aside nav a.active');
            const currentPage = activeNav ? activeNav.id.replace('nav-', '') : 'dashboard';
            router(currentPage);
        });
    },
    save() {
        if (!isFirebaseReady) return;
        db.ref('AmwaySystem/v1').set(this.data).catch(err => alert("å„²å­˜å¤±æ•—: " + err.message));
    },
    getPartner(id) { return this.data.partners.find(p => p.id === id); },
    getInitiator(id) { return this.data.initiators.find(i => i.id === id); },
    getRecord(id) { return this.data.records.find(r => r.id === id); },
    getRecordsByMonth(month) { return this.data.records.filter(r => r.month === month); },
    getVersion(id) { return this.data.versions.find(v => v.id === id) || this.data.versions[0]; },
    getCoachingScope(initiatorId) { return this.data.coachingScopes.find(c => c.initiatorId === initiatorId) || { initiatorId, roots: [], depth: 5 }; }
};

store.init();

/* Utils */
function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
function formatMoney(num) { return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num); }
function getBonusPercent(pv) {
    if (pv >= 10000) return 0.21; if (pv >= 7000) return 0.18; if (pv >= 4000) return 0.15;
    if (pv >= 2000) return 0.12; if (pv >= 1000) return 0.09; if (pv >= 600) return 0.06;
    if (pv >= 200) return 0.03; return 0;
}
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
function getHeaderHtml(title) { return `<h1><button class="menu-btn" onclick="toggleSidebar()">â˜°</button> ${title}</h1>`; }

/* Calculate Logic */
function calculateRecord(record) {
    const partner = store.getPartner(record.partnerId);
    if (!partner) return null; 
    const version = store.getVersion(record.planVersionId);
    const params = version.params;
    const myRate = getBonusPercent(record.gpv);
    
    // å…¬å¸çé‡‘æ­¸é›¶
    const personalBonus = 0, diffBonusTotal = 0, companyTotal = 0;
    const legDetails = (record.legs || []).map(leg => { return { ...leg, bonus: 0 }; });

    let starTotal = 0, baseBonus = 0, recruitBonus = 0, learningBonus = 0;
    let isGraduated = record.gpv >= 1000;
    let isEligible = !isGraduated && record.participation !== 'inactive';

    if (isEligible) {
        let hasRecruit = (record.newRecruits || []).length > 0;
        let appliedRate = 0;
        if (myRate <= 0.03) appliedRate = hasRecruit ? params.rate_0_3_rec : params.rate_0_3_base;
        else if (myRate === 0.06) appliedRate = hasRecruit ? params.rate_6_rec : params.rate_6_base;
        
        const independentLegsBV = legDetails.filter(l => l.isIndependent).reduce((sum, l) => sum + (Number(l.bv) || 0), 0);
        const totalGroupBV = record.gpv * 50; 
        const calcBaseBV = Math.max(0, totalGroupBV - independentLegsBV);
        baseBonus = calcBaseBV * appliedRate;

        const newRecruitTotalBV = (record.newRecruits || []).reduce((sum, r) => sum + (Number(r.bv)||0), 0);
        recruitBonus = newRecruitTotalBV * params.rate_recruit_bv;

        if (record.learningDone) learningBonus = (baseBonus + recruitBonus) * params.rate_learning;
        starTotal = baseBonus + recruitBonus + learningBonus;
    }
    const totalIncome = starTotal;
    return { ...record, partnerName: partner.name + ' ' + partner.code, initiatorId: partner.initiatorId, myRate, personalBonus, legDetails, diffBonusTotal, companyTotal, isGraduated, isEligible, baseBonus, recruitBonus, learningBonus, starTotal, totalIncome };
}

/* Calculate Preview Logic (Independent) */
function calculatePreview(r) {
    const v = store.getVersion(r.planVersionId);
    if (!v) return null;
    const params = v.params;
    const myRate = getBonusPercent(r.gpv);
    const isGraduated = r.gpv >= 1000;
    const isInactive = r.participation === 'inactive';
    const isEligible = !isGraduated && !isInactive;

    let appliedRateText = '0%', baseBonus = 0, recruitBonus = 0, learningBonus = 0, starTotal = 0;
    let msg = '', msgColor = 'black';

    if (isInactive) { msg = 'âš ï¸ åœç”¨ï¼šæœ¬æœˆä¸è¨ˆ'; msgColor = '#e74c3c'; } 
    else if (isGraduated) { msg = 'ğŸ“ ç•¢æ¥­ (GPVâ‰¥1000)'; msgColor = '#27ae60'; } 
    else if (myRate > 0.06) { msg = 'ğŸš« éé©ç”¨æª”ä½ (9%ä»¥ä¸Š)'; msgColor = '#f39c12'; }

    if (isEligible) {
        const hasRecruit = (r.newRecruits || []).length > 0;
        let appliedRate = 0;
        if (myRate <= 0.03) {
            appliedRate = hasRecruit ? params.rate_0_3_rec : params.rate_0_3_base;
            appliedRateText = hasRecruit ? `å«æ¨è–¦ (${(params.rate_0_3_rec*100).toFixed(1)}%)` : `åŸºç¤ (${(params.rate_0_3_base*100).toFixed(1)}%)`;
        } else if (myRate === 0.06) {
            appliedRate = hasRecruit ? params.rate_6_rec : params.rate_6_base;
            appliedRateText = hasRecruit ? `å«æ¨è–¦ (${(params.rate_6_rec*100).toFixed(1)}%)` : `åŸºç¤ (${(params.rate_6_base*100).toFixed(1)}%)`;
        }
        const independentLegsBV = (r.legs || []).filter(l => l.isIndependent).reduce((sum, l) => sum + (Number(l.bv) || 0), 0);
        const totalGroupBV = r.gpv * 50;
        const calcBaseBV = Math.max(0, totalGroupBV - independentLegsBV);
        baseBonus = calcBaseBV * appliedRate;
        
        const newRecruitTotalBV = (r.newRecruits || []).reduce((sum, nr) => sum + (Number(nr.bv) || 0), 0);
        recruitBonus = newRecruitTotalBV * params.rate_recruit_bv;
        
        if (r.learningDone) learningBonus = (baseBonus + recruitBonus) * params.rate_learning;
        starTotal = baseBonus + recruitBonus + learningBonus;
    }
    return { myRate, isEligible, appliedRateText, baseBonus, recruitBonus, learningBonus, starTotal, msg, msgColor };
}

/* Routing */
function router(page) {
    document.querySelectorAll('aside nav a').forEach(a => a.classList.remove('active'));
    if(document.getElementById('nav-' + page)) document.getElementById('nav-' + page).classList.add('active');
    app.innerHTML = '';
    switch(page) {
        case 'dashboard': renderDashboard(); break;
        case 'payout': renderPayout(); break;
        case 'partners': renderPartners(); break;
        case 'initiators': renderInitiators(); break;
        case 'records': renderRecords(); break;
        case 'org': renderOrgChart(); break;
        case 'versions': renderVersions(); break;
        case 'settings': renderSettings(); break;
        default: renderDashboard();
    }
}

/* 1. Dashboard */
function renderDashboard() {
    const currentMonth = new Date().toISOString().slice(0, 7);
    const records = store.getRecordsByMonth(currentMonth).map(calculateRecord).filter(x=>x); 
    const totalStar = records.reduce((s, r) => s + r.starTotal, 0);
    const unpaidCount = records.filter(r => r.payoutStatus !== 'paid' && r.totalIncome > 0).length;
    app.innerHTML = `<header>${getHeaderHtml(`ç¸½è¦½å„€è¡¨æ¿ (${currentMonth})`)}</header>
        <div class="row">
            <div class="summary-box col" style="background:#27ae60"><div class="summary-item"><div>æ–°æ˜Ÿåœ˜éšŠå›é¥‹</div><div>${formatMoney(totalStar)}</div></div></div>
            <div class="summary-box col" style="background:#c0392b"><div class="summary-item"><div>å¾…ç™¼æ”¾äººæ•¸</div><div>${unpaidCount} äºº</div></div></div>
        </div>
        <div class="card"><h3>â˜ï¸ æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ±</h3><p>å·²é€£æ¥é›²ç«¯ã€‚è‹¥æœ‰ä»»ä½•å•é¡Œè«‹ç¢ºèªç¶²è·¯ç‹€æ…‹ã€‚</p></div>`;
}

/* 2. Partners */
function renderPartners() {
    app.innerHTML = `<header>${getHeaderHtml('å¤¥ä¼´åå–®ç®¡ç†')} <button class="btn btn-primary" onclick="editPartner()">+ æ–°å¢å¤¥ä¼´</button></header>
        <div class="card"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>æ¨è–¦äºº</th><th>ç™¼èµ·äºº</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>
        ${store.data.partners.map(p => {
            const sponsor = store.getPartner(p.sponsorId); const init = store.getInitiator(p.initiatorId);
            return `<tr><td>${p.code}</td><td>${p.name}</td><td>${sponsor?sponsor.code+' '+sponsor.name:'-'}</td><td>${init?init.code+' '+init.name:'<span style="color:red">æœªè¨­å®š</span>'}</td>
            <td><span class="status-badge ${p.status==='inactive'?'status-inactive':'status-active'}">${p.status==='inactive'?'åœç”¨':'å•Ÿç”¨'}</span></td>
            <td><button class="btn btn-secondary" onclick="editPartner('${p.id}')">ç·¨è¼¯</button> <button class="btn btn-danger" onclick="deletePartner('${p.id}')">åˆªé™¤</button></td></tr>`;
        }).join('')}</tbody></table></div>`;
}
function editPartner(id) {
    const p = id ? store.getPartner(id) : { id:'', code:'', name:'', sponsorId:'', initiatorId:'', status:'active' };
    const partners = store.data.partners.filter(x => x.id !== p.id); const initiators = store.data.initiators;
    openModal(`<h2>${id?'ç·¨è¼¯':'æ–°å¢'}å¤¥ä¼´</h2><form onsubmit="savePartner(event, '${id||''}')">
        <div class="row"><div class="col form-group"><label>ç·¨è™Ÿ *</label><input class="form-control" name="code" value="${p.code}" required></div><div class="col form-group"><label>å§“å *</label><input class="form-control" name="name" value="${p.name}" required></div></div>
        <div class="form-group"><label>æ¨è–¦äºº</label><select class="form-control" name="sponsorId"><option value="">-- ç„¡ --</option>${partners.map(o=>`<option value="${o.id}" ${o.id===p.sponsorId?'selected':''}>${o.code} ${o.name}</option>`).join('')}</select></div>
        <div class="form-group"><label>ç™¼èµ·äºº *</label><select class="form-control" name="initiatorId" required><option value="">-- è«‹é¸æ“‡ --</option>${initiators.map(o=>`<option value="${o.id}" ${o.id===p.initiatorId?'selected':''}>${o.code} ${o.name}</option>`).join('')}</select></div>
        <div class="form-group"><label>ç‹€æ…‹</label><select class="form-control" name="status"><option value="active" ${p.status==='active'?'selected':''}>å•Ÿç”¨</option><option value="inactive" ${p.status==='inactive'?'selected':''}>åœç”¨</option></select></div>
        <button type="submit" class="btn btn-primary">å„²å­˜</button></form>`);
}
function savePartner(e, id) {
    e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries());
    if(store.data.partners.some(p => p.code === data.code && p.id !== id)) return alert('ç·¨è™Ÿé‡è¤‡');
    if(id) { const idx = store.data.partners.findIndex(p => p.id === id); store.data.partners[idx] = { ...store.data.partners[idx], ...data }; }
    else { store.data.partners.push({ ...data, id: generateUUID() }); }
    store.save(); closeModal();
}
function deletePartner(id) {
    const p = store.getPartner(id); if(!p || !confirm(`ç¢ºå®šåˆªé™¤ ${p.name}ï¼Ÿ\né€™å°‡åˆªé™¤å…¶æ‰€æœ‰ç´€éŒ„ä¸¦å½±éŸ¿ä¸‹ç·šçµæ§‹ã€‚`)) return;
    store.data.records = store.data.records.filter(r => r.partnerId !== id);
    store.data.partners.forEach(sub => { if(sub.sponsorId === id) sub.sponsorId = ""; if(sub.initiatorId === id) sub.initiatorId = ""; });
    store.data.coachingScopes.forEach(s => { if(s.roots) s.roots = s.roots.filter(rid => rid !== id); });
    store.data.partners = store.data.partners.filter(x => x.id !== id);
    store.save(); renderPartners();
}

/* 3. Initiators */
function renderInitiators() {
    app.innerHTML = `<header>${getHeaderHtml('ç™¼èµ·äººç®¡ç†')} <button class="btn btn-primary" onclick="editInitiator()">+ æ–°å¢</button></header>
        <div class="card"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead><tbody>
        ${store.data.initiators.map(i => `<tr><td>${i.code}</td><td>${i.name}</td><td>${i.note||''}</td><td><button class="btn btn-secondary" onclick="editInitiator('${i.id}')">ç·¨è¼¯</button> <button class="btn btn-danger" onclick="deleteInitiator('${i.id}')">åˆªé™¤</button></td></tr>`).join('')}
        </tbody></table></div>`;
}
function editInitiator(id) {
    const i = id ? store.getInitiator(id) : { id:'', code:'', name:'', note:'' };
    openModal(`<h2>${id?'ç·¨è¼¯':'æ–°å¢'}ç™¼èµ·äºº</h2><form onsubmit="saveInitiator(event, '${id||''}')"><div class="row"><div class="col form-group"><label>ç·¨è™Ÿ</label><input class="form-control" name="code" value="${i.code}" required></div><div class="col form-group"><label>å§“å</label><input class="form-control" name="name" value="${i.name}" required></div></div><div class="form-group"><label>å‚™è¨»</label><input class="form-control" name="note" value="${i.note}"></div><button type="submit" class="btn btn-primary">å„²å­˜</button></form>`);
}
function saveInitiator(e, id) {
    e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries());
    if(store.data.initiators.some(i => i.code === data.code && i.id !== id)) return alert('ç·¨è™Ÿé‡è¤‡');
    if(id) { const idx = store.data.initiators.findIndex(i => i.id === id); store.data.initiators[idx] = { ...store.data.initiators[idx], ...data }; }
    else { store.data.initiators.push({ ...data, id: generateUUID() }); }
    store.save(); closeModal();
}
function deleteInitiator(id) {
    if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿæ——ä¸‹å¤¥ä¼´å°‡è®Šç‚ºæœªè¨­å®šã€‚')) return;
    store.data.partners.forEach(p => { if(p.initiatorId === id) p.initiatorId = ""; });
    store.data.coachingScopes = store.data.coachingScopes.filter(s => s.initiatorId !== id);
    store.data.initiators = store.data.initiators.filter(i => i.id !== id);
    store.save(); renderInitiators();
}

/* 4. Records */
function renderRecords() {
    const month = localStorage.getItem('last_view_month') || new Date().toISOString().slice(0, 7);
    const list = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x);
    app.innerHTML = `<header>${getHeaderHtml('æœˆä»½æ¥­ç¸¾ç´€éŒ„')} <div style="display:flex;gap:10px;"><input type="month" value="${month}" class="form-control" onchange="localStorage.setItem('last_view_month',this.value);renderRecords();"><button class="btn btn-primary" onclick="editRecord(null,'${month}')">+ ç´€éŒ„</button></div></header>
    <div class="card"><table><thead><tr><th>å¤¥ä¼´</th><th>å°çµ„PV</th><th>æ–°æ˜Ÿå›é¥‹</th><th>åˆè¨ˆ</th><th>ç™¼æ”¾</th><th>æ“ä½œ</th></tr></thead><tbody>
    ${list.length===0 ? '<tr><td colspan="6" class="text-center">ç„¡è³‡æ–™</td></tr>' : list.map(r => `<tr><td>${r.partnerName}</td><td>${r.gpv} <small>(${ (r.myRate*100).toFixed(0) }%)</small></td><td>${formatMoney(r.starTotal)}</td><td style="font-weight:bold">${formatMoney(r.totalIncome)}</td>
    <td><span class="status-badge ${r.payoutStatus==='paid'?'status-paid':'status-unpaid'}">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</span></td>
    <td><button class="btn btn-secondary" onclick="editRecord('${r.id}')">ç·¨è¼¯</button></td></tr>`).join('')}</tbody></table></div>`;
}

let tempRecord = {};

function editRecord(id, month) {
    const r = id ? store.getRecord(id) : { id:'', partnerId:'', month: month, ppv:0, pbv:0, gpv:0, legs:[], newRecruits:[], learningDone:false, participation:'active', payoutStatus:'unpaid', payoutDate: month+'-18', planVersionId: store.data.versions.find(v=>!v.archived)?.id, note: '' };
    if (r.payoutStatus === 'paid' && id && !confirm('æ­¤ç´€éŒ„å·²ç™¼æ”¾é–å®šï¼Œç¢ºå®šè¦è§£é–ç·¨è¼¯ï¼Ÿ')) return;
    tempRecord = JSON.parse(JSON.stringify(r));
    const partners = store.data.partners.filter(p => p.status === 'active');
    
    // ç‰ˆæœ¬é¸å–®é‚è¼¯ï¼šé¡¯ç¤ºæœªå°å­˜çš„ + ç•¶å‰ç´€éŒ„ä½¿ç”¨çš„(å³ä½¿å·²å°å­˜)
    const versionOptions = store.data.versions.filter(v => !v.archived || v.id === r.planVersionId).map(v => 
        `<option value="${v.id}" ${v.id===r.planVersionId?'selected':''}>${v.name} ${v.archived?'(å·²å°å­˜)':''}</option>`
    ).join('');

    // ğŸ”¥ é›™æ¬„ Modal HTML
    openModal(`
        <h2>${id ? 'ç·¨è¼¯' : 'æ–°å¢'}æ¥­ç¸¾ç´€éŒ„ (${r.month})</h2>
        <form onsubmit="saveRecord(event, '${id||''}')">
            <div class="record-modal-grid">
                <div class="record-form-col">
                    <fieldset><legend>åŸºæœ¬è³‡æ–™</legend>
                        <div class="row">
                            <div class="col form-group"><label>å¤¥ä¼´</label><select class="form-control" name="partnerId" required onchange="tempRecord.partnerId=this.value"><option value="">-- è«‹é¸æ“‡ --</option>${partners.map(p => `<option value="${p.id}" ${p.id===r.partnerId?'selected':''}>${p.code} ${p.name}</option>`).join('')}</select></div>
                            <div class="col form-group"><label>è¨ˆç•«ç‰ˆæœ¬</label><select class="form-control" name="planVersionId" required onchange="tempRecord.planVersionId=this.value; renderPreview();">${versionOptions}</select></div>
                        </div>
                    </fieldset>

                    <fieldset><legend>ğŸ“ˆ æ¥­ç¸¾æ•¸æ“š (PV/BV)</legend>
                        <div class="row">
                            <div class="col"><label>å€‹äººPV</label><input type="number" class="form-control" name="ppv" value="${r.ppv}" oninput="document.getElementsByName('pbv')[0].value=this.value*50"></div>
                            <div class="col"><label>å€‹äººBV</label><input type="number" class="form-control" name="pbv" value="${r.pbv}"></div>
                            <div class="col"><label>å°çµ„PV *</label><input type="number" class="form-control" name="gpv" value="${r.gpv}" required oninput="tempRecord.gpv=Number(this.value); renderPreview();"></div>
                        </div>
                    </fieldset>

                    <fieldset><legend>ğŸ¦µ ç¬¬ä¸€ä»£è…¿ (åˆ¤æ–·ç¨ç«‹)</legend>
                        <div id="legs-container"></div>
                        <button type="button" class="btn btn-outline" style="margin-top:5px" onclick="addLeg()">+ æ–°å¢è…¿</button>
                    </fieldset>

                    <fieldset><legend>âœ¨ æ–°æ˜Ÿè¨ˆç•«æ¢ä»¶</legend>
                        <div class="row">
                            <div class="col form-group"><label>åƒèˆ‡ç‹€æ…‹</label><select class="form-control" onchange="tempRecord.participation=this.value; renderPreview();"><option value="active" ${r.participation==='active'?'selected':''}>åƒèˆ‡</option><option value="inactive" ${r.participation==='inactive'?'selected':''}>åœç”¨</option></select></div>
                            <div class="col form-group"><label style="padding-top:30px;"><input type="checkbox" ${r.learningDone?'checked':''} onchange="tempRecord.learningDone=this.checked; renderPreview();"> å®Œæˆå­¸ç¿’ä»»å‹™</label></div>
                        </div>
                        <div><label>æ–°æ¨è–¦æœƒå“¡æ¸…å–®</label>
                            <div id="recruits-container"></div>
                            <button type="button" class="btn btn-outline" style="margin-top:5px" onclick="addRecruit()">+ æ–°å¢æ–°äºº</button>
                        </div>
                    </fieldset>

                    <fieldset><legend>ğŸ“ å…¶ä»–è³‡è¨Š</legend>
                        <div class="form-group"><label>å‚™è¨»</label><textarea name="note" class="form-control" rows="3" placeholder="ç‰¹æ®Šæƒ…æ³å‚™è¨»...">${r.note||''}</textarea></div>
                        <div class="row">
                            <div class="col"><label>ç™¼æ”¾æ—¥</label><input type="date" class="form-control" name="payoutDate" value="${r.payoutDate}"></div>
                            <div class="col"><label>ç‹€æ…‹</label><select class="form-control" name="payoutStatus"><option value="unpaid" ${r.payoutStatus==='unpaid'?'selected':''}>æœªç™¼æ”¾</option><option value="paid" ${r.payoutStatus==='paid'?'selected':''}>å·²ç™¼æ”¾</option></select></div>
                        </div>
                    </fieldset>
                </div>

                <div class="record-preview-col">
                    <div id="preview-box" class="preview-card">
                        </div>
                    <button type="submit" class="btn btn-primary" style="width:100%; margin-top:15px; padding:12px; font-size:1.1rem;">å„²å­˜ç´€éŒ„</button>
                </div>
            </div>
        </form>
    `);
    
    renderLegs();
    renderRecruits();
    renderPreview();
}

function renderPreview() {
    const res = calculatePreview(tempRecord);
    const box = document.getElementById('preview-box');
    if(!box || !res) return;

    box.innerHTML = `
        <div class="preview-header">
            <span>é ä¼°æœ¬æœˆç™¼æ”¾</span>
            <span class="status-tag">${(res.myRate*100).toFixed(0)}%</span>
        </div>
        <div class="preview-amount-big">${formatMoney(res.starTotal)}</div>
        <div style="font-weight:bold; color:${res.msgColor}; margin-bottom:15px; font-size:0.9rem;">
            ${res.msg ? res.msg : 'âœ… ç¬¦åˆè¨ˆç®—è³‡æ ¼'}
        </div>
        ${res.isEligible ? `
            <div class="preview-row"><span>é©ç”¨æ¯”ä¾‹</span><span>${res.appliedRateText}</span></div>
            <div class="preview-row"><span>åŸºç¤å›é¥‹</span><span>${formatMoney(res.baseBonus)}</span></div>
            <div class="preview-row"><span>æ–°äººå›é¥‹</span><span>${formatMoney(res.recruitBonus)}</span></div>
            <div class="preview-row"><span>å­¸ç¿’åŠ ç¢¼</span><span>${formatMoney(res.learningBonus)}</span></div>
            <div class="preview-row total"><span>ç¸½è¨ˆ</span><span>${formatMoney(res.starTotal)}</span></div>
        ` : ''}
    `;
}

/* Helper Renders */
function renderLegs() {
    document.getElementById('legs-container').innerHTML = tempRecord.legs.map((l, i) => `
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input style="flex:2" class="form-control" placeholder="è…¿å" value="${l.name}" oninput="tempRecord.legs[${i}].name=this.value">
            <input style="flex:1.5" type="number" class="form-control" placeholder="PV" value="${l.pv}" oninput="tempRecord.legs[${i}].pv=Number(this.value)">
            <input style="flex:1.5" type="number" class="form-control" placeholder="BV" value="${l.bv}" oninput="tempRecord.legs[${i}].bv=Number(this.value);renderPreview()">
            <label style="flex:1; display:flex; align-items:center; justify-content:center; font-size:0.8rem"><input type="checkbox" ${l.isIndependent?'checked':''} onchange="tempRecord.legs[${i}].isIndependent=this.checked;renderPreview()"> ç¨ç«‹</label>
            <button type="button" class="btn btn-danger" onclick="tempRecord.legs.splice(${i},1);renderLegs();renderPreview()">X</button>
        </div>`).join('');
}
function addLeg() { tempRecord.legs.push({ name: '', pv: 0, bv: 0, isIndependent: false }); renderLegs(); renderPreview(); }

function renderRecruits() {
    document.getElementById('recruits-container').innerHTML = tempRecord.newRecruits.map((r, i) => `
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input style="flex:2" class="form-control" placeholder="å§“å" value="${r.name}" oninput="tempRecord.newRecruits[${i}].name=this.value">
            <input style="flex:1.5" type="number" class="form-control" placeholder="BV" value="${r.bv}" oninput="tempRecord.newRecruits[${i}].bv=Number(this.value);renderPreview()">
            <button type="button" class="btn btn-danger" onclick="tempRecord.newRecruits.splice(${i},1);renderRecruits();renderPreview()">X</button>
        </div>`).join('');
}
function addRecruit() { tempRecord.newRecruits.push({ name: '', bv: 0 }); renderRecruits(); renderPreview(); }

function saveRecord(e, id) {
    e.preventDefault(); const fd = new FormData(e.target);
    const record = { 
        ...tempRecord, 
        partnerId: fd.get('partnerId'), planVersionId: fd.get('planVersionId'), 
        month: tempRecord.month, ppv: Number(fd.get('ppv')), pbv: Number(fd.get('pbv')), gpv: Number(fd.get('gpv')), 
        note: fd.get('note'), payoutDate: fd.get('payoutDate'), payoutStatus: fd.get('payoutStatus') 
    };
    if(id) { const idx = store.data.records.findIndex(r => r.id === id); store.data.records[idx] = record; }
    else { record.id = generateUUID(); store.data.records.push(record); }
    store.save(); closeModal();
}

/* 5. Payout */
function renderPayout() {
    const month = localStorage.getItem('last_payout_view_month') || new Date().toISOString().slice(0, 7);
    const records = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x);
    const initiators = store.data.initiators;
    const groups = {};
    initiators.forEach(init => { groups[init.id] = { info: init, records: records.filter(r => r.initiatorId === init.id), total: 0, paid: 0, unpaid: 0 }; });
    const orphanRecords = records.filter(r => !r.initiatorId || !store.getInitiator(r.initiatorId));
    if(orphanRecords.length > 0) groups['none'] = { info: { name: 'æœªæŒ‡å®š', code: 'N/A' }, records: orphanRecords, total:0, paid:0, unpaid:0 };
    Object.values(groups).forEach(g => { g.records.forEach(r => { g.total += r.totalIncome; if(r.payoutStatus === 'paid') g.paid += r.totalIncome; else g.unpaid += r.totalIncome; }); });
    
    app.innerHTML = `<header>${getHeaderHtml('æœ¬æœˆç™¼æ”¾ç¸½è¡¨')} <input type="month" value="${month}" class="form-control" style="width:auto" onchange="localStorage.setItem('last_payout_view_month', this.value); renderPayout();"></header>
        <div class="row"><div class="col"><button class="btn btn-primary" onclick="bulkMarkPaid()">æ‰¹æ¬¡æ¨™è¨˜å·²ç™¼æ”¾</button> <button class="btn btn-secondary" onclick="exportPayoutCSV('${month}')">åŒ¯å‡º CSV</button></div></div><br>
        ${Object.values(groups).filter(g => g.records.length > 0).map(g => `
            <div class="card"><h3 style="border-bottom:2px solid var(--accent);padding-bottom:10px;display:flex;justify-content:space-between;"><span>${g.info.code} ${g.info.name}</span><span style="font-size:0.9rem">æ‡‰ä»˜ï¼š${formatMoney(g.unpaid)}</span></h3>
            <table><thead><tr><th width="40"><input type="checkbox" onchange="toggleGroupCheck(this, '${g.info.id}')"></th><th>å¤¥ä¼´</th><th>æ–°æ˜Ÿå›é¥‹</th><th>ç¸½è¨ˆ</th><th>ç™¼æ”¾</th></tr></thead><tbody>
            ${g.records.map(r => `<tr><td><input type="checkbox" class="payout-check group-${g.info.id}" value="${r.id}" ${r.payoutStatus==='paid'?'disabled':''}></td><td>${r.partnerName}</td><td>${formatMoney(r.starTotal)}</td><td style="font-weight:bold">${formatMoney(r.totalIncome)}</td>
            <td><span class="status-badge ${r.payoutStatus==='paid'?'status-paid':'status-unpaid'}">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</span></td></tr>`).join('')}</tbody></table></div>
        `).join('')}`;
}
function toggleGroupCheck(m, id) { document.querySelectorAll(`.group-${id}`).forEach(c => { if(!c.disabled) c.checked = m.checked; }); }
function bulkMarkPaid() { 
    const sel = Array.from(document.querySelectorAll('.payout-check:checked')).map(c => c.value); 
    if(!sel.length || !confirm('ç¢ºèªå°‡é¸å–é …ç›®æ¨™è¨˜ç‚ºå·²ç™¼æ”¾ï¼Ÿ')) return;
    sel.forEach(id => { const r = store.getRecord(id); if(r) r.payoutStatus = 'paid'; }); store.save(); 
}
function exportPayoutCSV(month) {
    const records = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x);
    let csv = '\uFEFFæœˆä»½,ç™¼èµ·äºº,å¤¥ä¼´,æ–°æ˜Ÿå›é¥‹,ç¸½åˆè¨ˆ,å‚™è¨»\n';
    records.forEach(r => { const init = store.getInitiator(r.initiatorId); csv += `${r.month},${init?init.name:'N/A'},${r.partnerName},${r.starTotal},${r.totalIncome},${r.note||''}\n`; });
    const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = `Payout_${month}.csv`; link.click();
}

/* 6. Org Chart */
function renderOrgChart() {
    const month = localStorage.getItem('last_org_view_month') || new Date().toISOString().slice(0, 7);
    const partners = store.data.partners; const records = store.getRecordsByMonth(month).map(calculateRecord);
    const partnerMap = {}; partners.forEach(p => { partnerMap[p.id] = { ...p, children: [], record: records.find(r => r && r.partnerId === p.id) }; });
    const roots = []; partners.forEach(p => { if(p.sponsorId && partnerMap[p.sponsorId]) partnerMap[p.sponsorId].children.push(partnerMap[p.id]); else roots.push(partnerMap[p.id]); });
    
    const activeScopeId = localStorage.getItem('active_scope_initiator');
    let scopeSet = new Set();
    if(activeScopeId) {
        const scope = store.getCoachingScope(activeScopeId);
        if(scope.roots) {
            function mark(pid, d) { if(d>5) return; scopeSet.add(pid); const p = partnerMap[pid]; if(p && p.children) p.children.forEach(c => mark(c.id, d+1)); }
            scope.roots.forEach(rid => { if(partnerMap[rid]) mark(rid, 1); });
        }
    }
    function renderNode(node) {
        const r = node.record;
        let classes = ['node']; if(scopeSet.has(node.id)) classes.push('in-scope');
        if(activeScopeId && store.getCoachingScope(activeScopeId).roots.includes(node.id)) classes.push('scope-root');
        if(r && r.isGraduated) classes.push('graduate');
        let metric = r ? `${formatMoney(r.totalIncome)}` : 'ç„¡ç´€éŒ„';
        if(r && r.participation === 'inactive') metric = '(åœç”¨)';
        return `<li><div class="${classes.join(' ')}" onclick="showNodeDetails('${node.id}','${month}')"><div class="name">${node.code} ${node.name}</div><div class="metric">${metric}</div></div>${node.children.length>0 ? `<ul>${node.children.map(renderNode).join('')}</ul>` : ''}</li>`;
    }
    app.innerHTML = `<header>${getHeaderHtml('çµ„ç¹”é—œè¯åœ–')} <div style="display:flex;gap:10px;"><input type="month" value="${month}" class="form-control" style="width:auto" onchange="localStorage.setItem('last_org_view_month',this.value);renderOrgChart();"><button class="btn btn-secondary" onclick="openScopeSettings()">ğŸ¯ è¨­å®šè¼”å°ç¯„åœ</button></div></header>
    <div style="margin-bottom:10px;padding:10px;background:white;border-radius:4px;">é¡¯ç¤ºè¼”å°ç¯„åœï¼š<select class="form-control" style="width:auto;display:inline-block" onchange="localStorage.setItem('active_scope_initiator',this.value);renderOrgChart();"><option value="">-- ç„¡ --</option>${store.data.initiators.map(i=>`<option value="${i.id}" ${i.id===activeScopeId?'selected':''}>${i.name}</option>`).join('')}</select></div>
    <div class="org-container"><div class="tree"><ul>${roots.map(renderNode).join('')}</ul></div></div>`;
}
function openScopeSettings() {
    const initiators = store.data.initiators;
    openModal(`<h2>è¨­å®šè¼”å°ç¯„åœ</h2><div class="form-group"><label>ç™¼èµ·äºº</label><select id="scope-init-select" class="form-control" onchange="renderScopeSelector(this.value)"><option value="">-- è«‹é¸æ“‡ --</option>${initiators.map(i=>`<option value="${i.id}">${i.name}</option>`).join('')}</select></div><div id="scope-selector-area"></div>`);
}
function renderScopeSelector(initId) {
    if(!initId) { document.getElementById('scope-selector-area').innerHTML = ''; return; }
    const scope = store.getCoachingScope(initId);
    const partners = store.data.partners;
    document.getElementById('scope-selector-area').innerHTML = `<p>å‹¾é¸ç¬¬ä¸€å±¤è¼”å°å°è±¡ (æœ€å¤š3ä½)ï¼š</p><div style="max-height:300px;overflow-y:auto;border:1px solid #ddd;padding:10px;">${partners.map(p=>`<div style="margin-bottom:5px;"><label><input type="checkbox" class="scope-root-check" value="${p.id}" ${scope.roots.includes(p.id)?'checked':''} onchange="if(document.querySelectorAll('.scope-root-check:checked').length>3){alert('æœ€å¤š3ä½');this.checked=false;}"> ${p.code} ${p.name}</label></div>`).join('')}</div><button class="btn btn-primary" style="margin-top:10px" onclick="saveScope('${initId}')">å„²å­˜</button>`;
}
function saveScope(id) {
    const checked = Array.from(document.querySelectorAll('.scope-root-check:checked')).map(c => c.value);
    let idx = store.data.coachingScopes.findIndex(c => c.initiatorId === id);
    if(idx === -1) store.data.coachingScopes.push({ initiatorId: id, roots: checked, depth: 5 }); else store.data.coachingScopes[idx].roots = checked;
    store.save(); closeModal(); renderOrgChart();
}
function showNodeDetails(pid, month) {
    const r = store.data.records.find(r => r.partnerId === pid && r.month === month);
    const p = store.getPartner(pid);
    if(!r) return confirm('ç„¡ç´€éŒ„ï¼Œå»ºç«‹ï¼Ÿ') ? (closeModal(), router('records'), setTimeout(() => { editRecord(null, month); tempRecord.partnerId = pid; document.getElementsByName('partnerId')[0].value = pid; }, 100)) : null;
    const calc = calculateRecord(r);
    openModal(`<h2>${p.name} - ${month}</h2><table class="table">
    <tr><th>å°çµ„PV</th><td>${calc.gpv}</td></tr><tr><th>æ–°æ˜Ÿå›é¥‹</th><td>${formatMoney(calc.starTotal)}</td></tr>
    ${r.note ? `<tr><th>å‚™è¨»</th><td>${r.note}</td></tr>` : ''}
    </table><div class="text-right"><button class="btn btn-primary" onclick="closeModal(); router('records'); setTimeout(()=>editRecord('${r.id}', '${month}'), 100)">ç·¨è¼¯</button></div>`);
}

/* 7. Versions (ğŸ”¥ æ–°å¢åˆªé™¤åŠŸèƒ½) */
function renderVersions() {
    app.innerHTML = `<header>${getHeaderHtml('ç‰ˆæœ¬æ§ç®¡')} <button class="btn btn-primary" onclick="editVersion()">+ æ–°å¢</button></header>
    <div class="card"><table><thead><tr><th>åç¨±</th><th>å»ºç«‹æ—¥æœŸ</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>${store.data.versions.map(v => `<tr>
        <td>${v.name}</td><td>${new Date(v.createdAt).toLocaleDateString()}</td>
        <td>${v.archived ? '<span class="status-badge status-archived">å·²å°å­˜</span>' : '<span class="status-badge status-active">ä½¿ç”¨ä¸­</span>'}</td>
        <td><button class="btn btn-secondary" onclick="editVersion('${v.id}')">æŸ¥çœ‹</button> 
            ${!v.archived ? `<button class="btn btn-danger" onclick="deleteVersion('${v.id}')">åˆªé™¤</button>` : ''}
        </td></tr>`).join('')}</tbody></table></div>`;
}
function editVersion(id) {
    const v = id ? store.getVersion(id) : { id:'', name:'æ–°ç‰ˆæœ¬', createdAt:'', params:{...defaultPlanParams} };
    const p = v.params;
    openModal(`<h2>${id?'æŸ¥çœ‹/ç·¨è¼¯':'æ–°å¢'}ç‰ˆæœ¬</h2><form onsubmit="saveVersion(event, '${id||''}')">
        <div class="form-group"><label>åç¨±</label><input class="form-control" name="name" value="${v.name}" required ${v.archived?'disabled':''}></div>
        <fieldset><legend>åƒæ•¸è¨­å®š ${v.archived?'(å”¯è®€)':''}</legend>
        <div class="row"><div class="col"><label>0-3% åŸºç¤</label><input type="number" step="0.01" name="rate_0_3_base" value="${p.rate_0_3_base}" class="form-control" ${v.archived?'disabled':''}></div>
        <div class="col"><label>0-3% æ¨è–¦</label><input type="number" step="0.01" name="rate_0_3_rec" value="${p.rate_0_3_rec}" class="form-control" ${v.archived?'disabled':''}></div></div>
        <div class="row"><div class="col"><label>6% åŸºç¤</label><input type="number" step="0.01" name="rate_6_base" value="${p.rate_6_base}" class="form-control" ${v.archived?'disabled':''}></div>
        <div class="col"><label>6% æ¨è–¦</label><input type="number" step="0.01" name="rate_6_rec" value="${p.rate_6_rec}" class="form-control" ${v.archived?'disabled':''}></div></div>
        <div class="row"><div class="col"><label>æ–°äººå›é¥‹</label><input type="number" step="0.01" name="rate_recruit_bv" value="${p.rate_recruit_bv}" class="form-control" ${v.archived?'disabled':''}></div>
        <div class="col"><label>å­¸ç¿’åŠ ç¢¼</label><input type="number" step="0.01" name="rate_learning" value="${p.rate_learning}" class="form-control" ${v.archived?'disabled':''}></div></div>
        </fieldset>
        ${!v.archived ? '<button type="submit" class="btn btn-primary">å„²å­˜</button>' : ''}</form>`);
}
function saveVersion(e, id) {
    e.preventDefault(); const fd = new FormData(e.target);
    const params = { rate_0_3_base: Number(fd.get('rate_0_3_base')), rate_0_3_rec: Number(fd.get('rate_0_3_rec')), rate_6_base: Number(fd.get('rate_6_base')), rate_6_rec: Number(fd.get('rate_6_rec')), rate_recruit_bv: Number(fd.get('rate_recruit_bv')), rate_learning: Number(fd.get('rate_learning')) };
    if(id) { const idx = store.data.versions.findIndex(v => v.id === id); store.data.versions[idx] = { ...store.data.versions[idx], name: fd.get('name'), params }; }
    else { store.data.versions.unshift({ id: generateUUID(), name: fd.get('name'), createdAt: new Date().toISOString(), params }); }
    store.save(); closeModal(); renderVersions();
}
function deleteVersion(id) {
    const v = store.getVersion(id);
    if(!v) return;
    if(!confirm(`ç¢ºå®šè¦åˆªé™¤ç‰ˆæœ¬ã€Œ${v.name}ã€å—ï¼Ÿ`)) return;
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ç´€éŒ„ä½¿ç”¨æ­¤ç‰ˆæœ¬
    const isUsed = store.data.records.some(r => r.planVersionId === id);
    
    if (isUsed) {
        if(!confirm(`âš ï¸ æ­¤ç‰ˆæœ¬å·²è¢«éƒ¨åˆ†æ¥­ç¸¾ç´€éŒ„ä½¿ç”¨ï¼Œç„¡æ³•å®Œå…¨åˆªé™¤ã€‚\n\nç³»çµ±å°‡åŸ·è¡Œã€Œå°å­˜ (Archive)ã€ï¼Œä¿ç•™èˆŠç´€éŒ„å°ç…§ï¼Œä½†æ–°ç´€éŒ„å°‡ç„¡æ³•å†é¸æ“‡æ­¤ç‰ˆæœ¬ã€‚\n\næ˜¯å¦ç¹¼çºŒï¼Ÿ`)) return;
        v.archived = true;
    } else {
        store.data.versions = store.data.versions.filter(ver => ver.id !== id);
    }
    store.save(); renderVersions();
}

/* 8. Settings */
function renderSettings() { app.innerHTML = `<header>${getHeaderHtml('ç³»çµ±è¨­å®š')}</header><div class="card"><h3>âš ï¸ å±éšªå€åŸŸ</h3><button class="btn btn-danger" onclick="if(prompt('è¼¸å…¥ DELETE ç¢ºèª')==='DELETE'){db.ref('AmwaySystem/v1').remove();location.reload();}">ğŸ”¥ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button></div>`; }

function openModal(c) { document.getElementById('modal-body').innerHTML = c; document.getElementById('modal').style.display = 'block'; }
function closeModal() { document.getElementById('modal').style.display = 'none'; }
window.onclick = function(e) { if(e.target == document.getElementById('modal')) closeModal(); }

</script>
</body>
</html>
