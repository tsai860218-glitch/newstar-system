<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«æ——è‰¦ç³»çµ± (2026 Pro v3.5)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0066cc;
            --primary-dark: #004c99;
            --secondary: #ff9900;
            --bg: #f0f2f5;
            --text: #333;
            --border: #e1e1e1;
            --purple: #6f42c1;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 10;}
        .logo { padding: 25px 20px; font-size: 1.3rem; font-weight: bold; color: var(--primary); border-bottom: 1px solid var(--border); background: #f8f9fa;}
        .nav-item { padding: 16px 20px; cursor: pointer; transition: 0.2s; color: #555; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .nav-item:hover { background: #eef7ff; color: var(--primary); }
        .nav-item.active { background: #eef7ff; color: var(--primary); border-right: 4px solid var(--primary); font-weight: bold; }
        .nav-divider { font-size: 0.8rem; color: #999; padding: 15px 20px 5px; text-transform: uppercase; font-weight: bold; margin-top: 10px;}
        
        /* Main */
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }
        .page-title { font-size: 1.6rem; font-weight: bold; color: #2c3e50; border-left: 5px solid var(--primary); padding-left: 15px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.04); margin-bottom: 25px; border: 1px solid #f0f0f0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }

        /* Form */
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 0.95rem; font-weight: 600; color: #4b5563; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .row-inputs { display: flex; gap: 15px; align-items: center; }
        .row-inputs > div { flex: 1; }
        .equal-sign { font-size: 1.5rem; color: #999; font-weight: bold; padding-top: 25px; }

        /* Input Sections */
        .input-section { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .is-sales { border-left: 4px solid #3b82f6; background: #f8fbff; }
        .is-newcomer { border-left: 4px solid #e67e22; background: #fffaf5; }
        .is-learning { border-left: 4px solid #10b981; background: #f0fff4; }
        .section-header { font-weight: bold; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; color: #555; }

        /* V3.5 Product Row Styles */
        .product-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; animation: fadeIn 0.3s; }
        .product-row input { padding: 8px; font-size: 0.9rem; background: white; }
        .btn-remove-prod { color: #dc3545; background: none; border: none; cursor: pointer; font-size: 1.1rem; }
        .btn-remove-prod:hover { color: #a71d2a; }

        /* Tree View */
        .tree-node { margin-left: 25px; border-left: 2px dashed #ccc; padding-left: 20px; position: relative; margin-top: 15px; }
        .tree-node::before { content: ""; position: absolute; left: 0; top: 18px; width: 18px; height: 2px; background: #ccc; }
        .tree-content { display: flex; align-items: center; gap: 10px; background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 6px; width: fit-content; transition:0.2s;}
        .tree-content:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--primary); }
        .tree-name { font-weight: bold; color: #333; }
        .tree-id { color: #888; font-size: 0.85rem; font-family: monospace; }
        .tree-root { margin-left: 0; border-left: none; padding-left: 0; margin-bottom: 30px; }
        .tree-root::before { display: none; }
        .tree-root > .tree-content { background: linear-gradient(to right, #f3e5f5, #fff); border: 1px solid #d1c4e9; border-left: 5px solid var(--purple); width: 100%; box-sizing: border-box; }
        .tree-root > .tree-content .tree-name { font-size: 1.2rem; color: #4a148c; }

        /* Badges */
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .badge-sales { background: #3b82f6; color: white; }
        .badge-new { background: #e67e22; color: white; }
        .badge-learn { background: #10b981; color: white; }
        .badge-sponsor { background: var(--purple); color: white; }
        .status-active { color: #28a745; font-weight: bold; background: #e6f9ed; padding: 2px 6px; border-radius: 4px; border: 1px solid #28a745; }
        .status-inactive { color: #999; font-size: 0.85rem; }

        /* Others */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-purple { background: var(--purple); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: #dc3545; color: white; }
        .instant-bonus-box { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 6px solid var(--secondary); }
        .ib-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 10px;}
        .ib-total { font-size: 1.8rem; font-weight: bold; color: var(--secondary); }
        .ib-breakdown { display: flex; justify-content: space-between; gap: 10px; }
        .ib-item { flex: 1; background: rgba(255,255,255,0.08); padding: 10px; border-radius: 6px; text-align: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        th { background: #f1f5f9; font-weight: 700; color: #475569; }

        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; min-height: 100vh; }
            .sidebar { width: 100%; flex-direction: row; overflow-x: auto; height: auto; border-bottom: 1px solid var(--border); border-right: none; }
            .nav-item { padding: 15px; white-space: nowrap; }
            .nav-divider, .logo { display: none; }
            .main { padding: 15px; overflow: visible; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .row-inputs { flex-direction: column; gap: 5px; }
            .equal-sign { transform: rotate(90deg); padding: 5px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-gem"></i> æ–°æ˜Ÿå•Ÿå‹•ç³»çµ± <small style="font-size:0.6em; color:#28a745;">(V3.5)</small></div>
        
        <div class="nav-divider">æ•¸æ“šç®¡ç†</div>
        <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i> æ¥­ç¸¾æˆ°æƒ…å®¤</div>
        <div class="nav-item" onclick="switchTab('network')"><i class="fas fa-project-diagram"></i> çµ„ç¹”é—œä¿‚åœ–</div>
        <div class="nav-item" onclick="switchTab('entry')"><i class="fas fa-pen"></i> æ–°å¢ç¶œåˆç´€éŒ„</div>
        <div class="nav-item" onclick="switchTab('members')"><i class="fas fa-users"></i> æœƒå“¡è³‡æ–™åº«</div>
        <div class="nav-item" onclick="switchTab('logs')"><i class="fas fa-list"></i> æ—¥èªŒæ˜ç´°</div>

        <div class="nav-divider">æ ¸å¿ƒè¨­å®š</div>
        <div class="nav-item" onclick="switchTab('sponsors')"><i class="fas fa-crown"></i> ç™¼èµ·äººè³‡æ–™åº«</div>
        
        <div class="nav-divider">å·¥å…·</div>
        <div class="nav-item" onclick="switchTab('calculator')"><i class="fas fa-calculator"></i> çé‡‘æ¨¡æ“¬å™¨</div>
        <div class="nav-item" onclick="switchTab('guide')"><i class="fas fa-book-open"></i> æ”»ç•¥ç™¾ç§‘</div>
        <div class="nav-item" onclick="switchTab('settings')"><i class="fas fa-cog"></i> è¨­å®šèˆ‡å‚™ä»½</div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="section active">
            <div class="header">
                <div class="page-title">ç•¶æœˆæ¥­ç¸¾æˆ°æƒ…å®¤</div>
                <div style="display:flex; gap:10px;">
                    <select id="dashMonthSelect" onchange="renderDashboard()" style="width: auto; cursor:pointer; font-weight:bold; color:var(--primary);"></select>
                    <button class="btn btn-outline" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> ä¸‹è¼‰å ±è¡¨</button>
                </div>
            </div>
            <div class="grid-3">
                <div class="card" style="border-top: 4px solid var(--primary);">
                    <div style="color: #666; font-size: 0.9rem;">æœ¬æœˆåœ˜éšŠç¸½ PV (å« Roll-up)</div>
                    <h1 id="totalPVDisplay" style="margin: 10px 0; color: var(--primary);">0</h1>
                </div>
                <div class="card" style="border-top: 4px solid var(--secondary);">
                    <div style="color: #666; font-size: 0.9rem;">é ä¼°ç™¼æ”¾ç¸½çé‡‘</div>
                    <h1 id="totalBonusDisplay" style="margin: 10px 0; color: var(--secondary);">$0</h1>
                </div>
                <div class="card" style="border-top: 4px solid var(--success);">
                    <div style="color: #666; font-size: 0.9rem;">æ´»èºå¤¥ä¼´ / ç¸½äººæ•¸</div>
                    <h1 id="activeMembersDisplay" style="margin: 10px 0; color: var(--success);">0 / 0</h1>
                </div>
            </div>
            <div class="card">
                <h3>ğŸ’° çé‡‘æ’è¡Œæ¦œ (Top 10)</h3>
                <div style="overflow-x: auto;">
                    <table id="rankingTable"><thead><tr><th>æ’å</th><th>æœƒå“¡</th><th>æœ‰æ•ˆç¸½ PV</th><th>è©³ç´°çµæ§‹</th><th>é ä¼°çé‡‘</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="network" class="section">
            <div class="page-title">ğŸ§¬ çµ„ç¹”é—œä¿‚åœ–</div>
            <div class="grid-2">
                <div class="card">
                    <h3><i class="fas fa-sitemap"></i> ç„¡é™å±¤ç´šçµ„ç¹”æ¨¹</h3>
                    <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">åŒ…å«ã€Œæ¥­ç¸¾æ­¸æˆ¶ã€é‚è¼¯æª¢æŸ¥ã€‚</p>
                    <div id="treeContainer" style="overflow-x:auto; padding-bottom:20px;"></div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-history"></i> æ¨è–¦ç´€éŒ„æ¸…å–®</h3>
                    <div style="max-height: 600px; overflow-y: auto;">
                        <table id="referralTable"><thead><tr><th>æ¨è–¦æ—¥æœŸ</th><th>ç›´å±¬ä¸Šç·š (æ¨è–¦äºº)</th><th>æ–°äºº (ä¸‹ç·š)</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="entry" class="section">
            <div class="page-title">ğŸ“ æ–°å¢ç¶œåˆç´€éŒ„</div>
            <div class="grid-2">
                <div>
                    <div class="card">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="entryDate" onchange="updateInstantCalc()"></div>
                        <div class="form-group">
                            <label>æ“ä½œæœƒå“¡ (åƒ…é¡¯ç¤ºåƒåŠ ä¸­)</label>
                            <select id="entryMember" onchange="checkMemberSelect(); updateInstantCalc(); updateNewcomerUplineSelect();"></select>
                            <div id="quickAddMemberBox" style="display:none; background:#f0f9ff; padding:15px; margin-top:10px; border-radius:8px; border:1px dashed #0066cc;">
                                <small style="color:#0066cc; font-weight:bold; font-size:1rem;"><i class="fas fa-user-plus"></i> å»ºç«‹æ–°æœƒå“¡</small>
                                <div style="display:flex; gap:10px; margin-top:10px;">
                                    <input type="text" id="quickNewMemName" placeholder="å§“å" style="font-size:0.9rem;">
                                    <input type="text" id="quickNewMemID" placeholder="ç·¨è™Ÿ" style="font-size:0.9rem;">
                                </div>
                                <div style="margin-top:10px;">
                                    <label style="font-size:0.85rem; color:#666;">éš¸å±¬ç™¼èµ·äºº</label>
                                    <select id="quickNewMemSponsor" style="font-size:0.9rem;"></select>
                                </div>
                                <div style="margin-top:10px; display:flex; align-items:center; gap:5px;">
                                    <input type="checkbox" id="quickNewMemStatus" checked>
                                    <label for="quickNewMemStatus" style="margin:0; font-size:0.9rem; color:#28a745;">åƒåŠ æ–°æ˜Ÿè¨ˆç•«</label>
                                </div>
                            </div>
                        </div>
                        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                        <div class="input-section is-sales">
                            <div class="section-header"><i class="fas fa-shopping-cart"></i> æ¥­ç¸¾è¼¸å…¥</div>
                            <div class="row-inputs">
                                <div class="form-group" style="margin:0;"><label style="font-size:0.8rem;">PV</label><input type="number" id="entryPV" placeholder="0" oninput="autoConvert('pv', 'entry'); updateInstantCalc();" onfocus="this.select()"></div>
                                <div class="equal-sign" style="font-size:1.2rem; padding-top:20px;">=</div>
                                <div class="form-group" style="margin:0;"><label style="font-size:0.8rem;">BV (1:50)</label><input type="number" id="entryBV" placeholder="0" oninput="autoConvert('bv', 'entry'); updateInstantCalc();" onfocus="this.select()" style="background:#fff;"></div>
                            </div>
                            
                            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                                <label style="font-size:0.85rem; color:#666;">ğŸ“¦ åˆ†äº«ç”¢å“æ˜ç´° (éå¿…å¡«)</label>
                                <div id="productContainer"></div>
                                <button class="btn btn-outline" style="font-size:0.8rem; padding:5px 10px; margin-top:5px; border-style:dashed;" onclick="addProductRow()">
                                    <i class="fas fa-plus"></i> æ–°å¢å“é …
                                </button>
                            </div>
                        </div>
                        
                        <div class="input-section is-newcomer">
                            <div class="section-header"><i class="fas fa-user-plus"></i> æ¨è–¦æ–°äºº</div>
                            <div class="form-group" style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e67e22;">
                                <label style="color:#d35400; font-size:0.9rem;">ç›´å±¬æ¨è–¦äºº (ä¸Šç·š)</label>
                                <select id="newcomerUpline" style="font-size:0.95rem; border-color:#fadbd8;"></select>
                                <small style="color:#888;">*è‹¥é¸å–®ç„¡äººï¼Œè«‹å…ˆå»ºç«‹æœƒå“¡</small>
                            </div>
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <input type="text" id="newcomerName" placeholder="æ–°äººå§“å" oninput="updateInstantCalc()">
                                <input type="text" id="newcomerID" placeholder="æ–°äººç·¨è™Ÿ">
                            </div>
                            <div class="form-group" style="margin:0;"><label style="font-size:0.8rem;">æ–°äººBV</label><input type="number" id="newcomerBV" placeholder="0" oninput="updateInstantCalc()"></div>
                        </div>
                        <div class="input-section is-learning">
                            <div class="section-header"><i class="fas fa-graduation-cap"></i> å­¸ç¿’å¿ƒå¾—</div>
                            <textarea id="learningNote" rows="2" placeholder="å¿ƒå¾—æ‘˜è¦..." oninput="updateInstantCalc()"></textarea>
                            <label style="margin-top:10px; display:flex; align-items:center; gap:10px; cursor:pointer;"><input type="checkbox" id="learningFileCheck" style="width:auto;" onchange="updateInstantCalc()"> <span>å·²ç¹³äº¤è­‰æ˜</span></label>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="card" style="position:sticky; top:20px;">
                        <h3>ğŸ“Š ç´¯è¨ˆçé‡‘é è¦½</h3>
                        <div class="instant-bonus-box">
                            <div class="ib-header"><div class="ib-title">é è¨ˆçé‡‘å¢åŠ </div><div class="ib-total" id="ibTotalVal">$0</div></div>
                            <div class="ib-breakdown">
                                <div class="ib-item"><div class="ib-label">æ¥­ç¸¾/å‡ç´š</div><div class="ib-val" id="ibDiffBase">+0</div></div>
                                <div class="ib-item"><div class="ib-label">æ–°äººåŠ ç¢¼</div><div class="ib-val" id="ibDiffNew">+0</div></div>
                                <div class="ib-item"><div class="ib-label">å­¸ç¿’çå‹µ</div><div class="ib-val" id="ibDiffLearn">+0</div></div>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="width:100%; margin-top:20px; padding:15px; font-size:1.1rem;" onclick="addCompositeLog()"><i class="fas fa-save"></i> ç¢ºèªå„²å­˜ç´€éŒ„</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="members" class="section">
            <div class="page-title">ğŸ‘¥ æœƒå“¡è³‡æ–™åº«</div>
            <div class="grid-2">
                <div class="card">
                    <h3>æ–°å¢æœƒå“¡</h3>
                    <div class="form-group"><label>ç·¨è™Ÿ</label><input type="text" id="newMemberID" placeholder="TW123456"></div>
                    <div class="form-group"><label>å§“å</label><input type="text" id="newMemberName" placeholder="é™³å¤§æ˜"></div>
                    <div class="form-group">
                        <label style="color:var(--purple);"><i class="fas fa-crown"></i> éš¸å±¬ç™¼èµ·äºº</label>
                        <select id="newMemSponsor" style="border:1px solid var(--purple);"></select>
                    </div>
                    <div class="form-group">
                        <label style="color:#28a745;">æ–°æ˜Ÿè¨ˆç•«ç‹€æ…‹</label>
                        <div style="display:flex; gap:10px;">
                            <input type="checkbox" id="newMemIsNewStar" checked style="width:20px; height:20px;">
                            <span style="line-height:24px;">åƒåŠ è¨ˆç•« (æˆç‚ºç¨ç«‹è¨ˆç®—å–®ä½)</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addMember()"><i class="fas fa-plus"></i> åŠ å…¥è³‡æ–™åº«</button>
                </div>
                <div class="card">
                    <h3>æœƒå“¡åˆ—è¡¨</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table id="memberTable"><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>ç‹€æ…‹</th><th>ç™¼èµ·äºº</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="sponsors" class="section">
            <div class="page-title">ğŸ‘‘ ç™¼èµ·äººè³‡æ–™åº«</div>
            <div class="grid-2">
                <div class="card">
                    <h3>æ–°å¢ç™¼èµ·äºº</h3>
                    <div class="form-group"><label>å§“å</label><input type="text" id="newSponsorName" placeholder="ä¾‹å¦‚ï¼šé™³ç¸½ç›£"></div>
                    <div class="form-group"><label>ä»£è™Ÿ(ID)</label><input type="text" id="newSponsorID" placeholder="ä¾‹å¦‚ï¼šBOSS_01"></div>
                    <button class="btn btn-purple" onclick="addSponsor()"><i class="fas fa-plus"></i> æ–°å¢ç™¼èµ·äºº</button>
                </div>
                <div class="card">
                    <h3>åˆ—è¡¨</h3>
                    <table id="sponsorTable"><thead><tr><th>ID</th><th>å§“å</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="logs" class="section">
            <div class="page-title">ğŸ“‹ ç´€éŒ„æ˜ç´°</div>
            <div class="card">
                <div class="grid-3">
                    <div class="form-group"><label>æœˆä»½</label><input type="month" id="filterMonth" onchange="renderLogs()"></div>
                    <div class="form-group"><label>æœƒå“¡</label><select id="filterMember" onchange="renderLogs()"><option value="all">å…¨éƒ¨</option></select></div>
                    <div class="form-group"><label style="visibility:hidden">R</label><button class="btn btn-outline" style="width:100%" onclick="resetLogFilter()">é‡ç½®</button></div>
                </div>
                <table id="logTable"><thead><tr><th>æ—¥æœŸ</th><th>æœƒå“¡</th><th>é¡å‹</th><th>å…§å®¹</th><th>æ•¸å€¼ / é ä¼°çé‡‘</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="calculator" class="section">
            <div class="page-title">ğŸ§® çé‡‘æ¨¡æ“¬å™¨</div>
            <div class="card">
                <div class="grid-2">
                    <div style="background:#f0f9ff; padding:20px; border-radius:8px;">
                        <div class="form-group"><label>PV</label><input type="number" id="calcPV" oninput="autoConvert('pv','calc'); runSimulation()"></div>
                        <div class="form-group"><label>BV</label><input type="number" id="calcBV" oninput="autoConvert('bv','calc'); runSimulation()"></div>
                        <div class="form-group"><label>æ¨è–¦äººæ•¸</label><input type="number" id="calcPartners" oninput="runSimulation()"></div>
                        <div class="form-group"><label>æ–°äººBV</label><input type="number" id="calcNewcomerBV" oninput="runSimulation()"></div>
                        <div class="form-group"><label><input type="checkbox" id="calcHasLearned" onchange="runSimulation()"> å·²å­¸ç¿’</label></div>
                    </div>
                    <div style="background:#2c3e50; color:white; padding:20px; border-radius:8px; display:flex; flex-direction:column; justify-content:center; text-align:center;">
                        <div id="simGraduateMsg" style="display:none; color:#28a745; margin-bottom:10px;">ğŸ‰ ç•¢æ¥­</div>
                        <div>æ¨¡æ“¬ç¸½çé‡‘</div>
                        <div style="font-size:2.5rem; font-weight:bold; color:#ff9900;" id="simValTotal">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="guide" class="section">
            <div class="page-title">ğŸ“– æ”»ç•¥ç™¾ç§‘</div>
            <div class="card">
                <div style="background:#fafafa; padding:20px; border-radius:8px; line-height:1.8;">
                    <h3>ğŸŒŸ æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«</h3>
                    <ul><li><strong>æ¥­ç¸¾é”æ¨™ï¼š</strong>0-3% åŠ ç¢¼ 3% / 6% åŠ ç¢¼ 1%ã€‚</li><li><strong>æ¨è–¦åŠ ç¢¼ï¼š</strong>æœ‰æ¨è–¦äººï¼Œæ¯”ä¾‹å‡ç´šã€‚</li><li><strong>æ–°äººå›é¥‹ï¼š</strong>æ–°äººBV x 1%ã€‚</li><li><strong>å­¸ç¿’çå‹µï¼š</strong>ç¸½é¡å¤– +3%ã€‚</li></ul>
                </div>
            </div>
        </div>

        <div id="settings" class="section">
            <div class="page-title">âš™ï¸ è¨­å®š</div>
            <div class="card">
                <button class="btn btn-primary" onclick="exportData()">ä¸‹è¼‰å‚™ä»½</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
                <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">é‚„åŸå‚™ä»½</button>
                <button class="btn btn-danger" onclick="clearAllData()" style="margin-left:20px;">æ¸…é™¤è³‡æ–™</button>
            </div>
        </div>

    </div>

<script>
    // --- Cloud Sync ---
    const firebaseConfig = {
      apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
      authDomain: "newstar-system.firebaseapp.com",
      projectId: "newstar-system",
      storageBucket: "newstar-system.firebasestorage.app",
      messagingSenderId: "889699172174",
      appId: "1:889699172174:web:0ff42757035a879cb3281f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const TEAM_ID = "newstar_main";

    let unsubscribe = null;
    function startCloudSync() {
      const ref = db.collection("newstar").doc(TEAM_ID);
      if (unsubscribe) unsubscribe();
      unsubscribe = ref.onSnapshot((snap) => {
        if (!snap.exists) { saveToCloud(); return; }
        const data = snap.data();
        if (!data || !Array.isArray(data.members)) return;
        members = data.members;
        logs = data.logs || [];
        sponsors = data.sponsors || []; 
        localStorage.setItem("amway_members", JSON.stringify(members));
        localStorage.setItem("amway_logs", JSON.stringify(logs));
        localStorage.setItem("amway_sponsors", JSON.stringify(sponsors));
        refreshAllUI();
      });
    }
    let saveTimer = null;
    function saveToCloud() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        db.collection("newstar").doc(TEAM_ID).set(
          { members, logs, sponsors, updatedAt: new Date().toISOString() }, { merge: true }
        );
      }, 300);
    }

    // --- Global Data ---
    let members = JSON.parse(localStorage.getItem('amway_members')) || [];
    let logs = JSON.parse(localStorage.getItem('amway_logs')) || [];
    let sponsors = JSON.parse(localStorage.getItem('amway_sponsors')) || [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entryDate').valueAsDate = new Date();
        document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);
        populateMonthSelect(); refreshAllUI();
        auth.signInAnonymously().then(() => startCloudSync()).catch(err => console.error(err));
    });

    function refreshAllUI() {
        renderSponsors(); updateSponsorSelects(); renderMembers(); updateMemberSelects(); renderLogs(); renderDashboard(); renderNetwork(); runSimulation();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const map = {'dashboard':0, 'network':1, 'entry':2, 'members':3, 'logs':4, 'sponsors':5, 'calculator':6, 'guide':7, 'settings':8};
        if(map[tabId]!==undefined) document.querySelectorAll('.nav-item')[map[tabId]].classList.add('active');
        if(tabId==='dashboard') renderDashboard();
        if(tabId==='logs') renderLogs();
        if(tabId==='network') renderNetwork(); 
    }

    // --- V3.5 Product Row Logic ---
    function addProductRow() {
        const div = document.createElement('div');
        div.className = 'product-row';
        div.innerHTML = `
            <input type="text" placeholder="å“é …åç¨±" class="prod-name" style="flex:2;">
            <input type="number" placeholder="æ•¸é‡" class="prod-qty" style="flex:1;">
            <button onclick="this.parentElement.remove()" class="btn-remove-prod"><i class="fas fa-times"></i></button>
        `;
        document.getElementById('productContainer').appendChild(div);
    }

    // --- Entry Logic (V3.5) ---
    function addCompositeLog() {
        const date = document.getElementById('entryDate').value;
        let memberId = document.getElementById('entryMember').value;

        if(!date) return alert("è«‹é¸æ“‡æ—¥æœŸ");
        if(!memberId) return alert("è«‹é¸æ“‡æœƒå“¡");

        if (memberId === 'new_mode') {
            const nn = document.getElementById('quickNewMemName').value.trim();
            const ni = document.getElementById('quickNewMemID').value.trim();
            const ns = document.getElementById('quickNewMemSponsor').value;
            const isNS = document.getElementById('quickNewMemStatus').checked;
            if(!nn || !ni || !ns) return alert("è«‹è¼¸å…¥æ–°æœƒå“¡è³‡æ–™èˆ‡ç™¼èµ·äºº");
            if(members.find(m=>m.id===ni)) return alert("ç·¨è™Ÿé‡è¤‡");
            members.push({id: ni, name: nn, sponsorId: ns, isNewStar: isNS});
            refreshAllUI(); memberId = ni; document.getElementById('entryMember').value = ni;
            document.getElementById('quickNewMemName').value=''; document.getElementById('quickNewMemID').value=''; document.getElementById('quickNewMemSponsor').value='';
            checkMemberSelect();
        }

        let saved=0;
        const pv = parseFloat(document.getElementById('entryPV').value)||0;
        if(pv>0) {
            const bvVal = document.getElementById('entryBV').value;
            
            // V3.5 Collect Products
            let products = [];
            document.querySelectorAll('.product-row').forEach(row => {
                const pname = row.querySelector('.prod-name').value.trim();
                const pqty = row.querySelector('.prod-qty').value.trim();
                if(pname) products.push({name: pname, qty: pqty || 1});
            });
            
            let detailStr = `æ¥­ç¸¾ (BV: ${bvVal})`;
            if(products.length > 0) {
                const prodStr = products.map(p => `${p.name}x${p.qty}`).join(', ');
                detailStr += ` | ğŸ“¦ ${prodStr}`;
            }

            logs.push({ 
                id: Date.now()+1, date, memberId, 
                type: 'sales', pv, 
                details: detailStr,
                products: products // Store raw data
            });
            saved++;
        }
        
        const nName = document.getElementById('newcomerName').value.trim();
        if(nName) {
            const nID = document.getElementById('newcomerID').value.trim();
            const nBV = parseFloat(document.getElementById('newcomerBV').value)||0;
            const uplineId = document.getElementById('newcomerUpline').value || memberId;
            
            if(!nID) return alert("è«‹è¼¸å…¥æ–°äººç·¨è™Ÿ");
            if(!members.find(m=>m.id===nID)) {
                const uplineObj = members.find(m=>m.id===uplineId);
                const inheritSponsor = uplineObj ? uplineObj.sponsorId : "";
                members.push({id: nID, name: nName, sponsorId: inheritSponsor, isNewStar: true}); 
            }
            logs.push({
                id: Date.now()+2, date, memberId, 
                type: 'newcomer', pv: 0, 
                details: `æ¨è–¦: ${nName}`, 
                newcomerData: { name: nName, id: nID, bv: nBV, uplineId: uplineId } 
            });
            saved++;
        }
        
        if(document.getElementById('learningFileCheck').checked) {
            logs.push({ id: Date.now()+3, date, memberId, type: 'learning', pv: 0, details: "å¿ƒå¾—å·²ç¹³", isLearning: true });
            saved++;
        }
        if(saved===0) return alert("ç„¡è³‡æ–™");
        saveToLocal(); alert("å„²å­˜æˆåŠŸ");
        
        document.getElementById('entryPV').value=''; document.getElementById('entryBV').value='';
        document.getElementById('newcomerName').value=''; document.getElementById('newcomerID').value=''; document.getElementById('newcomerBV').value='';
        document.getElementById('learningNote').value=''; document.getElementById('learningFileCheck').checked=false;
        // Clear products
        document.getElementById('productContainer').innerHTML = '';
        
        updateInstantCalc();
    }

    // --- Helpers (V3.4 Updates) ---
    function checkMemberSelect() { document.getElementById('quickAddMemberBox').style.display = (document.getElementById('entryMember').value === 'new_mode') ? 'block' : 'none'; }
    function autoConvert(s, c) { 
        const p=document.getElementById(c==='entry'?'entryPV':'calcPV'), b=document.getElementById(c==='entry'?'entryBV':'calcBV');
        if(s==='pv') b.value=(parseFloat(p.value)||0)*50; else p.value=(parseFloat(b.value)||0)/50; 
    }
    function updateNewcomerUplineSelect() {
        const curMem = document.getElementById('entryMember').value;
        const sel = document.getElementById('newcomerUpline');
        let h = members.map(m => `<option value="${m.id}">${m.name} (${m.id})</option>`).join('');
        sel.innerHTML = h;
        if(curMem && curMem!=='new_mode') sel.value = curMem;
    }
    
    // V3.4: Filtered Selection
    function updateMemberSelects() {
        const cur = document.getElementById('entryMember').value;
        
        // 1. Entry Dropdown: Only Participating Members
        const activeMembers = members.filter(m => m.isNewStar);
        let entryHtml = '<option value="" disabled selected>-- é¸æ“‡æ“ä½œæœƒå“¡ (åƒ…é™åƒåŠ ä¸­) --</option>';
        entryHtml += '<option value="new_mode" style="color:blue;">â• å»ºç«‹æ–°æœƒå“¡...</option>';
        entryHtml += activeMembers.map(m => `<option value="${m.id}">${m.name} (${m.id})</option>`).join('');
        document.getElementById('entryMember').innerHTML = entryHtml;
        
        if(cur && (cur === 'new_mode' || activeMembers.find(m=>m.id===cur))) {
            document.getElementById('entryMember').value = cur;
        }

        // 2. Filter Dropdown: All Members
        document.getElementById('filterMember').innerHTML = '<option value="all">å…¨éƒ¨æœƒå“¡</option>' + members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
        updateNewcomerUplineSelect();
    }

    // V3.4: Render Logs with Newcomer Bonus & BV
    function renderLogs() {
        const fm=document.getElementById('filterMonth').value, fmem=document.getElementById('filterMember').value;
        let d = logs.filter(l=> (!fm||l.date.startsWith(fm)) && (fmem==='all'||l.memberId===fmem));
        d.sort((a,b)=>new Date(b.date)-new Date(a.date));
        
        const typeMap = { 'sales': 'éŠ·å”®', 'newcomer': 'æ¨è–¦', 'learning': 'å­¸ç¿’' };
        
        document.querySelector('#logTable tbody').innerHTML = d.length ? d.map(l=>{
            const m = members.find(x=>x.id===l.memberId)?.name || l.memberId;
            let cls = l.type==='sales'?'badge-sales':(l.type==='newcomer'?'badge-new':'badge-learn');
            
            // Value Logic V3.4
            let valDisplay = '-';
            if(l.type === 'sales') {
                valDisplay = `${(l.pv||0).toLocaleString()} PV`;
            } else if (l.type === 'newcomer' && l.newcomerData) {
                const nbv = l.newcomerData.bv || 0;
                const bonus = Math.round(nbv * 0.01);
                valDisplay = `<div>æ–°äººBV: ${nbv.toLocaleString()}</div><div style="color:#e67e22; font-size:0.85rem; font-weight:bold;">æ¨è–¦çé‡‘: $${bonus.toLocaleString()}</div>`;
            } else if (l.type === 'learning') {
                valDisplay = `<span style="color:#10b981;">è§¸ç™¼ +3%</span>`;
            }

            return `<tr><td>${l.date}</td><td>${m}</td><td><span class="badge ${cls}">${typeMap[l.type]}</span></td><td>${l.details}</td><td>${valDisplay}</td><td><button onclick="deleteLog(${l.id})" style="color:red;border:none;background:none"><i class="fas fa-trash"></i></button></td></tr>`;
        }).join('') : '<tr><td colspan="6" style="text-align:center">ç„¡ç´€éŒ„</td></tr>';
    }

    function updateInstantCalc() {
        // Simple preview (Full logic is in calculateMonthlyStats)
        const tel = document.getElementById('ibTotalVal');
        tel.innerText = "-"; 
    }

    function saveToLocal() { localStorage.setItem('amway_members', JSON.stringify(members)); localStorage.setItem('amway_logs', JSON.stringify(logs)); localStorage.setItem('amway_sponsors', JSON.stringify(sponsors)); saveToCloud(); }
    function deleteMember(id){ if(confirm("åˆªé™¤?")) { members=members.filter(m=>m.id!==id); saveToLocal(); refreshAllUI(); } }
    function deleteLog(id){ if(confirm("åˆªé™¤?")) { logs=logs.filter(l=>l.id!==id); saveToLocal(); refreshAllUI(); } }
    
    function populateMonthSelect() {
        const s = document.getElementById('dashMonthSelect'); s.innerHTML='';
        for(let i=1;i<=12;i++) { let v=`2026-${i.toString().padStart(2,'0')}`; let o=document.createElement('option'); o.value=v; o.text=`2026å¹´ ${i}æœˆ`; s.appendChild(o); }
        let now=new Date().toISOString().slice(0,7); if(now.startsWith('2026')) s.value=now;
    }

    // Calculation (Roll-up)
    function calculateMonthlyStats(monthStr) {
        const monthLogs = logs.filter(l => l.date.startsWith(monthStr));
        let personalSalesMap = {};
        let personalNewcomersMap = {};
        let personalLearningMap = {};
        let childrenMap = {}; 
        
        logs.filter(l => l.type === 'newcomer').forEach(l => {
            const childData = l.newcomerData;
            const parentId = childData.uplineId || l.memberId;
            if(!childrenMap[parentId]) childrenMap[parentId] = [];
            if(!childrenMap[parentId].includes(childData.id)) childrenMap[parentId].push(childData.id);
        });

        members.forEach(m => { personalSalesMap[m.id]=0; personalNewcomersMap[m.id]=[]; personalLearningMap[m.id]=false; });

        monthLogs.forEach(l => {
            if(l.type === 'sales') { if(personalSalesMap[l.memberId]!==undefined) personalSalesMap[l.memberId]+=l.pv; }
            else if (l.type === 'newcomer') { if(personalNewcomersMap[l.memberId]) personalNewcomersMap[l.memberId].push(l.newcomerData); }
            else if (l.type === 'learning') { if(personalLearningMap[l.memberId]!==undefined) personalLearningMap[l.memberId]=true; }
        });

        function calculateGroupPV(memId) {
            let total = personalSalesMap[memId] || 0;
            const children = childrenMap[memId] || [];
            children.forEach(childId => {
                const childMem = members.find(m => m.id === childId);
                const childGroupPV = calculateGroupPV(childId);
                if (childMem && !childMem.isNewStar) { total += childGroupPV; }
            });
            return total;
        }

        let res = [];
        members.forEach(m => {
            const effectivePV = calculateGroupPV(m.id);
            // V3.4 Filter: Only show active participants in dashboard if they have PV or activity
            if (!m.isNewStar && effectivePV === 0) return; 

            const c = calculateBonusLogic(effectivePV, effectivePV*50, personalNewcomersMap[m.id].length>0, personalNewcomersMap[m.id], personalLearningMap[m.id]);
            res.push({ ...m, pv: effectivePV, bonus: c.total, isGraduated: c.isGraduated, detailsText: c.detailsText });
        });
        res.sort((a,b)=>b.bonus-a.bonus); return res;
    }

    function calculateBonusLogic(pv, bv, isRec, news, hasLearn) {
        if(pv>=1000) return {total:0, isGraduated:true, detailsText:"å·²ç•¢æ¥­", breakdown:{base:0,new:0,learn:0}};
        let rate = (pv>=600) ? (isRec?0.02:0.01) : (isRec?0.04:0.03);
        let rateTxt = (pv>=600) ? (isRec?"6%+2%":"6%+1%") : (isRec?"4%":"3%");
        let base = bv * rate; let nBonus = 0; news.forEach(n=> nBonus += n.bv*0.01);
        let sub = base + nBonus; let lBonus = hasLearn ? sub*0.03 : 0;
        let txt = `R:${rateTxt}`; if(news.length) txt+=`|æ–°+${Math.round(nBonus)}`; if(hasLearn) txt+=`|å­¸+3%`;
        return {total:Math.floor(sub+lBonus), isGraduated:false, detailsText:txt, breakdown:{base, new:nBonus, learn:lBonus}};
    }
    function renderDashboard() {
        const m = document.getElementById('dashMonthSelect').value; const stats = calculateMonthlyStats(m);
        document.getElementById('totalPVDisplay').innerText = stats.reduce((a,b)=>a+b.pv,0).toLocaleString();
        document.getElementById('totalBonusDisplay').innerText = "$"+stats.reduce((a,b)=>a+b.bonus,0).toLocaleString();
        document.getElementById('activeMembersDisplay').innerText = `${stats.length}/${members.filter(m=>m.isNewStar).length}`;
        const tb = document.querySelector('#rankingTable tbody');
        tb.innerHTML = stats.length ? stats.slice(0,10).map((s,i)=>`<tr><td>${i+1}</td><td>${s.name}</td><td>${s.pv.toLocaleString()}</td><td style="font-size:0.8rem;color:#666">${s.detailsText}</td><td style="font-weight:bold;color:#ff9900">${s.isGraduated?"ç•¢æ¥­":'$'+s.bonus.toLocaleString()}</td></tr>`).join('') : '<tr><td colspan="5" style="text-align:center">ç„¡è³‡æ–™</td></tr>';
    }
    function runSimulation() {
        let pv=parseFloat(document.getElementById('calcPV').value)||0; let bv=parseFloat(document.getElementById('calcBV').value)||0;
        let part=parseFloat(document.getElementById('calcPartners').value)||0; let nbv=parseFloat(document.getElementById('calcNewcomerBV').value)||0;
        let learn=document.getElementById('calcHasLearned').checked; let news=[]; if(nbv>0) news.push({bv:nbv});
        let res = calculateBonusLogic(pv, bv, part>0, news, learn);
        if(res.isGraduated) { document.getElementById('simGraduateMsg').style.display='block'; document.getElementById('simValTotal').innerText="ç•¢æ¥­"; }
        else { document.getElementById('simGraduateMsg').style.display='none'; document.getElementById('simValTotal').innerText=res.total.toLocaleString(); }
    }
    function exportData(){ const d={members, logs, sponsors, version:"Pro_2026_v3.4"}; const u=URL.createObjectURL(new Blob([JSON.stringify(d)],{type:"application/json"})); const a=document.createElement('a'); a.href=u; a.download=`NewStar_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    function importData(i){ const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); if(d.members&&d.logs&&confirm("è¦†è“‹?")){members=d.members;logs=d.logs;sponsors=d.sponsors||[]; saveToLocal();location.reload();} }catch(e){alert("éŒ¯èª¤");} }; r.readAsText(f); }
    
    // --- Network Logic (Must be included to avoid error) ---
    function renderNetwork() {
        const treeContainer = document.getElementById('treeContainer');
        if(!treeContainer) return; // Guard
        const listBody = document.querySelector('#referralTable tbody');
        let parentMap = {}; let childrenMap = {}; let referralList = [];
        logs.filter(l => l.type === 'newcomer').forEach(l => {
            const childData = l.newcomerData; const parentId = childData.uplineId || l.memberId; 
            if (parentMap[childData.id] !== parentId) {
                parentMap[childData.id] = parentId;
                if(!childrenMap[parentId]) childrenMap[parentId] = [];
                if(!childrenMap[parentId].some(c => c.id === childData.id)) {
                    childrenMap[parentId].push({ id: childData.id, name: childData.name, date: l.date });
                }
                const pName = members.find(m=>m.id===parentId)?.name || parentId;
                referralList.push({ date: l.date, parent: `${pName} (${parentId})`, child: `${childData.name} (${childData.id})` });
            }
        });
        referralList.sort((a,b) => new Date(b.date) - new Date(a.date));
        listBody.innerHTML = referralList.length ? referralList.map(r => `<tr><td>${r.date}</td><td style="color:#0066cc; font-weight:bold;">${r.parent}</td><td>${r.child}</td></tr>`).join('') : '<tr><td colspan="3" style="text-align:center">å°šç„¡æ¨è–¦ç´€éŒ„</td></tr>';
        if(sponsors.length === 0) { treeContainer.innerHTML = "<div style='padding:20px; color:#666;'>è«‹å…ˆå»ºç«‹ã€Œç™¼èµ·äººã€è³‡æ–™ã€‚</div>"; return; }
        function buildTree(memberId, memberName, date) {
            let html = `<div class="tree-node"><div class="tree-content"><i class="fas fa-user" style="color:#555"></i><div class="tree-name">${memberName}</div><div class="tree-id">#${memberId}</div></div>`;
            if(date) html += `<div style="position:relative"><span style="position:absolute; left:35px; top:-8px; font-size:0.7rem; color:#999;"><i class="far fa-clock"></i> ${date} åŠ å…¥</span></div>`;
            if(childrenMap[memberId]) { childrenMap[memberId].forEach(child => { html += buildTree(child.id, child.name, child.date); }); }
            html += `</div>`; return html;
        }
        let fullHtml = "";
        sponsors.forEach(sp => {
            const roots = members.filter(m => { if(m.sponsorId !== sp.id) return false; const uplineId = parentMap[m.id]; if(!uplineId) return true; return false; });
            if(roots.length > 0) {
                fullHtml += `<div class="tree-node tree-root"><div class="tree-content"><i class="fas fa-crown"></i><div class="tree-name">${sp.name}</div></div>`;
                roots.forEach(root => { fullHtml += buildTree(root.id, root.name, null); });
                fullHtml += `</div>`;
            }
        });
        if(!fullHtml) fullHtml = "<div style='padding:20px; color:#999;'>å°šç„¡çµ„ç¹”çµæ§‹ã€‚</div>";
        treeContainer.innerHTML = fullHtml;
    }

    function clearAllData() { if(prompt("è¼¸å…¥DELETEç¢ºèª")!=='DELETE')return; localStorage.clear(); members=[]; logs=[]; sponsors=[]; saveToCloud(); alert("å·²æ¸…é™¤"); location.reload(); }
    function exportPDF(){const e=document.getElementById('dashboard');html2pdf().set({margin:0.2,filename:'Report.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'in',format:'a4',orientation:'landscape'}}).from(e).save();}
</script>
</body>
</html>
