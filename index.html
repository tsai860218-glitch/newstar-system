<!DOCTYPE
html>
<html
lang="zh-TW">
<head>
Â Â Â 
<meta charset="UTF-8"> 
Â Â Â 
<meta name="viewport" 
content="width=device-width,
initial-scale=1.0, maximum-scale=1.0, 
user-scalable=no,
viewport-fit=cover"> 
Â Â Â 
<title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ± (v10.4æœ€çµ‚ä¿®å¾©ç‰ˆ)</title> 
Â Â Â 
Â Â Â 
<link rel="icon" 
type="image/svg+xml"
href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' 
viewBox='0
0 100 100'%3E%3Ctext y='0.9em' 
font-size='90'%3E%F0%9F%9A%80%3C/text%3E%3C/svg%3E">
Â Â Â 
<link rel="apple-touch-icon" 
href="data:image/svg+xml,%3Csvg
xmlns='http://www.w3.org/2000/svg' 
viewBox='0
0 180 180'%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' 
font-size='120'%3E%F0%9F%9A%80%3C/text%3E%3C/svg%3E">
Â 
Â Â Â 
<script 
src="https://cdn.tailwindcss.com"></script>
Â Â Â 
<script> 
Â Â Â Â Â Â Â 
tailwind.config = { 
Â Â Â Â Â Â Â Â Â Â Â 
theme: { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
extend: { 
Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â colors: { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
background: 
'rgb(var(--background)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
foreground: 
'rgb(var(--foreground)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
card: 'rgb(var(--card) 
/
<alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â 'card-foreground': 
'rgb(var(--card-foreground)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
border: 
'rgb(var(--border)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
muted: 
'rgb(var(--muted)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
'muted-foreground': 'rgb(var(--muted-foreground) 
/
<alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
primary: 
'rgb(var(--primary)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
'primary-foreground': 
'rgb(var(--primary-foreground)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
secondary: 'rgb(var(--secondary) 
/
<alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
'secondary-foreground': 
'rgb(var(--secondary-foreground)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
accent: 
'rgb(var(--accent)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
destructive: 
'rgb(var(--destructive)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
success: 
'rgb(var(--success)
/ <alpha-value>)', 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
warning: 
'rgb(var(--warning)
/ <alpha-value>)' 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
}, 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
fontFamily: { sans: 
['Inter',
'Microsoft JhengHei', 'sans-serif'] }, 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â 
} 
Â Â Â 
</script> 
Â Â Â 
<link 
href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
rel="stylesheet">
Â Â Â 
Â Â Â 
<script 
src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
Â Â Â 
<script
src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
Â Â Â 
<script 
src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
Â 
Â Â Â 
<style> 
Â Â Â Â Â Â Â 
:root { 
Â Â Â Â Â Â Â Â Â Â Â 
--authbar-h: 52px; --authbar-gap: 
16px; 
Â Â Â Â Â Â Â Â Â Â Â 
/* Dark Mode (Default) */ 
Â Â Â Â Â Â Â Â Â Â Â 
--background: 10 10 11; 
--foreground:
250 250 250; 
Â Â Â Â Â Â Â Â Â Â Â 
--card: 24 24 27; 
--card-foreground:
250 250 250; 
Â Â Â Â Â Â Â Â Â Â Â 
--border: 39 39 42; --muted: 39 39 
42;
--muted-foreground: 161 161 170; 
Â Â Â Â Â Â Â Â Â Â Â 
--primary: 16 185 129; 
--primary-foreground:
2 44 34; 
Â Â Â Â Â Â Â Â Â Â Â 
--secondary: 39 39 42; 
--secondary-foreground:
250 250 250; 
Â Â Â Â Â Â Â Â Â Â Â 
--accent: 16 185 129; 
--destructive:
239 68 68; --success: 16 185 129; --warning: 245 158 11; 
Â Â Â Â Â Â Â Â Â Â Â 
--hover: 255 255 255; --shadow: 0 0 
0; 
Â Â Â Â Â Â Â Â Â Â Â 
/* Org Chart - Dark */ 
Â Â Â Â Â Â Â Â Â Â Â 
--org-line: 63 63 70; 
--org-node-bg:
24 24 27; --org-node-border: 82 82 91; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-node-hover-border: 113 113 
122;
--org-toggle-bg: 255 255 255; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-text: 250 250 250; --org-subtext: 
161
161 170; --org-chip-bg: 255 255 255; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-line-alpha: 0.55; 
--org-line-w:
1.5px; --org-line-w-strong: 2px; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-node-shadow: 0 12px 28px 
rgba(0,0,0,.28);
--org-node-shadow-hover: 0 18px 42px rgba(0,0,0,.36); 
Â Â Â Â Â Â Â Â Â 
Â Â --org-badge-direct-bg: 16 185 129; 
--org-badge-member-bg:
59 130 246; --org-badge-fg: 2 44 34; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-highlight: 234 179 8; 
Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â 
:root[data-theme="light"] { 
Â Â Â Â Â Â Â Â Â Â Â 
--background: 246 247 251; 
--foreground:
15 23 42; 
Â Â Â Â Â Â Â Â Â Â Â 
--card: 255 255 255; 
--card-foreground:
15 23 42; 
Â Â Â Â Â Â Â Â Â Â Â 
--border: 229 231 235; --muted: 241 
245
249; --muted-foreground: 100 116 139; 
Â Â Â Â Â Â Â Â Â Â Â 
--primary: 16 185 129; --primary-foreground: 
2 44
34; 
Â Â Â Â Â Â Â Â Â Â Â 
--secondary: 241 245 249; 
--secondary-foreground:
15 23 42; 
Â Â Â Â Â Â Â Â Â Â Â 
--accent: 16 185 129; 
--destructive:
239 68 68; --success: 16 185 129; --warning: 245 158 11; 
Â Â Â Â Â Â Â Â Â Â Â 
--hover: 0 0 0; --shadow: 0 0 0; 
Â Â Â Â Â Â Â 
Â Â Â Â /* Org Chart - Light */ 
Â Â Â Â Â Â Â Â Â Â Â 
--org-line: 203 213 225; 
--org-node-bg:
255 255 255; --org-node-border: 148 163 184; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-node-hover-border: 100 116 
139;
--org-toggle-bg: 0 0 0; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-text: 15 23 42; 
--org-subtext:
100 116 139; --org-chip-bg: 0 0 0; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-line-alpha: 0.85; 
--org-line-w:
1.5px; --org-line-w-strong: 2px; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-node-shadow: 0 10px 24px 
rgba(0,0,0,.10);
--org-node-shadow-hover: 0 16px 34px rgba(0,0,0,.14); 
Â Â Â Â Â Â Â Â Â Â Â 
--org-badge-direct-bg: 16 185 129; 
--org-badge-member-bg:
37 99 235; --org-badge-fg: 255 255 255; 
Â Â Â Â Â Â Â Â Â Â Â 
--org-highlight: 234 179 8; 
Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â 
* { box-sizing: border-box; 
-webkit-tap-highlight-color:
transparent; } 
Â Â Â Â Â Â Â 
body { margin: 0; background-color: 
rgb(var(--background));
color: rgb(var(--foreground)); overflow: hidden; 
height:
100vh; height: calc(var(--vh, 1vh) * 100); display: flex; font-family: 
'Inter',
'Microsoft JhengHei', sans-serif; } 
Â Â Â Â Â Â Â 
::-webkit-scrollbar { width: 6px; 
height:
6px; } 
Â Â Â Â Â 
Â Â ::-webkit-scrollbar-track { background: 
transparent;
} 
Â Â Â Â Â Â Â 
::-webkit-scrollbar-thumb { background: 
rgb(var(--border));
border-radius: 3px; } 
Â Â Â Â Â Â Â 
::-webkit-scrollbar-thumb:hover { 
background:
rgb(var(--muted-foreground)); } 
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â 
aside { width: 260px; background: 
linear-gradient(180deg,
rgb(var(--card)) 0%, rgb(var(--background)) 100%); 
color:
rgb(var(--foreground)); display: flex; flex-direction: column; 
flex-shrink:
0; z-index: 1000; height: 100%; transition: transform 0.3s 
cubic-bezier(0.4,
0, 0.2, 1); border-right: 1px solid rgb(var(--border)); } 
Â Â Â Â Â Â Â 
aside.collapsed { width: 0; opacity: 0; 
overflow:
hidden; } 
Â Â Â Â Â Â Â 
.sidebar-scroll { flex: 1; overflow-y: 
auto;
-webkit-overflow-scrolling: touch; padding: 8px 0; } 
Â Â Â Â Â Â Â 
.nav-group-title { padding: 10px 16px; 
color:
rgb(var(--muted-foreground)); font-size: 0.75rem; font-weight: 600; 
cursor:
pointer; display: flex; justify-content: space-between; align-items: 
center;
transition: color 0.2s; user-select: none; text-transform: uppercase; 
letter-spacing:
0.05em; } 
Â Â Â Â Â Â Â 
.nav-group-title:hover { color: 
rgb(var(--foreground));
} 
Â Â Â Â Â Â Â 
.nav-group-title::after { content: ''; 
width:
0; height: 0; border-left: 4px solid transparent; border-right: 4px 
solid
transparent; border-top: 5px solid currentColor; transition: transform 
0.2s;
} 
Â Â Â Â Â Â Â 
.nav-group.collapsed 
.nav-group-title::after
{ transform: rotate(-90deg); } 
Â Â Â Â Â Â Â 
.nav-items { max-height: 500px; 
overflow:
hidden; transition: max-height 0.3s ease-out; } 
Â Â Â Â Â Â Â 
.nav-group.collapsed .nav-items { 
max-height:
0; } 
Â Â Â Â Â Â Â 
.nav-item { display: flex; align-items: 
center;
gap: 10px; padding: 10px 16px 10px 20px; color: #a1a1aa; 
text-decoration:
none; font-size: 0.875rem; cursor: pointer; transition: all 
0.15s;
border-radius: 6px; margin: 2px 8px; } 
Â Â Â Â Â Â Â 
.nav-item:hover { color: 
rgb(var(--foreground));
background: rgb(var(--hover) / 0.06); } 
Â Â Â Â Â Â Â 
.nav-item.active { color: #10b981; 
background:
rgba(16, 185, 129, 0.1); } 
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â 
main { flex: 1; height: 100%; 
overflow-y:
auto; -webkit-overflow-scrolling: touch; padding: 24px; 
padding-top:
calc(24px + var(--authbar-h) + var(--authbar-gap)); position: 
relative;
background-color: rgb(var(--background)); } 
Â Â Â Â Â Â Â 
@media (max-width: 1023px) { 
Â Â Â Â Â Â Â Â Â Â Â 
.menu-btn { display: flex 
!important;
} 
Â Â Â Â Â Â Â Â Â Â Â 
aside { position: fixed; top: 0; 
left:
0; bottom: 0; transform: translateX(-100%); box-shadow: 4px 0 20px 
rgba(0,0,0,0.5);
} 
Â Â Â Â Â Â Â Â Â Â Â 
aside.open { transform: 
translateX(0);
} 
Â Â Â Â Â Â Â Â Â Â Â 
#drawer-overlay { position: fixed; 
top:
0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 
999;
opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: 
blur(4px);
} 
Â Â Â Â Â Â Â Â Â Â Â 
#drawer-overlay.visible { opacity: 
1;
visibility: visible; } 
Â Â Â Â Â Â Â 
} 
Â 
Â Â Â Â Â Â Â 
.switch { position: relative; display: 
inline-block;
width: 44px; height: 24px; vertical-align: middle; flex-shrink: 
0; } 
Â Â Â Â Â Â Â 
.switch input { opacity: 0; width: 0; 
height:
0; } 
Â Â Â Â Â Â Â 
.slider { position: absolute; cursor: 
pointer;
top: 0; left: 0; right: 0; bottom: 0; background-color: #3f3f46; 
transition:
.3s; border-radius: 24px; } 
Â Â Â Â Â Â Â 
.slider:before { position: absolute; 
content:
""; height: 18px; width: 18px; left: 3px; bottom: 3px; 
background-color:
white; transition: .3s; border-radius: 50%; } 
Â Â Â Â Â Â Â 
input:checked + .slider { 
background-color:
#10b981; } 
Â Â Â Â Â Â Â 
input:checked + .slider:before { 
transform:
translateX(20px); } 
Â Â Â Â Â Â Â 
.switch-sm { position: relative; 
display:
inline-block; width: 36px; height: 20px; vertical-align: middle; 
flex-shrink:
0; } 
Â Â Â Â Â Â Â 
.switch-sm input { opacity: 0; width: 
0;
height: 0; } 
Â Â Â Â Â Â Â 
.slider-sm { position: absolute; 
cursor:
pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: 
#3f3f46;
transition: .3s; border-radius: 20px; } 
Â Â Â Â Â Â Â 
.slider-sm:before { position: absolute; 
content:
""; height: 14px; width: 14px; left: 3px; bottom: 3px;
background-color: 
white;
transition: .3s; border-radius: 50%; } 
Â Â Â Â Â Â Â 
input:checked + .slider-sm { 
background-color:
#10b981; } 
Â Â Â Â Â Â Â 
input:checked + .slider-sm:before { 
transform:
translateX(16px); } 
Â 
Â Â Â Â Â Â Â 
table { width: 100%; border-collapse: 
collapse;
font-size: 0.875rem; } 
Â Â Â Â Â Â Â 
th, td { padding: 12px 16px; 
text-align:
left; vertical-align: middle; } 
Â Â Â Â Â Â Â 
th { background: rgb(var(--card)); 
color:
rgb(var(--muted-foreground)); font-weight: 500; font-size: 0.75rem; 
text-transform:
uppercase; letter-spacing: 0.05em; border-bottom: 1px solid 
rgb(var(--border));
} 
Â Â Â Â Â Â Â 
td { border-bottom: 1px solid 
rgb(var(--border));
} 
Â Â Â Â Â Â Â 
tr:hover td { background: 
rgb(var(--hover)
/ 0.03); } 
Â Â Â Â Â Â Â 
tr:last-child td { border-bottom: none; 
} 
Â 
Â Â Â Â Â Â Â 
.modal { display: none; position: 
fixed;
z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: 
rgba(0,0,0,0.8);
backdrop-filter: blur(4px); } 
Â Â Â Â Â Â Â 
.modal-content { background: 
rgb(var(--card));
margin: 5vh auto; width: 95%; max-width: 1100px; 
border-radius:
16px; max-height: 90vh; display: flex; flex-direction: column; 
overflow:
hidden; border: 1px solid rgb(var(--border)); box-shadow: 0 25px 50px 
-12px
rgba(0, 0, 0, 0.5); } 
Â Â Â Â Â Â Â 
.modal-header { padding: 20px 24px; 
border-bottom:
1px solid rgb(var(--border)); display: flex; justify-content: 
space-between;
align-items: center; } 
Â Â Â Â Â Â Â 
.modal-body { padding: 24px; overflow-y: 
auto;
flex: 1; background: rgb(var(--background)); -webkit-overflow-scrolling: 
touch;
} 
Â 
Â Â Â Â Â Â Â 
.form-input, .form-control { width: 
100%;
padding: 10px 14px; background: rgb(var(--card)); border: 1px solid 
rgb(var(--border));
border-radius: 8px; color: rgb(var(--foreground)); 
font-size:
0.875rem; transition: all 0.15s; margin-bottom: 5px; } 
Â Â Â Â Â Â Â 
.form-input:focus, .form-control:focus 
{
outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 
129,
0.1); } 
Â Â Â Â Â Â Â 
.form-input::placeholder { color: 
rgb(var(--muted-foreground));
} 
Â Â Â Â Â Â Â 
select.form-input { appearance: none; 
background-image:
url("data:image/svg+xml,%3csvg 
xmlns='http://www.w3.org/2000/svg'
fill='none' viewBox='0 0 20 20'%3e%3cpath 
stroke='%236b7280'
stroke-linecap='round' stroke-linejoin='round' 
stroke-width='1.5'
d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: 
right
10px center; background-repeat: no-repeat; background-size: 16px; 
padding-right:
36px; } 
Â Â Â Â Â Â Â 
.row { display: flex; gap: 15px; 
flex-wrap:
wrap; margin-bottom:10px; } .col { flex: 1; min-width: 150px; } 
Â 
Â Â Â Â Â Â Â 
#loading { position: fixed; inset: 0; 
background:
#0a0a0b; display: flex; justify-content: center; align-items: 
center;
z-index: 3000; flex-direction: column; color:white; } 
Â Â Â Â Â Â Â 
.spinner { width: 40px; height: 40px; 
border:
4px solid rgba(255,255,255,0.1); border-left-color: #10b981; 
border-radius:
50%; animation: spin 1s linear infinite; margin-bottom: 10px; } 
Â Â Â Â Â Â Â 
@keyframes spin { to { transform: 
rotate(360deg);
} } 
Â Â Â Â Â Â Â 
#loginOverlay { position: fixed; inset: 
0;
background: rgba(0,0,0,.85); z-index: 99998; display: flex; align-items: 
center;
justify-content: center; backdrop-filter: blur(5px); } 
Â Â Â Â Â Â Â 
.login-card { width: min(420px, 92vw); 
background:
#18181b; border: 1px solid #27272a; border-radius: 16px; padding: 
30px;
text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,.5); } 
Â 
Â Â Â Â Â Â Â 
.auth-buttons{ position: fixed; top: 
max(10px,
env(safe-area-inset-top)); right: max(10px, 
env(safe-area-inset-right));
z-index: 99999; display: flex; align-items: 
center;
gap: 8px; padding: 6px; border-radius: 14px; background: 
rgba(10,10,11,.55);
border: 1px solid rgba(255,255,255,.08); backdrop-filter: 
blur(10px);
} 
Â Â Â Â Â Â Â 
.auth-buttons button{ padding: 7px 
12px;
border-radius: 12px; font-weight: 700; cursor: pointer; border: 1px solid 
transparent;
font-size: 0.78rem; line-height: 1; display: inline-flex; 
align-items:
center; gap: 6px; transition: transform .12s ease, background .12s 
ease,
border-color .12s ease, opacity .12s ease; } 
Â Â Â Â Â Â Â 
.auth-buttons button:active{ transform: 
scale(.97);
} 
Â Â Â Â Â Â Â 
.user-email{ max-width: 140px; padding: 
7px
10px; border-radius: 12px; background: rgba(39,39,42,.8); color: #d4d4d8; 
font-size:
.78rem; font-weight: 800; border: 1px solid rgba(255,255,255,.10); 
white-space:
nowrap; overflow: hidden; text-overflow: ellipsis; } 
Â Â Â Â Â Â Â 
.login-btn{ background: #10b981; color: 
#022c22;
} 
Â Â Â Â Â Â Â 
.logout-btn{ background: 
rgba(39,39,42,.85);
color: #f87171; border-color: rgba(255,255,255,.10) 
!important;
} 
Â Â Â Â Â Â Â 
.logout-btn:hover{ border-color: 
rgba(248,113,113,.35)
!important; } 
Â Â Â Â Â Â Â 
@media (max-width: 420px){ :root { 
--authbar-h:
58px; } .auth-buttons{ right: 8px; top: max(8px, 
env(safe-area-inset-top));
gap: 6px; padding: 5px; } .user-email{ max-width: 
95px;
font-size: .72rem; } .auth-buttons button{ padding: 7px 10px; font-size: 
.72rem;
} } 
Â 
Â Â Â Â Â Â Â 
/* Org Chart */ 
Â Â Â Â Â Â Â 
.org-container { overflow: auto; width: 
100%;
height: 600px; background: rgb(var(--card)); border-radius: 12px; 
position:
relative; cursor: grab; touch-action: none; user-select: none; 
border:
1px solid rgb(var(--border)); } 
Â Â Â Â Â Â Â 
.org-container:active { cursor: 
grabbing;
} 
Â Â Â Â Â Â Â 
.tree { transform-origin: 0 0; 
will-change:
transform; display: inline-block; min-width: 100%; padding: 40px; 
box-sizing:
border-box; } 
Â Â Â Â Â Â Â 
.tree ul { padding-top: 20px; position: 
relative;
transition: .3s; display: table; margin: 0 auto; white-space: nowrap; 
} 
Â Â Â Â Â Â Â 
.tree li { float: none; display: 
table-cell;
vertical-align: top; text-align: center; list-style-type: none; 
position:
relative; padding: 20px 5px 0 5px; } 
Â Â Â Â Â Â Â 
.tree li::before, .tree li::after { 
content:
''; position: absolute; top: 0; right: 50%; border-top: 
var(--org-line-w)
solid rgb(var(--org-line) / var(--org-line-alpha)); width: 
50%;
height: 20px; } 
Â Â Â Â Â Â Â 
.tree li::after { right: auto; left: 
50%;
border-left: var(--org-line-w) solid rgb(var(--org-line) / 
var(--org-line-alpha));
} 
Â Â Â Â Â Â Â 
.tree li:only-child::after, .tree 
li:only-child::before
{ display: none; } 
Â Â Â Â Â Â Â 
.tree li:only-child { padding-top: 0; } 
Â Â Â Â Â Â Â 
.tree li:first-child::before, .tree 
li:last-child::after
{ border: 0 none; } 
Â Â Â Â Â Â Â 
.tree li:last-child::before { 
border-right:
var(--org-line-w) solid rgb(var(--org-line) / 
var(--org-line-alpha));
border-radius: 0 10px 0 0; } 
Â Â Â Â Â Â Â 
.tree li:first-child::after { 
border-radius:
10px 0 0 0; } 
Â Â Â Â Â Â Â 
.tree ul ul::before { content: ''; 
position:
absolute; top: 0; left: 50%; border-left: var(--org-line-w-strong) 
solid
rgb(var(--org-line) / var(--org-line-alpha)); width: 0; height: 20px; } 
Â Â Â Â Â Â Â 
.tree li.collapsed > ul { display: 
none;
} 
Â Â Â Â Â Â Â 
.tree li.collapsed > .node .caret { 
transform:
rotate(-90deg); } 
Â Â Â Â Â Â Â 
.node { border: 1px solid 
rgb(var(--org-node-border));
text-decoration: none; color: 
rgb(var(--org-text));
font-size: 12px; display: inline-flex; align-items: stretch; 
border-radius:
12px; transition: transform 0.15s ease, box-shadow 0.15s ease, 
border-color
0.15s ease; min-width: 190px; position: relative; background: 
linear-gradient(180deg,
rgb(var(--org-node-bg)) 0%, rgb(var(--org-node-bg) / 
.92)
100%); z-index: 2; overflow: hidden; text-align: left; box-shadow: 
var(--org-node-shadow);
} 
Â Â Â Â Â Â Â 
.node:hover { transform: 
translateY(-2px);
z-index: 10; border-color: rgb(var(--org-node-hover-border)); 
box-shadow:
var(--org-node-shadow-hover); } 
Â Â Â Â Â Â Â 
.node.node-active { border-color: 
rgb(var(--primary));
background: linear-gradient(135deg, 
rgb(var(--org-node-bg))
0%, rgb(var(--primary) / 0.10) 100%); } 
Â Â Â Â Â Â Â 
.node.node-inactive { border-color: 
rgb(var(--border));
opacity: 0.65; } 
Â Â Â Â Â Â Â 
.node.node-highlight { border-color: 
rgb(var(--org-highlight))
!important; box-shadow: 0 0 20px 
rgb(var(--org-highlight)
/ 0.4) !important; animation: pulse-glow 1.5s 
infinite;
} 
Â Â Â Â Â Â Â 
@keyframes pulse-glow { 0% { 
box-shadow:
0 0 0 0 rgb(var(--org-highlight) / 0.4); } 70% { box-shadow: 0 0 0 
10px
rgb(var(--org-highlight) / 0); } 100% { box-shadow: 0 0 0 0 
rgb(var(--org-highlight)
/ 0); } } 
Â Â Â Â Â Â Â 
.node-toggle { width: 38px; background: 
rgb(var(--org-toggle-bg)
/ 0.06); border-right: 1px solid rgb(var(--border) / 
1);
display: flex; flex-direction: column; align-items: center; 
justify-content:
center; cursor: pointer; transition: background .2s; 
flex-shrink:
0; } 
Â Â Â Â Â Â Â 
.node-toggle:hover { background: 
rgb(var(--org-toggle-bg)
/ 0.10); } 
Â Â Â Â Â Â Â 
.caret { font-size: 12px; color: 
rgb(var(--org-subtext));
transition: transform 0.2s; } 
Â Â Â Â Â Â Â 
.count { font-size: 10px; color: 
rgb(var(--org-subtext));
margin-top: 2px; font-weight: 700; } 
Â Â Â Â Â Â Â 
.node-content { padding: 12px; flex: 1; 
cursor:
pointer; } 
Â Â Â Â Â Â Â 
.node-content .name { font-weight: 800; 
display:
block; margin-bottom: 4px; font-size: 13px; color: 
rgb(var(--org-text));
} 
Â Â Â Â Â Â Â 
.node-content .type { font-size: 10px; 
color:
rgb(var(--org-subtext)); background: rgb(var(--org-chip-bg) / 0.06); 
padding:
2px 8px; border-radius: 6px; display: inline-block; margin-bottom: 
8px;
border: 1px solid rgb(var(--border)); } 
Â Â Â Â Â Â Â 
.node-content .detail { font-size: 
11px;
color: rgb(var(--org-subtext)); border-top: 1px solid rgb(var(--border)); 
padding-top:
8px; margin-top: 8px; } 
Â Â Â Â Â Â Â 
.node-status { position: absolute; top: 
0;
right: 0; font-size: 9px; padding: 3px 8px; border-bottom-left-radius: 10px; 
font-weight:
800; letter-spacing: 0.02em; } 
Â Â Â Â Â Â Â 
.node-status.badge-direct { background: 
rgb(var(--org-badge-direct-bg));
color: rgb(var(--org-badge-fg)); } 
Â Â Â Â Â Â Â 
.node-status.badge-member { background: 
rgb(var(--org-badge-member-bg));
color: rgb(var(--org-badge-fg)); } 
Â Â Â 
</style> 
</head>
<body>
Â 
<div
class="auth-buttons">
Â Â Â 
<span id="userEmailBadge" 
class="user-email"
style="display:none;"></span> 
Â Â Â 
<button id="themeBtn" 
class="logout-btn"
onclick="toggleTheme()" 
type="button"
title="åˆ‡æ›æ·±/æ·ºæ¨¡å¼" style="display:none;">ğŸŒ“</button>
Â Â Â 
<button class="login-btn" 
onclick="login()">Googleç™»å…¥</button>
Â Â Â 
<button id="logoutBtn" 
class="logout-btn"
onclick="logout()" 
style="display:none;">ç™»å‡º</button> 
</div>
Â 
<div
id="loading"><div
class="spinner"></div><div>ç³»çµ±è¼‰å…¥ä¸­...</div></div> 
<div
id="drawer-overlay"
onclick="closeDrawer()"></div> 
Â 
<aside
id="sidebar">
Â Â Â 
<div class="px-4 py-5 border-b 
border-border
flex items-center gap-3"> 
Â Â Â Â Â Â Â 
<div class="w-9 h-9 rounded-lg 
bg-gradient-to-br
from-primary to-emerald-400 flex items-center 
justify-center">
Â Â Â Â Â Â Â Â Â Â Â 
<span 
style="font-size:1.2rem">ğŸš€</span>
Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-sm 
font-bold
text-foreground">æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-xs 
text-muted-foreground">ç®¡ç†ç³»çµ± v10.4</div> 
Â Â Â Â Â Â Â 
</div> 
Â Â Â 
</div> 
Â Â Â 
Â Â Â 
<div class="sidebar-scroll" 
id="sidebar-scroll-area">
Â Â Â Â Â Â Â 
<div class="nav-group" 
id="group-overview">
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-group-title"
onclick="toggleGroup('group-overview')">ç‡Ÿé‹ç¸½è¦½</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-items">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<a 
onclick="router('dashboard')"
id="nav-dashboard" 
class="nav-item">ğŸ“Š ç¸½è¦½å„€è¡¨æ¿</a> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<a 
onclick="router('payout')"
id="nav-payout" class="nav-item">ğŸ’° æœ¬æœˆç™¼æ”¾ç¸½è¡¨</a> 
Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
<div class="nav-group" 
id="group-records">
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-group-title"
onclick="toggleGroup('group-records')">æ¥­ç¸¾èˆ‡ç´€éŒ„</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-items"><a
onclick="router('records')" 
id="nav-records"
class="nav-item">ğŸ“ æœˆä»½æ¥­ç¸¾ç´€éŒ„</a></div> 
Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
<div class="nav-group" 
id="group-products">
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-group-title"
onclick="toggleGroup('group-products')">ç”¢å“ç®¡ç†</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-items">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<a 
onclick="router('catalog')"
id="nav-catalog" 
class="nav-item">ğŸ“¦ ç”¢å“è³‡æ–™åº«</a> 
Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
<div class="nav-group" 
id="group-partners">
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-group-title"
onclick="toggleGroup('group-partners')">äººå“¡ç®¡ç†</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-items">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<a 
onclick="router('partners')"
id="nav-partners" 
class="nav-item">ğŸ‘¥ å¤¥ä¼´åå–®ç®¡ç†</a> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<a 
onclick="router('initiators')"
id="nav-initiators" 
class="nav-item">ğŸ‘‘ ç™¼èµ·äººç®¡ç†</a> 
Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
<div class="nav-group" 
id="group-org">
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-group-title"
onclick="toggleGroup('group-org')">çµ„ç¹”çµæ§‹</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-items"><a
onclick="router('org')" 
id="nav-org"
class="nav-item">ğŸ§© çµ„ç¹”é—œè¯åœ–</a></div> 
Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
<div class="nav-group" 
id="group-settings">
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-group-title"
onclick="toggleGroup('group-settings')">ç³»çµ±è¨­å®š</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="nav-items">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<a onclick="router('versions')" 
id="nav-versions"
class="nav-item">âš–ï¸ è¨ˆç•«ç‰ˆæœ¬æ§ç®¡</a> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<a 
onclick="router('settings')"
id="nav-settings" 
class="nav-item">âš™ï¸ ç³»çµ±è¨­å®š</a> 
Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
</div> 
Â Â Â 
</div> 
</aside>
Â 
<main
id="app"></main>
Â 
<div
id="loginOverlay"
style="display:none;"> 
Â Â Â 
<div class="login-card"> 
Â Â Â Â Â Â Â 
<div class="w-16 h-16 
rounded-full
bg-primary/10 flex items-center justify-center mx-auto 
mb-4"><span
style="font-size:2rem">ğŸ”’</span></div> 
Â Â Â Â Â Â Â 
<h2 class="text-xl font-bold 
text-foreground
mb-2">æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ±</h2>
Â Â Â Â Â Â Â 
<p class="text-muted-foreground 
mb-6">è«‹å…ˆç™»å…¥ä»¥å­˜å–è³‡æ–™åº«</p> 
Â Â Â Â Â Â Â 
<button onclick="login()" 
class="w-full
py-3 bg-primary text-primary-foreground font-bold rounded-xl 
hover:bg-primary/90
transition-colors">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button> 
Â Â Â 
</div> 
</div>
Â 
<div
id="modal"
class="modal"> 
Â Â Â 
<div class="modal-content"> 
Â Â Â Â Â Â Â 
<div 
class="modal-header">
Â Â Â Â Â Â Â Â Â Â Â 
<h2 id="modal-title" 
class="text-lg
font-semibold text-foreground"></h2> 
Â Â Â Â Â Â Â Â Â Â Â 
<button class="w-8 h-8 
rounded-lg
bg-secondary hover:bg-secondary/80 flex items-center justify-center 
text-muted-foreground
hover:text-foreground transition-colors" 
onclick="closeModalSafe()">âœ•</button> 
Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
<div class="modal-body" 
id="modal-body"></div>
Â Â Â 
</div> 
</div>
Â 
<div
id="catalogModal"
class="modal"> 
Â Â Â 
<div class="modal-content" 
style="max-width:700px">
Â Â Â Â Â Â Â 
<div class="modal-header"> 
Â Â Â Â Â Â Â Â Â Â Â 
<h2 
id="catalogModalTitle"
class="text-lg font-semibold 
text-foreground">æ–°å¢ç”¢å“åˆ°è³‡æ–™åº«</h2> 
Â Â Â Â Â Â Â Â Â Â Â 
<button class="w-8 h-8 
rounded-lg
bg-secondary hover:bg-secondary/80 flex items-center justify-center 
text-muted-foreground
hover:text-foreground transition-colors" 
onclick="closeCatalogModal()">âœ•</button> 
Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â 
<div class="modal-body" 
id="catalogModalBody"></div>
Â Â Â 
</div> 
</div>
Â 
<script>
Â Â Â 
// 
=========================================
Â Â Â 
// A) Theme & UI Utilities 
Â Â Â 
// 
=========================================
Â Â Â 
const STORAGE_KEYS = { THEME: 'theme', 
PV_MODE:
'pv_view_mode', SEARCH_P: 'p_search', STATUS_P: 'p_statusFilter', 
DATE_P_FROM:
'p_joinedFrom', DATE_P_TO: 'p_joinedTo', SORT_P: 'p_sort', 
MONTH_REC:
'r_m', SEARCH_REC: 'r_q', UNPAID_REC: 'r_unpaid', MONTH_PAY: 
'pay_m',
SEARCH_PAY: 'pay_q', SEARCH_CAT: 'c_search' }; 
Â 
Â Â Â 
function applyTheme(theme){ 
Â Â Â Â Â document.documentElement.setAttribute('data-theme',
theme); 
localStorage.setItem(STORAGE_KEYS.THEME,
theme); 
Â 
Â Â Â Â const btn = 
document.getElementById('themeBtn');
if(btn){ btn.textContent = (theme === 
'light')
? 'ğŸŒ™' : 'â˜€ï¸'; btn.title =
(theme === 'light') ? 'åˆ‡æ›æ·±è‰²æ¨¡å¼' : 'åˆ‡æ›æ·ºè‰²æ¨¡å¼'; } 
Â Â Â 
} 
Â Â Â 
function toggleTheme(){ const cur = 
document.documentElement.getAttribute('data-theme')
|| 'dark'; applyTheme(cur 
===
'dark' ? 'light' : 'dark'); } 
Â Â Â 
(function initTheme(){ 
Â Â Â Â Â 
const saved = 
localStorage.getItem(STORAGE_KEYS.THEME);
if(saved){ applyTheme(saved); return; 
} 
Â Â Â Â Â 
const prefersLight = window.matchMedia 
&&
window.matchMedia('(prefers-color-scheme: light)').matches; 
applyTheme(prefersLight
? 'light' : 'dark'); 
Â Â Â 
})(); 
Â 
Â Â Â 
let _errFlag = false; 
Â Â Â 
window.onerror = function(msg, url, line, 
col,
error) { 
Â Â Â Â Â Â Â 
console.error(error); 
document.getElementById('loading').style.display
= 'none'; 
Â Â Â Â Â Â Â 
if (_errFlag) return; _errFlag = true; 
setTimeout(()
=> { _errFlag = false; }, 3000); alert(`âš ï¸ ç³»çµ±éŒ¯èª¤ï¼š\n${msg}`); 
Â Â Â 
}; 
Â Â Â 
function setVh() { let vh = 
window.innerHeight
* 0.01; document.documentElement.style.setProperty('--vh', 
`${vh}px`);
} 
Â Â Â 
window.addEventListener('resize', setVh); 
window.addEventListener('orientationchange',
setVh); setVh(); 
Â 
Â Â Â 
const sidebar = 
document.getElementById('sidebar');
const overlay = 
document.getElementById('drawer-overlay');
let bodyScrollY = 0; 
Â Â Â 
function openDrawer() { 
sidebar.classList.add('open');
overlay.classList.add('visible'); } 
Â Â Â 
function closeDrawer() { 
sidebar.classList.remove('open');
overlay.classList.remove('visible'); } 
Â Â Â 
function toggleGroup(groupId) { 
document.getElementById(groupId).classList.toggle('collapsed');
} 
Â 
Â Â Â 
function openModal(title, content) {
document.getElementById('modal-title').innerText 
=
title; document.getElementById('modal-body').innerHTML = content; 
document.getElementById('modal').style.display
= 'block'; } 
Â Â Â 
function closeModalSafe() { if(isDirty 
&&
!confirm('æœ‰æœªå„²å­˜è®Šæ›´ï¼Œç¢ºå®šé›¢é–‹ï¼Ÿ'))
return; document.getElementById('modal').style.display = 'none'; 
} 
Â Â Â 
function closeModal() { 
document.getElementById('modal').style.display
= 'none'; } 
Â Â Â 
function openCatalogModal(title, content){ 
document.getElementById('catalogModalTitle').innerText
= title || 'ç”¢å“è³‡æ–™åº«'; 
document.getElementById('catalogModalBody').innerHTML
= content || ''; 
document.getElementById('catalogModal').style.display
= 'block'; } 
Â Â Â 
function closeCatalogModal(){ 
document.getElementById('catalogModal').style.display
= 'none'; } 
Â 
Â Â Â 
// 
=========================================
Â Â Â 
// B) Firebase Init & Auth 
Â Â Â 
// 
=========================================
Â Â Â 
const firebaseConfig = { apiKey: 
"AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
authDomain: 
"newstar-system.firebaseapp.com",
projectId: 
"newstar-system",
storageBucket: 
"newstar-system.firebasestorage.app",
messagingSenderId: 
"889699172174",
appId: 
"1:889699172174:web:0ff42757035a879cb3281f",
databaseURL: 
"https://newstar-system-default-rtdb.asia-southeast1.firebasedatabase.app"
}; 
Â 
Â Â let 
isReady
= false; let db = null; const ALLOWED_EMAILS = 
["tsai860218@gmail.com",
"xc23026849@gmail.com"].map(e 
=>
e.toLowerCase().trim()); 
Â Â Â 
let isDirty = 
false;
window.tempRec = null; let _didCatalogMigration = false; 
Â Â Â 
function markDirty() { isDirty = true; } 
Â 
Â Â Â 
function setOverlay(show){ 
document.getElementById("loginOverlay").style.display
= show ? 
"flex"
: "none"; } 
Â Â Â 
function setAuthButtons(isLoggedIn){ 
Â Â Â Â Â Â Â 
const loginBtn = 
document.querySelector(".auth-buttons
.login-btn"); const logoutBtn = 
document.getElementById("logoutBtn");
const themeBtn = 
document.getElementById("themeBtn");
Â Â Â Â Â Â Â 
if(loginBtn) loginBtn.style.display = isLoggedIn 
?
"none" : "inline-flex"; if(logoutBtn) 
logoutBtn.style.display
= isLoggedIn ? "inline-flex" : 
"none";
if(themeBtn) themeBtn.style.display = 
"inline-flex";
Â Â Â 
} 
Â Â Â 
function setUserBadge(user){ 
Â Â Â Â Â Â Â 
const badge = 
document.getElementById("userEmailBadge");
if(!badge) return; 
Â Â Â Â Â Â Â 
if(!user){ badge.style.display = 
"none";
badge.textContent = ""; return; } 
Â Â Â Â Â Â Â 
const email = (user.email || 
"").toLowerCase().trim();
const displayName = (user.displayName || 
"").trim();
const name = displayName || email.split("@")[0] 
||
"ä½ "; 
badge.style.display
= "inline-flex"; badge.textContent = `Hi, 
${name}`;
Â Â Â 
} 
Â Â Â 
let _didInitAfterLogin = false; function 
initAfterLogin(){
if (_didInitAfterLogin) return; _didInitAfterLogin = true; 
console.log("âœ… Auth
Success..."); store.init(); } 
Â 
Â Â Â 
try { 
Â Â Â Â Â Â Â 
firebase.initializeApp(firebaseConfig); 
db =
firebase.database(); const auth = firebase.auth(); const provider = new 
firebase.auth.GoogleAuthProvider();
Â Â Â Â Â Â Â auth.getRedirectResult().catch(console.error);
Â 
Â Â Â Â Â Â window.login = function(){ 
auth.signInWithPopup(provider).catch(()
=> 
auth.signInWithRedirect(provider));
} 
Â Â Â Â Â Â Â 
window.logout = function(){ 
store.cleanup();
auth.signOut(); location.reload(); } 
Â Â Â Â Â Â Â 
auth.onAuthStateChanged(async (user) 
=>
{ 
Â 
Â Â Â Â Â Â Â Â Â Â if (!user) {
store.cleanup(); 
setOverlay(true);
setAuthButtons(false); setUserBadge(null); isReady = false; 
_didInitAfterLogin
= false; document.getElementById('loading').style.display = 
'none';
document.getElementById("themeBtn").style.display = 
"inline-flex";
return; } 
Â Â Â Â Â Â Â Â Â Â Â 
const email = (user.email || 
"").toLowerCase().trim();
Â Â Â Â Â Â Â Â Â Â Â 
if 
(!ALLOWED_EMAILS.includes(email))
{ alert(`âŒ å¸³è™Ÿç„¡æ¬Šé™ï¼š${email}\nè«‹ä½¿ç”¨æˆæ¬Šå¸³è™Ÿç™»å…¥æˆ–è¯çµ¡ç®¡ç†å“¡ã€‚`); await 
auth.signOut();
return; } 
Â Â Â Â Â Â Â Â Â Â Â 
setOverlay(false); setAuthButtons(true); 
setUserBadge(user);
isReady = true; initAfterLogin(); 
Â Â Â Â Â Â Â 
}); 
Â Â Â 
} catch (e) { console.error(e); 
alert('Firebase
Error'); } 
Â 
Â Â Â 
// 
=========================================
Â Â Â 
// C) Store Logic 
Â Â Â 
// 
=========================================
Â Â Â 
const defaultParams = { rate_0_3_base: 
0.03,
rate_0_3_rec: 0.04, rate_6_base: 0.01, rate_6_rec: 0.02, rate_recruit_bv: 
0.01,
rate_learning: 0.03 }; 
Â Â Â 
let appData = { partners: [], initiators: 
[],
records: [], versions: [], productCatalog: {} }; 
Â Â Â 
let firebaseListener = null; 
Â 
Â Â Â 
const store = { 
Â Â Â Â Â Â Â 
data: appData, 
Â Â Â Â Â Â Â 
init() { 
Â Â Â Â Â Â Â Â Â Â Â 
if(!isReady) return; 
Â Â Â Â Â Â Â Â Â Â Â 
if(firebaseListener) 
db.ref('AmwaySystem/v1').off('value',
firebaseListener); 
Â Â Â Â Â Â Â Â Â Â Â 
firebaseListener = snap => { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const val = snap.val(); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
if(val) { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
this.data = val; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ['partners','initiators','records','versions','productCatalog'].forEach(k
=>
{ if(!this.data[k]) this.data[k] = (k==='productCatalog'?{}:[]); }); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
// --- MIGRATION: Ensure 
PID is
the KEY --- 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const catalog = 
this.data.productCatalog;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const newCatalog = {}; 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â let
migrated = false; 
Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Object.entries(catalog || 
{}).forEach(([key,
prod]) => { 
Â Â Â 
if (!prod) return; 
Â 
Â Â Â 
// âœ… ä¿è­·ï¼šé¿å… pid ç©ºå€¼é€ æˆ newCatalog[""] é€™ç¨®åœ°é›· key 
Â Â Â 
let pid = (prod.pid || prod.id || key || 
'').trim();
Â Â Â 
if (!pid) pid =
key;Â Â Â Â Â Â Â Â Â Â  // å¦‚æœé‚„æ˜¯ç©ºï¼Œå°±ç”¨åŸ key 
Â Â Â 
prod.pid = pid; 
Â 
Â Â Â 
if (key !== pid) migrated = true; 
Â Â Â 
newCatalog[pid] = prod; 
}); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
if (migrated) { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â this.data.productCatalog
= newCatalog; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
if 
(!_didCatalogMigration)
{ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â _didCatalogMigration
= true; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.log("Migrating
catalog keys to PID..."); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â this.save().catch(console.error);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
} 
Â 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â (this.data.records||[]).forEach(r
=>
{ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const PV_RATE = 50; 
if
(r.ppv !== undefined && r.pbv === undefined) r.pbv = 
Math.round(r.ppv
* PV_RATE); if (r.gpv !== undefined && r.gbv === 
undefined)
r.gbv = Math.round(r.gpv * PV_RATE); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
(r.products || 
[]).forEach(p
=> { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
if (!p.pid 
&&
p.productId) { if (p.productId.length < 20) p.pid = p.productId; 
} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
if (p.pid) 
p.productId
= p.pid; 
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
}); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
} else { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
this.data = { partners: [], 
initiators:
[], records: [], versions: [], productCatalog: {} }; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
this.data.versions.push({ 
id:
uuid(), name: 'é è¨­ç‰ˆæœ¬', params:
{ ...defaultParams }, archived: false }); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
this.save(); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('loading').style.display
= 'none'; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const active = 
document.querySelector('.nav-item.active');
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â if(active) 
router(active.id.replace('nav-',''));
else router('dashboard'); 
Â Â Â Â Â Â Â Â Â Â Â 
}; 
Â Â Â Â Â Â Â Â Â Â Â db.ref('AmwaySystem/v1').on('value',
firebaseListener, err => { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
console.error(err); 
document.getElementById('loading').style.display
= 'none'; alert('è®€å–å¤±æ•—\n' + 
getFirebaseErrorMsg(err));
Â Â Â Â Â Â Â Â Â Â Â 
}); 
Â Â Â Â Â Â Â 
}, 
Â Â Â Â Â Â Â 
cleanup() { if(firebaseListener) { 
db.ref('AmwaySystem/v1').off('value',
firebaseListener); firebaseListener = 
null;
} this.data = { partners: [], initiators: [], records: [], versions: [], 
productCatalog:
{} }; }, 
Â Â Â Â Â Â Â 
save() { if(!isReady) return 
Promise.reject('Not
Logged In'); return db.ref('AmwaySystem/v1').set(this.data); }, 
Â Â Â Â Â Â Â 
getPartner(id) { return 
(this.data.partners||[]).find(p=>p.id===id);
}, 
Â Â Â Â Â Â Â 
getInitiator(id) { return 
(this.data.initiators||[]).find(i=>i.id===id);
}, 
Â Â Â Â Â Â Â 
getRecord(id) { return 
(this.data.records||[]).find(r=>r.id===id);
}, 
Â Â Â Â Â Â Â 
getRecordsByMonth(m) { return 
(this.data.records||[]).filter(r=>r.month===m);
}, 
Â Â Â Â 
Â Â Â getVersion(id) { return 
(this.data.versions||[]).find(v=>v.id===id)
|| this.data.versions[0]; } 
Â Â Â 
}; 
Â 
Â Â Â 
// 
=========================================
Â Â Â 
// D) Utils 
Â Â Â 
// 
=========================================
Â Â Â 
function uuid() { return
'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, 
c
=> { const r = Math.random()*16|0, v = c=='x'?r:(r&0x3|0x8); return 
v.toString(16);
}); } 
Â Â Â 
function money(n) { return new 
Intl.NumberFormat('zh-TW',
{style:'currency', currency:'TWD', minimumFractionDigits:0}).format(n||0); 
} 
Â Â Â 
function getPercent(pv) { return 
pv>=10000?0.21:pv>=7000?0.18:pv>=4000?0.15:pv>=2000?0.12:pv>=1000?0.09:pv>=600?0.06:pv>=200?0.03:0;
} 
Â Â Â 
function getLocalToday() { const d = new 
Date();
return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, 
'0')}-${String(d.getDate()).padStart(2,
'0')}`; } 
Â Â Â 
function getLocalMonth() { return 
getLocalToday().slice(0,
7); } 
Â Â Â 
function getToday(m) { if(m) { const d = 
new
Date(); return (d.toISOString().slice(0,7)===m && d.getDate()<18) 
?
m+'-18' : getLocalToday(); } return getLocalToday(); } 
Â Â Â 
function getFirebaseErrorMsg(err) { 
Â Â Â Â Â Â Â 
const msg = (err.message || err.code || 
'').toLowerCase();
Â Â Â Â Â Â Â 
if (msg.includes('permission_denied')) 
return
'æ¬Šé™ä¸è¶³ï¼šè«‹ç¢ºèªå·²ç™»å…¥ä¸” 
Email åœ¨ç™½åå–®ï¼Œä¸¦æª¢æŸ¥ Firebase Rulesã€‚'; 
Â Â Â Â Â Â Â 
if (msg.includes('network') || 
msg.includes('offline'))
return 'ç¶²è·¯ç•°å¸¸ï¼šè«‹æª¢æŸ¥é€£ç·šç‹€æ…‹ã€‚';
Â Â Â Â Â Â Â 
return 'éŒ¯èª¤è©³æƒ…: ' +
(err.message || err); 
Â Â Â 
} 
Â Â Â 
function getDuration(joinedAt) { 
Â Â Â Â Â Â Â 
if (!joinedAt) return 'â€”'; 
Â Â Â Â Â Â Â 
const start = new Date(joinedAt); const 
now =
new Date(); if (isNaN(start)) return 'â€”'; 
Â Â Â Â Â Â Â 
let years = now.getFullYear() - 
start.getFullYear();
let months = now.getMonth() - start.getMonth(); let days = 
now.getDate()
- start.getDate(); 
Â Â Â Â Â Â Â 
if (days < 0) { months--; const 
prevMonth
= new Date(now.getFullYear(), now.getMonth(), 0); days += 
prevMonth.getDate();
} 
Â Â Â Â Â Â Â 
if (months < 0) { years--; months += 
12; } 
Â Â Â Â Â Â Â 
const totalMonths = years * 12 + 
months;
Â Â Â Â Â Â Â 
if (totalMonths === 0 && days 
=== 0)
return 'ä»Šå¤©åŠ å…¥'; 
Â Â Â Â Â Â Â 
let result = ''; if (totalMonths > 
0)
result += `${totalMonths} å€‹æœˆ `; if (days > 0) result += `${days} å¤©`; 
return
result.trim(); 
Â Â Â 
} 
Â Â Â 
function getCategoryOptionsHtml() { 
Â Â Â Â Â 
const preset = ["ç‡Ÿé¤Š", "ç¾å®¹", "å®¶å±…", "å€‹äººè­·ç†", "æ·¨æ°´", "ç©ºæ°£", "å…¶ä»–"]; 
Â Â Â Â Â 
const set = new Set(preset); 
Â Â Â Â Â 
const catalog = store.data.productCatalog 
|| {};
Â Â Â Â Â 
Object.values(catalog).forEach(p => { 
const
c = (p.category || "").trim(); if (c) set.add(c); }); 
Â Â Â Â Â 
return 
Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hant')).map(c
=> 
`<option
value="${c}"></option>`).join(''); 
Â Â Â 
} 
Â Â Â 
function safeNum(v) { return Number(v) || 
0; } 
Â Â Â 
function normStr(s) { return String(s || 
'').trim();
} 
Â Â Â 
function escapeHtml(text) { 
Â Â Â Â Â Â Â 
if (!text) return ''; 
Â Â Â Â Â Â Â 
return text.toString().replace(/&/g, 
"&amp;").replace(/</g,
"&lt;").replace(/>/g, 
"&gt;").replace(/"/g,
"&quot;").replace(/'/g, 
"&#039;");
Â Â Â 
} 
Â 
Â Â Â 
const PV_RATE = 50; 
Â Â Â 
function getPvViewMode() { return 
localStorage.getItem(STORAGE_KEYS.PV_MODE)
|| 'both'; } 
Â Â Â 
function pvToBv(pv) { return 
Math.round((Number(pv)||0)
* PV_RATE); } 
Â Â Â 
function bvToPv(bv) { return 
parseFloat(((Number(bv)||0)
/ PV_RATE).toFixed(2)); } 
Â Â Â 
function formatPvBv(pv, bv) { 
Â Â Â Â Â Â Â 
const mode = getPvViewMode(); const p = 
Number(pv)||0;
const b = (bv !== undefined && bv !== null) ? Number(bv) 
:
pvToBv(p); 
Â Â Â Â Â Â Â 
if (mode === 'pv') return `PV: ${p}`; 
if
(mode === 'bv') return `BV: ${b.toLocaleString()}`; return `${p} / 
${b.toLocaleString()}`;
Â Â Â 
} 
Â Â Â 
function getPvViewSelect(onchangeFnName) { 
Â Â Â Â Â Â Â 
const m = getPvViewMode(); 
Â Â Â Â Â Â Â 
return `<select 
class="form-input"
style="width:auto" 
onchange="localStorage.setItem('${STORAGE_KEYS.PV_MODE}',this.value);${onchangeFnName}()">
Â Â Â Â Â Â Â Â Â Â Â 
<option value="both" 
${m==='both'?'selected':''}>PV
+ BV</option><option 
value="pv"
${m==='pv'?'selected':''}>åªçœ‹ PV</option><option 
value="bv"
${m==='bv'?'selected':''}>åªçœ‹ 
BV</option></select>`;
Â Â Â 
} 
Â 
Â Â Â 
function calculate(r) { 
Â Â Â Â Â Â Â 
const p = 
store.getPartner(r.partnerId);
if(!p) return null; 
Â Â Â Â Â Â Â 
const v = 
store.getVersion(r.planVersionId);
const params = v ? v.params : defaultParams; 
Â Â Â Â Â Â Â 
const gpv = Number(r.gpv) || 0; const 
rate =
getPercent(gpv); 
Â Â Â Â Â Â Â 
let res = { ...r, partnerName: p.code+' 
'+p.name,
initiatorId: p.initiatorId, myRate: rate, starTotal: 0, totalIncome: 
0,
isEligible: false, isGraduated: rate >= 0.09, isPartnerInactive: 
p.status==='inactive',
isMonthlyInactive: r.participation==='inactive' }; 
Â Â Â Â Â 
Â Â if(!res.isGraduated && 
!res.isPartnerInactive
&& !res.isMonthlyInactive) { 
Â Â Â Â Â Â Â Â Â Â Â 
let applied = 0, txt = ''; const 
hasRec
= (r.newRecruits||[]).length > 0; 
Â Â Â Â Â Â Â Â Â Â Â 
if(rate === 0 || rate === 0.03) { 
applied
= hasRec ? params.rate_0_3_rec : params.rate_0_3_base; txt = '0-3%'; } 
Â Â Â Â Â Â Â Â Â Â Â 
else if(rate === 0.06) { applied = 
hasRec
? params.rate_6_rec : params.rate_6_base; txt = '6%'; } 
Â Â Â Â Â Â Â Â Â Â Â 
if(applied > 0) { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
res.isEligible = true; 
res.appliedRateText
= txt + (hasRec?' (å«æ¨è–¦)':' (åŸºç¤)'); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const indepBV = 
(r.legs||[]).filter(l=>l.isIndependent).reduce((s,l)=>s+(Number(l.bv)||0),0);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const calcBase = Math.max(0, 
(gpv *
50) - indepBV); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
res.baseBonus = 
Math.round(calcBase
* applied); 
Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â res.recruitBonus
= 
Math.round((r.newRecruits||[]).reduce((s,n)=>s+(Number(n.bv)||0),0)
* 
params.rate_recruit_bv);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
res.learningBonus = 
r.learningDone
? Math.round((res.baseBonus + res.recruitBonus) * 
params.rate_learning)
: 0; 
Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â res.starTotal
= 
Math.round(res.baseBonus
+ res.recruitBonus + res.learningBonus); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
res.totalIncome = 
res.starTotal;
Â Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â 
return res; 
Â Â Â 
} 
Â Â Â 
Â Â Â 
// v10.2 Recommendation Engine (Greedy Combo) 
Â Â Â 
function 
getRecommendations(gapPV)
{ 
Â Â Â 
const catalog = Object.values(store.data.productCatalog 
||
{}); 
Â Â Â 
if (!catalog.length) return { items: [], 
totalPV:
0 }; 
Â 
Â Â Â 
// åªæŒ‘ pv > 0ï¼Œä¸¦ä»¥ pv ç”±å°åˆ°å¤§æ’åºï¼ˆæ–¹ä¾¿ç”¨é›™æŒ‡æ¨™é€¼è¿‘ï¼‰ 
Â Â Â 
const items = catalog 
Â Â Â Â Â Â Â 
.filter(p => Number(p.pv) > 0) 
Â Â Â Â Â Â Â 
.map(p => ({ ...p, pv: Number(p.pv) 
})) 
Â 
Â Â Â Â Â Â .sort((a, b) => a.pv - b.pv); 
Â 
Â Â Â 
if (!items.length) return { items: [], 
totalPV:
0 }; 
Â 
Â Â Â 
const topN = Math.min(items.length, 80); //ä¸Šé™æ§åˆ¶ï¼Œé¿å…è¶…å¤§è³‡æ–™åº«æ‹–æ…¢ 
Â Â Â 
const arr = items.slice(0, topN); 
Â 
Â Â Â 
let best = []; 
Â Â Â 
let bestSum = 0; 
Â Â Â 
let minDiff = Infinity; 
Â 
Â Â Â 
function tryUpdate(combo, sum) { 
Â Â Â Â Â Â Â 
const diff = sum - gapPV; 
Â Â Â Â Â Â Â 
if (diff >= 0 && diff < 
minDiff)
{ 
Â Â Â Â Â Â Â Â Â Â Â 
minDiff = diff; 
Â Â Â Â Â Â Â Â Â Â Â 
best = combo; 
Â Â Â Â Â Â Â Â Â Â Â 
bestSum = sum; 
Â Â Â Â Â Â Â 
} 
Â Â Â 
} 
Â 
Â Â Â 
// 1) å–®å“ï¼šäºŒåˆ†æ‰¾ >=
gapPV çš„æœ€æ¥è¿‘ 
Â Â Â 
let lo = 0, hi = arr.length - 1, pos = -1; 
Â Â Â 
while (lo <= hi) { 
Â Â Â Â Â Â Â 
const mid = (lo + hi) >> 1; 
Â Â Â Â Â Â Â 
if (arr[mid].pv >= gapPV) { pos = 
mid;
hi = mid - 1; } 
Â Â Â Â Â Â Â 
else lo = mid + 1; 
Â Â Â 
} 
Â Â Â 
if (pos !== -1) tryUpdate([arr[pos]], 
arr[pos].pv);
Â 
Â Â Â 
// 2) å…©å“ï¼šé›™æŒ‡æ¨™ 
Â Â Â 
let l = 0, r = arr.length - 1; 
Â Â Â 
while (l <= r) { 
Â Â Â Â Â Â Â 
const sum = arr[l].pv + arr[r].pv; 
Â Â Â Â Â Â Â 
if (sum >= gapPV) { 
Â Â Â Â Â Â Â Â Â Â Â 
tryUpdate([arr[l], arr[r]], sum); 
Â Â Â Â Â Â Â Â Â Â Â 
r--; 
Â Â Â Â Â Â Â 
} else { 
Â Â Â Â Â Â Â Â Â Â Â 
l++; 
Â Â Â Â Â Â Â 
} 
Â Â Â 
} 
Â 
Â Â Â 
// 3) ä¸‰å“ï¼šå›ºå®š i + é›™æŒ‡æ¨™
Â Â Â 
for (let i = 0; i < arr.length; i++) { 
Â Â Â Â Â Â Â 
let left = i, right = arr.length - 1; 
Â Â Â Â Â Â Â 
while (left <= right) { 
Â Â Â Â Â Â Â Â Â Â Â 
const sum = arr[i].pv + 
arr[left].pv
+ arr[right].pv; 
Â Â Â Â Â Â Â Â Â Â Â 
if (sum >= gapPV) { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
tryUpdate([arr[i], arr[left], 
arr[right]],
sum); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
right--; 
Â Â Â Â Â Â Â Â Â Â Â 
} else { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
left++; 
Â Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â 
} 
Â Â Â 
} 
Â 
Â Â Â 
if (!best.length) { 
Â Â Â Â Â Â Â 
const last = arr[arr.length - 1]; 
Â Â Â Â Â Â Â 
best = [last]; 
Â Â Â Â Â Â Â 
bestSum = last.pv; 
Â Â Â 
} 
Â 
Â Â Â 
return { items: best, totalPV: 
parseFloat(bestSum.toFixed(2))
}; 
} 
Â 
Â Â Â 
// 
=========================================
Â Â Â 
// E) Router 
Â Â Â 
// 
=========================================
Â Â Â 
function header(t) { return `<div 
class="flex
items-center gap-3"><button class="menu-btn 
hidden
w-10 h-10 rounded-lg bg-card border border-border items-center 
justify-center
text-foreground hover:bg-secondary transition-colors" 
onclick="openDrawer()">â˜°</button><h1
class="text-xl
font-bold text-foreground">${t}</h1></div>`; 
} 
Â Â Â 
function router(pg) { 
Â Â Â Â Â Â Â 
try { 
Â Â Â Â Â Â Â Â Â Â Â document.querySelectorAll('.nav-item').forEach(a=>a.classList.remove('active'));
Â Â Â Â Â Â Â Â Â Â Â 
const nav = 
document.getElementById('nav-'+pg);
Â Â Â Â Â Â Â Â Â Â Â 
if(nav) { nav.classList.add('active'); 
const
group = nav.closest('.nav-group'); if(group) 
group.classList.remove('collapsed');
} 
Â Â Â Â Â Â Â Â Â Â Â 
if(window.innerWidth < 1024) 
closeDrawer();
Â Â Â Â Â Â Â Â Â Â Â document.getElementById('app').innerHTML
= ''; 
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â 
if(pg==='dashboard') 
renderDashboard();
Â Â Â Â Â Â Â Â Â Â Â 
else if(pg==='records') 
renderRecords();
Â Â Â Â Â Â Â Â Â Â Â 
else if(pg==='payout') 
renderPayout();
Â Â Â Â Â Â Â Â Â Â Â 
else if(pg==='partners') 
renderPartners();
Â Â Â Â Â Â Â Â Â Â Â 
else if(pg==='initiators') 
renderInitiators();
Â Â Â Â Â Â Â Â Â Â 
Â else if(pg==='catalog') renderCatalog(); 
Â Â Â Â Â Â Â Â Â Â Â 
else if(pg==='org') 
renderOrgChart();
Â Â Â Â Â Â Â Â Â Â Â 
else if(pg==='versions') 
renderVersions();
Â Â Â Â Â Â Â Â Â Â Â 
else if(pg==='settings') 
renderSettings();
Â Â Â Â Â Â Â 
} catch(e) { console.error(e); alert('é é¢è¼‰å…¥éŒ¯èª¤ï¼š' + e.message); } 
Â Â Â 
} 
Â 
Â Â Â 
// 
=========================================
Â Â Â 
// F) Pages Render 
Â Â Â 
// 
=========================================
Â Â Â 
function renderDashboard() { 
Â Â Â Â Â Â Â 
const m = getLocalMonth(); 
Â Â Â Â Â Â Â 
const today = getLocalToday(); 
Â Â Â Â Â Â Â 
const allRecs = store.data.records || 
[]; 
Â Â Â Â Â Â Â 
const recs = 
store.getRecordsByMonth(m).map(calculate).filter(x
=> x); 
Â Â Â Â Â Â Â 
const partners = store.data.partners || 
[]; 
Â Â Â Â Â Â Â 
const activePartners = partners.filter(p 
=>
p.status === 'active'); 
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â 
const totalBonus = recs.reduce((s, r) 
=>
s + r.starTotal, 0); 
Â Â Â Â Â Â Â 
const unpaidSum = recs.filter(r => 
r.payoutStatus
!== 'paid').reduce((s, r) => s + r.totalIncome, 0); 
Â Â Â Â Â Â Â 
const unpaidCount = recs.filter(r => 
r.payoutStatus
!== 'paid' && r.totalIncome > 0).length; 
Â Â Â Â Â Â Â 
const bonusCount = recs.filter(r => 
r.totalIncome
> 0).length; 
Â Â Â Â Â Â Â 
const payoutRate = bonusCount > 0 ? 
Math.round(((bonusCount
- unpaidCount) / bonusCount) * 100) : 0; 
Â 
Â Â Â Â Â Â Â const
trends = []; 
Â Â Â Â Â Â Â 
for(let i=0; i<3; i++){ 
Â Â Â Â Â Â Â Â Â Â Â 
const d = new Date(); 
d.setMonth(d.getMonth()
- i); const tm = d.toISOString().slice(0,7); 
Â Â Â Â Â Â Â Â Â Â Â 
const tRecs = allRecs.filter(r 
=>
r.month === tm).map(calculate).filter(x=>x); 
Â Â Â 
Â Â Â Â Â Â Â Â const tBonus =
tRecs.reduce((s,r) => 
s +
r.starTotal, 0); 
Â Â Â Â Â Â Â Â Â Â Â 
const tPeople = tRecs.filter(r 
=>
r.gpv > 0).length; 
Â Â Â Â Â Â Â Â Â Â Â 
trends.push({ month: tm, bonus: 
tBonus,
people: tPeople }); 
Â Â Â Â Â Â Â 
} 
Â 
Â Â Â Â Â Â Â 
// Tasks 
Â Â Â Â Â Â Â 
const tasks = []; 
Â Â Â Â Â Â Â 
const recPartnerIds = new 
Set(recs.map(r
=> r.partnerId)); 
Â Â Â Â Â Â Â 
const missingRecs = 
activePartners.filter(p
=> !recPartnerIds.has(p.id)); 
Â Â Â Â Â Â Â 
if(missingRecs.length > 0) 
tasks.push({
type: 'missing', title: `æœªäº¤ä½œæ¥­ (${missingRecs.length}äºº)`, desc: 'æœ¬æœˆå°šæœªæœ‰æ¥­ç¸¾ç´€éŒ„', action: `goToMissingRecords()` }); 
Â Â Â Â Â Â Â 
if(unpaidCount > 0) tasks.push({ 
type:
'unpaid', title: `å¾…ç™¼æ”¾ (${unpaidCount}ç­†)`, desc: `ç¸½é‡‘é¡ ${money(unpaidSum)}`, action: `payoutAction('${m}')` }); 
Â Â Â Â Â Â Â 
const badData = recs.filter(r => 
r.gpv
> 0 && (!r.gbv || r.gbv === 0)).length; 
Â Â Â Â Â Â Â 
if(badData > 0) tasks.push({ type: 
'quality',
title: `è³‡æ–™ç•°å¸¸
(${badData}ç­†)`, desc: 'æœ‰ PV ä½†ç„¡ BV', action: `router('records')` }); 
Â 
Â Â Â Â Â Â Â 
// Countdown 
Â Â Â Â Â Â Â 
const thresholds = [200, 600, 1000, 
2000,
4000, 7000, 10000]; 
Â Â Â Â Â Â Â 
const gapList = []; 
Â Â Â Â Â Â Â 
recs.forEach(r => { 
Â Â Â Â Â Â Â Â Â Â Â 
if(r.isGraduated || r.participation 
===
'inactive') return; 
Â Â Â Â Â Â Â Â Â Â Â 
const nextT = thresholds.find(t 
=>
t > r.gpv); 
Â Â Â Â Â Â Â Â Â Â Â 
if(nextT) { const gap = nextT - 
r.gpv;
if(gap > 0) gapList.push({ name: r.partnerName, current: r.gpv, gap: 
gap,
next: nextT }); } 
Â Â Â Â Â Â Â 
}); 
Â Â Â Â Â Â Â 
gapList.sort((a,b) => a.gap - 
b.gap);
const topGaps = gapList.slice(0, 6); 
Â 
Â Â Â Â Â Â Â 
const pvDist = { '0-199': 0, '200-599': 
0,
'600-3999': 0, '4000+': 0 }; 
Â Â Â Â Â Â Â 
recs.forEach(r => { 
if(r.participation
=== 'inactive') return; if(r.gpv >= 4000) 
pvDist['4000+']++;
else if(r.gpv >= 600) pvDist['600-3999']++; else if(r.gpv 
>=
200) pvDist['200-599']++; else pvDist['0-199']++; }); 
Â 
Â Â Â Â Â Â Â 
const watchList = { near: [], low: [], 
missing:
[] }; 
Â Â Â Â Â Â Â 
recs.forEach(r => { 
Â Â Â Â Â Â Â Â Â Â Â 
if(r.isGraduated || r.participation 
===
'inactive') return; 
Â Â Â Â Â Â Â Â Â Â Â 
if(r.gpv >= 150 && r.gpv 
< 200)
watchList.near.push({ name: r.partnerName, val: r.gpv, target: 200 
}); 
Â Â Â Â Â Â Â Â Â Â Â 
else if(r.gpv >= 550 && 
r.gpv
< 600) watchList.near.push({ name: r.partnerName, val: r.gpv, target: 
600
}); 
Â Â Â Â Â Â Â Â Â Â Â 
else if(r.gpv > 0 && 
r.gpv
< 100) watchList.low.push({ name: r.partnerName, val: r.gpv }); 
Â Â Â Â Â Â Â 
}); 
Â Â Â Â Â Â Â 
missingRecs.slice(0,5).forEach(p => 
watchList.missing.push({
name: `${p.code} ${p.name}` })); 
Â 
Â Â Â Â Â Â Â 
const initStats = {}; 
Â Â Â Â Â Â Â 
recs.forEach(r => { 
Â Â Â Â Â Â Â Â Â Â Â 
const iId = r.initiatorId || 
'none';
Â Â Â Â Â Â Â Â Â Â Â 
if(!initStats[iId]) initStats[iId] 
= {
name: (store.getInitiator(iId)||{name:'æœªæŒ‡å®š'}).name, bonus:0, people:0, unpaid:0 }; 
Â Â Â Â Â Â Â Â Â Â Â 
initStats[iId].bonus += 
r.totalIncome;
if(r.gpv > 0) initStats[iId].people++; if(r.payoutStatus !== 
'paid')
initStats[iId].unpaid += r.totalIncome; 
Â Â Â Â Â Â Â 
}); 
Â Â Â Â Â Â Â 
const topInits = 
Object.values(initStats).sort((a,b)
=> b.bonus - a.bonus).slice(0, 6); 
Â 
Â Â Â Â Â Â Â 
const prodStats = {}; 
Â Â Â Â Â Â Â 
recs.forEach(r => { (r.products || 
[]).forEach(p
=> { const name = p.name || 'æœªçŸ¥ç”¢å“'; if(!prodStats[name]) prodStats[name] = { name, 
count:
0, qty: 0 }; prodStats[name].count++; prodStats[name].qty += 
(Number(p.qty)||1);
}); }); 
Â Â Â Â Â Â Â 
const topProds = 
Object.values(prodStats).sort((a,b)
=> b.qty - a.qty).slice(0, 5); 
Â 
Â Â Â Â Â 
Â Â document.getElementById('app').innerHTML = ` 
Â Â Â Â Â Â Â Â Â Â Â 
<header class="flex 
items-center
justify-between mb-6 flex-wrap gap-4">${header(`ç¸½è¦½ - ${m}`)}<div 
class="flex
items-center gap-2 text-sm text-muted-foreground">æœ€å¾Œæ›´æ–°:
${today}</div></header> 
Â Â Â Â Â Â 
Â Â Â Â Â <div class="grid grid-cols-1 
md:grid-cols-2
lg:grid-cols-4 gap-4 mb-6"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5 relative overflow-hidden"><div 
class="absolute
top-0 right-0 w-20 h-20 bg-gradient-to-br from-primary/20 
to-transparent
rounded-bl-full"></div><div class="flex 
items-center
gap-3 mb-2"><div class="w-10 h-10 rounded-lg 
bg-primary/10
flex items-center justify-center">ğŸ’°</div><span
class="text-sm 
text-muted-foreground">æœ¬æœˆé ä¼°</span></div><div
class="text-3xl font-bold 
text-foreground
mb-1">${money(totalBonus)}</div><div 
class="text-xs
text-muted-foreground">ä¸Šæœˆ: 
${money(trends[1]?.bonus||0)}</div></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5 relative overflow-hidden"><div 
class="absolute
top-0 right-0 w-20 h-20 bg-gradient-to-br 
from-destructive/20
to-transparent rounded-bl-full"></div><div 
class="flex
items-center gap-3 mb-2"><div class="w-10 h-10 
rounded-lg
bg-destructive/10 flex items-center justify-center">ğŸš¨</div><span
class="text-sm 
text-muted-foreground">å¾…ç™¼æ”¾</span></div><div
class="text-3xl font-bold 
text-foreground">${money(unpaidSum)}</div><div
class="text-xs
text-muted-foreground mt-1 cursor-pointer 
hover:text-primary"
onclick="payoutAction('${m}')">æŸ¥çœ‹ ${unpaidCount} ç­†æœªçµæ¸…
&rarr;</div></div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5 relative overflow-hidden"><div 
class="absolute
top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-500/20 
to-transparent
rounded-bl-full"></div><div class="flex 
items-center
gap-3 mb-2"><div class="w-10 h-10 rounded-lg 
bg-blue-500/10
flex items-center justify-center">ğŸ‘¥</div><span
class="text-sm 
text-muted-foreground">æ´»èº/ç¸½æ•¸</span></div><div
class="text-3xl
font-bold text-foreground">${recs.length} <span 
class="text-base
text-muted-foreground">/ 
${activePartners.length}</span></div><div
class="text-xs 
text-muted-foreground
mt-1">åƒèˆ‡ç‡: 
${activePartners.length
? Math.round(recs.length/activePartners.length*100) : 
0}%</div></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5 relative overflow-hidden"><div 
class="absolute
top-0 right-0 w-20 h-20 bg-gradient-to-br 
from-amber-500/20
to-transparent rounded-bl-full"></div><div 
class="flex
items-center gap-3 mb-2"><div class="w-10 h-10 
rounded-lg
bg-amber-500/10 flex items-center justify-center">ğŸ“ˆ</div><span
class="text-sm 
text-muted-foreground">è¿‘3æœˆè¶¨å‹¢</span></div><div
class="space-y-1
mt-2">${trends.map(t => `<div 
class="flex
justify-between text-xs"><span
class="text-muted-foreground">${t.month}</span><span>${money(t.bonus)}
(${t.people}äºº)</span></div>`).join('')}</div></div>
Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div class="grid 
grid-cols-1
lg:grid-cols-3 gap-6 mb-6"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5"><h3 class="font-bold 
text-lg
mb-4 flex items-center gap-2">ğŸ“Œ ä»Šæ—¥ä»»å‹™ <span class="text-xs bg-primary/20
text-primary px-2 
rounded-full">${tasks.length}</span></h3><div
class="space-y-3">${tasks.map(t
=> `<div class="flex 
items-center
justify-between p-3 rounded bg-secondary/10 border 
border-border/50
cursor-pointer hover:bg-secondary/30 transition" 
onclick="${t.action}"><div><div
class="font-bold 
text-sm
${t.type==='unpaid'?'text-destructive':'text-foreground'}">${t.title}</div><div
class="text-xs
text-muted-foreground">${t.desc}</div></div><span
class="text-muted-foreground">â†’</span></div>`).join('')
||
'<div class="text-center text-muted-foreground text-sm 
py-4">ç›®å‰ç„¡å¾…è¾¦äº‹é …</div>'}</div></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5 lg:col-span-2"><h3 
class="font-bold
text-lg mb-4 flex items-center gap-2">ğŸ§¾ å€’æ•¸è£œå–®å»ºè­° <span class="text-xs
text-muted-foreground 
font-normal">Top
6</span></h3><div class="grid 
grid-cols-1
md:grid-cols-2 gap-4">${topGaps.map(g => { const recInfo 
=
getRecommendations(g.gap); const recText = 
recInfo.items.map(i=>i.name).join('+')
|| 'å»ºè­°æ–°å¢ç”¢å“è‡³è³‡æ–™åº«';
return `<div class="p-3 rounded bg-secondary/10 border 
border-border/50
flex justify-between items-center cursor-pointer 
hover:border-primary/50
transition" 
onclick="showGapDetail('${g.name}',
${g.current}, ${g.next}, 
${g.gap})"><div><div
class="font-bold 
text-sm">${g.name}</div><div
class="text-xs 
text-muted-foreground">ç¾ ${g.current} / å·® <span class="text-destructive 
font-bold">${parseFloat(g.gap.toFixed(2))}</span>é”
${g.next}</div></div><div 
class="text-right"><div
class="text-xs bg-primary/10 
text-primary
px-2 py-1 rounded mb-1">æ¨: 
${recText}</div></div></div>`;
}).join('') || '<div 
class="col-span-2
text-center text-muted-foreground text-sm py-4">å…¨å“¡çš†å·²é”æ¨™æˆ–ç„¡æ¥è¿‘é–€æª»è€…</div>'}</div></div>
Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div class="grid 
grid-cols-1
lg:grid-cols-3 gap-6 mb-6"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5 lg:col-span-2"><h3 
class="font-bold
text-lg mb-4 flex items-center gap-2">ğŸ¯ æœ¬æœˆé”æ¨™åˆ†ä½ˆ <span class="text-xs
font-normal text-muted-foreground 
bg-secondary
px-2 py-0.5 rounded">æœ‰æ•ˆ: ${recs.length}</span></h3><div 
class="space-y-4">${Object.entries(pvDist).map(([label,
count]) 
=>
{ const pct = recs.length ? Math.round(count/recs.length*100) : 0; let 
color
= 'bg-secondary'; if(label==='4000+') color = 'bg-primary'; else 
if(label==='600-3999')
color = 'bg-blue-500'; else if(label==='200-599') color 
=
'bg-amber-500'; return `<div><div class="flex justify-between 
text-sm
mb-1"><span 
class="text-muted-foreground">${label}
PV</span><span 
class="font-bold">${count}äºº <span 
class="text-xs
text-muted-foreground">(${pct}%)</span></span></div><div
class="h-2
w-full bg-secondary rounded-full 
overflow-hidden"><div
class="h-full ${color}" 
style="width:
${pct}%"></div></div></div>`; 
}).join('')}</div></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5"><h3 class="font-bold 
text-lg
mb-4">ğŸš¨ éœ€é—œæ³¨åå–®</h3><div class="space-y-4
max-h-[300px] 
overflow-y-auto
pr-1">${watchList.near.length > 0 ? 
`<div><div
class="text-xs font-bold text-warning mb-2 uppercase 
tracking-wide">å·®ä¸€é»é”æ¨™</div>${watchList.near.slice(0,5).map(i
=>
`<div class="flex justify-between text-sm py-1 border-b 
border-border/50"><span>${i.name}</span><span
class="text-warning">${i.val}
/ 
${i.target}</span></div>`).join('')}</div>`
: 
''}${watchList.missing.length
> 0 ? `<div><div class="text-xs 
font-bold
text-destructive mb-2 uppercase tracking-wide mt-2">æœªäº¤ä½œæ¥­</div>${watchList.missing.slice(0,5).map(i
=> `<div 
class="flex
justify-between text-sm py-1 border-b 
border-border/50"><span
class="text-muted-foreground">${i.name}</span></div>`).join('')}</div>`
:
''}${!watchList.near.length && !watchList.missing.length ? '<div 
class="text-center
text-muted-foreground text-sm py-4">ç›®å‰ç„¡ç‰¹åˆ¥éœ€é—œæ³¨é …ç›®</div>' : ''}</div></div> 
Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â 
<div class="grid 
grid-cols-1
md:grid-cols-2 lg:grid-cols-3 gap-6"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5"><h3 class="font-bold 
text-lg
mb-4">ğŸ† ç™¼èµ·äººæˆ°å ±</h3><div
class="space-y-3">${topInits.map((i, 
idx)
=> `<div class="flex items-center justify-between p-2 rounded 
bg-secondary/10
border border-border/50"><div class="flex 
items-center
gap-3"><div class="w-6 h-6 rounded-full 
bg-secondary
flex items-center justify-center text-xs 
font-bold">${idx+1}</div><span
class="text-sm 
font-medium">${i.name}</span></div><div
class="text-right"><div
class="text-sm font-bold 
text-primary">${money(i.bonus)}</div><div
class="text-[10px]
text-muted-foreground">${i.people}äºº / æœªç™¼:${money(i.unpaid)}</div></div></div>`).join('')
||
'<div class="text-center text-muted-foreground text-sm">å°šç„¡æ•¸æ“š</div>'}</div></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5"><h3 class="font-bold 
text-lg
mb-4">ğŸ’° ç™¼æ”¾æ¦‚æ³</h3><div class="flex items-center
justify-center 
py-6"><div
class="relative w-32 h-32 rounded-full border-8 
border-secondary
flex items-center justify-center" style="background: 
conic-gradient(rgb(var(--primary))
${payoutRate}%, transparent 
0)"><div
class="absolute inset-2 bg-card rounded-full flex 
flex-col
items-center justify-center"><span class="text-2xl 
font-bold">${payoutRate}%</span><span
class="text-[10px] 
text-muted-foreground">å·²ç™¼æ”¾</span></div></div></div><div
class="text-center"><button
class="w-full mt-2 py-2 
text-sm
bg-secondary hover:bg-secondary/80 rounded transition-colors" 
onclick="payoutAction('${m}')">å‰å¾€ç™¼æ”¾ç®¡ç†</button></div></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-5"><h3 class="font-bold 
text-lg
mb-4">ğŸ›’ ç†±é–€ç”¢å“</h3><div
class="space-y-0">${topProds.map((p, 
idx)
=> `<div class="flex justify-between items-center py-2 border-b 
border-border/50
last:border-0"><div class="flex items-center 
gap-2
overflow-hidden"><span class="text-xs font-mono 
text-muted-foreground
min-w-[1.2em]">${idx+1}.</span><span 
class="text-sm
truncate" 
title="${p.name}">${p.name}</span></div><div
class="text-xs
font-bold bg-secondary px-2 py-1 rounded 
whitespace-nowrap">x${p.qty}</div></div>`).join('')
|| 
'<div
class="text-center text-muted-foreground text-sm py-8">æœ¬æœˆå°šç„¡ç”¢å“ç´€éŒ„</div>'}</div></div>
Â Â Â Â Â Â Â Â Â Â Â 
</div>`; 
Â Â Â 
} 
Â 
Â Â Â 
// [v10.2] Show Gap Detail Modal 
Â Â Â 
window.showGapDetail = function(name, 
current,
next, gap) { 
Â Â Â Â Â Â Â 
const recInfo = 
getRecommendations(gap);
Â Â Â Â Â Â Â 
const prodHtml = recInfo.items.length ? 
recInfo.items.map(p
=> `<li>${p.name} (PV: 
${p.pv})</li>`).join('')
: '<li 
class="text-muted-foreground">å»ºè­°æ–°å¢ç”¢å“è‡³è³‡æ–™åº«ä»¥ç²å¾—æ¨è–¦</li>'; 
Â Â Â Â Â Â Â 
openModal('è£œå–®å»ºè­°',
`<div 
class="space-y-4"><div
class="text-center"><div 
class="text-2xl
font-bold 
text-foreground">${name}</div><div
class="text-muted-foreground">ç›®å‰ PV: 
${current}</div></div><div
class="bg-card border 
border-border
p-4 rounded-xl text-center"><div class="text-sm 
text-muted-foreground">è·é›¢ä¸‹ä¸€éš <span 
class="text-primary
font-bold">${next}</span> é‚„å·®</div><div class="text-4xl font-bold
text-destructive 
my-2">${parseFloat(gap.toFixed(2))}</div><div
class="text-sm
text-muted-foreground">PV</div></div><div><h4
class="font-bold
mb-2">ğŸ’¡ å»ºè­°è£œå–®çµ„åˆï¼š</h4><ul class="list-disc pl-5
space-y-1 
text-sm">${prodHtml}</ul><div
class="mt-2 text-xs 
text-muted-foreground">ç¸½è¨ˆ PV: 
${recInfo.totalPV}</div></div><button
class="w-full py-3 
bg-secondary
text-secondary-foreground rounded-lg" onclick="closeModal()">é—œé–‰</button></div>`); 
Â Â Â 
}; 
Â Â Â 
window.goToMissingRecords = function() { 
localStorage.setItem('p_statusFilter',
'active'); router('partners'); alert('å·²ç¯©é¸å‡ºæœ¬æœˆéœ€æäº¤ç´€éŒ„çš„å¤¥ä¼´'); } 
Â Â Â 
function payoutAction(month) { 
localStorage.setItem('pay_m',
month); localStorage.setItem('pay_q', ''); 
router('payout');
} 
Â 
Â Â Â 
// --- Product Catalog Management --- 
Â Â Â 
function renderCatalog() { 
Â Â Â Â Â Â Â 
const term = 
localStorage.getItem('c_search')
|| ''; 
Â Â Â Â Â Â Â 
const catalog = 
store.data.productCatalog
|| {}; 
Â Â 
Â Â Â Â Â let list = 
Object.entries(catalog).map(([pid,
p]) => ({ pid, ...p })); 
Â Â Â Â Â Â Â 
list = list.filter(p => (p.name || 
'').includes(term)
|| (p.pid || '').includes(term) || (p.category || 
'').includes(term));
Â Â Â Â Â Â Â 
list.sort((a,b) => 
(a.pid||'').localeCompare(b.pid||''));
Â Â Â Â Â Â Â document.getElementById('app').innerHTML
= ` 
Â Â Â Â Â Â Â Â Â Â Â 
<header class="flex 
items-center
justify-between mb-6 flex-wrap gap-4">${header('ç”¢å“è³‡æ–™åº«')}<div class="flex 
gap-2"><button
class="inline-flex items-center gap-2 px-4 
py-2.5
bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-lg 
font-medium
text-sm transition-colors" 
onclick="openMergeModal()">åˆä½µé‡è¤‡</button><button 
class="inline-flex
items-center gap-2 px-4 py-2.5 bg-primary 
hover:bg-primary/90
text-primary-foreground rounded-lg font-medium text-sm 
transition-colors"
onclick="editCatalogItem(null)">+ æ–°å¢ç”¢å“</button></div></header> 
Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border p-4 mb-4"><div class="flex 
flex-wrap
items-center gap-3"><input class="form-input 
w-64"
placeholder="æœå°‹ç·¨è™Ÿ / åç¨± / åˆ†é¡" 
value="${term}"
oninput="localStorage.setItem('c_search',this.value);renderCatalog()"></div></div>
Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
rounded-xl
border border-border overflow-hidden"><div 
class="overflow-x-auto"><table><thead><tr><th>ç·¨è™Ÿ (PID)</th><th>åˆ†é¡</th><th>åç¨±</th><th>PV
/ BV /
DP</th><th>æ“ä½œ</th></tr></thead><tbody>${list.map(p 
=>
`<tr><td><span class="font-mono text-sm text-primary 
font-bold">${p.pid}</span></td><td><span
class="text-xs
bg-secondary px-2 py-1 rounded 
text-muted-foreground">${p.category
|| 'æœªåˆ†é¡'}</span></td><td><span
class="font-medium
text-foreground">${p.name}</span></td><td
class="text-sm
text-muted-foreground">PV:${p.pv} / BV:${p.bv} / 
$${p.dp}</td><td>
Â 
<button class="px-3 py-1.5 text-xs 
font-medium
bg-secondary hover:bg-secondary/80 text-secondary-foreground 
rounded-lg
transition-colors mr-2" 
Â Â Â onclick="editCatalogItem('${p.pid}')">ç·¨è¼¯</button> 
Â 
Â 
<button class="px-3 py-1.5 text-xs 
font-medium
bg-secondary hover:bg-secondary/80 text-secondary-foreground 
rounded-lg
transition-colors mr-2" 
Â Â Â onclick="promptRename('${p.pid}')">æ›´å</button> 
Â 
Â 
<button class="px-3 py-1.5 text-xs 
font-medium
bg-destructive/10 hover:bg-destructive/20 text-destructive 
rounded-lg
transition-colors" 
Â Â Â onclick="deleteCatalogItem('${p.pid}')">åˆªé™¤</button> 
</td></tr>`).join('')}</tbody></table>${list.length
=== 0
? '<div class="p-8 text-center text-muted-foreground">æ²’æœ‰ç¬¦åˆçš„ç”¢å“</div>' : 
''}</div></div>`;
Â Â Â 
} 
Â 
Â Â 
Â // ========================================= 
Â Â Â 
// Catalog Management Modals & Logic 
(v10.4
Repaired) 
Â Â Â 
// 
=========================================
Â 
Â Â Â 
Â Â Â 
// 1. Open Product Selector (for 
editRecord)
Â Â Â 
window.openAddCatalogModal = 
function(isMultiMode
= false) { 
Â Â Â Â Â Â Â 
const catalog = 
store.data.productCatalog
|| {}; 
Â Â Â Â Â Â Â 
const list = 
Object.values(catalog).sort((a,b)
=> 
(a.category||'').localeCompare(b.category||''));
Â Â Â Â Â Â Â 
const groups = {}; list.forEach(p => 
{
const c = p.category || 'æœªåˆ†é¡'; if (!groups[c]) groups[c] = []; groups[c].push(p); }); 
Â 
Â Â Â Â Â Â Â 
let html = '<div 
class="space-y-4"><div
class="relative"><input 
id="cat-search"
class="form-input mb-2 pl-8" 
placeholder="æœå°‹ç·¨è™Ÿã€åç¨±æˆ–åˆ†é¡..."
oninput="filterSelector(this.value)"><span 
class="absolute
left-2.5 top-2.5 text-muted-foreground">ğŸ”</span></div><div
id="selector-list"
class="max-h-[50vh] overflow-y-auto space-y-4 
pr-1">';
Â Â Â Â Â Â Â 
if (list.length === 0) html += `<div 
class="text-center
text-muted-foreground py-8">è³‡æ–™åº«å°šç„¡ç”¢å“ï¼Œè«‹å…ˆè‡³ã€Œç”¢å“ç®¡ç†ã€æ–°å¢ã€‚</div>`; 
Â Â Â Â Â Â Â 
for(const [cat, items] of 
Object.entries(groups))
{ 
Â Â Â Â Â Â Â Â Â Â Â 
html += `<div 
class="cat-group"><h4
class="text-xs font-bold 
text-muted-foreground
uppercase tracking-wider mb-2 sticky top-0 bg-card py-1 
z-10">${escapeHtml(cat)}</h4><div
class="grid grid-cols-1 
gap-2">`;
Â Â Â Â Â Â Â Â Â Â Â 
items.forEach(p => { const 
searchStr
= `${p.pid} ${p.name} ${p.category}`.toLowerCase(); html += `<div 
class="prod-item
p-3 border border-border rounded-lg flex justify-between 
items-center
cursor-pointer hover:border-primary hover:bg-primary/5 transition 
group"
data-search="${escapeHtml(searchStr)}"
onclick="selectProductForRecord('${p.pid}')"><div><div 
class="font-bold
text-sm text-foreground 
group-hover:text-primary">${escapeHtml(p.name)}</div><div
class="text-xs
text-muted-foreground"><span 
class="font-mono
bg-secondary px-1 rounded">${p.pid}</span> 
PV:${p.pv}
/ BV:${p.bv}</div></div><button 
type="button"
class="w-8 h-8 rounded-full bg-primary/10 
text-primary
flex items-center justify-center font-bold text-lg 
hover:bg-primary
hover:text-primary-foreground 
transition">+</button></div>`;
}); 
Â Â Â Â Â Â Â Â Â Â Â 
html += `</div></div>`; 
Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â 
html += `</div></div>`; 
Â Â Â Â Â Â Â 
openCatalogModal('é¸æ“‡ç”¢å“åŠ å…¥', html); 
Â 
Â Â Â Â Â Â Â 
window.filterSelector = function(val) { 
Â Â Â Â Â Â Â Â Â Â Â 
val = normStr(val).toLowerCase(); 
Â Â Â Â Â Â Â Â Â Â Â document.querySelectorAll('.prod-item').forEach(el
=> { const match = 
el.dataset.search.includes(val);
el.style.display = match ? 'flex' : 'none'; 
}); 
Â Â Â Â Â Â Â Â Â Â Â 
document.querySelectorAll('.cat-group').forEach(grp 
=>
{ const hasVisible = 
Array.from(grp.querySelectorAll('.prod-item')).some(el
=> el.style.display 
!==
'none'); grp.style.display = hasVisible ? 'block' : 'none'; }); 
Â Â Â Â Â Â Â 
}; 
Â Â Â 
}; 
Â 
Â Â Â 
window.selectProductForRecord = 
function(pid)
{ 
Â Â Â Â Â Â Â 
if (!window.tempRec) return; 
Â Â Â Â Â Â Â 
const catalog = 
store.data.productCatalog
|| {}; const prod = catalog[pid]; if (!prod) return 
alert('ç”¢å“è³‡æ–™ç•°å¸¸'); 
Â Â Â Â Â Â Â 
if (!window.tempRec.products) 
window.tempRec.products
= []; 
Â Â Â Â Â Â Â 
const exist = 
window.tempRec.products.find(p
=> p.pid === pid || p.productId === pid); 
Â Â Â Â Â Â Â 
if (exist) { exist.qty = 
(safeNum(exist.qty)
|| 0) + 1; exist.name = prod.name; exist.pv = prod.pv; 
exist.bv
= prod.bv; exist.dp = prod.dp; } 
Â Â Â Â Â Â Â 
else { window.tempRec.products.push({ 
pid:
prod.pid, productId: prod.pid, name: prod.name, pv: prod.pv, bv: prod.bv, 
dp:
prod.dp, qty: 1, note: '' }); } 
Â Â Â Â Â Â Â 
markDirty(); if (typeof renderProducts 
===
'function') renderProducts(); if (typeof renderPreview === 'function') 
renderPreview();
closeCatalogModal(); 
Â Â Â 
}; 
Â 
Â Â Â 
// 2. Catalog CRUD 
Â Â Â 
window.editCatalogItem = function(pid) { 
Â Â Â Â Â Â Â 
const catalog = 
store.data.productCatalog
|| {}; const p = pid ? catalog[pid] : { pid:'', 
name:'',
category:'', pv:0, bv:0, dp:0 }; const isEdit = !!pid; 
Â Â Â Â Â Â Â 
if (!isEdit) { let max = 0; 
Object.values(catalog).forEach(prod
=> { const m = (prod.pid || 
'').match(/^P(\d+)$/i);
if (m) { const n = parseInt(m[1], 10); if (!isNaN(n) 
&&
n > max) max = n; } }); p.pid = 'P' + String(max + 1).padStart(4, 
'0');
} 
Â Â Â Â Â Â Â 
openCatalogModal(isEdit ? 'ç·¨è¼¯ç”¢å“' : 'æ–°å¢ç”¢å“', `<form
onsubmit="saveCatalogItem(event, '${isEdit ? p.pid : 
''}')"><div
class="row"><div 
class="col"><label
class="text-sm 
text-muted-foreground">ç”¢å“ç·¨è™Ÿ (PID) 
*</label><input
name="pid" 
value="${escapeHtml(p.pid)}"
class="form-input font-mono" 
required
placeholder="å”¯ä¸€ç·¨è™Ÿï¼Œå¦‚ 
P0001">${isEdit
? '<p class="text-xs text-muted-foreground 
mt-1">ğŸ’¡ ä¿®æ”¹ç·¨è™Ÿæœƒè‡ªå‹•åŒæ­¥æ›´æ–°æ­·å²ç´€éŒ„</p>' :
''}</div><div 
class="col"><label
class="text-sm 
text-muted-foreground">åç¨± 
*</label><input
name="name" 
value="${escapeHtml(p.name)}"
class="form-input" 
required></div></div><div
class="row"><div 
class="col"><label
class="text-sm text-muted-foreground">åˆ†é¡</label><input
list="cat-list-edit" 
name="category"
value="${escapeHtml(p.category || '')}" 
class="form-input"
placeholder="é¸æ“‡æˆ–è¼¸å…¥åˆ†é¡"><datalist 
id="cat-list-edit">${getCategoryOptionsHtml()}</datalist></div></div><div
class="row"><div
class="col"><label 
class="text-sm
text-muted-foreground">PV (å°æ•¸)</label><input name="pv" type="number"
step="0.01"
value="${p.pv||0}" class="form-input" 
required></div><div
class="col"><label 
class="text-sm
text-muted-foreground">BV (æ•´æ•¸)</label><input name="bv" type="number"
value="${p.bv||0}"
class="form-input" required></div><div 
class="col"><label
class="text-sm 
text-muted-foreground">DP
(æ•´æ•¸)</label><input
name="dp"
type="number" value="${p.dp||0}" 
class="form-input"></div></div><div
class="mt-4
flex gap-2 justify-end"><button 
type="button"
class="px-4 py-2 bg-secondary text-secondary-foreground 
rounded-lg"
onclick="closeCatalogModal()">å–æ¶ˆ</button><button class="px-6 py-2
bg-primary 
text-primary-foreground
font-bold rounded-lg">å„²å­˜</button></div></form>`); 
Â Â Â 
}; 
Â 
Â Â Â 
window.saveCatalogItem = async function(e, 
oldPid)
{ 
Â Â Â Â 
Â Â Â e.preventDefault(); const fd = new 
FormData(e.target);
const newPid = normStr(fd.get('pid')); const name = 
normStr(fd.get('name'));
Â Â Â Â Â Â Â 
if(!newPid || !name) return alert('ç·¨è™Ÿèˆ‡åç¨±ç‚ºå¿…å¡«é …ç›®'); 
Â Â Â Â Â Â Â 
const catalog = 
store.data.productCatalog
|| {}; 
Â Â Â Â Â Â 
Â if ((!oldPid && catalog[newPid]) || 
(oldPid
&& newPid !== oldPid && catalog[newPid])) { return 
alert(`ç·¨è™Ÿ [${newPid}]å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ç·¨è™Ÿã€‚`); } 
Â Â Â Â Â Â Â 
const newItem = { pid: newPid, id: 
newPid,
name: name, category: normStr(fd.get('category')) || 'æœªåˆ†é¡', pv: parseFloat(fd.get('pv')) 
|| 0,
bv: parseInt(fd.get('bv')) || 0, dp: fd.get('dp') === '' ? null : 
parseInt(fd.get('dp')),
updatedAt: getLocalToday() }; 
Â Â Â Â Â Â Â 
try { 
Â Â Â Â Â Â Â Â Â Â Â 
if (oldPid && newPid !== 
oldPid)
{ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
if(!confirm(`ç¢ºå®šè¦å°‡ç·¨è™Ÿå¾
[${oldPid}] æ”¹ç‚º [${newPid}] å—ï¼Ÿ\nç³»çµ±å°‡åŒæ­¥æ›´æ–°æ‰€æœ‰é—œè¯ç´€éŒ„ã€‚`)) return; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
delete catalog[oldPid]; 
catalog[newPid]
= newItem; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
let count = 0; 
(store.data.records
|| []).forEach(r => { (r.products || []).forEach(p => 
{ if
(p.pid === oldPid || p.productId === oldPid) { p.pid = newPid; p.productId 
=
newPid; p.name = newItem.name; count++; } }); }); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
console.log(`[Rename] Synced 
${count}
records.`); 
Â Â Â Â Â Â Â Â Â Â Â 
} else { catalog[newPid] = newItem; 
} 
Â Â Â Â Â Â Â Â Â Â Â 
store.data.productCatalog = 
catalog;
await store.save(); alert('å„²å­˜æˆåŠŸ'); closeCatalogModal(); renderCatalog(); 
Â Â Â Â Â Â Â 
} catch(err) { console.error(err); 
alert('å„²å­˜å¤±æ•—ï¼š' + 
getFirebaseErrorMsg(err));
} 
Â Â Â 
}; 
Â 
Â Â Â 
window.deleteCatalogItem = async 
function(pid)
{ 
Â Â Â Â Â Â Â 
if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¢å“
[${pid}] å—ï¼Ÿ\n\nè­¦å‘Šï¼š\n1. æ­¤ç”¢å“å°‡å¾è³‡æ–™åº«æ°¸ä¹…ç§»é™¤ã€‚\n2. æ­·å²ç´€éŒ„å°‡ä¿ç•™ã€Œå¿«ç…§è³‡æ–™ã€ï¼Œä½†æœƒå¤±å»èˆ‡è³‡æ–™åº«çš„é€£çµã€‚`)) return; 
Â Â Â Â Â Â Â 
const catalog = 
store.data.productCatalog
|| {}; delete catalog[pid]; 
Â Â Â 
Â Â Â Â (store.data.records || []).forEach(r => 
{
(r.products || []).forEach(p => { if (p.pid === pid || p.productId === 
pid) {
p.pid = ''; p.productId = ''; p.note = (p.note || '') + ` [åŸPID:${pid}å·²åˆª]`; } }); }); 
Â Â Â Â Â Â Â 
store.data.productCatalog = catalog; try 
{
await store.save(); alert('åˆªé™¤æˆåŠŸ'); renderCatalog(); } catch(err) { alert('åˆªé™¤å¤±æ•—ï¼š' + err.message); } 
Â Â Â 
}; 
Â 
Â Â Â 
window.promptRename = function(oldPid) { 
Â Â Â Â Â Â Â 
const newPid = prompt(`è«‹è¼¸å…¥æ–°çš„ç·¨è™Ÿ (åŸ: 
${oldPid})`,
oldPid); 
Â Â Â Â Â Â Â 
if (newPid && newPid.trim() !== 
oldPid)
{ renameCatalogPid(oldPid, newPid.trim()); } 
Â Â Â 
}; 
Â 
Â Â Â 
window.renameCatalogPid = async 
function(oldPid,
newPid) { 
Â Â Â Â Â Â Â 
const catalog = 
store.data.productCatalog
|| {}; if (catalog[newPid]) return alert('æ–°ç·¨è™Ÿå·²å­˜åœ¨'); 
Â Â Â Â Â Â Â 
const item = catalog[oldPid]; if(!item) 
return
alert('åŸç”¢å“ä¸å­˜åœ¨'); 
Â Â Â Â Â Â Â 
if (!confirm(`ç¢ºå®šè¦å°‡ ${oldPid}æ”¹åç‚º ${newPid} å—ï¼Ÿ\næ‰€æœ‰ç›¸é—œçš„æ­·å²æ¥­ç¸¾ç´€éŒ„å°‡æœƒåŒæ­¥æ›´æ–°ã€‚`)) return; 
Â Â Â Â Â Â Â 
item.pid = newPid; item.id = newPid; 
catalog[newPid]
= item; delete catalog[oldPid]; 
Â Â Â Â Â Â Â 
let count = 0; (store.data.records || 
[]).forEach(r
=> { (r.products || []).forEach(p => { if (p.pid === oldPid 
||
p.productId === oldPid) { p.pid = newPid; p.productId = newPid; count++; } 
});
}); 
Â Â Â Â Â Â Â 
store.data.productCatalog = catalog; 
try {
await store.save(); alert(`æ›´åæˆåŠŸï¼å·²åŒæ­¥ ${count} ç­†ç´€éŒ„ã€‚`); renderCatalog(); } 
catch(e)
{ alert(e.message); } 
Â Â Â 
}; 
Â 
Â Â Â 
// 5. Merge Modal & Logic 
Â Â Â 
window.openMergeModal = function() { 
Â Â Â Â Â Â Â 
const catalog = 
store.data.productCatalog
|| {}; 
Â Â Â Â Â Â Â 
const list = 
Object.values(catalog).sort((a,b)
=> a.pid.localeCompare(b.pid)); 
Â Â Â Â Â Â Â 
const options = list.map(p => 
`<option
value="${p.pid}">${p.pid} 
${escapeHtml(p.name)}</option>`).join('');
Â Â Â Â Â Â Â 
openCatalogModal('åˆä½µé‡è¤‡ç”¢å“', `<div 
class="space-y-4"><div
class="p-3 bg-warning/10 
text-warning
border border-warning/30 rounded text-sm">âš ï¸ <b>è­¦å‘Šï¼š</b> <br>æ­¤æ“ä½œå°‡æŠŠã€Œä¾†æºç”¢å“ã€çš„æ‰€æœ‰æ­·å²ç´€éŒ„è½‰ç§»çµ¦ã€Œç›®æ¨™ç”¢å“ã€ï¼Œä¸¦<b>æ°¸ä¹…åˆªé™¤</b>ä¾†æºç”¢å“ã€‚<br>è‹¥åŒä¸€ç­†ç´€éŒ„åŒæ™‚åŒ…å«å…©è€…ï¼Œæ•¸é‡å°‡æœƒè‡ªå‹•åŠ ç¸½ã€‚</div><div
class="grid
grid-cols-1 md:grid-cols-2 gap-4"><div><label 
class="text-sm
font-bold block mb-1 text-destructive">âŒ ä¾†æºç”¢å“ (å°‡è¢«åˆªé™¤)</label><select
id="merge-source"
class="form-input">${options}</select></div><div
class="flex
justify-center text-muted-foreground text-xl">â¬‡ï¸ åˆä½µè‡³ â¬‡ï¸</div><div><label
class="text-sm
font-bold block mb-1 text-primary">âœ… ç›®æ¨™ç”¢å“ (ä¿ç•™)</label><select
id="merge-target"
class="form-input">${options}</select></div></div><button
class="w-full
py-3 bg-destructive text-destructive-foreground font-bold rounded-lg 
mt-2"
onclick="performMerge()">ç¢ºèªåˆä½µ</button></div>`); 
Â Â Â 
}; 
Â 
Â Â Â 
window.performMerge = async function() { 
Â Â Â Â Â Â Â 
const sPid = 
document.getElementById('merge-source').value;
const tPid = 
document.getElementById('merge-target').value;
Â Â Â Â Â Â Â 
if (!sPid || !tPid) return alert('è«‹é¸æ“‡ç”¢å“'); if (sPid === tPid) return 
alert('ä¾†æºèˆ‡ç›®æ¨™ä¸èƒ½ç›¸åŒ'); 
Â Â Â Â Â Â Â 
const catalog = 
store.data.productCatalog
|| {}; const targetProd = catalog[tPid]; 
Â Â Â Â Â Â Â 
if (!confirm(`ã€æœ€çµ‚ç¢ºèªã€‘\n\nç¢ºå®šè¦å°‡ [${sPid}] åˆä½µåˆ° [${tPid}] å—ï¼Ÿ\n[${sPid}] å°‡æœƒæ¶ˆå¤±ï¼`)) return; 
Â Â Â Â Â Â Â 
let recUpdateCount = 0; 
Â Â Â Â Â Â Â 
(store.data.records || []).forEach(r 
=>
{ 
Â Â Â Â Â Â Â Â Â Â Â 
if (!r.products || 
r.products.length
=== 0) return; 
Â Â Â Â Â Â Â Â Â Â Â 
let sourceIdx = -1; let targetIdx = 
-1; 
Â Â Â Â Â Â Â Â Â Â Â 
r.products.forEach((p, idx) => { 
const
pid = p.pid || p.productId; if (pid === tPid) targetIdx = idx; if (pid 
===
sPid) { sourceIdx = idx; } }); 
Â Â Â Â Â Â Â Â Â Â Â 
if (sourceIdx !== -1) { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
recUpdateCount++; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const sProd = 
r.products[sourceIdx];
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
if (targetIdx !== -1) { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const tProd = 
r.products[targetIdx];
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
tProd.qty = 
(safeNum(tProd.qty)
+ safeNum(sProd.qty)); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â r.products.splice(sourceIdx,
1); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
} else { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
sProd.pid = tPid; 
sProd.productId
= tPid; sProd.name = targetProd.name; sProd.pv = targetProd.pv; 
sProd.bv
= targetProd.bv; sProd.dp = targetProd.dp; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â 
}); 
Â Â Â Â Â Â Â 
delete catalog[sPid]; 
store.data.productCatalog
= catalog; 
Â Â Â Â Â Â Â 
try { await 
store.save();
alert(`åˆä½µå®Œæˆï¼å…±è™•ç†äº† 
${recUpdateCount}ç­†ç›¸é—œç´€éŒ„ã€‚`);
closeCatalogModal(); 
renderCatalog();
} catch(err) { alert('åˆä½µå¤±æ•—ï¼š' + 
err.message);
} 
Â Â Â 
}; 
// 
=========================================
Â Â 
// G) Records Management (æ¥­ç¸¾ç´€éŒ„) 
Â Â 
// ========================================= 
Â Â 
function renderRecords() { 
Â Â Â Â Â Â 
const m = 
localStorage.getItem(STORAGE_KEYS.MONTH_REC)
|| getLocalMonth(); 
Â Â Â Â Â Â 
const term = 
(localStorage.getItem(STORAGE_KEYS.SEARCH_REC)
|| '').toLowerCase(); 
Â Â Â Â Â Â 
const onlyUnpaid = 
localStorage.getItem(STORAGE_KEYS.UNPAID_REC)
=== 'true'; 
Â 
Â Â Â Â Â Â 
// Filter & Sort 
Â Â Â Â Â Â 
let raw = store.getRecordsByMonth(m); 
Â Â Â Â Â Â 
if (onlyUnpaid) raw = raw.filter(r => 
r.payoutStatus
!== 'paid'); 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
let list = raw.map(calculate).filter(x 
=>
x); 
Â Â Â Â Â Â 
if (term) { 
Â Â Â Â Â Â Â Â Â Â 
list = list.filter(r => 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
(r.partnerName || 
'').toLowerCase().includes(term)
|| 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
(r.products || []).some(p => 
(p.name||'').toLowerCase().includes(term))
Â Â Â Â Â Â Â Â Â Â 
); 
Â Â Â Â Â Â 
} 
Â Â Â Â Â Â 
// Sort: Unpaid first, then by date desc 
Â Â Â Â Â Â 
list.sort((a,b) => { 
Â Â Â Â Â Â Â Â Â Â Â 
if(a.payoutStatus !== 
b.payoutStatus)
return a.payoutStatus === 'paid' ? 1 : -1; 
Â Â Â Â Â Â Â Â Â Â Â 
return (b.date || 
'').localeCompare(a.date
|| ''); 
Â Â Â Â Â Â 
}); 
Â 
Â Â Â Â Â Â 
// Stats 
Â Â Â Â Â Â 
const sumPV = list.reduce((s,r) => s 
+
(r.gpv||0), 0); 
Â Â Â Â Â Â 
const sumBonus = list.reduce((s,r) => 
s +
(r.totalIncome||0), 0); 
Â 
Â Â Â Â Â Â 
document.getElementById('app').innerHTML 
= ` 
Â Â Â Â Â Â 
<header class="flex items-center 
justify-between
mb-6 flex-wrap gap-4"> 
Â Â Â Â Â Â Â Â Â Â 
${header('æœˆä»½æ¥­ç¸¾ç´€éŒ„')} 
Â Â Â Â Â Â Â Â Â Â 
<button class="px-4 py-2 
bg-primary
text-primary-foreground font-bold rounded-lg hover:bg-primary/90 
transition"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â onclick="editRecord(null)">+æ–°å¢ç´€éŒ„</button>
Â Â Â Â Â Â 
</header> 
Â 
Â Â Â Â Â Â 
<div class="bg-card rounded-xl 
border
border-border p-4 mb-4 space-y-4"> 
Â Â Â Â Â Â Â Â Â Â 
<div class="flex flex-wrap 
items-end
gap-4"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="text-xs
text-muted-foreground block mb-1">æœˆä»½</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="month"
class="form-input w-40" value="${m}" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onchange="localStorage.setItem('${STORAGE_KEYS.MONTH_REC}',
this.value);
renderRecords()"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex-1 
min-w-[200px]">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="text-xs
text-muted-foreground block mb-1">æœå°‹å¤¥ä¼´æˆ–ç”¢å“</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
class="form-input"
placeholder="æœå°‹..." 
value="${term}"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â oninput="localStorage.setItem('${STORAGE_KEYS.SEARCH_REC}',
this.value);
renderRecords()"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
items-center
gap-2 pb-2"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span class="text-sm 
text-muted-foreground">é¡¯ç¤ºæ¨¡å¼:</span> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ${getPvViewSelect('renderRecords')}
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â </div> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
items-center
gap-4 text-sm border-t border-border pt-3"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span 
class="text-muted-foreground">ç¯©é¸çµ±è¨ˆ:</span> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span class="font-bold 
text-foreground">GPV:
${sumPV.toLocaleString()}</span> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span class="font-bold 
text-primary">çé‡‘: 
${money(sumBonus)}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label class="flex 
items-center
gap-2 ml-auto cursor-pointer select-none"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="checkbox"
${onlyUnpaid ? 'checked' : ''} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onchange="localStorage.setItem('${STORAGE_KEYS.UNPAID_REC}',
this.checked);
renderRecords()"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span>åªçœ‹æœªç™¼æ”¾</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</label> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
</div> 
Â 
Â Â Â Â Â Â 
<div class="bg-card rounded-xl border 
border-border
overflow-hidden"> 
Â Â Â Â Â Â Â Â Â Â 
<div 
class="overflow-x-auto">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<table> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<thead> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<tr> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>æ—¥æœŸ</th> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>å¤¥ä¼´å§“å</th>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>å€‹äºº PV /
GPV</th> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>æœ¬æœˆä½éš</th>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>æ–°æ˜Ÿçé‡‘</th>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>ç”¢å“æ˜ç´°</th>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>ç‹€æ…‹</th> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>æ“ä½œ</th> 
Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </tr>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</thead> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<tbody> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${list.map(r => { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const pList = 
(r.products||[]).map(p
=> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
`<div 
class="text-xs
text-muted-foreground"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ${escapeHtml(p.name)}
<span 
class="opacity-70">x${p.qty}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div>` 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
).join('').slice(0, 
150);
// limit length 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â return
`<tr> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td 
class="whitespace-nowrap
text-xs 
text-muted-foreground">${r.date.slice(5)}</td>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="font-bold">${r.partnerName}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="text-xs
text-muted-foreground">${r.participation === 
'active'
? 'åƒèˆ‡ä¸­' : 'ä¸åƒèˆ‡'}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="text-sm">P:
${formatPvBv(r.ppv, r.pbv)}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="text-xs
text-muted-foreground">G: ${r.gpv}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span class="badge 
${r.myRate
>= 0.09 ? 'bg-primary/20 text-primary' : 'bg-secondary 
text-muted-foreground'}
px-2 py-0.5 rounded text-xs font-bold"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ${(r.myRate
* 100).toFixed(0)}% 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td 
class="font-mono
font-bold text-foreground"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ${r.totalIncome
> 0 ? money(r.totalIncome) : '<span class="text-muted-foreground">-</span>'}
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td 
class="max-w-[200px]
truncate"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${pList || 
'<span
class="text-muted-foreground">-</span>'} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â </td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span 
class="text-xs
px-2 py-1 rounded font-bold ${r.payoutStatus==='paid' ? 
'bg-success/10
text-success' : 'bg-destructive/10 text-destructive'}"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â ${r.payoutStatus
=== 'paid' ? 'å·²ç™¼' : 'æœªç™¼'} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
onclick="editRecord('${r.id}')"
class="text-primary 
hover:underline
text-xs mr-2">ç·¨è¼¯</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
onclick="deleteRecord('${r.id}')"
class="text-destructive 
hover:underline
text-xs">åˆªé™¤</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</tr>`; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
}).join('')} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</tbody> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</table> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${list.length === 0 ? '<div 
class="p-8
text-center text-muted-foreground">ç„¡è³‡æ–™</div>' : ''} 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
</div>`; 
Â Â 
} 
Â 
Â Â 
window.editRecord = function(id) { 
Â Â Â Â Â Â 
const m = 
localStorage.getItem(STORAGE_KEYS.MONTH_REC)
|| getLocalMonth(); 
Â Â Â Â Â Â 
const partners = store.data.partners || 
[]; 
Â Â Â Â Â Â 
const versions = store.data.versions || 
[]; 
Â Â Â Â Â Â 
const activeV = versions.find(v => 
!v.archived)
|| versions[0]; 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
let rec = id ? store.getRecord(id) : { 
Â Â Â Â Â Â Â Â Â Â 
id: uuid(), month: m, date: 
getToday(m),
Â Â Â Â Â Â Â Â Â Â 
partnerId: partners.length ? 
partners[0].id
: '', 
Â Â Â Â Â Â Â Â Â Â 
ppv: 0, pbv: 0, gpv: 0, gbv: 0, 
Â Â Â Â Â Â Â Â Â Â 
planVersionId: activeV ? activeV.id 
: '', 
Â Â Â Â Â Â Â Â Â Â 
participation: 'active', 
payoutStatus:
'unpaid', 
Â Â Â Â Â Â Â Â Â Â 
learningDone: false, products: [], 
legs:
[], newRecruits: [] 
Â Â Â Â Â Â 
}; 
Â 
Â Â Â Â Â Â 
// Deep copy for temp state 
Â Â Â Â Â Â 
window.tempRec = 
JSON.parse(JSON.stringify(rec));
Â Â Â Â Â Â 
if (!window.tempRec.products) 
window.tempRec.products
= []; 
Â 
Â Â Â Â Â Â 
const pOptions = partners.map(p => 
`<option
value="${p.id}" ${p.id===rec.partnerId?'selected':''}>${p.code} 
${p.name}</option>`).join('');
Â Â Â Â Â Â 
Â Â Â Â Â Â 
const modalHtml = ` 
Â Â Â Â Â Â 
<div class="grid grid-cols-1 
md:grid-cols-3
gap-6 h-full overflow-hidden"> 
Â Â Â Â Â Â Â Â Â Â 
<div class="md:col-span-1 
space-y-4
overflow-y-auto pr-2"> 
Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="text-xs
text-muted-foreground">å¤¥ä¼´</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<select 
id="rec-pid"
class="form-input" 
onchange="window.tempRec.partnerId
= 
this.value">${pOptions}</select>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â <div class="grid grid-cols-2 
gap-2">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="text-xs
text-muted-foreground">æ—¥æœŸ</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="date"
class="form-input" 
value="${rec.date}"
onchange="window.tempRec.date = 
this.value">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="text-xs
text-muted-foreground">åƒèˆ‡ç‹€æ…‹</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<select 
class="form-input"
onchange="window.tempRec.participation = 
this.value">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="active"
${rec.participation==='active'?'selected':''}>åƒèˆ‡</option> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="inactive"
${rec.participation==='inactive'?'selected':''}>ä¸åƒèˆ‡</option> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</select> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="p-3 
bg-secondary/10
rounded-lg border border-border"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label class="flex 
items-center
gap-2 cursor-pointer"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="checkbox"
class="w-4 h-4 rounded border-gray-500 
text-primary
focus:ring-primary" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${rec.learningDone ? 
'checked'
: ''} onchange="window.tempRec.learningDone = 
this.checked">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span 
class="text-sm
font-medium">å®Œæˆå­¸ç¿’ (åŠ æˆ 3%)</span> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<hr 
class="border-border">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="space-y-3"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<h4 class="text-sm 
font-bold
text-foreground">æ¥­ç¸¾æ•¸å€¼</h4> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="text-xs
text-muted-foreground flex justify-between"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â å€‹äºº PV / BV
<span class="text-[10px] 
text-primary
cursor-pointer" onclick="autoCalcBV()">è‡ªå‹•æ›ç®—BV</span> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
gap-2">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="number"
class="form-input" id="rec-ppv" 
placeholder="PPV"
value="${rec.ppv}" 
onchange="updateVal('ppv',
this.value)"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="number"
class="form-input" id="rec-pbv" 
placeholder="PBV"
value="${rec.pbv}" 
onchange="updateVal('pbv',
this.value)"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="text-xs
text-muted-foreground">å°çµ„ GPV / GBV</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
gap-2">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="number"
class="form-input" id="rec-gpv" 
placeholder="GPV"
value="${rec.gpv}" 
onchange="updateVal('gpv',
this.value)"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="number"
class="form-input" id="rec-gbv" 
placeholder="GBV"
value="${rec.gbv}" 
onchange="updateVal('gbv',
this.value)"> 
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<p 
class="text-[10px]
text-muted-foreground mt-1">* GPV æ‡‰åŒ…å« PPV</p> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â 
Â Â Â Â Â Â Â Â Â Â 
<div class="md:col-span-2 
flex
flex-col h-full overflow-hidden"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
border-b
border-border mb-3"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button class="px-4 
py-2
text-sm font-bold border-b-2 border-primary text-primary">ç”¢å“æ˜ç´°</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex-1 
overflow-y-auto
bg-secondary/5 rounded-lg border border-border p-3 mb-3 
relative">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
id="rec-prod-list"
class="space-y-2"></div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
class="absolute
bottom-4 right-4 w-12 h-12 bg-primary 
text-primary-foreground
rounded-full shadow-lg flex items-center justify-center 
text-2xl
hover:scale-110 transition" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onclick="openAddCatalogModal()"
title="å¾è³‡æ–™åº«åŠ å…¥ç”¢å“">+</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div id="rec-preview" 
class="p-3
bg-card border border-border rounded-lg 
text-sm"></div>
Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="mt-4 flex 
justify-end
gap-3"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button class="px-4 
py-2
rounded-lg hover:bg-secondary transition" 
onclick="closeModalSafe()">å–æ¶ˆ</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button class="px-6 
py-2
bg-primary text-primary-foreground font-bold rounded-lg 
hover:bg-primary/90
transition" onclick="saveRecord()">å„²å­˜ç´€éŒ„</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
</div>`; 
Â 
Â Â Â Â Â Â 
openModal(id ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢ç´€éŒ„', 
modalHtml);
Â Â Â Â Â Â 
renderProducts(); 
Â Â Â Â Â Â 
renderPreview(); 
Â 
Â Â Â Â Â Â 
window.updateVal = function(key, val) { 
Â Â Â Â Â Â Â Â Â Â 
window.tempRec[key] = 
parseFloat(val)
|| 0; 
Â Â Â Â Â Â Â Â Â Â 
renderPreview(); 
Â Â Â Â Â Â 
}; 
Â Â Â Â Â Â 
window.autoCalcBV = function() { 
Â Â Â Â Â Â Â Â Â Â 
const ppv = 
parseFloat(document.getElementById('rec-ppv').value)
|| 0; 
Â Â Â Â Â Â Â Â Â Â 
const gpv = 
parseFloat(document.getElementById('rec-gpv').value)
|| 0; 
Â Â Â Â Â Â Â Â Â Â document.getElementById('rec-pbv').value
= pvToBv(ppv); 
Â Â Â Â Â Â Â Â Â Â document.getElementById('rec-gbv').value
= pvToBv(gpv); 
Â Â Â Â Â Â Â Â Â Â 
window.tempRec.pbv = pvToBv(ppv); 
Â Â Â Â Â Â Â Â Â Â 
window.tempRec.gbv = pvToBv(gpv); 
Â Â Â Â Â Â Â Â Â Â 
renderPreview(); 
Â Â Â Â Â Â 
}; 
Â Â 
}; 
Â 
Â Â 
// Render Product List in Modal 
Â Â 
window.renderProducts = function() { 
Â Â Â Â Â Â 
const listEl = 
document.getElementById('rec-prod-list');
Â Â Â Â Â Â 
if (!listEl) return; 
Â Â Â Â Â Â 
const prods = window.tempRec.products || 
[]; 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
if (prods.length === 0) { 
Â Â Â Â Â Â Â Â Â Â 
listEl.innerHTML = `<div 
class="flex
flex-col items-center justify-center h-full 
text-muted-foreground
opacity-50"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span class="text-4xl 
mb-2">ğŸ“¦</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span>å°šç„¡ç”¢å“ï¼Œé»æ“Šå³ä¸‹è§’ + æ–°å¢</span> 
Â Â Â Â Â Â Â Â Â Â 
</div>`; 
Â Â Â Â Â Â Â Â Â Â 
return; 
Â Â Â Â Â Â 
} 
Â 
Â Â Â Â Â Â 
let sumPPV = 0, sumDP = 0; 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
listEl.innerHTML = prods.map((p, idx) 
=>
{ 
Â Â Â Â Â Â Â Â Â Â 
const totalPv = (p.pv || 0) * (p.qty 
|| 1);
Â Â Â Â Â Â Â Â Â Â 
sumPPV += totalPv; 
Â Â Â Â Â Â Â Â Â Â 
sumDP += (p.dp || 0) * (p.qty || 1); 
Â Â Â Â Â Â Â Â Â Â 
Â 
Â Â Â Â Â Â Â Â Â // Check if PID still
exists in 
catalog
(for warning) 
Â Â Â Â Â Â Â Â Â Â 
const catItem = 
(store.data.productCatalog||{})[p.pid
|| p.productId]; 
Â Â Â Â Â Â Â Â Â Â 
const warning = !catItem ? '<span 
class="text-[10px]
text-destructive border border-destructive px-1 rounded 
ml-2">å·²è‡ªè³‡æ–™åº«åˆªé™¤</span>' : ''; 
Â 
Â Â Â Â Â Â Â Â Â Â 
return `<div class="flex 
items-center
gap-3 p-3 bg-card rounded border border-border 
hover:border-primary/50
transition group"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="w-8 h-8 
rounded
bg-secondary flex items-center justify-center font-mono text-xs 
text-muted-foreground">${idx+1}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="flex-1">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="font-bold
text-sm flex items-center">${p.name} 
${warning}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-xs 
text-muted-foreground
font-mono"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${p.pid} | å–®åƒ¹ PV:${p.pv} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
items-center
gap-3"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="text-right
mr-2"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="font-bold
text-sm 
text-primary">${parseFloat(totalPv.toFixed(2))}
PV</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="text-xs
text-muted-foreground">$${(p.dp * 
p.qty).toLocaleString()}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
items-center
border border-border rounded overflow-hidden"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
class="px-2
py-1 hover:bg-secondary" 
onclick="updateProdQty(${idx},
-1)">-</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
class="w-10
text-center text-sm bg-transparent border-0 p-0 
focus:ring-0"
value="${p.qty}" readonly> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button class="px-2 
py-1
hover:bg-secondary" onclick="updateProdQty(${idx}, 
1)">+</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
class="text-muted-foreground
hover:text-destructive p-1 opacity-0 
group-hover:opacity-100
transition" onclick="removeProd(${idx})">âœ•</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
</div>`; 
Â Â Â Â Â Â 
}).join(''); 
Â 
Â Â Â Â Â Â 
// Auto-update PPV input if user allows 
(Logic:
if manual PPV is roughly equal to sum, keep syncing) 
Â Â Â Â Â Â 
// For simplicity, we just show the sum 
in
preview 
Â Â Â Â Â Â 
window.tempRec.calc_sumPPV = sumPPV; 
Â Â Â Â Â Â 
window.tempRec.calc_sumDP = sumDP; 
Â Â 
}; 
Â 
Â Â 
window.updateProdQty = function(idx, delta) 
{ 
Â Â Â Â Â Â 
const p = window.tempRec.products[idx]; 
Â Â Â Â Â Â 
p.qty = Math.max(1, (p.qty || 1) + 
delta);
Â Â Â Â Â Â 
renderProducts(); renderPreview(); 
Â Â 
}; 
Â 
Â Â 
window.removeProd = function(idx) { 
Â Â Â Â Â Â 
window.tempRec.products.splice(idx, 1); 
Â Â Â Â Â Â 
renderProducts(); renderPreview(); 
Â Â 
}; 
Â 
Â Â 
window.renderPreview = function() { 
Â Â Â Â Â Â 
const r = window.tempRec; 
Â Â Â Â Â Â 
const res = calculate(r); // Dry run 
calculation
Â Â Â Â Â Â 
const el = 
document.getElementById('rec-preview');
Â Â Â Â Â Â 
if(!el || !res) return; 
Â 
Â Â Â Â Â Â 
const prodSyncBtn = `<button 
class="text-[10px]
underline ml-2 text-primary" 
onclick="syncPpvFromProds()">å¥—ç”¨</button>`; 
Â Â Â Â Â Â 
const prodSumTxt = r.calc_sumPPV ? `(ç”¢å“åŠ ç¸½: ${parseFloat(r.calc_sumPPV.toFixed(2))} PV 
${prodSyncBtn})`
: ''; 
Â 
Â Â Â Â Â Â 
el.innerHTML = ` 
Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
justify-between
items-center"> 
Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â <div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span class="text-xs 
text-muted-foreground">é ä¼°çé‡‘</span> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-xl 
font-bold
text-primary">${money(res.totalIncome)}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-right 
text-xs
text-muted-foreground"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div>ä½éš: <span
class="font-bold 
text-foreground">${(res.myRate*100).toFixed(0)}%</span></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div>åŸºç¤:
${money(res.baseBonus)} / æ¨è–¦:
${money(res.recruitBonus)}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="mt-1">${prodSumTxt}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
`; 
Â Â 
}; 
Â 
Â Â 
window.syncPpvFromProds = function() { 
Â Â Â Â Â Â 
if(window.tempRec.calc_sumPPV) { 
Â Â Â Â Â Â Â Â Â Â 
const pv = 
parseFloat(window.tempRec.calc_sumPPV.toFixed(2));
Â Â Â Â Â Â Â Â Â Â 
document.getElementById('rec-ppv').value 
= pv; 
Â Â Â Â Â Â Â Â Â Â document.getElementById('rec-pbv').value
= pvToBv(pv); 
Â Â Â Â Â Â Â Â Â Â 
// Assume GPV is at least PPV 
Â Â Â Â Â Â Â Â Â Â 
const curGpv = 
parseFloat(document.getElementById('rec-gpv').value)||0;
Â Â Â Â Â Â Â Â Â Â 
if(curGpv < pv) { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('rec-gpv').value
= pv; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('rec-gbv').value
= pvToBv(pv); 
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â window.tempRec.gpv = pv; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
window.tempRec.gbv = pvToBv(pv); 
Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â Â Â Â Â 
window.tempRec.ppv = pv; 
Â Â Â Â Â Â Â Â Â Â 
window.tempRec.pbv = pvToBv(pv); 
Â Â Â Â Â Â Â Â Â Â 
renderPreview(); 
Â Â Â Â Â Â 
} 
Â Â 
}; 
Â 
Â Â 
window.saveRecord = async function() { 
Â Â Â Â Â Â const
r = window.tempRec; 
Â Â Â Â Â Â 
if (!r.partnerId) return alert('è«‹é¸æ“‡å¤¥ä¼´'); 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
// Clean up temp props 
Â Â Â Â Â Â 
delete r.calc_sumPPV; delete 
r.calc_sumDP;
Â 
Â Â Â Â Â Â 
// Find if edit or new 
Â Â Â Â Â Â 
const idx = 
store.data.records.findIndex(x
=> x.id === r.id); 
Â Â Â Â Â Â 
if (idx >= 0) store.data.records[idx] 
= r; 
Â Â Â Â Â Â 
else store.data.records.push(r); 
Â 
Â Â Â Â Â Â 
try { 
Â Â Â Â Â Â Â Â Â Â 
await store.save(); 
Â Â Â Â Â Â Â Â Â Â 
isDirty = false; 
Â Â Â Â Â Â Â Â Â Â 
closeModal(); 
Â Â Â Â Â Â Â Â Â Â 
renderRecords(); 
Â Â Â Â Â Â 
} catch (e) { alert(e.message); } 
Â Â 
}; 
Â 
Â Â 
window.deleteRecord = async function(id) { 
Â Â Â Â Â Â 
if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ'))
return; 
Â Â Â Â Â Â 
store.data.records = 
store.data.records.filter(r
=> r.id !== id); 
Â Â Â Â Â Â 
await store.save(); 
Â Â Â Â Â Â 
renderRecords(); 
Â Â 
}; 
Â 
Â Â 
// ========================================= 
Â Â 
// H) Payout Management (ç™¼æ”¾ç¸½è¡¨) 
Â Â 
// ========================================= 
Â Â 
function renderPayout() { 
Â Â Â Â Â Â 
const m = 
localStorage.getItem(STORAGE_KEYS.MONTH_PAY)
|| getLocalMonth(); 
Â Â Â Â Â 
Â const term = 
localStorage.getItem(STORAGE_KEYS.SEARCH_PAY)
|| ''; 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
let raw = store.getRecordsByMonth(m); 
Â Â Â Â Â Â 
let list = raw.map(calculate).filter(r 
=>
r && r.totalIncome > 0); 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
if (term) list = list.filter(r => 
r.partnerName.includes(term));
Â Â Â Â Â Â 
Â Â Â Â Â Â 
// Sort by income desc 
Â Â Â Â Â Â 
list.sort((a,b) => b.totalIncome - 
a.totalIncome);
Â 
Â Â Â Â Â Â 
const totalPay = list.reduce((s,r) => 
s +
r.totalIncome, 0); 
Â Â Â Â Â Â 
const unpaid = list.filter(r => 
r.payoutStatus
!== 'paid').reduce((s,r) => s + r.totalIncome, 0); 
Â 
Â Â Â Â Â Â 
document.getElementById('app').innerHTML 
= ` 
Â Â Â Â Â Â 
<header class="flex items-center 
justify-between
mb-6 flex-wrap gap-4"> 
Â Â Â Â Â Â Â Â Â Â 
${header('æœ¬æœˆç™¼æ”¾ç¸½è¡¨')} 
Â Â Â Â Â Â Â Â Â Â 
<button class="px-4 py-2 
bg-secondary
text-secondary-foreground rounded-lg text-sm" 
onclick="exportPayout('${m}')">åŒ¯å‡ºå ±è¡¨</button> 
Â Â Â Â Â Â 
</header> 
Â 
Â Â Â Â Â Â 
<div class="grid grid-cols-1 
md:grid-cols-3
gap-4 mb-6"> 
Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card p-4 
rounded-xl
border border-border"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-xs 
text-muted-foreground">æ‡‰ç™¼ç¸½é¡</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-2xl 
font-bold">${money(totalPay)}</div>
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card p-4 
rounded-xl
border border-border"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-xs 
text-muted-foreground">æœªç™¼é¤˜é¡</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-2xl 
font-bold
text-destructive">${money(unpaid)}</div> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card p-4 
rounded-xl
border border-border flex items-end gap-2"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="flex-1">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="text-xs
text-muted-foreground">æœˆä»½</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="month"
class="form-input" value="${m}" 
onchange="localStorage.setItem('${STORAGE_KEYS.MONTH_PAY}',
this.value); 
renderPayout()">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="flex-1">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="text-xs
text-muted-foreground">æœå°‹</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
class="form-input"
placeholder="å§“å..." 
value="${term}"
oninput="localStorage.setItem('${STORAGE_KEYS.SEARCH_PAY}', 
this.value);
renderPayout()"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
</div> 
Â 
Â Â Â Â Â Â 
<div class="bg-card rounded-xl 
border
border-border overflow-hidden"> 
Â Â Â Â Â Â Â Â Â Â 
<div 
class="overflow-x-auto">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<table> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<thead> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<tr> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>å¤¥ä¼´</th> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>ä½éš</th> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>çé‡‘çµæ§‹</th>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â <th>æ‡‰ç™¼é‡‘é¡</th> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>ç‹€æ…‹</th> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<th>æ“ä½œ</th> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</tr> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</thead> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<tbody> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${list.map(r => 
`<tr>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â <td 
class="font-bold">${r.partnerName}</td>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <td>${(r.myRate*100).toFixed(0)}%
<span class="text-xs 
text-muted-foreground
block">${r.appliedRateText||''}</span></td>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td 
class="text-xs
text-muted-foreground"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div>åŸºç¤:
${money(r.baseBonus)}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${r.recruitBonus 
?
`<div>æ¨è–¦:
${money(r.recruitBonus)}</div>` : ''} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ${r.learningBonus
? `<div>å­¸ç¿’: 
${money(r.learningBonus)}</div>`
: ''} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td 
class="font-bold
text-lg 
text-primary">${money(r.totalIncome)}</td>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
onclick="togglePayStatus('${r.id}')"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â class="px-3
py-1 rounded-full text-xs font-bold transition-all ${ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â r.payoutStatus==='paid'
? 'bg-success text-primary-foreground' : 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â r.payoutStatus==='hold'
? 'bg-warning text-warning-foreground' : 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 'bg-secondary
text-muted-foreground hover:bg-destructive 
hover:text-white'
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
}"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ${r.payoutStatus==='paid'
? 'âœ… å·²ç™¼æ”¾' : r.payoutStatus==='hold' ? 'â¸ï¸ æš«ç·©' : 'â³ æœªç™¼æ”¾'} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
class="text-muted-foreground
hover:text-foreground text-xs" 
onclick="viewDetail('${r.id}')">æ˜ç´°</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</td> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</tr>`).join('')} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</tbody> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</table> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${list.length === 0 ? '<div 
class="p-8
text-center text-muted-foreground">ç„¡çé‡‘è³‡æ–™</div>' : ''} 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
</div>`; 
Â Â 
} 
Â 
Â Â 
window.togglePayStatus = async function(id) 
{ 
Â Â Â Â Â Â 
const r = store.getRecord(id); 
Â Â Â Â Â Â 
if(!r) return; 
Â Â Â Â Â Â 
// Cycle: unpaid -> paid -> hold 
->
unpaid 
Â Â Â Â Â Â 
const next = r.payoutStatus === 'unpaid' 
?
'paid' : (r.payoutStatus === 'paid' ? 'hold' : 'unpaid'); 
Â Â Â Â Â Â 
r.payoutStatus = next; 
Â Â Â Â Â Â 
await store.save(); 
Â Â Â Â Â Â 
renderPayout(); 
Â Â 
}; 
Â Â 
Â Â 
window.exportPayout = function(m) { 
Â Â Â Â Â Â 
alert('åŠŸèƒ½é–‹ç™¼ä¸­ï¼šå°‡åŒ¯å‡º
Excel/CSV'); 
Â Â 
}; 
Â 
Â Â 
// ========================================= 
Â Â 
// I) Partners Management (å¤¥ä¼´ç®¡ç†) 
Â Â 
// ========================================= 
Â Â 
function renderPartners() { 
Â Â Â Â Â Â 
const term = 
(localStorage.getItem(STORAGE_KEYS.SEARCH_P)
|| '').toLowerCase(); 
Â Â Â Â Â Â 
const statusFilter = 
localStorage.getItem(STORAGE_KEYS.STATUS_P)
|| 'all'; 
Â Â Â Â Â Â 
const sort = 
localStorage.getItem(STORAGE_KEYS.SORT_P)
|| 'joinDesc'; 
Â 
Â Â Â Â Â Â 
let list = [...(store.data.partners || 
[])]; 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
if (statusFilter !== 'all') list = 
list.filter(p
=> p.status === statusFilter); 
Â Â Â Â Â Â 
if (term) list = list.filter(p => 
p.name.toLowerCase().includes(term)
|| p.code.toLowerCase().includes(term)); 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
// Sort 
Â Â Â Â Â Â 
list.sort((a,b) => { 
Â Â Â Â Â Â Â Â Â Â 
if (sort === 'joinDesc') return 
(b.joinedAt||'').localeCompare(a.joinedAt||'');
Â Â Â Â Â Â Â Â Â Â 
if (sort === 'joinAsc') return 
(a.joinedAt||'').localeCompare(b.joinedAt||'');
Â Â Â Â Â Â Â Â Â Â 
if (sort === 'name') return 
a.name.localeCompare(b.name);
Â Â Â Â Â Â Â Â Â Â 
return 0; 
Â Â Â Â Â Â 
}); 
Â 
Â Â Â Â Â Â 
document.getElementById('app').innerHTML 
= ` 
Â Â Â Â Â Â 
<header class="flex items-center 
justify-between
mb-6 flex-wrap gap-4"> 
Â Â Â Â Â Â Â Â Â Â 
${header('å¤¥ä¼´åå–®ç®¡ç†')} 
Â Â Â Â Â Â Â Â Â Â 
<button class="px-4 py-2 
bg-primary
text-primary-foreground font-bold rounded-lg" 
onclick="editPartner(null)">+æ–°å¢å¤¥ä¼´</button>
Â Â Â Â Â Â 
</header> 
Â 
Â Â Â Â Â Â 
<div class="bg-card rounded-xl 
border
border-border p-4 mb-4 flex flex-wrap gap-4 items-end"> 
Â Â Â Â Â Â Â Â Â Â 
<div class="flex-1 
min-w-[200px]">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
class="form-input"
placeholder="æœå°‹ç·¨è™Ÿ / å§“å..." value="${term}" 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â oninput="localStorage.setItem('${STORAGE_KEYS.SEARCH_P}',
this.value);
renderPartners()"> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<select 
class="form-input"
onchange="localStorage.setItem('${STORAGE_KEYS.STATUS_P}',
this.value); 
renderPartners()">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="all"
${statusFilter==='all'?'selected':''}>å…¨éƒ¨ç‹€æ…‹</option> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="active"
${statusFilter==='active'?'selected':''}>ä½¿ç”¨ä¸­ (Active)</option> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option value="inactive" 
${statusFilter==='inactive'?'selected':''}>åœç”¨ 
(Inactive)</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</select> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<select 
class="form-input"
onchange="localStorage.setItem('${STORAGE_KEYS.SORT_P}',
this.value); 
renderPartners()">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="joinDesc"
${sort==='joinDesc'?'selected':''}>åŠ å…¥æ—¥æœŸ (æ–°â†’èˆŠ)</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="joinAsc"
${sort==='joinAsc'?'selected':''}>åŠ å…¥æ—¥æœŸ (èˆŠâ†’æ–°)</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="name"
${sort==='name'?'selected':''}>å§“åé †åº</option> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</select> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
</div> 
Â 
Â Â Â Â Â Â 
<div class="grid grid-cols-1 
md:grid-cols-2
lg:grid-cols-3 xl:grid-cols-4 gap-4"> 
Â Â Â Â Â Â Â Â Â Â 
${list.map(p => { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const upline = 
store.getPartner(p.uplineId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const init = 
store.getInitiator(p.initiatorId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
return `<div 
class="bg-card
border border-border rounded-xl p-4 hover:border-primary/50 
transition
relative group"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
justify-between
items-start mb-2"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="font-bold
text-lg">${p.name}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="text-xs
font-mono text-muted-foreground bg-secondary px-1.5 py-0.5 
rounded
inline-block">${p.code}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span class="w-3 
h-3
rounded-full ${p.status==='active' ? 'bg-success 
shadow-[0_0_8px_rgba(16,185,129,0.5)]'
: 'bg-muted'}"></span> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="space-y-1
text-sm text-muted-foreground mt-3"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
items-center
gap-2"><span>ğŸ“…</span> 
${p.joinedAt
|| 'æœªçŸ¥'} 
(${getDuration(p.joinedAt)})</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
items-center
gap-2" title="æ¨è–¦äºº"><span>ğŸ”—</span>
${upline
? upline.name : '<span class="opacity-50">ç„¡</span>'}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
items-center
gap-2" title="ç™¼èµ·äºº"><span>ğŸ‘‘</span>
${init 
?
init.name : '<span class="opacity-50">æœªæŒ‡å®š</span>'}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="absolute 
top-4
right-4 opacity-0 group-hover:opacity-100 transition"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
class="p-2
bg-secondary rounded-lg hover:bg-primary 
hover:text-primary-foreground"
onclick="editPartner('${p.id}')">âœ</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div>`; 
Â Â Â Â Â Â Â Â Â Â 
}).join('')} 
Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
<div class="text-center text-xs 
text-muted-foreground
mt-6">å…± 
${list.length}ä½å¤¥ä¼´</div>`;
Â Â 
} 
Â 
Â Â 
window.editPartner = function(id) { 
Â Â Â Â Â Â 
const p = id ? store.getPartner(id) : { 
id:
uuid(), name: '', code: '', joinedAt: getLocalToday(), status: 'active', 
uplineId:
'', initiatorId: '' }; 
Â Â Â Â Â Â 
const partners = 
store.data.partners.filter(x
=> x.id !== p.id); // Exclude self 
Â Â Â Â Â Â 
const initiators = store.data.initiators 
|| [];
Â Â Â Â Â Â 
Â Â Â Â Â Â 
const modalHtml = ` 
Â Â Â Â Â Â 
<form 
onsubmit="savePartner(event,
'${p.id}')" 
class="space-y-4">
Â Â Â Â Â Â Â Â Â Â 
<div class="grid grid-cols-2 
gap-4">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div><label 
class="label">å§“å</label><input 
name="name"
class="form-input" value="${p.name}" 
required></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div><label 
class="label">ç·¨è™Ÿ</label><input 
name="code"
class="form-input" value="${p.code}" 
required></div>
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
<div class="grid grid-cols-2 
gap-4">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div><label 
class="label">åŠ å…¥æ—¥æœŸ</label><input 
type="date"
name="joinedAt" class="form-input" 
value="${p.joinedAt}"></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="label">ç‹€æ…‹</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<select 
name="status"
class="form-input"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="active"
${p.status==='active'?'selected':''}>ä½¿ç”¨ä¸­</option> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="inactive"
${p.status==='inactive'?'selected':''}>åœç”¨</option> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</select> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="label">æ¨è–¦äºº 
(Upline)</label>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<select 
name="uplineId"
class="form-input"> 
Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <option
value="">--ç„¡ 
--</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${partners.map(opt => 
`<option
value="${opt.id}" 
${opt.id===p.uplineId?'selected':''}>${opt.code}
${opt.name}</option>`).join('')}
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</select> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<label 
class="label">æ‰€å±¬ç™¼èµ·äºº</label> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<select 
name="initiatorId"
class="form-input"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<option 
value="">--æœªæŒ‡å®š 
--</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${initiators.map(i => 
`<option
value="${i.id}"
${i.id===p.initiatorId?'selected':''}>${i.name}</option>`).join('')} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</select> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
<div class="flex justify-end 
gap-2
mt-6"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${id ? `<button 
type="button"
class="px-4 py-2 text-destructive 
hover:bg-destructive/10
rounded-lg mr-auto" 
onclick="deletePartner('${p.id}')">åˆªé™¤</button>` 
: ''} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
type="button"
class="px-4 py-2 rounded-lg 
hover:bg-secondary"
onclick="closeModal()">å–æ¶ˆ</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button class="px-6 py-2 
bg-primary
text-primary-foreground font-bold rounded-lg">å„²å­˜</button> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
</form>`; 
Â Â Â Â Â Â 
openModal(id ? 'ç·¨è¼¯å¤¥ä¼´' : 'æ–°å¢å¤¥ä¼´', 
modalHtml);
Â Â 
}; 
Â 
Â Â 
window.savePartner = async function(e, id) { 
Â Â Â Â Â Â 
e.preventDefault(); 
Â Â Â Â Â Â 
const fd = new FormData(e.target); 
Â Â Â Â Â Â 
const data = { 
Â Â Â Â Â Â Â Â Â Â 
id: id, 
Â Â Â Â Â Â Â Â Â Â 
name: fd.get('name'), code: 
fd.get('code'),
joinedAt: fd.get('joinedAt'), 
Â Â Â Â Â Â Â Â Â Â 
status: fd.get('status'), uplineId: 
fd.get('uplineId'),
initiatorId: fd.get('initiatorId') 
Â Â Â Â Â Â 
}; 
Â Â Â Â Â Â 
const idx = 
store.data.partners.findIndex(x
=> x.id === id); 
Â Â Â Â Â Â 
if (idx >= 0) 
store.data.partners[idx]
= data; 
Â Â Â Â Â Â 
else store.data.partners.push(data); 
Â Â Â Â Â Â 
Â Â Â Â Â Â 
await store.save(); 
Â Â Â Â Â Â 
closeModal(); renderPartners(); 
Â Â 
}; 
Â 
Â Â 
window.deletePartner = async function(id) { 
Â Â Â Â Â Â 
if(!confirm('åˆªé™¤å¤¥ä¼´å°‡åŒæ™‚åˆªé™¤å…¶é—œè¯çš„æ¥­ç¸¾ç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ')) return; 
Â Â Â Â Â Â 
store.data.partners = 
store.data.partners.filter(p
=> p.id !== id); 
Â Â Â Â Â Â 
store.data.records = 
store.data.records.filter(r
=> r.partnerId !== id); // Cascade delete 
Â Â Â Â Â Â 
await store.save(); 
Â Â Â Â Â Â 
closeModal(); renderPartners(); 
Â Â 
}; 
Â 
Â Â 
// ========================================= 
Â Â 
// J) Initiators (ç™¼èµ·äºº) 
Â Â 
// ========================================= 
Â Â 
function renderInitiators() { 
Â Â Â Â Â Â 
const list = store.data.initiators || 
[]; 
Â Â Â Â Â Â 
document.getElementById('app').innerHTML 
= ` 
Â Â Â Â Â Â 
<header class="flex items-center 
justify-between
mb-6">${header('ç™¼èµ·äººç®¡ç†')} 
Â Â Â Â Â Â Â Â Â Â 
<button 
class="btn-primary"
onclick="editInitiator(null)">+ æ–°å¢ç™¼èµ·äºº</button> 
Â Â Â Â Â Â 
</header> 
Â Â Â Â Â Â 
<div class="grid grid-cols-1 
md:grid-cols-2
lg:grid-cols-3 gap-4"> 
Â Â Â Â Â Â Â Â Â Â 
${list.map(i => ` 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
border
border-border p-4 rounded-xl flex justify-between items-center"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="font-bold
text-lg">ğŸ‘‘ 
${i.name}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
class="text-sm
text-muted-foreground hover:text-primary" 
onclick="editInitiator('${i.id}')">ç·¨è¼¯</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
`).join('')} 
Â Â Â Â Â Â 
</div>`; 
Â Â 
} 
Â 
Â Â 
window.editInitiator = function(id) { 
Â Â Â Â Â Â 
const item = id ? store.getInitiator(id) 
: {
id: uuid(), name: '' }; 
Â Â Â Â Â Â 
openModal(id?'ç·¨è¼¯':'æ–°å¢', ` 
Â Â Â Â Â Â Â Â Â Â 
<div 
class="space-y-4">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div><label>åç¨±</label><input id="init-name" 
class="form-input"
value="${item.name}"></div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button class="w-full 
btn-primary
py-2 mt-4" onclick="saveInit('${item.id}')">å„²å­˜</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${id ? `<button 
class="w-full
text-destructive mt-2 text-sm" 
onclick="delInit('${item.id}')">åˆªé™¤</button>` 
: ''} 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
`); 
Â Â 
}; 
Â 
Â Â 
window.saveInit = async function(id) { 
Â Â Â Â Â Â 
const name = 
document.getElementById('init-name').value;
Â Â Â Â Â Â 
if(!name) return; 
Â Â Â Â Â Â 
const idx = 
store.data.initiators.findIndex(x=>x.id===id);
Â Â Â Â Â Â 
if(idx>=0) 
store.data.initiators[idx].name
= name; 
Â Â Â Â Â Â 
else store.data.initiators.push({id, 
name});
Â Â Â Â Â Â 
await store.save(); closeModal(); 
renderInitiators();
Â Â 
}; 
Â 
Â Â 
window.delInit = async function(id) { 
Â Â Â Â Â Â 
if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))
return; 
Â Â Â Â Â Â 
store.data.initiators = 
store.data.initiators.filter(x=>x.id!==id);
Â Â Â Â Â Â 
await store.save(); closeModal(); 
renderInitiators();
Â Â 
}; 
Â 
Â Â 
// ========================================= 
Â Â 
// K) Org Chart (çµ„ç¹”åœ–) 
Â Â 
// ========================================= 
Â Â 
function renderOrgChart() { 
Â Â Â Â Â Â 
const m = getLocalMonth(); // Default to 
current
month for PV stats 
Â Â Â Â Â Â 
const partners = store.data.partners || 
[]; 
Â Â Â Â Â Â 
const records = 
store.getRecordsByMonth(m);
Â Â Â Â Â Â 
Â Â Â Â Â Â 
// Build map 
Â Â Â Â Â Â 
const pMap = {}; 
Â Â Â Â Â Â 
partners.forEach(p => { 
Â Â Â Â Â Â Â Â Â Â 
const rec = records.find(r => 
r.partnerId
=== p.id); 
Â Â Â Â Â Â Â Â Â Â 
pMap[p.id] = { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
...p, 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
children: [], 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
pv: rec ? (rec.ppv || 0) : 0, 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
gpv: rec ? (rec.gpv || 0) : 0, 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
teamPv: 0 // Will calc 
Â Â Â Â Â Â Â Â Â Â 
}; 
Â Â Â Â Â Â 
}); 
Â 
Â Â Â Â Â Â 
// Link children 
Â Â Â Â Â Â 
const roots = []; 
Â Â Â Â Â Â 
partners.forEach(p => { 
Â Â Â Â Â Â Â Â Â Â 
if (p.uplineId && 
pMap[p.uplineId])
{ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â pMap[p.uplineId].children.push(pMap[p.id]);
Â Â Â Â Â Â Â Â Â Â 
} else { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
roots.push(pMap[p.id]); 
Â Â Â Â Â Â Â Â Â Â 
} 
Â Â Â Â Â Â 
}); 
Â 
Â Â Â Â Â Â 
// Recursive calc team PV 
Â Â Â Â Â Â 
function calcTeam(node) { 
Â Â Â Â Â Â Â Â Â Â 
let sum = node.pv; // Start with own 
PV 
Â Â Â Â Â Â Â Â Â Â 
node.children.forEach(c => { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
sum += calcTeam(c); 
Â Â Â Â Â Â Â Â Â Â 
}); 
Â Â Â Â Â Â Â Â Â Â 
node.teamPv = sum; 
Â Â Â Â Â Â Â Â Â Â 
return sum; 
Â Â Â Â Â Â 
} 
Â Â Â Â Â Â 
roots.forEach(calcTeam); 
Â 
Â Â Â Â Â Â 
// Render Tree HTML 
Â Â Â Â Â Â 
function buildTreeHtml(nodes) { 
Â Â Â Â Â Â Â Â Â Â 
if (!nodes || nodes.length === 0) 
return
''; 
Â Â Â Â Â Â Â Â Â Â 
return `<ul>${nodes.map(node 
=>
{ 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const hasKids = 
node.children.length
> 0; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
return ` 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<li class="${hasKids ? 
'' :
'leaf'}"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="node 
${node.status==='inactive'
? 'node-inactive' : ''}" 
onclick="showNodeDetail('${node.id}')">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${hasKids ? `<div 
class="node-toggle"
onclick="event.stopPropagation(); 
this.closest('li').classList.toggle('collapsed')">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<span 
class="caret">â–¼</span><span
class="count">${node.children.length}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div>` : ''} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="node-content">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="name">${node.name}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="type">${node.code}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="detail"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div>PV: 
${node.pv}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="text-[10px]
text-muted-foreground">Team: 
${Math.round(node.teamPv)}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â </div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ${buildTreeHtml(node.children)}
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</li>`; 
Â Â Â Â Â Â Â Â Â Â 
}).join('')}</ul>`; 
Â Â Â Â Â Â 
} 
Â 
Â Â Â Â Â Â 
document.getElementById('app').innerHTML 
= ` 
Â Â Â Â Â Â 
<header class="flex items-center 
justify-between
mb-4">${header('çµ„ç¹”é—œè¯åœ–')} 
Â Â Â Â Â Â Â Â Â Â Â 
<div class="text-xs 
text-muted-foreground">é¡¯ç¤º 
${m} æ¥­ç¸¾æ•¸æ“š</div> 
Â Â Â Â Â Â 
</header> 
Â Â Â Â Â Â 
<div class="org-container 
p-4">
Â Â Â Â Â Â Â Â Â Â 
<div class="tree text-center 
min-w-max">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${roots.length ? 
buildTreeHtml(roots)
: '<div class="text-muted-foreground 
mt-10">å°šç„¡çµ„ç¹”è³‡æ–™</div>'} 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
</div>`; 
Â Â 
} 
Â Â 
Â Â 
window.showNodeDetail = function(id) { 
Â Â Â Â Â Â 
const p = store.getPartner(id); 
Â Â Â Â Â Â 
if(p) editPartner(id); // Reuse edit 
modal 
Â Â 
}; 
Â 
Â Â 
// ========================================= 
Â Â 
// L) Versions & Settings 
Â Â 
// ========================================= 
Â Â 
function renderVersions() { 
Â Â Â Â Â Â 
const list = store.data.versions || []; 
Â Â Â Â Â Â 
document.getElementById('app').innerHTML 
= ` 
Â Â Â Â Â Â 
<header 
class="mb-6">${header('è¨ˆç•«ç‰ˆæœ¬æ§ç®¡')}</header> 
Â Â Â Â Â Â 
<div class="space-y-4 
max-w-2xl">
Â Â Â Â Â Â Â Â Â Â 
${list.map(v => ` 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card 
border
border-border p-4 rounded-xl"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
justify-between
items-center mb-4"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="font-bold
text-lg flex items-center gap-2"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${v.name} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
${v.archived ? 
'<span
class="text-xs bg-secondary px-2 rounded">å°å­˜</span>' : '<span
class="text-xs 
bg-success/20
text-success px-2 rounded">å•Ÿç”¨ä¸­</span>'} 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div 
class="text-xs
text-muted-foreground font-mono">${v.id}</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="grid 
grid-cols-2
gap-4 text-sm mb-4"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
justify-between"><span>0-3%åŸºç¤:</span>
<b>${v.params.rate_0_3_base}</b></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
justify-between"><span>0-3%æ¨è–¦:</span>
<b>${v.params.rate_0_3_rec}</b></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
justify-between"><span>6%åŸºç¤:</span>
<b>${v.params.rate_6_base}</b></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
justify-between"><span>6%æ¨è–¦:</span>
<b>${v.params.rate_6_rec}</b></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
justify-between"><span>æ¨è–¦çé‡‘æ¬Šé‡:</span> 
<b>${v.params.rate_recruit_bv}</b></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
justify-between"><span>å­¸ç¿’åŠ æˆ:</span> 
<b>${v.params.rate_learning}</b></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
class="w-full
bg-secondary py-2 rounded text-sm 
hover:bg-secondary/80"
onclick="alert('è«‹è¯ç¹«ç®¡ç†å“¡ä¿®æ”¹æ ¸å¿ƒåƒæ•¸')">ä¿®æ”¹åƒæ•¸</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
`).join('')} 
Â Â Â Â Â Â 
</div>`; 
Â Â 
} 
Â 
Â Â 
function renderSettings() { 
Â Â Â Â Â Â 
document.getElementById('app').innerHTML 
= ` 
Â Â Â Â Â Â 
<header 
class="mb-6">${header('ç³»çµ±è¨­å®š')}</header> 
Â Â Â Â Â Â 
<div class="max-w-xl 
space-y-6">
Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card border 
border-border
p-5 rounded-xl"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<h3 class="font-bold 
mb-3">ğŸ“¦ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<div class="flex 
gap-4">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
class="flex-1
bg-primary text-primary-foreground py-2 rounded-lg 
font-bold"
onclick="downloadBackup()">ä¸‹è¼‰å®Œæ•´å‚™ä»½ (JSON)</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button 
class="flex-1
bg-secondary text-secondary-foreground py-2 rounded-lg" 
onclick="document.getElementById('file-upload').click()">åŒ¯å…¥å‚™ä»½</button> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<input 
type="file"
id="file-upload" hidden 
onchange="restoreBackup(this)">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<p class="text-xs 
text-muted-foreground
mt-2">åŒ…å«æ‰€æœ‰å¤¥ä¼´ã€ç”¢å“ã€æ¥­ç¸¾ç´€éŒ„èˆ‡è¨­å®šã€‚</p> 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â 
<div class="bg-card border 
border-border
p-5 rounded-xl"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<h3 class="font-bold 
mb-3
text-destructive">ğŸ’€ å±éšªå€åŸŸ</h3> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
<button class="w-full 
border
border-destructive/50 text-destructive py-2 rounded-lg 
hover:bg-destructive/10"
onclick="if(confirm('é€™å°‡æ¸…é™¤æ‰€æœ‰æ•¸æ“šä¸”ç„¡æ³•å¾©åŸï¼è«‹å†æ¬¡ç¢ºèªï¼')) { 
store.data={partners:[],initiators:[],records:[],versions:[],productCatalog:{}};
store.save().then(()=>location.reload());
}">é‡ç½®æ‰€æœ‰ç³»çµ±æ•¸æ“š</button>
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â 
<div class="text-center 
text-xs
text-muted-foreground mt-10"> 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
System v10.4 (Build 20260115) 
<br>
Designed for Amway Team Management 
Â Â Â Â Â Â Â Â Â Â 
</div> 
Â Â Â Â Â Â 
</div>`; 
Â Â 
} 
Â 
Â Â 
window.downloadBackup = function() { 
Â Â Â Â Â Â 
const str = JSON.stringify(store.data, 
null,
2); 
Â Â Â Â Â Â 
const blob = new Blob([str], {type: 
'application/json'});
Â Â Â Â Â Â 
const url = URL.createObjectURL(blob); 
Â Â Â Â Â Â 
const a = document.createElement('a'); 
Â Â Â Â Â Â 
a.href = url; 
Â Â Â Â Â Â 
a.download = 
`backup_newstar_${getLocalToday()}.json`;
Â Â Â Â Â Â 
a.click(); 
Â Â 
}; 
Â 
Â Â 
window.restoreBackup = function(input) { 
Â Â Â Â Â Â 
const file = input.files[0]; 
Â Â Â Â Â Â 
if(!file) return; 
Â Â Â Â Â Â 
const reader = new FileReader(); 
Â Â Â Â Â Â 
reader.onload = async function(e) { 
Â Â Â Â Â Â Â Â Â Â 
try { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
const json = 
JSON.parse(e.target.result);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
if(!json.partners || 
!json.records)
throw new Error('æ ¼å¼éŒ¯èª¤'); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
if(!confirm('ç¢ºå®šè¦è¦†è“‹ç¾æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
store.data = json; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
await store.save(); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
alert('é‚„åŸæˆåŠŸï¼'); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
location.reload(); 
Â Â Â Â Â Â Â Â Â Â 
} catch(err) { alert('é‚„åŸå¤±æ•—: '+err.message); } 
Â Â Â Â Â Â 
}; 
Â Â Â Â Â Â 
reader.readAsText(file); 
Â Â 
}; 
</script>
</body>
</html>
Â 
