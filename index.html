<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ± (v9.9 Final)</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%9A%80%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-size='120'%3E%F0%9F%9A%80%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: 'rgb(var(--background) / <alpha-value>)',
                        foreground: 'rgb(var(--foreground) / <alpha-value>)',
                        card: 'rgb(var(--card) / <alpha-value>)',
                        'card-foreground': 'rgb(var(--card-foreground) / <alpha-value>)',
                        border: 'rgb(var(--border) / <alpha-value>)',
                        muted: 'rgb(var(--muted) / <alpha-value>)',
                        'muted-foreground': 'rgb(var(--muted-foreground) / <alpha-value>)',
                        primary: 'rgb(var(--primary) / <alpha-value>)',
                        'primary-foreground': 'rgb(var(--primary-foreground) / <alpha-value>)',
                        secondary: 'rgb(var(--secondary) / <alpha-value>)',
                        'secondary-foreground': 'rgb(var(--secondary-foreground) / <alpha-value>)',
                        accent: 'rgb(var(--accent) / <alpha-value>)',
                        destructive: 'rgb(var(--destructive) / <alpha-value>)',
                        success: 'rgb(var(--success) / <alpha-value>)',
                        warning: 'rgb(var(--warning) / <alpha-value>)'
                    },
                    fontFamily: {
                        sans: ['Inter', 'Microsoft JhengHei', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --authbar-h: 52px;
            --authbar-gap: 16px;

            /* Dark Mode (Default) */
            --background: 10 10 11;
            --foreground: 250 250 250;
            --card: 24 24 27;
            --card-foreground: 250 250 250;
            --border: 39 39 42;
            --muted: 39 39 42;
            --muted-foreground: 161 161 170;
            --primary: 16 185 129;
            --primary-foreground: 2 44 34;
            --secondary: 39 39 42;
            --secondary-foreground: 250 250 250;
            --accent: 16 185 129;
            --destructive: 239 68 68;
            --success: 16 185 129;
            --warning: 245 158 11;
            --hover: 255 255 255;
            --shadow: 0 0 0;

            /* Org Chart - Dark */
            --org-line: 63 63 70;
            --org-node-bg: 24 24 27;
            --org-node-border: 82 82 91;
            --org-node-hover-border: 113 113 122;
            --org-toggle-bg: 255 255 255;
            --org-text: 250 250 250;
            --org-subtext: 161 161 170;
            --org-chip-bg: 255 255 255;
            
            --org-line-alpha: 0.55;
            --org-line-w: 1.5px;
            --org-line-w-strong: 2px;
            --org-node-shadow: 0 12px 28px rgba(0,0,0,.28);
            --org-node-shadow-hover: 0 18px 42px rgba(0,0,0,.36);
            --org-badge-direct-bg: 16 185 129;
            --org-badge-member-bg: 59 130 246;
            --org-badge-fg: 2 44 34;
        }

        :root[data-theme="light"] {
            --background: 246 247 251;
            --foreground: 15 23 42;
            --card: 255 255 255;
            --card-foreground: 15 23 42;
            --border: 229 231 235;
            --muted: 241 245 249;
            --muted-foreground: 100 116 139;
            --primary: 16 185 129;
            --primary-foreground: 2 44 34;
            --secondary: 241 245 249;
            --secondary-foreground: 15 23 42;
            --accent: 16 185 129;
            --destructive: 239 68 68;
            --success: 16 185 129;
            --warning: 245 158 11;
            --hover: 0 0 0;
            --shadow: 0 0 0;

            /* Org Chart - Light */
            --org-line: 203 213 225;
            --org-node-bg: 255 255 255;
            --org-node-border: 148 163 184;
            --org-node-hover-border: 100 116 139;
            --org-toggle-bg: 0 0 0;
            --org-text: 15 23 42;
            --org-subtext: 100 116 139;
            --org-chip-bg: 0 0 0;

            --org-line-alpha: 0.85;
            --org-line-w: 1.5px;
            --org-line-w-strong: 2px;
            --org-node-shadow: 0 10px 24px rgba(0,0,0,.10);
            --org-node-shadow-hover: 0 16px 34px rgba(0,0,0,.14);
            --org-badge-direct-bg: 16 185 129;
            --org-badge-member-bg: 37 99 235;
            --org-badge-fg: 255 255 255;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            background-color: rgb(var(--background)); 
            color: rgb(var(--foreground)); 
            overflow: hidden; 
            height: 100vh; 
            height: calc(var(--vh, 1vh) * 100);
            display: flex;
            font-family: 'Inter', 'Microsoft JhengHei', system-ui, sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgb(var(--border)); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgb(var(--muted-foreground)); }

        /* Sidebar */
        aside { 
            width: 260px; 
            background: linear-gradient(180deg, rgb(var(--card)) 0%, rgb(var(--background)) 100%);
            color: rgb(var(--foreground)); 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            z-index: 1000; 
            height: 100%; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid rgb(var(--border));
        }
        aside.collapsed { width: 0; opacity: 0; overflow: hidden; }
        .sidebar-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 8px 0; }
        
        .nav-group-title { 
            padding: 10px 16px; 
            color: rgb(var(--muted-foreground));
            font-size: 0.75rem; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: color 0.2s; 
            user-select: none;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .nav-group-title:hover { color: rgb(var(--foreground)); }
        .nav-group-title::after { 
            content: ''; width: 0; height: 0; 
            border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 5px solid currentColor;
            transition: transform 0.2s; 
        }
        .nav-group.collapsed .nav-group-title::after { transform: rotate(-90deg); }
        .nav-items { max-height: 500px; overflow: hidden; transition: max-height 0.3s ease-out; }
        .nav-group.collapsed .nav-items { max-height: 0; }
        
        .nav-item { 
            display: flex; align-items: center; gap: 10px;
            padding: 10px 16px 10px 20px; 
            color: #a1a1aa; text-decoration: none; font-size: 0.875rem; 
            cursor: pointer; transition: all 0.15s; border-radius: 6px; margin: 2px 8px;
        }
        .nav-item:hover { color: rgb(var(--foreground)); background: rgb(var(--hover) / 0.06); }
        .nav-item.active { color: #10b981; background: rgba(16, 185, 129, 0.1); }

        /* Main Content */
        main { 
            flex: 1; 
            height: 100%; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding: 24px; 
            padding-top: calc(24px + var(--authbar-h) + var(--authbar-gap));
            position: relative; 
            background-color: rgb(var(--background)); 
        }

        @media (max-width: 1023px) {
            .menu-btn { display: flex !important; }
            aside { 
                position: fixed; top: 0; left: 0; bottom: 0; 
                transform: translateX(-100%); 
                box-shadow: 4px 0 20px rgba(0,0,0,0.5); 
            }
            aside.open { transform: translateX(0); }
            #drawer-overlay { 
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.7); z-index: 999; 
                opacity: 0; visibility: hidden; 
                transition: opacity 0.3s; backdrop-filter: blur(4px); 
            }
            #drawer-overlay.visible { opacity: 1; visibility: visible; }
        }

        /* Components */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3f3f46; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }

        .switch-sm { position: relative; display: inline-block; width: 36px; height: 20px; vertical-align: middle; flex-shrink: 0; }
        .switch-sm input { opacity: 0; width: 0; height: 0; }
        .slider-sm { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3f3f46; transition: .3s; border-radius: 20px; }
        .slider-sm:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider-sm { background-color: #10b981; }
        input:checked + .slider-sm:before { transform: translateX(16px); }

        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 12px 16px; text-align: left; vertical-align: middle; }
        th { 
            background: rgb(var(--card)); 
            color: rgb(var(--muted-foreground)); 
            font-weight: 500; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
            border-bottom: 1px solid rgb(var(--border));
        }
        td { border-bottom: 1px solid rgb(var(--border)); }
        tr:hover td { background: rgb(var(--hover) / 0.03); }
        tr:last-child td { border-bottom: none; }

        .modal { 
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); 
        }
        .modal-content { 
            background: rgb(var(--card)); margin: 5vh auto; width: 95%; max-width: 1100px; 
            border-radius: 16px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; 
            border: 1px solid rgb(var(--border)); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid rgb(var(--border)); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; background: rgb(var(--background)); -webkit-overflow-scrolling: touch; }

        .form-input, .form-control {
            width: 100%; padding: 10px 14px; 
            background: rgb(var(--card)); border: 1px solid rgb(var(--border)); border-radius: 8px; 
            color: rgb(var(--foreground)); font-size: 0.875rem; transition: all 0.15s; margin-bottom: 5px;
        }
        .form-input:focus, .form-control:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .form-input::placeholder { color: rgb(var(--muted-foreground)); }
        select.form-input, select.form-control {
            appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 10px center; background-repeat: no-repeat; background-size: 16px; padding-right: 36px;
        }
        .row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom:10px; } 
        .col { flex: 1; min-width: 150px; }

        #loading { position: fixed; inset: 0; background: #0a0a0b; display: flex; justify-content: center; align-items: center; z-index: 3000; flex-direction: column; color:white; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-left-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loginOverlay { position: fixed; inset: 0; background: rgba(0,0,0,.85); z-index: 99998; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .login-card { width: min(420px, 92vw); background: #18181b; border: 1px solid #27272a; border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,.5); }

        .auth-buttons{
          position: fixed;
          top: max(10px, env(safe-area-inset-top));
          right: max(10px, env(safe-area-inset-right));
          z-index: 99999;
          display: flex; align-items: center; gap: 8px; padding: 6px;
          border-radius: 14px; background: rgba(10,10,11,.55);
          border: 1px solid rgba(255,255,255,.08); backdrop-filter: blur(10px);
        }
        .auth-buttons button{
          padding: 7px 12px; border-radius: 12px; font-weight: 700; cursor: pointer; border: 1px solid transparent;
          font-size: 0.78rem; line-height: 1; display: inline-flex; align-items: center; gap: 6px;
          transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
        }
        .auth-buttons button:active{ transform: scale(.97); }
        .user-email{
          max-width: 140px; padding: 7px 10px; border-radius: 12px; background: rgba(39,39,42,.8);
          color: #d4d4d8; font-size: .78rem; font-weight: 800; border: 1px solid rgba(255,255,255,.10);
          white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .login-btn{ background: #10b981; color: #022c22; }
        .logout-btn{ background: rgba(39,39,42,.85); color: #f87171; border-color: rgba(255,255,255,.10) !important; }
        .logout-btn:hover{ border-color: rgba(248,113,113,.35) !important; }
        
        @media (max-width: 420px){
          :root { --authbar-h: 58px; }
          .auth-buttons{ right: 8px; top: max(8px, env(safe-area-inset-top)); gap: 6px; padding: 5px; }
          .user-email{ max-width: 95px; font-size: .72rem; }
          .auth-buttons button{ padding: 7px 10px; font-size: .72rem; }
        }

        /* Org Chart Styling */
        .org-container { 
          overflow: auto; width: 100%; height: 600px; 
          background: rgb(var(--card)); border-radius: 12px; position: relative; 
          cursor: grab; touch-action: none; user-select: none; border: 1px solid rgb(var(--border));
        }
        .org-container:active { cursor: grabbing; }
        .tree { transform-origin: 0 0; will-change: transform; display: inline-block; min-width: 100%; padding: 40px; box-sizing: border-box; }
        .tree ul { padding-top: 20px; position: relative; transition: .3s; display: table; margin: 0 auto; white-space: nowrap; }
        .tree li { float: none; display: table-cell; vertical-align: top; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; }
        
        .tree li::before, .tree li::after { 
          content: ''; position: absolute; top: 0; right: 50%; 
          border-top: var(--org-line-w) solid rgb(var(--org-line) / var(--org-line-alpha)); 
          width: 50%; height: 20px; 
        }
        .tree li::after { right: auto; left: 50%; border-left: var(--org-line-w) solid rgb(var(--org-line) / var(--org-line-alpha)); }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: var(--org-line-w) solid rgb(var(--org-line) / var(--org-line-alpha)); border-radius: 0 10px 0 0; }
        .tree li:first-child::after { border-radius: 10px 0 0 0; }
        .tree ul ul::before { 
          content: ''; position: absolute; top: 0; left: 50%; 
          border-left: var(--org-line-w-strong) solid rgb(var(--org-line) / var(--org-line-alpha)); 
          width: 0; height: 20px; 
        }
        .tree li.collapsed > ul { display: none; }
        .tree li.collapsed > .node .caret { transform: rotate(-90deg); }
        
        .node { 
          border: 1px solid rgb(var(--org-node-border)); text-decoration: none; color: rgb(var(--org-text)); 
          font-size: 12px; display: inline-flex; align-items: stretch; border-radius: 12px; 
          transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
          min-width: 190px; position: relative; 
          background: linear-gradient(180deg, rgb(var(--org-node-bg)) 0%, rgb(var(--org-node-bg) / .92) 100%);
          z-index: 2; overflow: hidden; text-align: left; box-shadow: var(--org-node-shadow);
        }
        .node:hover { transform: translateY(-2px); z-index: 10; border-color: rgb(var(--org-node-hover-border)); box-shadow: var(--org-node-shadow-hover); }
        .node.node-active { border-color: rgb(var(--primary)); background: linear-gradient(135deg, rgb(var(--org-node-bg)) 0%, rgb(var(--primary) / 0.10) 100%); }
        .node.node-inactive { border-color: rgb(var(--border)); opacity: 0.65; }
        
        .node-toggle {
          width: 38px; background: rgb(var(--org-toggle-bg) / 0.06); border-right: 1px solid rgb(var(--border) / 1);
          display: flex; flex-direction: column; align-items: center; justify-content: center;
          cursor: pointer; transition: background .2s; flex-shrink: 0;
        }
        .node-toggle:hover { background: rgb(var(--org-toggle-bg) / 0.10); }
        .caret { font-size: 12px; color: rgb(var(--org-subtext)); transition: transform 0.2s; }
        .count { font-size: 10px; color: rgb(var(--org-subtext)); margin-top: 2px; font-weight: 700; }
        
        .node-content { padding: 12px; flex: 1; cursor: pointer; }
        .node-content .name { font-weight: 800; display: block; margin-bottom: 4px; font-size: 13px; color: rgb(var(--org-text)); }
        .node-content .type { 
          font-size: 10px; color: rgb(var(--org-subtext)); background: rgb(var(--org-chip-bg) / 0.06); 
          padding: 2px 8px; border-radius: 6px; display: inline-block; margin-bottom: 8px; border: 1px solid rgb(var(--border));
        }
        .node-content .detail { font-size: 11px; color: rgb(var(--org-subtext)); border-top: 1px solid rgb(var(--border)); padding-top: 8px; margin-top: 8px; }
        
        .node-status { position: absolute; top: 0; right: 0; font-size: 9px; padding: 3px 8px; border-bottom-left-radius: 10px; font-weight: 800; letter-spacing: 0.02em; }
        .node-status.badge-direct { background: rgb(var(--org-badge-direct-bg)); color: rgb(var(--org-badge-fg)); }
        .node-status.badge-member { background: rgb(var(--org-badge-member-bg)); color: rgb(var(--org-badge-fg)); }
    </style>
</head>
<body>

<div class="auth-buttons">
    <span id="userEmailBadge" class="user-email" style="display:none;"></span>
    <button id="themeBtn" class="logout-btn" onclick="toggleTheme()" type="button" title="åˆ‡æ›æ·±/æ·ºæ¨¡å¼" style="display:none;">ğŸŒ“</button>
    <button class="login-btn" onclick="login()">Google ç™»å…¥</button>
    <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display:none;">ç™»å‡º</button>
</div>

<div id="loading"><div class="spinner"></div><div>ç³»çµ±è¼‰å…¥ä¸­...</div></div>
<div id="drawer-overlay" onclick="closeDrawer()"></div>

<aside id="sidebar">
    <div class="px-4 py-5 border-b border-border flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-primary to-emerald-400 flex items-center justify-center">
            <span style="font-size:1.2rem">ğŸš€</span>
        </div>
        <div>
            <div class="text-sm font-bold text-foreground">æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«</div>
            <div class="text-xs text-muted-foreground">ç®¡ç†ç³»çµ± v9.9</div>
        </div>
    </div>
    
    <div class="sidebar-scroll" id="sidebar-scroll-area">
        <div class="nav-group" id="group-overview">
            <div class="nav-group-title" onclick="toggleGroup('group-overview')">ç‡Ÿé‹ç¸½è¦½</div>
            <div class="nav-items">
                <a onclick="router('dashboard')" id="nav-dashboard" class="nav-item">ğŸ“Š ç¸½è¦½å„€è¡¨æ¿</a>
                <a onclick="router('payout')" id="nav-payout" class="nav-item">ğŸ’° æœ¬æœˆç™¼æ”¾ç¸½è¡¨</a>
            </div>
        </div>
        <div class="nav-group" id="group-records">
            <div class="nav-group-title" onclick="toggleGroup('group-records')">æ¥­ç¸¾èˆ‡ç´€éŒ„</div>
            <div class="nav-items"><a onclick="router('records')" id="nav-records" class="nav-item">ğŸ“ æœˆä»½æ¥­ç¸¾ç´€éŒ„</a></div>
        </div>
        <div class="nav-group" id="group-partners">
            <div class="nav-group-title" onclick="toggleGroup('group-partners')">äººå“¡ç®¡ç†</div>
            <div class="nav-items">
                <a onclick="router('partners')" id="nav-partners" class="nav-item">ğŸ‘¥ å¤¥ä¼´åå–®ç®¡ç†</a>
                <a onclick="router('initiators')" id="nav-initiators" class="nav-item">ğŸ‘‘ ç™¼èµ·äººç®¡ç†</a>
            </div>
        </div>
        <div class="nav-group" id="group-org">
            <div class="nav-group-title" onclick="toggleGroup('group-org')">çµ„ç¹”çµæ§‹</div>
            <div class="nav-items"><a onclick="router('org')" id="nav-org" class="nav-item">ğŸ§© çµ„ç¹”é—œè¯åœ–</a></div>
        </div>
        <div class="nav-group" id="group-settings">
            <div class="nav-group-title" onclick="toggleGroup('group-settings')">ç³»çµ±è¨­å®š</div>
            <div class="nav-items">
                <a onclick="router('versions')" id="nav-versions" class="nav-item">âš–ï¸ è¨ˆç•«ç‰ˆæœ¬æ§ç®¡</a>
                <a onclick="router('settings')" id="nav-settings" class="nav-item">âš™ï¸ ç³»çµ±è¨­å®š</a>
            </div>
        </div>
    </div>
</aside>

<main id="app"></main>

<div id="loginOverlay" style="display:none;">
    <div class="login-card">
        <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4"><span style="font-size:2rem">ğŸ”’</span></div>
        <h2 class="text-xl font-bold text-foreground mb-2">æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ±</h2>
        <p class="text-muted-foreground mb-6">è«‹å…ˆç™»å…¥ä»¥å­˜å–è³‡æ–™åº«</p>
        <button onclick="login()" class="w-full py-3 bg-primary text-primary-foreground font-bold rounded-xl hover:bg-primary/90 transition-colors">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title" class="text-lg font-semibold text-foreground"></h2>
            <button class="w-8 h-8 rounded-lg bg-secondary hover:bg-secondary/80 flex items-center justify-center text-muted-foreground hover:text-foreground transition-colors" onclick="closeModalSafe()">âœ•</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<div id="catalogModal" class="modal">
    <div class="modal-content" style="max-width:700px">
        <div class="modal-header">
            <h2 id="catalogModalTitle" class="text-lg font-semibold text-foreground">æ–°å¢ç”¢å“åˆ°è³‡æ–™åº«</h2>
            <button class="w-8 h-8 rounded-lg bg-secondary hover:bg-secondary/80 flex items-center justify-center text-muted-foreground hover:text-foreground transition-colors" onclick="closeCatalogModal()">âœ•</button>
        </div>
        <div class="modal-body" id="catalogModalBody"></div>
    </div>
</div>

<script>
    // =========================================
    // A) Theme & UI Utilities
    // =========================================
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const btn = document.getElementById('themeBtn');
      if(btn){
        btn.textContent = (theme === 'light') ? 'ğŸŒ™' : 'â˜€ï¸';
        btn.title = (theme === 'light') ? 'åˆ‡æ›æ·±è‰²æ¨¡å¼' : 'åˆ‡æ›æ·ºè‰²æ¨¡å¼';
      }
    }
    function toggleTheme(){
      const cur = document.documentElement.getAttribute('data-theme') || 'dark';
      applyTheme(cur === 'dark' ? 'light' : 'dark');
    }
    (function initTheme(){
      const saved = localStorage.getItem('theme');
      if(saved){ applyTheme(saved); return; }
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      applyTheme(prefersLight ? 'light' : 'dark');
    })();

    let _errFlag = false;
    window.onerror = function(msg, url, line, col, error) {
        console.error(error);
        document.getElementById('loading').style.display = 'none';
        if (_errFlag) return;
        _errFlag = true; setTimeout(() => { _errFlag = false; }, 3000);
        alert(`âš ï¸ ç³»çµ±éŒ¯èª¤ï¼š\n${msg}`);
    };

    function setVh() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', setVh);
    window.addEventListener('orientationchange', setVh);
    setVh();

    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('drawer-overlay');
    let bodyScrollY = 0;
    function openDrawer() {
        sidebar.classList.add('open'); overlay.classList.add('visible');
        bodyScrollY = window.scrollY; document.body.style.position = 'fixed'; document.body.style.top = `-${bodyScrollY}px`; document.body.style.width = '100%';
    }
    function closeDrawer() {
        sidebar.classList.remove('open'); overlay.classList.remove('visible');
        document.body.style.position = ''; document.body.style.top = ''; window.scrollTo(0, bodyScrollY);
    }
    function toggleGroup(groupId) { document.getElementById(groupId).classList.toggle('collapsed'); }

    function openModal(title, content) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = content;
        document.getElementById('modal').style.display = 'block';
    }
    function closeModalSafe() { 
        if(isDirty && !confirm('æœ‰æœªå„²å­˜è®Šæ›´ï¼Œç¢ºå®šé›¢é–‹ï¼Ÿ')) return; 
        document.getElementById('modal').style.display = 'none'; 
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function openCatalogModal(title, content){
        document.getElementById('catalogModalTitle').innerText = title || 'ç”¢å“è³‡æ–™åº«';
        document.getElementById('catalogModalBody').innerHTML = content || '';
        document.getElementById('catalogModal').style.display = 'block';
    }
    function closeCatalogModal(){ document.getElementById('catalogModal').style.display = 'none'; }

    // =========================================
    // B) Firebase Init & Auth
    // =========================================
    const firebaseConfig = {
        apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
        authDomain: "newstar-system.firebaseapp.com",
        projectId: "newstar-system",
        storageBucket: "newstar-system.firebasestorage.app",
        messagingSenderId: "889699172174",
        appId: "1:889699172174:web:0ff42757035a879cb3281f",
        databaseURL: "https://newstar-system-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    let isReady = false;
    let db = null;
    const ALLOWED_EMAILS = ["tsai860218@gmail.com", "xc23026849@gmail.com"].map(e => e.toLowerCase().trim());
    let isDirty = false;
    let tempRec = null;
    function markDirty() { isDirty = true; }

    function setOverlay(show){ document.getElementById("loginOverlay").style.display = show ? "flex" : "none"; }
    function setAuthButtons(isLoggedIn){
        const loginBtn  = document.querySelector(".auth-buttons .login-btn");
        const logoutBtn = document.getElementById("logoutBtn");
        const themeBtn  = document.getElementById("themeBtn");
        if(loginBtn)  loginBtn.style.display  = isLoggedIn ? "none" : "inline-flex";
        if(logoutBtn) logoutBtn.style.display = isLoggedIn ? "inline-flex" : "none";
        if(themeBtn)  themeBtn.style.display  = "inline-flex";
    }
    function setUserBadge(user){
        const badge = document.getElementById("userEmailBadge");
        if(!badge) return;
        if(!user){ badge.style.display = "none"; badge.textContent = ""; return; }
        const email = (user.email || "").toLowerCase().trim();
        const displayName = (user.displayName || "").trim();
        const name = displayName || email.split("@")[0] || "ä½ ";
        badge.style.display = "inline-flex"; badge.textContent = `Hi, ${name}`;
    }

    let _didInitAfterLogin = false;
    function initAfterLogin(){ if (_didInitAfterLogin) return; _didInitAfterLogin = true; console.log("âœ… Auth Success..."); store.init(); }

    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.getRedirectResult().catch(console.error);
        window.login = function(){ auth.signInWithPopup(provider).catch(() => auth.signInWithRedirect(provider)); }
        window.logout = function(){ store.cleanup(); auth.signOut(); location.reload(); }
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                store.cleanup(); setOverlay(true); setAuthButtons(false); setUserBadge(null);
                isReady = false; _didInitAfterLogin = false;
                document.getElementById('loading').style.display = 'none';
                document.getElementById("themeBtn").style.display = "inline-flex"; 
                return;
            }
            const email = (user.email || "").toLowerCase().trim();
            if (!ALLOWED_EMAILS.includes(email)) { alert("âŒ ç„¡æ¬Šé™å¸³è™Ÿï¼š" + email); await auth.signOut(); return; }
            setOverlay(false); setAuthButtons(true); setUserBadge(user); isReady = true; initAfterLogin();
        });
    } catch (e) { console.error(e); alert('Firebase Error'); }

    // =========================================
    // C) Store Logic
    // =========================================
    const defaultParams = { rate_0_3_base: 0.03, rate_0_3_rec: 0.04, rate_6_base: 0.01, rate_6_rec: 0.02, rate_recruit_bv: 0.01, rate_learning: 0.03 };
    let appData = { partners: [], initiators: [], records: [], versions: [], productCatalog: {} };
    let firebaseListener = null;

    const store = {
        data: appData,
        init() {
            if(!isReady) return;
            if(firebaseListener) db.ref('AmwaySystem/v1').off('value', firebaseListener);
            firebaseListener = snap => {
                const val = snap.val();
                if(val) {
                    this.data = val;
                    ['partners','initiators','records','versions','productCatalog'].forEach(k => { if(!this.data[k]) this.data[k] = (k==='productCatalog'?{}:[]); });
                    (this.data.records||[]).forEach(r => {
                          const PV_RATE = 50;
                          if (r.ppv !== undefined && r.pbv === undefined) r.pbv = Math.round(r.ppv * PV_RATE);
                          if (r.gpv !== undefined && r.gbv === undefined) r.gbv = Math.round(r.gpv * PV_RATE);
                    });
                } else {
                    this.data = { partners: [], initiators: [], records: [], versions: [], productCatalog: {} };
                    this.data.versions.push({ id: uuid(), name: 'é è¨­ç‰ˆæœ¬', params: { ...defaultParams }, archived: false });
                    this.save();
                }
                document.getElementById('loading').style.display = 'none';
                const active = document.querySelector('.nav-item.active');
                if(active) router(active.id.replace('nav-','')); else router('dashboard');
            };
            db.ref('AmwaySystem/v1').on('value', firebaseListener, err => {
                console.error(err); document.getElementById('loading').style.display = 'none'; alert('è®€å–å¤±æ•—\n' + getFirebaseErrorMsg(err));
            });
        },
        cleanup() {
            if(firebaseListener) { db.ref('AmwaySystem/v1').off('value', firebaseListener); firebaseListener = null; }
            this.data = { partners: [], initiators: [], records: [], versions: [], productCatalog: {} };
        },
        save() {
            if(!isReady) return Promise.reject('Not Logged In');
            return db.ref('AmwaySystem/v1').set(this.data);
        },
        getPartner(id) { return (this.data.partners||[]).find(p=>p.id===id); },
        getInitiator(id) { return (this.data.initiators||[]).find(i=>i.id===id); },
        getRecord(id) { return (this.data.records||[]).find(r=>r.id===id); },
        getRecordsByMonth(m) { return (this.data.records||[]).filter(r=>r.month===m); },
        getVersion(id) { return (this.data.versions||[]).find(v=>v.id===id) || this.data.versions[0]; }
    };

    // =========================================
    // D) Utils
    // =========================================
    function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random()*16|0, v = c=='x'?r:(r&0x3|0x8); return v.toString(16); }); }
    function money(n) { return new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', minimumFractionDigits:0}).format(n||0); }
    function getPercent(pv) { return pv>=10000?0.21:pv>=7000?0.18:pv>=4000?0.15:pv>=2000?0.12:pv>=1000?0.09:pv>=600?0.06:pv>=200?0.03:0; }
    function getLocalToday() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
    function getLocalMonth() { return getLocalToday().slice(0, 7); }
    function getToday(m) { if(m) { const d = new Date(); return (d.toISOString().slice(0,7)===m && d.getDate()<18) ? m+'-18' : getLocalToday(); } return getLocalToday(); }
    function getFirebaseErrorMsg(err) {
        const msg = (err.message || err.code || '').toLowerCase();
        if (msg.includes('permission_denied')) return 'æ¬Šé™ä¸è¶³ï¼šè«‹ç¢ºèªå·²ç™»å…¥ä¸” Email åœ¨ç™½åå–®ï¼Œä¸¦æª¢æŸ¥ Firebase Rulesã€‚';
        if (msg.includes('network') || msg.includes('offline')) return 'ç¶²è·¯ç•°å¸¸ï¼šè«‹æª¢æŸ¥é€£ç·šç‹€æ…‹ã€‚';
        return 'éŒ¯èª¤è©³æƒ…: ' + (err.message || err);
    }
    function getDuration(joinedAt) {
        if (!joinedAt) return 'â€”';
        const start = new Date(joinedAt); const now = new Date();
        if (isNaN(start)) return 'â€”';
        let years = now.getFullYear() - start.getFullYear(); let months = now.getMonth() - start.getMonth(); let days = now.getDate() - start.getDate();
        if (days < 0) { months--; const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0); days += prevMonth.getDate(); }
        if (months < 0) { years--; months += 12; }
        const totalMonths = years * 12 + months;
        if (totalMonths === 0 && days === 0) return 'ä»Šå¤©åŠ å…¥';
        let result = ''; if (totalMonths > 0) result += `${totalMonths} å€‹æœˆ `; if (days > 0) result += `${days} å¤©`; return result.trim();
    }

    const PV_RATE = 50; 
    function getPvViewMode() { return localStorage.getItem('pv_view_mode') || 'both'; }
    function pvToBv(pv) { return Math.round((Number(pv)||0) * PV_RATE); }
    function bvToPv(bv) { return parseFloat(((Number(bv)||0) / PV_RATE).toFixed(2)); }
    function formatPvBv(pv, bv) {
        const mode = getPvViewMode(); const p = Number(pv)||0; const b = (bv !== undefined && bv !== null) ? Number(bv) : pvToBv(p);
        if (mode === 'pv') return `PV: ${p}`; if (mode === 'bv') return `BV: ${b.toLocaleString()}`; return `${p} / ${b.toLocaleString()}`;
    }
    function getPvViewSelect(onchangeFnName) {
        const m = getPvViewMode();
        return `<select class="form-input" style="width:auto" onchange="localStorage.setItem('pv_view_mode',this.value);${onchangeFnName}()">
            <option value="both" ${m==='both'?'selected':''}>PV + BV</option><option value="pv" ${m==='pv'?'selected':''}>åªçœ‹ PV</option><option value="bv" ${m==='bv'?'selected':''}>åªçœ‹ BV</option></select>`;
    }

    function calculate(r) {
        const p = store.getPartner(r.partnerId); if(!p) return null;
        const v = store.getVersion(r.planVersionId); const params = v ? v.params : defaultParams;
        const gpv = Number(r.gpv) || 0; const rate = getPercent(gpv);
        let res = { ...r, partnerName: p.code+' '+p.name, initiatorId: p.initiatorId, myRate: rate, starTotal: 0, totalIncome: 0, isEligible: false, isGraduated: rate >= 0.09, isPartnerInactive: p.status==='inactive', isMonthlyInactive: r.participation==='inactive' };
        if(!res.isGraduated && !res.isPartnerInactive && !res.isMonthlyInactive) {
            let applied = 0, txt = ''; const hasRec = (r.newRecruits||[]).length > 0;
            if(rate === 0 || rate === 0.03) { applied = hasRec ? params.rate_0_3_rec : params.rate_0_3_base; txt = '0-3%'; }
            else if(rate === 0.06) { applied = hasRec ? params.rate_6_rec : params.rate_6_base; txt = '6%'; }
            if(applied > 0) {
                res.isEligible = true; res.appliedRateText = txt + (hasRec?' (å«æ¨è–¦)':' (åŸºç¤)');
                const indepBV = (r.legs||[]).filter(l=>l.isIndependent).reduce((s,l)=>s+(Number(l.bv)||0),0);
                const calcBase = Math.max(0, (gpv * 50) - indepBV);
                res.baseBonus = Math.round(calcBase * applied);
                res.recruitBonus = Math.round((r.newRecruits||[]).reduce((s,n)=>s+(Number(n.bv)||0),0) * params.rate_recruit_bv);
                res.learningBonus = r.learningDone ? Math.round((res.baseBonus + res.recruitBonus) * params.rate_learning) : 0;
                res.starTotal = Math.round(res.baseBonus + res.recruitBonus + res.learningBonus);
                res.totalIncome = res.starTotal;
            }
        }
        return res;
    }

    // =========================================
    // E) Router
    // =========================================
    function header(t) { return `<div class="flex items-center gap-3"><button class="menu-btn hidden w-10 h-10 rounded-lg bg-card border border-border items-center justify-center text-foreground hover:bg-secondary transition-colors" onclick="openDrawer()">â˜°</button><h1 class="text-xl font-bold text-foreground">${t}</h1></div>`; }
    function router(pg) {
        try {
            document.querySelectorAll('.nav-item').forEach(a=>a.classList.remove('active'));
            const nav = document.getElementById('nav-'+pg);
            if(nav) { nav.classList.add('active'); const group = nav.closest('.nav-group'); if(group) group.classList.remove('collapsed'); }
            if(window.innerWidth < 1024) closeDrawer();
            document.getElementById('app').innerHTML = '';
            if(pg==='dashboard') renderDashboard(); else if(pg==='records') renderRecords(); else if(pg==='payout') renderPayout(); else if(pg==='partners') renderPartners(); else if(pg==='initiators') renderInitiators(); else if(pg==='org') renderOrgChart(); else if(pg==='versions') renderVersions(); else if(pg==='settings') renderSettings();
        } catch(e) { console.error(e); alert('é é¢è¼‰å…¥éŒ¯èª¤ï¼š' + e.message); }
    }

    // =========================================
    // F) Pages Render
    // =========================================
    function renderDashboard() {
        const m = getLocalMonth(); // Fixed: Use local month directly
        const recs = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
        const total = recs.reduce((s,r)=>s+r.starTotal,0);
        const unpaid = recs.filter(r=>r.payoutStatus!=='paid' && r.totalIncome>0).length;
        const activePartners = store.data.partners.filter(p => p.status === 'active').length;
        document.getElementById('app').innerHTML = `
            <header class="flex items-center justify-between mb-6 flex-wrap gap-4">${header(`ç¸½è¦½ - ${m}`)}<div class="flex items-center gap-2 text-sm text-muted-foreground">æœ€å¾Œæ›´æ–°: ${getLocalToday()}</div></header>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-card rounded-xl border border-border p-5 relative overflow-hidden"><div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-primary/20 to-transparent rounded-bl-full"></div><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">ğŸ’°</div><span class="text-sm text-muted-foreground">æœ¬æœˆé ä¼°</span></div><div class="text-3xl font-bold text-foreground mb-1">${money(total)}</div><div class="text-xs text-muted-foreground">æ–°æ˜Ÿåœ˜éšŠå›é¥‹åˆè¨ˆ</div></div>
                <div class="bg-card rounded-xl border border-border p-5 relative overflow-hidden"><div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-destructive/20 to-transparent rounded-bl-full"></div><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 rounded-lg bg-destructive/10 flex items-center justify-center">ğŸš¨</div><span class="text-sm text-muted-foreground">å¾…ç™¼æ”¾</span></div><div class="text-3xl font-bold text-foreground mb-1">${unpaid} <span class="text-lg font-normal text-muted-foreground">äºº</span></div><div class="text-xs text-muted-foreground">å°šæœ‰é‡‘é¡æœªçµæ¸…</div></div>
                <div class="bg-card rounded-xl border border-border p-5 relative overflow-hidden"><div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-500/20 to-transparent rounded-bl-full"></div><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center">ğŸ‘¥</div><span class="text-sm text-muted-foreground">æ´»èºå¤¥ä¼´</span></div><div class="text-3xl font-bold text-foreground mb-1">${activePartners} <span class="text-lg font-normal text-muted-foreground">äºº</span></div><div class="text-xs text-muted-foreground">ç›®å‰åƒèˆ‡è¨ˆç•«</div></div>
                <div class="bg-card rounded-xl border border-border p-5 relative overflow-hidden"><div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-amber-500/20 to-transparent rounded-bl-full"></div><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center">ğŸ“</div><span class="text-sm text-muted-foreground">æœ¬æœˆç´€éŒ„</span></div><div class="text-3xl font-bold text-foreground mb-1">${recs.length} <span class="text-lg font-normal text-muted-foreground">ç­†</span></div><div class="text-xs text-muted-foreground">æ¥­ç¸¾ç´€éŒ„æ•¸</div></div>
            </div>`;
    }

    function renderPartners() {
        const term = localStorage.getItem('p_search') || '';
        let list = store.data.partners.filter(p => p.code.includes(term)||p.name.includes(term));
        const statusFilter = localStorage.getItem('p_statusFilter') || 'all';
        if (statusFilter !== 'all') list = list.filter(p => (p.status || 'active') === statusFilter);
        const joinedFrom = localStorage.getItem('p_joinedFrom'), joinedTo = localStorage.getItem('p_joinedTo');
        if (joinedFrom || joinedTo) { list = list.filter(p => { if (p.status !== 'active' || !p.joinedAt) return false; if (joinedFrom && p.joinedAt < joinedFrom) return false; if (joinedTo && p.joinedAt > joinedTo) return false; return true; }); }
        const sortMode = localStorage.getItem('p_sort') || 'default';
        if (sortMode !== 'default') { list.sort((a, b) => { const dateA = (a.status === 'active' && a.joinedAt) ? a.joinedAt : '0000-00-00'; const dateB = (b.status === 'active' && b.joinedAt) ? b.joinedAt : '0000-00-00'; return sortMode === 'desc' ? dateB.localeCompare(dateA) : dateA.localeCompare(dateB); }); }

        document.getElementById('app').innerHTML = `
            <header class="flex items-center justify-between mb-6 flex-wrap gap-4">${header('å¤¥ä¼´åå–®')}<button class="inline-flex items-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg font-medium text-sm transition-colors" onclick="editPartner()">+ æ–°å¢å¤¥ä¼´</button></header>
            <div class="bg-card rounded-xl border border-border p-4 mb-4"><div class="flex flex-wrap items-center gap-3"><input class="form-input w-48" placeholder="æœå°‹ç·¨è™Ÿ/å§“å" value="${term}" oninput="localStorage.setItem('p_search',this.value);renderPartners()"><select class="form-input w-auto" onchange="localStorage.setItem('p_statusFilter',this.value);renderPartners()"><option value="all" ${statusFilter==='all'?'selected':''}>å…¨éƒ¨ç‹€æ…‹</option><option value="active" ${statusFilter==='active'?'selected':''}>åªçœ‹åƒèˆ‡</option><option value="inactive" ${statusFilter==='inactive'?'selected':''}>åªçœ‹æœªåƒèˆ‡</option></select><button class="px-3 py-2 text-xs font-medium border border-primary text-primary hover:bg-primary/10 rounded-lg transition-colors" onclick="setThisMonthFilter()">æœ¬æœˆåŠ å…¥</button><button class="px-3 py-2 text-xs font-medium bg-secondary text-secondary-foreground hover:bg-secondary/80 rounded-lg transition-colors" onclick="clearPartnerFilter()">é‡ç½®</button></div></div>
            <div class="bg-card rounded-xl border border-border overflow-hidden"><div class="overflow-x-auto"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>æ€§è³ª</th><th class="cursor-pointer hover:text-primary transition-colors" onclick="togglePartnerSort()">åŠ å…¥æ—¥ ${sortMode==='desc'?'â†“':sortMode==='asc'?'â†‘':''}</th><th>åŠ å…¥æ™‚é•·</th><th>æ¨è–¦äºº</th><th>ç™¼èµ·äºº</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>${list.map(p => {
                const isActive = (p.status || 'active') === 'active';
                return `<tr><td><span class="font-mono text-sm text-foreground">${p.code}</span></td><td><span class="font-medium text-foreground">${p.name}</span></td><td><span class="inline-flex px-2 py-0.5 rounded text-xs font-medium ${p.memberType === 'member' ? 'bg-blue-500/10 text-blue-400' : 'bg-amber-500/10 text-amber-400'}">${p.memberType === 'member' ? 'ç”Ÿæ´»æœƒå“¡' : 'ç›´éŠ·å•†'}</span></td><td class="text-sm text-foreground">${isActive ? (p.joinedAt || '<span class="text-warning">æœªå¡«</span>') : '<span class="text-muted-foreground">â€”</span>'}</td><td class="text-sm text-muted-foreground">${isActive ? getDuration(p.joinedAt) : '<span class="text-muted-foreground">â€”</span>'}</td><td class="text-sm text-muted-foreground">${store.getPartner(p.sponsorId)?.name||'-'}</td><td class="text-sm">${store.getInitiator(p.initiatorId)?.name||'<span class="text-destructive">æœªè¨­å®š</span>'}</td><td><div class="flex items-center gap-2"><label class="switch-sm"><input type="checkbox" ${isActive?'checked':''} onchange="togglePartnerStatus('${p.id}', this)"><span class="slider-sm"></span></label><span class="text-xs font-medium ${isActive?'text-primary':'text-muted-foreground'}">${isActive?'åƒèˆ‡':'æœªåƒèˆ‡'}</span></div></td><td><button class="px-3 py-1.5 text-xs font-medium bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-lg transition-colors" onclick="editPartner('${p.id}')">ç·¨è¼¯</button><button class="px-3 py-1.5 text-xs font-medium bg-destructive/10 hover:bg-destructive/20 text-destructive rounded-lg transition-colors" onclick="deletePartner('${p.id}')">åˆªé™¤</button></td></tr>`; }).join('')}</tbody></table></div></div>`;
    }

    function renderRecords() {
        const m = localStorage.getItem('r_m') || getLocalMonth();
        const q = localStorage.getItem('r_q') || '';
        const unpaidOnly = localStorage.getItem('r_unpaid') === 'true';
        let list = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
        if(q) list = list.filter(r=>r.partnerName.includes(q));
        if(unpaidOnly) list = list.filter(r=>r.payoutStatus!=='paid' && r.totalIncome>0);
        
        document.getElementById('app').innerHTML = `
            <header class="flex items-center justify-between mb-6 flex-wrap gap-4">${header('æœˆä»½æ¥­ç¸¾ç´€éŒ„')}<button class="inline-flex items-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg font-medium text-sm transition-colors" onclick="editRecord(null,'${m}')">+ æ–°å¢ç´€éŒ„</button></header>
            <div class="bg-card rounded-xl border border-border p-4 mb-4"><div class="flex flex-wrap items-center gap-3"><input type="month" value="${m}" class="form-input w-auto" onchange="localStorage.setItem('r_m',this.value);renderRecords()"><input placeholder="æœå°‹å¤¥ä¼´" value="${q}" class="form-input w-48" oninput="localStorage.setItem('r_q',this.value);renderRecords()">${getPvViewSelect('renderRecords')}<label class="inline-flex items-center gap-2 px-3 py-2 bg-secondary rounded-lg cursor-pointer hover:bg-secondary/80 transition-colors"><input type="checkbox" ${unpaidOnly?'checked':''} onchange="localStorage.setItem('r_unpaid',this.checked);renderRecords()"><span class="text-sm text-foreground">åƒ…é¡¯ç¤ºæœªç™¼æ”¾</span></label></div></div>
            <div class="bg-card rounded-xl border border-border overflow-hidden"><div class="overflow-x-auto"><table><thead><tr><th>å¤¥ä¼´</th><th>ç‹€æ…‹</th><th>PV / BV</th><th>çé‡‘ / ç”¢å“</th><th>ç™¼æ”¾</th><th>æ“ä½œ</th></tr></thead><tbody>${list.map(r => `<tr><td><span class="font-medium text-foreground">${r.partnerName}</span></td><td>${r.isGraduated ? '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary">ç•¢æ¥­</span>' : (r.isPartnerInactive || r.isMonthlyInactive ? '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-secondary text-muted-foreground">æœªåƒèˆ‡</span>' : '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary">åƒèˆ‡</span>')}</td><td><div class="font-semibold text-foreground">${formatPvBv(r.gpv, r.gbv)}</div><div class="text-xs text-muted-foreground">${r.createdAt||''}</div></td><td><div class="font-semibold ${r.totalIncome>0?'text-primary':'text-muted-foreground'}">${money(r.totalIncome)}</div><div class="text-xs text-muted-foreground">${(r.products||[]).map(x=>`${x.name}x${x.qty}`).join(', ')}</div></td><td><span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium ${r.payoutStatus==='paid'?'bg-primary/10 text-primary':'bg-destructive/10 text-destructive'}">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</span></td><td><button class="px-3 py-1.5 text-xs font-medium bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-lg transition-colors" onclick="editRecord('${r.id}')">ç·¨è¼¯</button></td></tr>`).join('')}</tbody></table></div></div>`;
    }

    function renderPayout() {
        const m = localStorage.getItem('pay_m') || getLocalMonth();
        const q = localStorage.getItem('pay_q') || '';
        let recs = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
        if(q) recs = recs.filter(r=>r.partnerName.includes(q) || (store.getInitiator(r.initiatorId)||{}).name?.includes(q));
        const groups = {};
        store.data.initiators.forEach(i => { groups[i.id] = { info: i, list: [], sum:0, unpaid:0 }; });
        groups['none'] = { info:{id:'none', name:'æœªæŒ‡å®š', code:'N/A'}, list:[], sum:0, unpaid:0 };
        recs.forEach(r => { const gid = groups[r.initiatorId] ? r.initiatorId : 'none'; groups[gid].list.push(r); groups[gid].sum += r.totalIncome; if(r.payoutStatus!=='paid') groups[gid].unpaid += r.totalIncome; });
        
        document.getElementById('app').innerHTML = `
            <header class="flex items-center justify-between mb-6 flex-wrap gap-4">${header('æœ¬æœˆç™¼æ”¾')}<div class="flex gap-2"><button class="px-4 py-2 bg-primary text-primary-foreground rounded-lg font-medium text-sm" onclick="bulkPay('${m}')">æ‰¹æ¬¡ç™¼æ”¾</button><button class="px-4 py-2 bg-secondary text-secondary-foreground rounded-lg font-medium text-sm" onclick="exportCSV('${m}')">åŒ¯å‡º CSV</button></div></header>
            <div class="bg-card rounded-xl border border-border p-4 mb-4"><div class="flex flex-wrap items-center gap-3"><input type="month" value="${m}" class="form-input w-auto" onchange="localStorage.setItem('pay_m',this.value);renderPayout()"><input placeholder="æœå°‹" value="${q}" class="form-input w-48" oninput="localStorage.setItem('pay_q',this.value);renderPayout()"></div></div>
            <div class="grid gap-4">${Object.values(groups).filter(g=>g.list.length>0).map(g => `<div class="bg-card rounded-xl border border-border overflow-hidden"><div class="p-4 border-b border-border flex justify-between items-center bg-secondary/10"><h3 class="font-bold text-lg text-foreground">${g.info.name}</h3><div class="text-sm">æ‡‰ä»˜ï¼š<span class="text-destructive font-bold">${money(g.unpaid)}</span> / ç¸½è¨ˆï¼š${money(g.sum)}</div></div><div class="overflow-x-auto"><table><thead><tr><th width="30"><input type="checkbox" onchange="toggleGrp(this,'${g.info.id}')"></th><th>å¤¥ä¼´</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th></tr></thead><tbody>${g.list.map(r => `<tr><td><input type="checkbox" class="chk-${g.info.id}" value="${r.id}" ${r.payoutStatus==='paid'?'disabled':''}></td><td><span class="font-medium text-foreground">${r.partnerName}</span></td><td class="font-bold text-foreground">${money(r.totalIncome)}</td><td><button class="px-2 py-1 rounded text-xs font-medium ${r.payoutStatus==='paid'?'bg-primary/20 text-primary':'bg-secondary text-muted-foreground border border-border'}" onclick="togglePay('${r.id}','${r.payoutStatus}','${m}')">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</button></td></tr>`).join('')}</tbody></table></div></div>`).join('')}</div>`;
    }

    function renderInitiators() {
        document.getElementById('app').innerHTML = `
            <header class="flex items-center justify-between mb-6 flex-wrap gap-4">${header('ç™¼èµ·äººç®¡ç†')}<button class="inline-flex items-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg font-medium text-sm transition-colors" onclick="editInit()">+ æ–°å¢</button></header>
            <div class="bg-card rounded-xl border border-border overflow-hidden"><div class="overflow-x-auto"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>æ€§è³ª</th><th>è¼”å°åå–® (æœ€å¤š3ä½)</th><th>æ“ä½œ</th></tr></thead><tbody>${store.data.initiators.map(i => `<tr><td><span class="font-mono text-sm">${i.code}</span></td><td>${i.name}</td><td>${i.memberType === 'member' ? 'ç”Ÿæ´»æœƒå“¡' : 'ç›´éŠ·å•†'}</td><td>${(i.coachedPartnerIds||[]).map(pid => store.getPartner(pid)?store.getPartner(pid).code+' '+store.getPartner(pid).name:'?').join(', ')||'-'}</td><td><button class="px-3 py-1.5 text-xs font-medium bg-secondary hover:bg-secondary/80 text-secondary-foreground rounded-lg transition-colors" onclick="editInit('${i.id}')">ç·¨è¼¯</button><button class="px-3 py-1.5 text-xs font-medium bg-destructive/10 hover:bg-destructive/20 text-destructive rounded-lg transition-colors" onclick="delInit('${i.id}')">åˆªé™¤</button></td></tr>`).join('')}</tbody></table></div></div>`;
    }

    function renderOrgChart() {
        const partners = store.data.partners.filter(p => p.status === 'active');
        const roots = partners.filter(p => !p.sponsorId || !partners.find(u => u.id === p.sponsorId));
        function buildTree(p) {
            const children = partners.filter(c => c.sponsorId === p.id);
            // const totalTeam = 1 + children.reduce((acc, c) => acc + countTeam(c), 0); // Unused currently
            return `<li><div class="node ${children.length ? '' : 'node-leaf'}">${children.length ? `<div class="node-toggle" onclick="toggleNode(this)"><div class="caret">â–¼</div><div class="count">${children.length}</div></div>` : ''}<div class="node-content" onclick="editPartner('${p.id}')"><div class="node-status ${p.memberType==='member'?'badge-member':'badge-direct'}">${p.memberType==='member'?'M':'D'}</div><span class="name">${p.code} ${p.name}</span><span class="type">${store.getInitiator(p.initiatorId)?.name || 'æœªæŒ‡å®š'}</span><div class="detail">åŠ å…¥: ${getDuration(p.joinedAt)}</div></div></div>${children.length ? `<ul>${children.map(c => buildTree(c)).join('')}</ul>` : ''}</li>`;
        }
        document.getElementById('app').innerHTML = `<header class="flex items-center justify-between mb-6">${header('çµ„ç¹”é—œè¯åœ–')}<div class="text-sm text-muted-foreground"><span class="inline-block w-3 h-3 rounded-full mr-1" style="background: rgb(var(--org-badge-direct-bg))"></span>ç›´éŠ·å•†<span class="inline-block w-3 h-3 rounded-full ml-3 mr-1" style="background: rgb(var(--org-badge-member-bg))"></span>æœƒå“¡</div></header><div class="org-container" id="orgContainer"><div class="tree"><ul>${roots.length > 0 ? roots.map(r => buildTree(r)).join('') : '<li class="text-muted-foreground p-10">å°šç„¡çµ„ç¹”è³‡æ–™ï¼Œè«‹å…ˆæ–°å¢å¤¥ä¼´ä¸¦è¨­å®šæ¨è–¦äººã€‚</li>'}</ul></div></div>`;
        
        // Mobile & Desktop Drag Logic (Pointer Events)
        const slider = document.getElementById('orgContainer');
        if(!slider) return;
        if(slider.dataset.bound) return; // Prevent duplicate listeners
        slider.dataset.bound = 'true';
        slider.style.touchAction = 'none';
        
        let isDown = false, startX, startY, scrollLeft, scrollTop, isDragging = false; 
        slider.addEventListener('pointerdown', (e) => { isDown = true; isDragging = false; slider.classList.add('active'); startX = e.pageX - slider.offsetLeft; startY = e.pageY - slider.offsetTop; scrollLeft = slider.scrollLeft; scrollTop = slider.scrollTop; slider.setPointerCapture(e.pointerId); });
        slider.addEventListener('pointermove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const y = e.pageY - slider.offsetTop; const walkX = (x - startX); const walkY = (y - startY); if (Math.abs(walkX) > 6 || Math.abs(walkY) > 6) { isDragging = true; } slider.scrollLeft = scrollLeft - walkX; slider.scrollTop = scrollTop - walkY; });
        const stopDrag = (e) => { isDown = false; slider.classList.remove('active'); if (slider.hasPointerCapture(e.pointerId)) { slider.releasePointerCapture(e.pointerId); } };
        slider.addEventListener('pointerup', stopDrag); slider.addEventListener('pointercancel', stopDrag);
        slider.addEventListener('click', (e) => { if (isDragging) { e.preventDefault(); e.stopPropagation(); } }, true);
    }
    function toggleNode(el) { const li = el.closest('li'); li.classList.toggle('collapsed'); }

    function renderVersions() {
        const list = store.data.versions || [];
        document.getElementById('app').innerHTML = `<header class="flex items-center justify-between mb-6">${header('è¨ˆç•«ç‰ˆæœ¬æ§ç®¡')}<button class="px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-bold" onclick="addVersion()">+ æ–°å¢ç‰ˆæœ¬</button></header><div class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">${list.map((v, idx) => `<div class="bg-card border border-border rounded-xl p-5 relative overflow-hidden ${v.archived ? 'opacity-60' : ''}"><div class="flex justify-between items-start mb-4"><div><h3 class="font-bold text-lg text-foreground">${v.name}</h3><div class="text-xs text-muted-foreground">ID: ${v.id.slice(0,8)}...</div></div>${!v.archived ? `<span class="bg-primary/20 text-primary text-xs px-2 py-1 rounded">ä½¿ç”¨ä¸­</span>` : `<span class="bg-secondary text-muted-foreground text-xs px-2 py-1 rounded">å°å­˜</span>`}</div><div class="space-y-2 text-sm text-muted-foreground mb-4"><div class="flex justify-between"><span>0-3% åŸºç¤:</span> <span class="text-foreground">${(v.params.rate_0_3_base*100).toFixed(1)}%</span></div><div class="flex justify-between"><span>0-3% æ¨è–¦:</span> <span class="text-foreground">${(v.params.rate_0_3_rec*100).toFixed(1)}%</span></div><div class="flex justify-between"><span>6% åŸºç¤:</span> <span class="text-foreground">${(v.params.rate_6_base*100).toFixed(1)}%</span></div><div class="flex justify-between"><span>6% æ¨è–¦:</span> <span class="text-foreground">${(v.params.rate_6_rec*100).toFixed(1)}%</span></div><div class="flex justify-between"><span>æ–°äººæ¨è–¦çå‹µ:</span> <span class="text-foreground">${(v.params.rate_recruit_bv*100).toFixed(1)}%</span></div><div class="flex justify-between"><span>å­¸ç¿’åŠ ç¢¼:</span> <span class="text-foreground">${(v.params.rate_learning*100).toFixed(1)}%</span></div></div><div class="flex gap-2 mt-auto"><button class="flex-1 py-2 bg-secondary text-secondary-foreground rounded text-sm" onclick="editVersion('${v.id}')">ç·¨è¼¯åƒæ•¸</button>${list.length > 1 && !v.archived ? `<button class="px-3 py-2 bg-destructive/10 text-destructive rounded text-sm" onclick="archiveVersion('${v.id}')">å°å­˜</button>` : ''}</div></div>`).join('')}</div>`;
    }

    function renderSettings() {
        document.getElementById('app').innerHTML = `<header class="flex items-center justify-between mb-6">${header('ç³»çµ±è¨­å®š')}</header><div class="max-w-2xl mx-auto space-y-6"><div class="bg-card border border-border p-6 rounded-xl"><h3 class="text-lg font-bold mb-4 flex items-center gap-2">ğŸ“¦ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3><p class="text-sm text-muted-foreground mb-4">å°‡å®Œæ•´çš„ç³»çµ±è³‡æ–™åŒ¯å‡ºç‚º JSON æª”æ¡ˆï¼Œä»¥ä¾›å‚™ä»½ä½¿ç”¨ã€‚</p><div class="flex gap-4"><button class="px-4 py-2 bg-secondary text-secondary-foreground rounded-lg" onclick="downloadBackup()">â¬‡ï¸ ä¸‹è¼‰å‚™ä»½ (JSON)</button><label class="px-4 py-2 bg-secondary text-secondary-foreground rounded-lg cursor-pointer hover:bg-secondary/80">â¬†ï¸ é‚„åŸå‚™ä»½<input type="file" accept=".json" class="hidden" onchange="restoreBackup(this)"></label></div></div><div class="bg-card border border-destructive/50 p-6 rounded-xl"><h3 class="text-lg font-bold text-destructive mb-4 flex items-center gap-2">âš ï¸ å±éšªå€åŸŸ</h3><p class="text-sm text-muted-foreground mb-4">æ¸…é™¤æ‰€æœ‰æœ¬åœ°å¿«å–ï¼Œæˆ–é‡ç½®è³‡æ–™åº«ï¼ˆè«‹è¬¹æ…æ“ä½œï¼‰ã€‚</p><button class="px-4 py-2 bg-destructive text-destructive-foreground rounded-lg" onclick="if(confirm('ç¢ºå®šæ¸…é™¤æœ¬åœ°å¿«å–ï¼Ÿä¸æœƒå½±éŸ¿é›²ç«¯è³‡æ–™ã€‚')){localStorage.clear();location.reload();}">æ¸…é™¤ç€è¦½å™¨å¿«å–</button></div><div class="text-center text-xs text-muted-foreground mt-8">ç³»çµ±ç‰ˆæœ¬ v9.9 | é–‹ç™¼è€…: Gemini & Celia</div></div>`;
    }

    // =========================================
    // G) Forms & Actions
    // =========================================
    
    function setThisMonthFilter() {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        const fmt = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        localStorage.setItem('p_joinedFrom', fmt(start)); localStorage.setItem('p_joinedTo', fmt(end));
        renderPartners();
    }
    function clearPartnerFilter() { localStorage.removeItem('p_joinedFrom'); localStorage.removeItem('p_joinedTo'); localStorage.setItem('p_sort', 'default'); localStorage.setItem('p_statusFilter', 'all'); renderPartners(); }
    function togglePartnerSort() { const c = localStorage.getItem('p_sort')||'default'; localStorage.setItem('p_sort', c==='default'?'desc':(c==='desc'?'asc':'default')); renderPartners(); }
    function togglePartnerStatus(id, el) {
        const p = store.getPartner(id); if (!p) return;
        const newStatus = el.checked ? 'active' : 'inactive';
        if (newStatus === 'inactive' && !confirm('ç¢ºå®šå°‡æ­¤å¤¥ä¼´è¨­å®šç‚ºã€æœªåƒèˆ‡ã€å—ï¼Ÿ')) { el.checked = true; return; }
        if (newStatus === 'active' && !p.joinedAt) p.joinedAt = getLocalToday();
        p.status = newStatus; store.save().then(renderPartners).catch(err=>alert('å„²å­˜å¤±æ•—'));
    }
    function editPartner(id) {
        try {
            const p = id ? store.getPartner(id) : {id:'', code:'', name:'', memberType:'directSeller', sponsorId:'', initiatorId:'', status:'active', joinedAt:''};
            if(!p.memberType) p.memberType = 'directSeller'; if(!p.status) p.status = 'active'; if(p.status === 'active' && !p.joinedAt && !id) p.joinedAt = getLocalToday(); 
            const others = store.data.partners.filter(x=>x.id!==p.id); const inits = store.data.initiators;
            openModal(id?'ç·¨è¼¯å¤¥ä¼´':'æ–°å¢å¤¥ä¼´', `<form onsubmit="savePartner(event, '${id||''}')"><div class="row"><div class="col"><label class="text-sm text-muted-foreground">ç·¨è™Ÿ *</label><input name="code" value="${p.code}" class="form-input" required></div><div class="col"><label class="text-sm text-muted-foreground">å§“å *</label><input name="name" value="${p.name}" class="form-input" required></div></div><div class="mb-4"><label class="text-sm text-muted-foreground">æœƒå“¡æ€§è³ª *</label><select name="memberType" class="form-input" required><option value="directSeller" ${p.memberType==='directSeller'?'selected':''}>ç›´éŠ·å•†</option><option value="member" ${p.memberType==='member'?'selected':''}>ç”Ÿæ´»æœƒå“¡</option></select></div><div class="bg-card border border-border p-4 rounded-lg mb-4"><div class="flex justify-between items-center mb-2"><label class="text-sm">è¨ˆç•«ç‹€æ…‹</label><div class="flex items-center gap-2"><label class="switch"><input type="checkbox" id="statusToggle" ${p.status==='active'?'checked':''} onchange="toggleStatusUI(this)"><span class="slider"></span></label><span id="statusLabel" class="text-sm font-bold">${p.status==='active'?'åƒèˆ‡':'æœªåƒèˆ‡'}</span></div></div><div id="joinedAtGroup" style="display:${p.status==='active'?'block':'none'}"><label class="text-sm text-muted-foreground">åŠ å…¥è¨ˆç•«æ—¥æœŸ *</label><input type="date" name="joinedAt" id="joinedAtInput" class="form-input" value="${p.joinedAt||''}" ${p.status==='active'?'required':''}></div></div><div class="mb-4"><label class="text-sm text-muted-foreground">æ¨è–¦äºº (ä¸Šç·š)</label><select name="sponsorId" class="form-input"><option value="">-- ç„¡ (é ‚å±¤) --</option>${others.map(o=>`<option value="${o.id}" ${o.id===p.sponsorId?'selected':''}>${o.code} ${o.name}</option>`).join('')}</select></div><div class="mb-4"><label class="text-sm text-muted-foreground">æ‰€å±¬ç™¼èµ·äºº (çé‡‘ä¾†æº)</label><select name="initiatorId" class="form-input" required><option value="">-- è«‹é¸æ“‡ --</option>${inits.map(i=>`<option value="${i.id}" ${i.id===p.initiatorId?'selected':''}>${i.name}</option>`).join('')}</select></div><button class="w-full py-2 bg-primary text-primary-foreground rounded-lg font-bold">å„²å­˜</button></form>`);
            window.toggleStatusUI = function(el) { const label = document.getElementById('statusLabel'), grp = document.getElementById('joinedAtGroup'), inp = document.getElementById('joinedAtInput'); if (el.checked) { label.innerText = "åƒèˆ‡"; grp.style.display = "block"; inp.required = true; if (!inp.value) inp.value = getLocalToday(); } else { label.innerText = "æœªåƒèˆ‡"; grp.style.display = "none"; inp.required = false; } };
        } catch(e) { alert(e.message); }
    }
    function savePartner(e, id) {
        e.preventDefault(); const fd = new FormData(e.target), d = Object.fromEntries(fd);
        d.status = document.getElementById('statusToggle').checked ? 'active' : 'inactive';
        if(store.data.partners.some(x=>x.code===d.code && x.id!==id)) return alert('ç·¨è™Ÿé‡è¤‡');
        if(id) { const i = store.data.partners.findIndex(x=>x.id===id); store.data.partners[i] = {...store.data.partners[i], ...d}; } else { store.data.partners.push({...d, id: uuid()}); }
        store.save().then(()=>{closeModal();renderPartners()}).catch(err=>alert('å„²å­˜å¤±æ•—'));
    }
    function deletePartner(id) { if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return; store.data.partners = store.data.partners.filter(x=>x.id!==id); store.data.partners.forEach(p=>{if(p.sponsorId===id)p.sponsorId=''}); store.data.records = store.data.records.filter(r=>r.partnerId!==id); store.save().then(renderPartners).catch(err=>alert('åˆªé™¤å¤±æ•—')); }

    function editRecord(id, month) {
        try {
            isDirty = false;
            const existing = id ? store.getRecord(id) : null;
            if(existing && existing.payoutStatus==='paid' && !confirm('å·²ç™¼æ”¾ï¼Œç¢ºå®šè¦ä¿®æ”¹å—ï¼Ÿ')) return;
            const targetMonth = month || (existing ? existing.month : getLocalMonth()); 
            const base = existing || { id:'', partnerId:'', month: targetMonth, ppv:0, pbv:0, gpv:0, gbv:0, legs:[], newRecruits:[], products:[], learningDone:false, participation:'active', payoutStatus:'unpaid', payoutDate: getToday(targetMonth), createdAt: getLocalToday(), planVersionId: store.data.versions.find(v=>!v.archived)?.id, note:'' };
            if(!base.createdAt) base.createdAt = getLocalToday();
            if(base.pbv === undefined) base.pbv = pvToBv(base.ppv); if(base.gbv === undefined) base.gbv = pvToBv(base.gpv);
            tempRec = JSON.parse(JSON.stringify(base));
            if (!Array.isArray(tempRec.legs)) tempRec.legs = []; if (!Array.isArray(tempRec.newRecruits)) tempRec.newRecruits = []; if (!Array.isArray(tempRec.products)) tempRec.products = [];
            const pOpts = store.data.partners.map(p => `<option value="${p.id}" ${p.id===base.partnerId?'selected':''} style="${p.status==='inactive'?'color:gray':''}">${p.code} ${p.name} ${p.status==='inactive'?'(æœªåƒèˆ‡)':''}</option>`).join('');
            const vOpts = store.data.versions.map(v => `<option value="${v.id}" ${v.id===base.planVersionId?'selected':''} ${v.archived?'disabled':''}>${v.name}</option>`).join('');
            const syncScript = (type) => {
                if(type === 'ppv') return `this.form.pbv.value=Math.round(this.value*${PV_RATE}); tempRec.ppv=Number(this.value); tempRec.pbv=Number(this.form.pbv.value); markDirty();`;
                if(type === 'pbv') return `this.form.ppv.value=parseFloat((this.value/${PV_RATE}).toFixed(2)); tempRec.pbv=Number(this.value); tempRec.ppv=Number(this.form.ppv.value); markDirty();`;
                if(type === 'gpv') return `this.form.gbv.value=Math.round(this.value*${PV_RATE}); tempRec.gpv=Number(this.value); tempRec.gbv=Number(this.form.gbv.value); renderPreview(); markDirty();`;
                if(type === 'gbv') return `this.form.gpv.value=parseFloat((this.value/${PV_RATE}).toFixed(2)); tempRec.gbv=Number(this.value); tempRec.gpv=Number(this.form.gpv.value); renderPreview(); markDirty();`;
            };
            openModal(id?'ç·¨è¼¯ç´€éŒ„':'æ–°å¢ç´€éŒ„', `<form id="recForm" onsubmit="saveRecord(event, '${id||''}')"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-4"><div class="bg-card border border-border p-4 rounded-lg"><div class="row"><div class="col"><label class="text-sm text-muted-foreground">å¤¥ä¼´</label><select name="partnerId" class="form-input" onchange="tempRec.partnerId=this.value;renderPreview();markDirty()" required>${pOpts}</select></div><div class="col"><label class="text-sm text-muted-foreground">ç‰ˆæœ¬</label><select name="planVersionId" class="form-input" onchange="tempRec.planVersionId=this.value;renderPreview();markDirty()">${vOpts}</select></div></div><div class="row"><div class="col"><label class="text-sm text-muted-foreground">è¼¸å…¥æ—¥æœŸ</label><input type="date" name="createdAt" value="${base.createdAt}" class="form-input" oninput="markDirty()"></div></div></div><div class="bg-card border border-border p-4 rounded-lg"><div class="row"><div class="col"><label class="text-sm text-muted-foreground">å€‹äºº PV</label><input type="number" step="0.01" name="ppv" value="${base.ppv}" class="form-input" oninput="${syncScript('ppv')}"></div><div class="col"><label class="text-sm text-muted-foreground">å€‹äºº BV</label><input type="number" name="pbv" value="${base.pbv}" class="form-input" oninput="${syncScript('pbv')}"></div></div><div class="row"><div class="col"><label class="text-sm text-muted-foreground">å°çµ„ PV *</label><input type="number" step="0.01" name="gpv" value="${base.gpv}" class="form-input" required oninput="${syncScript('gpv')}"></div><div class="col"><label class="text-sm text-muted-foreground">å°çµ„ BV *</label><input type="number" name="gbv" value="${base.gbv}" class="form-input" required oninput="${syncScript('gbv')}"></div></div></div><div class="bg-card border border-border p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><label class="text-sm">ç”¢å“åˆ†äº«</label><button type="button" class="text-xs text-primary border border-primary px-2 py-1 rounded" onclick="openAddCatalogModal()">+ è³‡æ–™åº«</button></div><div id="productsArea" class="space-y-2 mb-2"></div><button type="button" class="w-full py-2 bg-secondary text-secondary-foreground rounded border border-border" onclick="addProd()">+ ç”¢å“</button></div><div class="bg-card border border-border p-4 rounded-lg"><label class="text-sm mb-2 block">è…¿ (æ‰£é™¤ç¨ç«‹æ¥­ç¸¾)</label><div id="legsArea" class="space-y-2 mb-2"></div><button type="button" class="w-full py-2 bg-secondary text-secondary-foreground rounded border border-border" onclick="addLeg()">+ è…¿</button></div><div class="bg-card border border-border p-4 rounded-lg"><label class="text-sm mb-2 block">æ–°æ¨è–¦</label><div id="recruitArea" class="space-y-2 mb-2"></div><button type="button" class="w-full py-2 bg-secondary text-secondary-foreground rounded border border-border" onclick="addRec()">+ æ–°äºº</button></div><div class="bg-card border border-border p-4 rounded-lg"><div class="row"><div class="col"><label class="text-sm text-muted-foreground">ç‹€æ…‹</label><select name="participation" class="form-input" onchange="tempRec.participation=this.value;renderPreview();markDirty()"><option value="active" ${base.participation==='active'?'selected':''}>åƒèˆ‡</option><option value="inactive" ${base.participation==='inactive'?'selected':''}>æœ¬æœˆä¸è¨ˆ</option></select></div><div class="col pt-8"><label class="flex items-center gap-2"><input type="checkbox" name="learningDone" ${base.learningDone?'checked':''} onchange="tempRec.learningDone=this.checked;renderPreview();markDirty()"> å®Œæˆå­¸ç¿’ä»»å‹™</label></div></div><div class="mb-2"><label class="text-sm text-muted-foreground">å‚™è¨»</label><textarea name="note" class="form-input" oninput="markDirty()">${base.note}</textarea></div><div class="row"><div class="col"><label class="text-sm text-muted-foreground">ç™¼æ”¾ç‹€æ…‹</label><select name="payoutStatus" class="form-input" onchange="markDirty()"><option value="unpaid" ${base.payoutStatus==='unpaid'?'selected':''}>æœªç™¼æ”¾</option><option value="paid" ${base.payoutStatus==='paid'?'selected':''}>å·²ç™¼æ”¾</option></select></div><div class="col"><label class="text-sm text-muted-foreground">ç™¼æ”¾æ—¥æœŸ</label><input type="date" name="payoutDate" value="${base.payoutDate}" class="form-input" oninput="markDirty()"></div></div></div></div><div class="lg:col-span-1"><div class="sticky top-4 space-y-4"><div id="previewBox" class="bg-card border border-accent p-6 rounded-lg shadow-lg min-h-[150px]"></div><div class="flex gap-2"><button type="button" class="flex-1 py-3 bg-secondary text-secondary-foreground rounded-lg" onclick="closeModalSafe()">å–æ¶ˆ</button>${id?`<button type="button" class="flex-1 py-3 bg-destructive/10 text-destructive rounded-lg" onclick="deleteRecord('${id}')">åˆªé™¤</button>`:''}<button class="flex-[2] py-3 bg-primary text-primary-foreground font-bold rounded-lg">å„²å­˜</button></div></div></div></div></form>`);
            requestAnimationFrame(() => { renderPreview(); renderProducts(); renderLegs(); renderRecs(); });
        } catch(e) { alert(e.message); }
    }
    function renderProducts() {
        const area = document.getElementById('productsArea'); if(!area) return;
        const catalog = store.data.productCatalog || {};
        const catalogList = Object.entries(catalog).map(([key, val]) => ({ key, ...val }));
        const totals = (tempRec.products || []).reduce((acc, p) => { const qty = Number(p.qty) || 1; acc.pv += (Number(p.pv)||0)*qty; acc.bv += (Number(p.bv)||0)*qty; return acc; }, { pv: 0, bv: 0 });
        const listHtml = (tempRec.products||[]).map((p,i)=>{
            const uPv = Number(p.pv)||0; const qty = Number(p.qty)||1;
            const hasPV = p.pv !== null && p.pv !== undefined && p.pv !== '';
            const subPv = hasPV ? (uPv * qty).toFixed(2) : '-';
            return `<div class="bg-secondary/20 p-3 rounded-lg border border-border"><div class="flex gap-2 mb-2"><select class="form-input flex-[2]" onchange="pickCatalogProduct(${i}, this.value)"><option value="">-- é¸ç”¢å“ --</option>${catalogList.map(x=>`<option value="${x.key}" ${p.productId===x.key?'selected':''}>${x.id} ${x.name}</option>`).join('')}</select><input placeholder="å“é …" value="${p.name||''}" class="form-input flex-[2]" ${p.productId ? 'disabled' : ''} oninput="tempRec.products[${i}].name=this.value;markDirty()"><input type="number" placeholder="æ•¸é‡" value="${p.qty||1}" class="form-input w-20" oninput="tempRec.products[${i}].qty=Number(this.value)||1;markDirty();renderProducts();renderPreview()"><button type="button" class="bg-destructive/10 text-destructive px-3 rounded" onclick="tempRec.products.splice(${i},1);renderProducts();markDirty();renderPreview()">Ã—</button></div><div class="flex justify-between text-xs text-muted-foreground"><span>PV:${(p.pv ?? '-') } BV:${(p.bv ?? '-')}</span><span>å°è¨ˆ PV:${subPv}</span></div></div>`;
        }).join('');
        area.innerHTML = listHtml + ( (tempRec.products||[]).length ? `<div class="mt-2 p-3 bg-card border border-dashed border-border rounded text-sm flex gap-4"><b>å°è¨ˆ</b> <span>PV: ${totals.pv.toFixed(2)}</span> <span>BV: ${totals.bv.toFixed(0)}</span></div>` : '' );
    }
    function pickCatalogProduct(i, pid){
        const catalog = store.data.productCatalog || {}; const prod = catalog[pid]; if(!prod) return;
        const existIndex = (tempRec.products || []).findIndex((x, idx) => idx !== i && x.productId === pid);
        if (existIndex !== -1) { tempRec.products[existIndex].qty += 1; tempRec.products.splice(i, 1); }
        else { if(!tempRec.products[i]) tempRec.products[i] = { qty: 1 }; tempRec.products[i] = { productId:pid, name:prod.name, pv:prod.pv, bv:prod.bv, dp:prod.dp, qty:tempRec.products[i].qty||1, note:'' }; }
        markDirty(); renderProducts(); renderPreview();
    }
    function renderLegs() { document.getElementById('legsArea').innerHTML = tempRec.legs.map((l,i)=>`<div class="flex gap-2"><input placeholder="è…¿å" value="${l.name}" class="form-input" oninput="tempRec.legs[${i}].name=this.value;markDirty()"><input type="number" placeholder="BV" value="${l.bv}" class="form-input" oninput="tempRec.legs[${i}].bv=Number(this.value);renderPreview();markDirty()"><label class="flex items-center whitespace-nowrap"><input type="checkbox" ${l.isIndependent?'checked':''} onchange="tempRec.legs[${i}].isIndependent=this.checked;renderPreview();markDirty()"> ç¨ç«‹</label><button type="button" class="bg-destructive/10 text-destructive px-3 rounded" onclick="tempRec.legs.splice(${i},1);renderLegs();renderPreview();markDirty()">Ã—</button></div>`).join(''); }
    function addLeg() { tempRec.legs.push({name:'',bv:0,isIndependent:false}); renderLegs(); renderPreview(); markDirty(); }
    function renderRecs() { document.getElementById('recruitArea').innerHTML = tempRec.newRecruits.map((r,i)=>`<div class="flex gap-2"><input placeholder="ç·¨è™Ÿ" value="${r.code||''}" class="form-input w-24" oninput="tempRec.newRecruits[${i}].code=this.value;markDirty()"><input placeholder="å§“å" value="${r.name}" class="form-input flex-1" oninput="tempRec.newRecruits[${i}].name=this.value;markDirty()"><input type="number" placeholder="BV" value="${r.bv}" class="form-input w-24" oninput="tempRec.newRecruits[${i}].bv=Number(this.value);renderPreview();markDirty()"><button type="button" class="bg-destructive/10 text-destructive px-3 rounded" onclick="tempRec.newRecruits.splice(${i},1);renderRecs();renderPreview();markDirty()">Ã—</button></div>`).join(''); }
    function addRec() { tempRec.newRecruits.push({code:'',name:'',memberType:'directSeller',bv:0}); renderRecs(); renderPreview(); markDirty(); }
    function addProd(){ if(!tempRec.products) tempRec.products=[]; tempRec.products.push({ productId:'', name:'', qty:1, pv:null, bv:null, dp:null, note:'' }); renderProducts(); markDirty(); }
    function renderPreview() {
        try {
            const res = calculate(tempRec); const box = document.getElementById('previewBox'); if(!box) return;
            if(!res) { box.innerHTML = '<div class="text-center text-muted-foreground">è«‹é¸æ“‡å¤¥ä¼´</div>'; return; }
            let tag = '<span class="text-primary">ğŸŸ¢ å¯ç™¼æ”¾</span>';
            if(res.isGraduated) tag = '<span class="text-primary">ğŸ“ ç•¢æ¥­</span>'; else if(res.isPartnerInactive) tag = '<span class="text-muted-foreground">æœªåƒèˆ‡</span>'; else if(res.isMonthlyInactive) tag = '<span class="text-muted-foreground">æœ¬æœˆä¸è¨ˆ</span>'; else if(!res.isEligible) tag = '<span class="text-destructive">ğŸš« ä¸é©ç”¨</span>';
            box.innerHTML = `<div class="flex justify-between text-muted-foreground text-sm mb-4"><span>æœ¬æœˆé ä¼°</span> ${tag}</div><div class="text-4xl font-bold ${res.starTotal>0?'text-success':'text-muted-foreground'} text-right border-b border-border pb-4 mb-4">${money(res.starTotal)}</div>${res.isEligible ? `<div class="flex justify-between text-sm text-muted-foreground mb-2"><span>è¨ˆç®—æ¯”ä¾‹</span><span>${res.appliedRateText}</span></div><div class="flex justify-between text-sm text-muted-foreground mb-2"><span>åŸºç¤å›é¥‹</span><span>${money(res.baseBonus)}</span></div><div class="flex justify-between text-sm text-muted-foreground mb-2"><span>æ¨è–¦å›é¥‹</span><span>${money(res.recruitBonus)}</span></div><div class="flex justify-between text-sm text-muted-foreground"><span>å­¸ç¿’åŠ ç¢¼</span><span>${money(res.learningBonus)}</span></div>` : `<div class="text-center text-muted-foreground">ç„¡çé‡‘ç”¢ç”Ÿ</div>`}`;
        } catch(e) { console.error(e); }
    }
    function saveRecord(e, id) {
        e.preventDefault(); const fd = new FormData(e.target);
        if(!id && store.data.records.some(r=>r.month===tempRec.month && r.partnerId===tempRec.partnerId)) return alert('æ­¤å¤¥ä¼´æœ¬æœˆå·²æœ‰ç´€éŒ„');
        const parent = store.getPartner(tempRec.partnerId);
        if(parent) { tempRec.newRecruits.forEach(rec => { if(!rec.code || !rec.name) return; let p = store.data.partners.find(x => x.code === rec.code); if(!p) { store.data.partners.push({ id: uuid(), code: rec.code, name: rec.name, memberType: rec.memberType || 'directSeller', sponsorId: parent.id, initiatorId: parent.initiatorId || '', status: 'active', joinedAt: '' }); } else { if(!p.sponsorId) p.sponsorId = parent.id; if(!p.initiatorId && parent.initiatorId) p.initiatorId = parent.initiatorId; } }); }
        const final = { ...tempRec, ...Object.fromEntries(fd) };
        final.ppv = Number(fd.get('ppv'))||0; final.pbv = Number(fd.get('pbv'))||0; final.gpv = Number(fd.get('gpv'))||0; final.gbv = Number(fd.get('gbv'))||0;
        if(final.gpv > 0 && final.gbv === 0) final.gbv = pvToBv(final.gpv); if(final.gbv > 0 && final.gpv === 0) final.gpv = bvToPv(final.gbv);
        final.learningDone = fd.get('learningDone')==='on'; final.legs = tempRec.legs; final.newRecruits = tempRec.newRecruits; final.products = tempRec.products;
        if(id) { const i = store.data.records.findIndex(x=>x.id===id); store.data.records[i] = final; } else { final.id = uuid(); store.data.records.push(final); }
        store.save().then(() => { isDirty=false; closeModal(); renderRecords(); }).catch(err => { console.error(err); alert('å„²å­˜å¤±æ•—\n' + getFirebaseErrorMsg(err)); });
    }
    function deleteRecord(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { store.data.records = store.data.records.filter(r=>r.id!==id); store.save().then(() => { isDirty=false; closeModal(); renderRecords(); }); } }

    function addVersion() { const name = prompt("è«‹è¼¸å…¥ç‰ˆæœ¬åç¨± (ä¾‹å¦‚: 2026 Q1 è¨ˆç•«):", `v${(store.data.versions.length + 1)}.0`); if (!name) return; const lastVer = store.data.versions[store.data.versions.length - 1]; const newParams = lastVer ? { ...lastVer.params } : { ...defaultParams }; store.data.versions.push({ id: uuid(), name, params: newParams, archived: false }); store.save().then(renderVersions); }
    function editVersion(id) { const v = store.getVersion(id); if (!v) return; openModal('ç·¨è¼¯è¨ˆç•«åƒæ•¸', `<form onsubmit="saveVersion(event, '${id}')"><div class="mb-4"><label class="text-sm text-muted-foreground">ç‰ˆæœ¬åç¨±</label><input name="name" value="${v.name}" class="form-input" required></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="text-sm text-muted-foreground">0-3% åŸºç¤ç‡</label><input type="number" step="0.01" name="rate_0_3_base" value="${v.params.rate_0_3_base}" class="form-input"></div><div><label class="text-sm text-muted-foreground">0-3% æ¨è–¦ç‡</label><input type="number" step="0.01" name="rate_0_3_rec" value="${v.params.rate_0_3_rec}" class="form-input"></div><div><label class="text-sm text-muted-foreground">6% åŸºç¤ç‡</label><input type="number" step="0.01" name="rate_6_base" value="${v.params.rate_6_base}" class="form-input"></div><div><label class="text-sm text-muted-foreground">6% æ¨è–¦ç‡</label><input type="number" step="0.01" name="rate_6_rec" value="${v.params.rate_6_rec}" class="form-input"></div><div><label class="text-sm text-muted-foreground">æ–°äººæ¨è–¦çå‹µ</label><input type="number" step="0.01" name="rate_recruit_bv" value="${v.params.rate_recruit_bv}" class="form-input"></div><div><label class="text-sm text-muted-foreground">å­¸ç¿’åŠ ç¢¼ç‡</label><input type="number" step="0.01" name="rate_learning" value="${v.params.rate_learning}" class="form-input"></div></div><button class="w-full py-3 bg-primary text-primary-foreground font-bold rounded-lg">å„²å­˜è®Šæ›´</button></form>`); }
    function saveVersion(e, id) { e.preventDefault(); const fd = new FormData(e.target); const v = store.data.versions.find(x => x.id === id); if (v) { v.name = fd.get('name'); v.params = { rate_0_3_base: Number(fd.get('rate_0_3_base')), rate_0_3_rec: Number(fd.get('rate_0_3_rec')), rate_6_base: Number(fd.get('rate_6_base')), rate_6_rec: Number(fd.get('rate_6_rec')), rate_recruit_bv: Number(fd.get('rate_recruit_bv')), rate_learning: Number(fd.get('rate_learning')) }; store.save().then(() => { closeModal(); renderVersions(); }); } }
    function archiveVersion(id) { if(!confirm('ç¢ºå®šå°å­˜æ­¤ç‰ˆæœ¬ï¼Ÿå°å­˜å¾Œæ–°ç´€éŒ„å°‡é è¨­ä½¿ç”¨å…¶ä»–ç‰ˆæœ¬ã€‚')) return; const v = store.data.versions.find(x => x.id === id); if(v) { v.archived = true; store.save().then(renderVersions); } }

    function downloadBackup() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(store.data)); const a = document.createElement('a'); a.href = dataStr; a.download = "amway_system_backup_" + getLocalToday() + ".json"; a.click(); }
    function restoreBackup(input) { const file = input.files[0]; if (!file) return; if (!confirm("âš ï¸ è­¦å‘Šï¼šé‚„åŸå°‡æœƒè¦†è“‹ç¾æœ‰çš„æ‰€æœ‰é›²ç«¯è³‡æ–™ï¼ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) return; const reader = new FileReader(); reader.onload = function(e) { try { const json = JSON.parse(e.target.result); if (json.partners && json.records) { store.data = json; store.save().then(() => { alert("é‚„åŸæˆåŠŸï¼"); location.reload(); }); } else { alert("ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼"); } } catch (err) { alert("è®€å–éŒ¯èª¤: " + err); } }; reader.readAsText(file); }
    function toggleGrp(el, id) { document.querySelectorAll('.chk-'+id).forEach(c => { if(!c.disabled) c.checked = el.checked; }); }

    function bulkPay(m) {
        const recs = store.getRecordsByMonth(m);
        const pending = [];
        recs.forEach(r => { const cal = calculate(r); if (cal && cal.totalIncome > 0 && r.payoutStatus !== 'paid') pending.push(r); });
        if (pending.length === 0) return alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶ä¸”æœªç™¼æ”¾çš„é …ç›®');
        const payDate = getToday(m); // Matches togglePay logic
        if (!confirm(`ç¢ºå®šè¦æ¨™è¨˜ ${pending.length} ç­†ç´€éŒ„ç‚ºå·²ç™¼æ”¾ï¼Ÿ\nç™¼æ”¾æ—¥æœŸå°‡è¨­ç‚ºï¼š${payDate}`)) return;
        pending.forEach(r => { r.payoutStatus = 'paid'; r.payoutDate = payDate; });
        store.save().then(() => { alert('ç™¼æ”¾å®Œæˆ'); renderPayout(); }).catch(err => alert('å„²å­˜å¤±æ•—'));
    }
    function togglePay(id, currentStatus, m) {
        const r = store.getRecord(id); if (!r) return;
        if (currentStatus === 'paid') { if (!confirm('ç¢ºå®šè¦å–æ¶ˆç™¼æ”¾ï¼Ÿ')) return; r.payoutStatus = 'unpaid'; } 
        else { r.payoutStatus = 'paid'; r.payoutDate = getToday(m); }
        store.save().then(() => renderPayout());
    }
    function checkLimit(el) {
        const checked = document.querySelectorAll('.coach-chk:checked');
        if (checked.length > 3) { alert('æœ€å¤šåªèƒ½é¸æ“‡ 3 ä½'); el.checked = false; }
    }
    function openAddCatalogModal() {
        const catalog = store.data.productCatalog || {};
        let max = 0;
        Object.values(catalog).forEach(p => { const n = parseInt(p.id.replace(/\D/g, '')); if (!isNaN(n) && n > max) max = n; });
        const nextId = 'P' + String(max + 1).padStart(4, '0');
        openCatalogModal('æ–°å¢ç”¢å“', `<form onsubmit="saveCatalogProduct(event)"><div class="row"><div class="col"><label class="text-sm text-muted-foreground">ç”¢å“ç·¨è™Ÿ</label><input name="pid" value="${nextId}" class="form-input" required></div><div class="col"><label class="text-sm text-muted-foreground">ç”¢å“åç¨±</label><input name="name" class="form-input" required></div></div><div class="row"><div class="col"><label class="text-sm text-muted-foreground">PV</label><input name="pv" type="number" step="0.01" class="form-input" required></div><div class="col"><label class="text-sm text-muted-foreground">BV</label><input name="bv" type="number" class="form-input" required></div><div class="col"><label class="text-sm text-muted-foreground">DP</label><input name="dp" type="number" class="form-input"></div></div><button class="w-full py-2 bg-primary text-primary-foreground font-bold rounded-lg mt-4">å„²å­˜</button></form>`);
    }
    function saveCatalogProduct(e){
        e.preventDefault(); const fd = new FormData(e.target); const pid = (fd.get('pid')||'').trim(); const name = (fd.get('name')||'').trim();
        if(!pid || !name) return alert('è«‹å¡«å¯«å®Œæ•´');
        const catalog = store.data.productCatalog || {};
        const exist = Object.values(catalog).some(v => (v?.id || '').trim() === pid);
        if(exist) return alert('ç·¨è™Ÿå·²å­˜åœ¨');
        catalog[uuid()] = { id: pid, name, pv: Number(fd.get('pv')) || 0, bv: Number(fd.get('bv')) || 0, dp: fd.get('dp')==='' ? null : (Number(fd.get('dp'))||0) };
        store.data.productCatalog = catalog; 
        store.save().then(() => { alert('å·²åŠ å…¥è³‡æ–™åº«'); closeCatalogModal(); if(document.getElementById('modal').style.display === 'block') { renderProducts(); } }).catch(err => { alert('åŠ å…¥å¤±æ•—\n' + getFirebaseErrorMsg(err)); });
    }
    function exportCSV(m) {
        const mode = getPvViewMode();
        const list = store.getRecordsByMonth(m).map(calculate).filter(x => x);
        if (!list.length) return alert('ç„¡è³‡æ–™å¯åŒ¯å‡º');
        let csv = '\uFEFFæœˆä»½,ç™¼èµ·äºº,å¤¥ä¼´,ç‹€æ…‹,GPV,GBV,çé‡‘,ç™¼æ”¾ç‹€æ…‹,ç™¼æ”¾æ—¥æœŸ,ç”¢å“æ˜ç´°\n';
        list.forEach(r => {
            const init = store.getInitiator(r.initiatorId)?.name || 'æœªæŒ‡å®š';
            const prods = (r.products || []).map(p => `${p.name}*${p.qty}`).join('; ');
            csv += `"${r.month}","${init}","${r.partnerName}","${r.isEligible?'ç¬¦åˆ':'ä¸ç¬¦'}","${r.gpv}","${r.gbv}","${r.starTotal}","${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}","${r.payoutDate||''}","${prods}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Payout_${m}_${mode}.csv`; link.click();
    }
</script>
</body>
</html>
