<!DOCTYPE html> 
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width,
initial-scale=1.0, maximum-scale=1.0, user-scalable=no,
viewport-fit=cover">
   <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ± (v8.3 å®Œæ•´ä¿®æ­£ç‰ˆ)</title>
   <link rel="icon" href="data:image/svg+xml,%3Csvg
xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em'
font-size='90'%3EğŸš€%3C/text%3E%3C/svg%3E">
    
   <script
src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script
src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
 
   <style>
       :root {
           --primary: #2c3e50;
           --secondary: #34495e;
           --accent: #1abc9c;
           --accent-hover: #16a085;
           --danger: #e74c3c;
           --success: #27ae60;
           --gray: #95a5a6;
           --bg: #f8f9fa;
           --border: #e0e0e0;
           --sidebar-width: 260px;
           --header-height: 60px;
           --vh: 1vh; 
       }
 
       * { box-sizing: border-box; -webkit-tap-highlight-color: transparent;
font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
}
       
       body { 
           margin: 0; 
           background-color: var(--bg); 
           color: #333; 
           overflow: hidden; 
           height: 100vh; 
           height: calc(var(--vh, 1vh) * 100);
           display: flex;
       }
 
       /* --- Sidebar --- */
       aside { width: var(--sidebar-width); background: var(--primary); color:
white; display: flex; flex-direction: column; flex-shrink: 0; z-index: 1000;
height: 100%; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
       aside.collapsed { width: 0; opacity: 0; overflow: hidden; }
       aside h2 { padding: 0 20px; margin: 0; font-size: 1.1rem; border-bottom:
1px solid rgba(255,255,255,0.1); height: var(--header-height); display: flex;
align-items: center; flex-shrink: 0; }
       .sidebar-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling:
touch; padding: 10px 0; }
       .nav-group-title { padding: 12px 20px; color: #bdc3c7; font-size:
0.85rem; font-weight: 600; cursor: pointer; display: flex; justify-content:
space-between; align-items: center; transition: color 0.2s; user-select: none;
}
       .nav-group-title:hover { color: white; }
       .nav-group-title::after { content: 'â€º'; font-size: 1.2em; transition:
transform 0.3s; transform: rotate(90deg); }
       .nav-group.collapsed .nav-group-title::after { transform: rotate(0deg);
}
       .nav-items { max-height: 500px; overflow: hidden; transition: max-height
0.3s ease-out; background: rgba(0,0,0,0.1); }
       .nav-group.collapsed .nav-items { max-height: 0; }
       .nav-item { display: block; padding: 10px 20px 10px 35px; color:
#bdc3c7; text-decoration: none; font-size: 0.95rem; border-left: 4px solid
transparent; cursor: pointer; transition: 0.2s; }
       .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
       .nav-item.active { color: white; background: rgba(255,255,255,0.1);
border-left-color: var(--accent); }
       aside .footer { padding: 15px; font-size: 0.75rem; color: #95a5a6;
text-align: center; border-top: 1px solid rgba(255,255,255,0.05); flex-shrink:
0; }
 
       /* --- Main Content --- */
       main { flex: 1; height: 100%; overflow-y: auto;
-webkit-overflow-scrolling: touch; padding: 20px; position: relative;
background-color: var(--bg); }
       header { display: flex; align-items: center; justify-content:
space-between; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }
       .menu-btn { display: none; background: none; border: none; font-size:
1.5rem; cursor: pointer; color: var(--primary); padding: 5px; margin-right:
10px; }
       h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color:
var(--primary); display: flex; align-items: center; }
 
       @media (max-width: 1023px) {
           .menu-btn { display: block; }
           aside { position: fixed; top: 0; left: 0; bottom: 0; transform:
translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
           aside.open { transform: translateX(0); }
           #drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0;
background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; visibility: hidden;
transition: opacity 0.3s; backdrop-filter: blur(2px); }
           #drawer-overlay.visible { opacity: 1; visibility: visible; }
       }
 
       /* --- UI Components --- */
       .card { background: white; border-radius: 10px; box-shadow: 0 2px 8px
rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; border: 1px solid
var(--border); }
       .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor:
pointer; font-size: 0.9rem; display: inline-flex; align-items: center;
justify-content: center; gap: 5px; transition: 0.2s; color: white; user-select:
none; }
       .btn:active { transform: scale(0.98); }
       .btn-primary { background: var(--accent); }
       .btn-danger { background: var(--danger); }
       .btn-secondary { background: #95a5a6; }
       .btn-outline { background: transparent; border: 1px solid var(--accent);
color: var(--accent); }
       
       .form-control { width: 100%; padding: 10px; border: 1px solid #ccc;
border-radius: 6px; margin-bottom: 5px; font-size: 1rem; }
       .row { display: flex; gap: 15px; flex-wrap: wrap; } .col { flex: 1;
min-width: 150px; }
       
       /* Toggle Switch */
       .switch { position: relative; display: inline-block; width: 50px;
height: 26px; vertical-align: middle; flex-shrink: 0; }
       .switch input { opacity: 0; width: 0; height: 0; }
       .slider { position: absolute; cursor: pointer; top: 0; left: 0; right:
0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
       .slider:before { position: absolute; content: ""; height:
20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition:
.4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
       input:checked + .slider { background-color: var(--success); }
       input:checked + .slider:before { transform: translateX(24px); }
       .switch-label { margin-left: 10px; font-weight: bold; vertical-align:
middle; color: #555; }
       .switch-sm { position: relative; display: inline-block; width: 40px;
height: 22px; vertical-align: middle; flex-shrink: 0; }
       .switch-sm input { opacity: 0; width: 0; height: 0; }
       .slider-sm { position: absolute; cursor: pointer; top: 0; left: 0;
right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius:
34px; }
       .slider-sm:before { position: absolute; content: ""; height:
16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition:
.4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
       input:checked + .slider-sm { background-color: var(--success); }
       input:checked + .slider-sm:before { transform: translateX(18px); }
 
       .status-badge { padding: 4px 10px; border-radius: 15px; font-size:
0.8rem; font-weight: bold; white-space: nowrap; }
       .status-active { background: #e8f8f5; color: var(--success); }
       .status-inactive { background: #f2f3f4; color: var(--gray); }
       .status-paid { background: #d4efdf; color: var(--success); }
       .status-unpaid { background: #fce4ec; color: var(--danger); }
 
       .summary-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap:
wrap; }
       .summary-card { flex: 1; min-width: 200px; background: white; padding:
20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
border-left: 5px solid transparent; }
       .summary-card.green { border-left-color: var(--success); }
       .summary-card.red { border-left-color: var(--danger); }
       .summary-val { font-size: 2rem; font-weight: 800; margin: 10px 0; color:
#2c3e50; }
       .summary-label { color: #7f8c8d; font-weight: 600; font-size: 0.9rem; }
 
       table { width: 100%; border-collapse: collapse; margin-top: 10px;
font-size: 0.95rem; }
       th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left;
vertical-align: middle; }
       th { background: #f8f9fa; color: #555; white-space: nowrap; cursor:
pointer; user-select: none; }
       th:hover { background: #eee; }
       tr:last-child td { border-bottom: none; }
       .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom:
15px; align-items: center; background: #fff; padding: 15px; border-radius:
10px; border: 1px solid #eee; }
 
       .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0;
width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter:
blur(2px); }
       .modal-content { background: white; margin: 5vh auto; width: 95%;
max-width: 1100px; border-radius: 12px; max-height: 90vh; display: flex;
flex-direction: column; overflow: hidden; box-shadow: 0 10px 25px
rgba(0,0,0,0.2); }
       .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee;
display: flex; justify-content: space-between; align-items: center; background:
#fff; }
       .modal-body { padding: 20px; overflow-y: auto; flex: 1; background:
#f9f9f9; -webkit-overflow-scrolling: touch; }
       
       .record-modal-grid { display: flex; gap: 20px; flex-direction: column; }
       @media (min-width: 769px) { 
           .record-modal-grid { flex-direction: row; align-items: flex-start; } 
           .record-form-col { flex: 1.5; } 
           .record-preview-col { flex: 1; min-width: 280px; position: sticky; top:
0; } 
       }
 
       .preview-card { background: white; padding: 20px; border-radius: 10px;
border-top: 4px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.08);
min-height: 150px; }
       .preview-amount { font-size: 2.2rem; font-weight: 800; color:
var(--success); text-align: right; border-bottom: 1px solid #eee;
margin-bottom: 15px; line-height: 1.2; }
       .preview-row { display: flex; justify-content: space-between;
margin-bottom: 8px; color: #555; font-size: 0.9rem; }
       .modal-actions-bar { position: sticky; bottom: 0; background: white;
padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; z-index:
50; }
       .modal-actions-bar button { flex: 1; padding: 12px; }
 
       .org-container { 
           overflow: auto;
           width: 100%; height: 650px; 
           background: white; border-radius: 8px; 
           box-shadow: inset 0 0 20px rgba(0,0,0,0.02); 
           position: relative; cursor: grab; 
           touch-action: none;
           user-select: none;
       }
       .org-container:active { cursor: grabbing; }
       
       .tree { 
           transform-origin: 0 0; will-change: transform;
           display: inline-block; min-width: 100%;
           padding: 50px; box-sizing: border-box;
       }
 
       .tree ul { 
           padding-top: 20px; position: relative; transition: .3s; 
           display: table; margin: 0 auto; white-space: nowrap;
       }
       .tree li { 
           float: none; display: table-cell; vertical-align: top;
           text-align: center; list-style-type: none; 
           position: relative; padding: 20px 5px 0 5px; 
       }
       
       .tree li::before, .tree li::after { 
           content: ''; position: absolute; top: 0; right: 50%; 
           border-top: 1px solid #ccc; width: 50%; height: 20px; 
       }
       .tree li::after { right: auto; left: 50%; border-left: 1px solid #ccc; }
        .tree li:only-child::after, .tree
li:only-child::before { display: none; }
       .tree li:only-child { padding-top: 0; }
       .tree li:first-child::before, .tree li:last-child::after { border: 0
none; }
       .tree li:last-child::before { border-right: 1px solid #ccc;
border-radius: 0 5px 0 0; }
       .tree li:first-child::after { border-radius: 5px 0 0 0; }
       .tree ul ul::before { 
           content: ''; position: absolute; top: 0; left: 50%; 
           border-left: 1px solid #ccc; width: 0; height: 20px; 
       }
       
       .tree li.collapsed > ul { display: none; }
       .tree li.collapsed > .node .caret { transform: rotate(-90deg); }
 
       .node { 
           border: 2px solid #ccc; text-decoration: none; color: #333; 
           font-size: 13px; display: inline-flex; align-items: stretch; 
           border-radius: 8px; transition: .2s; 
           min-width: 160px; position: relative; background: white; z-index: 2;
           overflow: hidden; text-align:
left;
       }
       .node:hover { transform: translateY(-2px); box-shadow: 0 5px 15px
rgba(0,0,0,0.15); z-index: 10; }
       
       .node.node-active { border-color: #27ae60; background-color: #f0fdf4; }
       .node.node-inactive { border-color: #bdc3c7; background-color: #f9f9f9;
filter: grayscale(1); opacity: 0.85; }
 
       .node-toggle {
           width: 40px; background: rgba(0,0,0,0.03); border-right: 1px solid
rgba(0,0,0,0.1);
           display: flex; flex-direction: column; align-items: center;
justify-content: center;
           cursor: pointer; transition: background .2s; flex-shrink: 0;
       }
       .node-toggle:hover { background: rgba(0,0,0,0.08); }
       .caret { font-size: 14px; color: #777; transition: transform 0.2s; }
       .count { font-size: 10px; color: #999; margin-top: 2px; font-weight:
bold; }
       
       .node-content { padding: 10px; flex: 1; cursor: pointer; }
       .node-content .name { font-weight: 800; display: block; margin-bottom:
3px; font-size: 14px; }
       .node-content .type { font-size: 10px; color: #555; background:
rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; display: inline-block;
margin-bottom: 6px; }
       .node-content .detail { font-size: 11px; color: #555; border-top: 1px
dashed #ddd; padding-top: 5px; margin-top: 5px; }
 
       .node-status { position: absolute; top: 0; right: 0; font-size: 10px;
padding: 2px 6px; border-bottom-left-radius: 6px; font-weight: bold; }
 
       #loading { position: fixed; inset: 0; background: #f4f7f6; display:
flex; justify-content: center; align-items: center; z-index: 3000;
flex-direction: column; }
       .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1);
border-left-color: var(--accent); border-radius: 50%; animation: spin 1s linear
infinite; margin-bottom: 10px; }
       @keyframes spin { to { transform:
rotate(360deg); } }
/* âœ… å³ä¸Šè§’ç™»å…¥/ç™»å‡ºæŒ‰éˆ• */
.auth-buttons{
  position: fixed;
  top: 14px;
  right: 16px;
  z-index: 99999;
  display: flex;
  gap: 10px;
}
.auth-buttons button{
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 800;
  box-shadow: 0 8px 18px rgba(0,0,0,.15);
}
.auth-buttons .user-email{
  padding: 10px 12px;
  border-radius: 999px;
  background: rgba(255,255,255,0.92);
  color: #111827;
  font-weight: 800;
  font-size: 12px;
  box-shadow: 0 8px 18px rgba(0,0,0,.12);
  max-width: 52vw;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.auth-buttons .login-btn{
background:#2563eb; color:#fff; }
/* âœ… ä¿®æ­£ 1: CSS Selector ä¿®å¾©èˆ‡æ¨£å¼çµ±ä¸€ */
.auth-buttons .logout-btn{ background:#111827; color:#fff; }

/* âœ… æœªç™»å…¥é®ç½© */
#loginOverlay{
  position: fixed;
  inset: 0;
  background:
rgba(0,0,0,.55);
  z-index: 99998;
  display: flex;
  align-items: center;
  justify-content: center;
}
#loginOverlay .login-card{
  width: min(420px, 92vw);
  background: #fff;
  border-radius: 16px;
  padding: 22px;
  text-align: center;
  box-shadow: 0 20px 50px
rgba(0,0,0,.25);
}
#loginOverlay button{
  margin-top: 12px;
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: 900;
  background: #2563eb;
  color: #fff;
}
   </style>
</head>
<body>
 
<div class="auth-buttons">
  <span id="userEmailBadge" class="user-email" style="display:none;"></span>
  <button class="login-btn" onclick="login()">Google ç™»å…¥</button>
  <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
</div>
 
<div id="loading"><div
class="spinner"></div><div>è¼‰å…¥ä¸­...</div></div>
 
<div id="drawer-overlay"
onclick="closeDrawer()"></div>
 
<aside id="sidebar">
   <h2>ğŸš€ æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«</h2>
   <div class="sidebar-scroll"
id="sidebar-scroll-area">
       <div class="nav-group" id="group-overview">
           <div
class="nav-group-title"
onclick="toggleGroup('group-overview')">ğŸ“Š ç‡Ÿé‹ç¸½è¦½</div>
           <div class="nav-items">
                <a
onclick="router('dashboard')" id="nav-dashboard"
class="nav-item">ç¸½è¦½å„€è¡¨æ¿</a>
                <a onclick="router('payout')"
id="nav-payout" class="nav-item">æœ¬æœˆç™¼æ”¾ç¸½è¡¨</a>
           </div>
       </div>
       <div class="nav-group" id="group-records">
           <div class="nav-group-title"
onclick="toggleGroup('group-records')">ğŸ“ æ¥­ç¸¾èˆ‡ç´€éŒ„</div>
           <div class="nav-items">
                <a
onclick="router('records')" id="nav-records"
class="nav-item">æœˆä»½æ¥­ç¸¾ç´€éŒ„</a>
           </div>
       </div>
       <div class="nav-group" id="group-partners">
           <div class="nav-group-title"
onclick="toggleGroup('group-partners')">ğŸ‘¥ äººå“¡ç®¡ç†</div>
           <div class="nav-items">
                <a
onclick="router('partners')" id="nav-partners" class="nav-item">å¤¥ä¼´åå–®ç®¡ç†</a>
                <a
onclick="router('initiators')" id="nav-initiators"
class="nav-item">ç™¼èµ·äººç®¡ç†</a>
           </div>
       </div>
       <div class="nav-group" id="group-org">
           <div class="nav-group-title" onclick="toggleGroup('group-org')">ğŸ§© çµ„ç¹”çµæ§‹</div>
           <div class="nav-items">
                <a
onclick="router('org')" id="nav-org"
class="nav-item">çµ„ç¹”é—œè¯åœ–</a>
           </div>
       </div>
       <div class="nav-group" id="group-settings">
           <div class="nav-group-title"
onclick="toggleGroup('group-settings')">âš™ï¸ ç³»çµ±è¨­å®š</div>
           <div class="nav-items">
                <a
onclick="router('versions')" id="nav-versions"
class="nav-item">è¨ˆç•«ç‰ˆæœ¬æ§ç®¡</a>
                <a
onclick="router('settings')" id="nav-settings"
class="nav-item">ç³»çµ±è¨­å®š</a>
           </div>
       </div>
   </div>
   <div class="footer">v8.3 å®Œæ•´ä¿®æ­£ç‰ˆ</div>
</aside>
 
<main id="app"></main>
<div id="loginOverlay"
style="display:none;">
  <div
class="login-card">
    <h2>ğŸ” æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ±</h2>
    <p>è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨</p>
    <button onclick="login()">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>
</div>
 
<div id="modal"
class="modal">
   <div class="modal-content">
       <div class="modal-header"><h2
id="modal-title"></h2><span class="close"
onclick="closeModalSafe()">&times;</span></div>
       <div class="modal-body"
id="modal-body"></div>
   </div>
</div>
<div id="catalogModal"
class="modal">
 <div class="modal-content"
style="max-width:700px">
   <div class="modal-header">
     <h2 id="catalogModalTitle">æ–°å¢ç”¢å“åˆ°è³‡æ–™åº«</h2>
     <span class="close"
onclick="closeCatalogModal()">&times;</span>
   </div>
   <div class="modal-body"
id="catalogModalBody"></div>
 </div>
</div>
 
<script>
window.onerror = function(msg, url, line,
col, error) {
   alert(`âš ï¸ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼š\n${msg}\n(è¡Œæ•¸: ${line})`);
   console.error(error);
   document.getElementById('loading').style.display = 'none';
};
 
// --- IOS & UI ---
function setVh() {
   let vh = window.innerHeight * 0.01;
   document.documentElement.style.setProperty('--vh', `${vh}px`);
}
window.addEventListener('resize', setVh);
window.addEventListener('orientationchange',
setVh);
setVh();
 
const sidebar =
document.getElementById('sidebar');
const overlay =
document.getElementById('drawer-overlay');
let bodyScrollY = 0;
 
function openDrawer() {
   sidebar.classList.add('open');
   overlay.classList.add('visible');
   bodyScrollY = window.scrollY;
   document.body.style.position = 'fixed';
   document.body.style.top = `-${bodyScrollY}px`;
   document.body.style.width = '100%';
}
 
function closeDrawer() {
   sidebar.classList.remove('open');
   overlay.classList.remove('visible');
   document.body.style.position = '';
   document.body.style.top = '';
   window.scrollTo(0, bodyScrollY);
}
 
function toggleGroup(groupId) {
   const group = document.getElementById(groupId);
   group.classList.toggle('collapsed');
}
 
let touchStartX = 0;
let touchStartY = 0;
const sidebarEl =
document.getElementById('sidebar');
sidebarEl.addEventListener('touchstart', e
=> { touchStartX = e.changedTouches[0].screenX; touchStartY =
e.changedTouches[0].screenY; }, {passive: true});
const sidebarEl = document.getElementById('sidebar');

sidebarEl.addEventListener('touchstart', (e) => {
  touchStartX = e.changedTouches[0].screenX;
  touchStartY = e.changedTouches[0].screenY;
}, { passive: true });

sidebarEl.addEventListener('touchend', (e) => {
  const deltaX = e.changedTouches[0].screenX - touchStartX;
  const deltaY = e.changedTouches[0].screenY - touchStartY;
  if (deltaX < -50 && Math.abs(deltaY) < 50) closeDrawer();
}, { passive: true }); 
// --- FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
    authDomain: "newstar-system.firebaseapp.com",
    projectId: "newstar-system",
    storageBucket: "newstar-system.firebasestorage.app",
    messagingSenderId: "889699172174",
    appId: "1:889699172174:web:0ff42757035a879cb3281f",
    databaseURL: "https://newstar-system-default-rtdb.asia-southeast1.firebasedatabase.app"
};

let isReady = false;
let db = null;

// âœ… ä¿®æ­£ 2: å¤šå¸³è™Ÿç™½åå–®
const ALLOWED_EMAILS = [
  "tsai860218@gmail.com",
  "xc23026849@gmail.com"
].map(e => (e || "").toLowerCase().trim());

// âœ… æ§åˆ¶é®ç½©
function setOverlay(show){
  const el = document.getElementById("loginOverlay");
  if (el) el.style.display = show ? "flex" : "none";
}

// âœ… UI Helpers
function setAuthButtons(isLoggedIn){
  const loginBtn = document.querySelector(".auth-buttons .login-btn");
  const logoutBtn = document.querySelector(".auth-buttons .logout-btn");
  const badge = document.getElementById("userEmailBadge");
  if(loginBtn) loginBtn.style.display = isLoggedIn ? "none" : "inline-flex";
  if(logoutBtn) logoutBtn.style.display = isLoggedIn ? "inline-flex" : "none";
  // if(badge) badge.style.display = isLoggedIn ? "inline-flex" : "none"; 
  // â¬†ï¸ å·²ç§»é™¤ï¼Œå°‡ badge é¡¯ç¤ºæ§åˆ¶æ¬Šå®Œå…¨äº¤çµ¦ setUserBadge
}

function setUserBadge(user){
  const badge = document.getElementById("userEmailBadge");
  if(!badge) return;

  if(!user){
    badge.style.display = "none";
    badge.textContent = "";
    return;
  }

  const email = (user.email || "").toLowerCase().trim();
  const displayName = (user.displayName || "").trim();
  const fallbackName = email ? email.split("@")[0] : "";
  const name = displayName || fallbackName || "ä½ ";

  badge.style.display = "inline-flex";
  badge.textContent = `ä½ å¥½ï¼Œ${name}`;
}

let _didInitAfterLogin = false;
function initAfterLogin(){
  if (_didInitAfterLogin) return;
  _didInitAfterLogin = true;
  console.log("âœ… ç™½åå–®é€šéï¼Œé–‹å§‹è¼‰å…¥è³‡æ–™...");
  store.init(); // âœ… ç™»å…¥é€šéæ‰è®€ DB
}

try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();

  // âœ… Auth åˆå§‹åŒ–
  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();

  // âœ… ä¿®æ­£ 4: iOS Safari ç™»å…¥å¼·åŒ– (è™•ç† Redirect å›ä¾†)
  auth.getRedirectResult().then((result) => {
    if (result.user) {
        console.log("Redirect ç™»å…¥æˆåŠŸ");
        // onAuthStateChanged æœƒæ¥æ‰‹è™•ç†
    }
  }).catch((error) => {
    console.error("Redirect ç™»å…¥å¤±æ•—:", error);
    alert("âŒ ç™»å…¥å¤±æ•— (Redirect): " + error.message);
  });

  // âœ… ç™»å…¥ (å„ªå…ˆ Popupï¼Œå¤±æ•—è½‰ Redirect)
  window.login = function login(){
    auth.signInWithPopup(provider).catch(err => {
      console.warn("Popup ç™»å…¥å¤±æ•—ï¼Œå˜—è©¦ Redirect...", err);
      // Fallback to redirect for iOS/Safari
      auth.signInWithRedirect(provider);
    });
  }

  // âœ… ç™»å‡º
  window.logout = function logout(){
    store.cleanup(); // å…ˆæ¸…ç†
    auth.signOut();
  }

  // âœ… ç‹€æ…‹ç›£è½
  auth.onAuthStateChanged(async (user) => {
    // 1. æœªç™»å…¥
    if (!user) {
      console.log("å°šæœªç™»å…¥");
      store.cleanup(); // âœ… æ–°å¢:æ¸…ç† listener å’Œè³‡æ–™
      setOverlay(true);
      setAuthButtons(false);
      setUserBadge(null);
      isReady = false;             // âœ… æœªç™»å…¥ä¸å…è¨±è®€å¯« DB
      _didInitAfterLogin = false;
      return;
    }

    // 2. æª¢æŸ¥ç™½åå–®
    const email = (user.email || "").toLowerCase().trim();
    console.log("âœ… å·²ç™»å…¥ï¼š", email);
    const ok = ALLOWED_EMAILS.includes(email);

    if (!ok) {
      alert("âŒ æ­¤å¸³è™Ÿæ²’æœ‰æ¬Šé™ä½¿ç”¨ï¼š" + email);
      store.cleanup(); // âœ… æ¸…ç†
      setUserBadge(null);
      setAuthButtons(false);
      setOverlay(true);
      _didInitAfterLogin = false;
      await auth.signOut();
      return;
    }

    // 3. ç™½åå–®é€šé
    setOverlay(false);
    setAuthButtons(true);
    setUserBadge(user);
    isReady = true;

    // ç™»å…¥å¾Œå†é–‹å§‹è®€è³‡æ–™
    initAfterLogin();
  });

} catch (e) {
  console.error(e);
  const loading = document.getElementById('loading');
  if (loading) loading.innerHTML = '<h3 style="color:red">âš ï¸ Firebase é€£ç·šéŒ¯èª¤</h3>';
}
 
// --- UTILS ---
function uuid() { return
'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r =
Math.random()*16|0, v = c=='x'?r:(r&0x3|0x8); return v.toString(16); }); }
function money(n) { return new
Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD',
minimumFractionDigits:0}).format(n||0); }
function getPercent(pv) { return
pv>=10000?0.21:pv>=7000?0.18:pv>=4000?0.15:pv>=2000?0.12:pv>=1000?0.09:pv>=600?0.06:pv>=200?0.03:0;
}
function getLocalToday() {
   const d = new Date();
   const year = d.getFullYear();
   const month = String(d.getMonth() + 1).padStart(2, '0');
   const day = String(d.getDate()).padStart(2, '0');
   return `${year}-${month}-${day}`;
}
function getToday(m) { 
   if(m) {
       const d = new Date();
       return (d.toISOString().slice(0,7)===m && d.getDate()<18) ?
m+'-18' : getLocalToday();
    }
   return getLocalToday();
}
 
// --- NEW PV/BV UTILS ---
const PV_RATE = 50; // 1 PV = 50 BV
function getPvViewMode() { return
localStorage.getItem('pv_view_mode') || 'both'; }
function pvToBv(pv) { return
Math.round((Number(pv)||0) * PV_RATE); }
function bvToPv(bv) { return
parseFloat(((Number(bv)||0) / PV_RATE).toFixed(2)); }
 
function formatPvBv(pv, bv) {
   const mode = getPvViewMode();
   const p = Number(pv)||0;
   const b = (bv !== undefined && bv !== null) ? Number(bv) :
pvToBv(p);
    
   if (mode === 'pv') return `PV: ${p}`;
   if (mode === 'bv') return `BV: ${b}`;
   return `PV/BV: ${p} / ${b}`;
}
 
function getPvViewSelect(onchangeFnName) {
   const m = getPvViewMode();
   return `
       <select class="form-control"
style="width:auto;margin:0;font-size:0.85rem;padding:4px 8px"
onchange="localStorage.setItem('pv_view_mode',this.value);${onchangeFnName}()">
           <option value="both" ${m==='both'?'selected':''}>PV +
BV</option>
           <option value="pv" ${m==='pv'?'selected':''}>åªçœ‹ PV</option>
           <option value="bv" ${m==='bv'?'selected':''}>åªçœ‹ BV</option>
       </select>
   `;
}
 
function header(t) { return
`<h1><button class="menu-btn"
onclick="openDrawer()">â˜°</button> ${t}</h1>`; }
function openModal(title, content) {
   document.getElementById('modal-title').innerText = title;
   document.getElementById('modal-body').innerHTML = content;
   document.getElementById('modal').style.display = 'block';
}
function openCatalogModal(title, content){
 document.getElementById('catalogModalTitle').innerText = title || 'ç”¢å“è³‡æ–™åº«';
 document.getElementById('catalogModalBody').innerHTML = content || '';
 document.getElementById('catalogModal').style.display = 'block';
}
function closeCatalogModal(){
 document.getElementById('catalogModal').style.display = 'none';
}
window.checkLimit = function(el) {
   if(document.querySelectorAll('.coach-chk:checked').length > 3) {
       alert('âŒ æœ€å¤šåªèƒ½é¸æ“‡ 3 ä½');
       el.checked = false;
    }
}
 
// Duration Calculator
function getDuration(joinedAt) {
   if (!joinedAt) return 'â€”';
   const start = new Date(joinedAt);
   const now = new Date();
   if (isNaN(start)) return 'â€”';
 
   let years = now.getFullYear() - start.getFullYear();
   let months = now.getMonth() - start.getMonth();
   let days = now.getDate() - start.getDate();
 
   if (days < 0) {
       months--;
       const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0);
       days += prevMonth.getDate();
    }
   if (months < 0) {
       years--;
       months += 12;
    }
    
   const totalMonths = years * 12 + months;
   if (totalMonths === 0 && days === 0) return 'ä»Šå¤©åŠ å…¥';
    
   let result = '';
   if (totalMonths > 0) result += `${totalMonths} å€‹æœˆ `;
   if (days > 0) result += `${days} å¤©`;
   return result.trim();
}
 
// --- DATA ---
const defaultParams = { rate_0_3_base:
0.03, rate_0_3_rec: 0.04, rate_6_base: 0.01, rate_6_rec: 0.02, rate_recruit_bv:
0.01, rate_learning: 0.03 };
let appData = { partners: [], initiators:
[], records: [], versions: [] };

let firebaseListener = null; // æ–°å¢:è¿½è¹¤ listener

const store = {
   data: appData,
   init() {
       if(!isReady) return;
       
       // âœ… ç§»é™¤èˆŠçš„ listener (é¿å…é‡è¤‡)
       if(firebaseListener) {
           db.ref('AmwaySystem/v1').off('value', firebaseListener);
       }

       setTimeout(() => { if
(document.getElementById('loading').style.display !== 'none')
document.getElementById('loading').style.display = 'none'; }, 8000);
 
       // âœ… å„²å­˜ listener åƒè€ƒ
       firebaseListener = snap => {
           if(!isReady) return; // é›™é‡æª¢æŸ¥
           
           const val = snap.val();
           if(val) {
                this.data = val;
               ['partners','initiators','records','versions','productCatalog'].forEach(k
=> { 
   if(!this.data[k]) this.data[k] = (k==='productCatalog'? {} : []); 
});
                
                // Normalization
                (this.data.partners ||
[]).forEach(p => { 
                    if(!p.memberType)
p.memberType = 'directSeller';
                    if(!p.status) p.status =
'active'; 
                });
                (this.data.initiators ||
[]).forEach(i => { if(!i.memberType) i.memberType = 'directSeller'; if
(!Array.isArray(i.coachedPartnerIds)) i.coachedPartnerIds = []; });
                (this.data.records ||
[]).forEach(r => {
                    if(r.newRecruits &&
Array.isArray(r.newRecruits)) {
                        r.newRecruits.forEach(nr
=> { if(!nr.memberType) nr.memberType = 'directSeller'; });
                    }
                    if(!r.products) r.products
= [];
                    if(!r.createdAt)
r.createdAt = ''; 
                    
                    // ã€Bã€‘èˆŠè³‡æ–™ç›¸å®¹ï¼šè£œé½Š PV/BV
                    if (r.ppv !== undefined
&& r.pbv === undefined) r.pbv = pvToBv(r.ppv);
                    else if (r.pbv !==
undefined && r.ppv === undefined) r.ppv = bvToPv(r.pbv);
                    
                    if (r.gpv !== undefined
&& r.gbv === undefined) r.gbv = pvToBv(r.gpv);
                    else if (r.gbv !==
undefined && r.gpv === undefined) r.gpv = bvToPv(r.gbv);
                });
           } else {
                this.data.versions.push({id:
uuid(), name:'é è¨­ç‰ˆæœ¬', params:{...defaultParams}});
                this.save();
           }
           document.getElementById('loading').style.display = 'none';
           const active = document.querySelector('.nav-item.active');
           if (active) {
                const pageId =
active.id.replace('nav-', '');
                if (pageId === 'records' ||
pageId === 'partners' || pageId === 'org') router(pageId); 
           } else {
                router('dashboard');
           }
       };

       db.ref('AmwaySystem/v1').on('value', firebaseListener, err => { console.error(err);
document.getElementById('loading').style.display = 'none'; alert('âš ï¸ è®€å–å¤±æ•—ï¼š' + err.message);
router('dashboard'); });
   },
   
   // âœ… æ–°å¢:æ¸…ç†å‡½æ•¸
   cleanup() {
       if(firebaseListener) {
           db.ref('AmwaySystem/v1').off('value', firebaseListener);
           firebaseListener = null;
       }
       this.data = { partners: [], initiators: [], records: [], versions: [], productCatalog: {} };
   },

   save() { 
       if(!isReady) {
           console.warn('âš ï¸ æœªç™»å…¥ç‹€æ…‹,æ‹’çµ•å„²å­˜');
           return Promise.reject(new Error('æœªç™»å…¥'));
       }
       return db.ref('AmwaySystem/v1').set(this.data);
   },
   getPartner(id) { return (this.data.partners||[]).find(p=>p.id===id);
},
   getInitiator(id) { return
(this.data.initiators||[]).find(i=>i.id===id); },
   getRecord(id) { return (this.data.records||[]).find(r=>r.id===id); },
   getRecordsByMonth(m) { return
(this.data.records||[]).filter(r=>r.month===m); },
   getVersion(id) { return (this.data.versions||[]).find(v=>v.id===id)
|| this.data.versions[0]; }
};
 
function calculate(r) {
   const p = store.getPartner(r.partnerId);
   if(!p) return null;
    
   const v = store.getVersion(r.planVersionId);
   const params = v ? v.params : defaultParams;
    
   // Ensure number calculation (Use GPV for rate)
   const gpv = Number(r.gpv) || 0; 
   const rate = getPercent(gpv);
    
   let res = { 
       ...r, 
       partnerName: p.code+' '+p.name, 
       initiatorId: p.initiatorId, 
       myRate: rate, 
       starTotal: 0, 
       totalIncome: 0, 
       isEligible: false, 
       isGraduated: rate >= 0.09, 
       isPartnerInactive: p.status==='inactive', 
       isMonthlyInactive: r.participation==='inactive' 
   };
    
   if(!res.isGraduated && !res.isPartnerInactive &&
!res.isMonthlyInactive) {
       let applied = 0, txt = '';
       const hasRec = (r.newRecruits||[]).length > 0;
       
       if(rate === 0 || rate === 0.03) { 
           applied = hasRec ? params.rate_0_3_rec : params.rate_0_3_base; 
           txt = '0-3%'; 
       }
       else if(rate === 0.06) { 
           applied = hasRec ? params.rate_6_rec : params.rate_6_base; 
           txt = '6%'; 
       }
       
       if(applied > 0) {
           res.isEligible = true;
           res.appliedRateText = txt + (hasRec?' (å«æ¨è–¦)':' (åŸºç¤)');
           const indepBV =
(r.legs||[]).filter(l=>l.isIndependent).reduce((s,l)=>s+(Number(l.bv)||0),0);
           
           // ã€Cã€‘çé‡‘è¨ˆç®—å››æ¨äº”å…¥ Math.round
           const calcBase = Math.max(0, (gpv * 50) - indepBV);
           
           res.baseBonus = Math.round(calcBase * applied);
           res.recruitBonus =
Math.round((r.newRecruits||[]).reduce((s,n)=>s+(Number(n.bv)||0),0) *
params.rate_recruit_bv);
           res.learningBonus = r.learningDone ? Math.round((res.baseBonus +
res.recruitBonus) * params.rate_learning) : 0;
           res.starTotal = Math.round(res.baseBonus + res.recruitBonus +
res.learningBonus);
           res.totalIncome = res.starTotal;
       }
    }
   return res;
}
 
function router(pg) {
   try {
       document.querySelectorAll('.nav-item').forEach(a=>a.classList.remove('active'));
       const nav = document.getElementById('nav-'+pg);
       if(nav) { nav.classList.add('active'); const group =
nav.closest('.nav-group'); if(group) group.classList.remove('collapsed'); }
       if(window.innerWidth < 1024) closeDrawer();
       document.getElementById('app').innerHTML = '';
       
       if(pg==='dashboard') renderDashboard();
       else if(pg==='records') renderRecords();
       else if(pg==='payout') renderPayout();
       else if(pg==='partners') renderPartners();
       else if(pg==='initiators') renderInitiators();
       else if(pg==='org') renderOrgChart();
       else if(pg==='versions') renderVersions();
       else if(pg==='settings') renderSettings();
    }
catch(e) { console.error(e); alert('é é¢è¼‰å…¥éŒ¯èª¤ï¼š' + e.message); }
}
 
function renderDashboard() {
   const m = new Date().toISOString().slice(0,7);
   const recs = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
   const total = recs.reduce((s,r)=>s+r.starTotal,0);
   const unpaid = recs.filter(r=>r.payoutStatus!=='paid' &&
r.totalIncome>0).length;
   document.getElementById('app').innerHTML = `
       <header>${header(`ç¸½è¦½ (${m})`)}</header>
       <div class="summary-row">
           <div class="summary-card green"><div
class="summary-label">æœ¬æœˆé ä¼°</div><div
class="summary-val">${money(total)}</div><div
style="font-size:0.8rem;color:#aaa">æ–°æ˜Ÿåœ˜éšŠå›é¥‹åˆè¨ˆ</div></div>
           <div class="summary-card red"><div
class="summary-label">å¾…ç™¼æ”¾</div><div class="summary-val">${unpaid} äºº</div><div
style="font-size:0.8rem;color:#aaa">å°šæœ‰é‡‘é¡æœªçµæ¸…</div></div>
       </div>
   `;
}
 
// --- PARTNERS ---
function renderPartners() {
   const term = localStorage.getItem('p_search') || '';
   let list = store.data.partners.filter(p =>
p.code.includes(term)||p.name.includes(term));
   const statusFilter = localStorage.getItem('p_statusFilter') || 'all';
   if (statusFilter !== 'all') list = list.filter(p => (p.status ||
'active') === statusFilter);
 
   const joinedFrom = localStorage.getItem('p_joinedFrom');
   const joinedTo = localStorage.getItem('p_joinedTo');
   if (joinedFrom || joinedTo) {
       list = list.filter(p => {
           if (p.status !== 'active' || !p.joinedAt) return false;
           if (joinedFrom && p.joinedAt < joinedFrom) return false;
           if (joinedTo && p.joinedAt > joinedTo) return false;
           return true;
       });
    }
 
   const sortMode = localStorage.getItem('p_sort') || 'default';
   if (sortMode !== 'default') {
       list.sort((a, b) => {
           const dateA = (a.status ===
'active' && a.joinedAt) ? a.joinedAt : '0000-00-00';
           const dateB = (b.status === 'active' && b.joinedAt) ? b.joinedAt
: '0000-00-00';
           if (sortMode === 'desc') return dateB.localeCompare(dateA);
           return
dateA.localeCompare(dateB);
       });
    }
 
   document.getElementById('app').innerHTML = `
       <header>${header('å¤¥ä¼´åå–®')} <button class="btn btn-primary"
onclick="editPartner()">+ æ–°å¢</button></header>
       
       <div class="filter-bar">
           <input class="form-control"
style="width:150px;margin:0" placeholder="ğŸ” æœå°‹ ç·¨è™Ÿ/å§“å" value="${term}"
oninput="localStorage.setItem('p_search',this.value);renderPartners()">
           <select class="form-control"
style="width:auto;margin:0"
onchange="localStorage.setItem('p_statusFilter',this.value);renderPartners()">
               <option
value="all" ${statusFilter==='all'?'selected':''}>å…¨éƒ¨ç‹€æ…‹</option>
               <option
value="active" ${statusFilter==='active'?'selected':''}>åªçœ‹åƒèˆ‡</option>
               <option
value="inactive" ${statusFilter==='inactive'?'selected':''}>åªçœ‹æœªåƒèˆ‡</option>
           </select>
           <span style="color:#aaa">|</span>
           <div
style="display:flex;align-items:center;gap:5px;flex-wrap:wrap">
               <small>åŠ å…¥æ—¥:</small>
               <input type="date"
class="form-control" style="width:130px;margin:0"
value="${joinedFrom||''}" onchange="localStorage.setItem('p_joinedFrom',this.value);renderPartners()">
               <span>~</span>
               <input type="date"
class="form-control" style="width:130px;margin:0"
value="${joinedTo||''}"
onchange="localStorage.setItem('p_joinedTo',this.value);renderPartners()">
               <button class="btn
btn-outline" style="font-size:0.8rem;padding:6px 10px"
onclick="setThisMonthFilter()">æœ¬æœˆ</button>
               <button class="btn
btn-secondary" style="font-size:0.8rem;padding:6px 10px"
onclick="clearPartnerFilter()">é‡ç½®</button>
           </div>
       </div>
 
       <div class="card"
style="overflow-x:auto"><table><thead>
           <tr>
               <th>ç·¨è™Ÿ</th>
               <th>å§“å</th>
               <th>æ€§è³ª</th>
               <th onclick="togglePartnerSort()"
style="cursor:pointer;color:var(--accent)">
                   åŠ å…¥è¨ˆç•«æ—¥
${sortMode==='desc'?'â†“':sortMode==='asc'?'â†‘':''}
               </th>
               <th>å·²åŠ å…¥</th>
               <th>æ¨è–¦äºº</th>
               <th>ç™¼èµ·äºº</th>
               <th>ç‹€æ…‹</th>
               <th>æ“ä½œ</th>
           </tr>
       </thead><tbody>
       ${list.map(p => {
           const isActive = (p.status || 'active') === 'active';
           const joinedDisplay = isActive ? (p.joinedAt || '<span
style="color:#f39c12">æœªå¡«</span>') : '<span style="color:#ccc">â€”</span>';
           const duration = isActive ? getDuration(p.joinedAt) : '<span
style="color:#ccc">â€”</span>';
           
           return `<tr>
           <td>${p.code}</td><td>${p.name}</td>
           <td>${p.memberType === 'member' ? 'ç”Ÿæ´»æœƒå“¡' : 'ç›´éŠ·å•†'}</td>
           <td>${joinedDisplay}</td>
           <td>${duration}</td>
           <td>${store.getPartner(p.sponsorId)?.name||'-'}</td>
           <td>${store.getInitiator(p.initiatorId)?.name||'<span
style="color:red">æœªè¨­å®š</span>'}</td>
           <td>
               <div
style="display:flex;align-items:center;gap:8px">
                   <label
class="switch-sm" style="margin:0">
                       <input
type="checkbox" ${isActive?'checked':''}
onchange="togglePartnerStatus('${p.id}', this)">
                       <span
class="slider-sm"></span>
                   </label>
                   <span style="font-size:0.85rem;color:${isActive?'var(--success)':'#95a5a6'};font-weight:bold">${isActive?'åƒèˆ‡':'æœªåƒèˆ‡'}</span>
               </div>
           </td>
           <td>
               <button class="btn
btn-secondary" style="padding:4px 10px;font-size:0.8rem"
onclick="editPartner('${p.id}')">ç·¨è¼¯</button>
               <button class="btn
btn-danger" style="padding:4px 10px;font-size:0.8rem"
onclick="deletePartner('${p.id}')">åˆªé™¤</button>
           </td>
       </tr>`}).join('')}
       </tbody></table></div>
   `;
}
 
function togglePartnerStatus(id, el) {
   const p = store.getPartner(id);
   if (!p) return;
   const newStatus = el.checked ? 'active' : 'inactive';
    
   if (newStatus === 'inactive') {
       if (!confirm('ç¢ºå®šå°‡æ­¤å¤¥ä¼´è¨­å®šç‚ºã€æœªåƒèˆ‡ã€å—ï¼Ÿ\nï¼ˆåŠ å…¥è¨ˆç•«æ—¥æœŸä¸æœƒè¢«åˆªé™¤ï¼Œä½†æœƒéš±è—ï¼‰')) {
           el.checked = true; return;
       }
    }
else {
       if (!p.joinedAt) p.joinedAt = getLocalToday();
    }
 
   const oldStatus = p.status;
   p.status = newStatus;
 
   store.save()
       .then(() => renderPartners())
       .catch(err => {
           console.error(err);
           p.status = oldStatus;
           el.checked = !el.checked;
           alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
       });
}
 
function setThisMonthFilter() {
   const now = new Date();
   const start = new Date(now.getFullYear(), now.getMonth(), 1);
   const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
   const fmt = d => {
       const year = d.getFullYear();
       const month = String(d.getMonth() + 1).padStart(2, '0');
       const day = String(d.getDate()).padStart(2, '0');
       return `${year}-${month}-${day}`;
   };
   localStorage.setItem('p_joinedFrom', fmt(start));
   localStorage.setItem('p_joinedTo', fmt(end));
   renderPartners();
}
 
function clearPartnerFilter() {
   localStorage.removeItem('p_joinedFrom');
   localStorage.removeItem('p_joinedTo');
   localStorage.setItem('p_sort', 'default');
   localStorage.setItem('p_statusFilter', 'all');
   renderPartners();
}
 
function togglePartnerSort() {
   const current = localStorage.getItem('p_sort') || 'default';
   const next = current === 'default' ? 'desc' : (current === 'desc' ?
'asc' : 'default');
   localStorage.setItem('p_sort', next);
   renderPartners();
}
 
function editPartner(id) {
   try {
       const p = id ? store.getPartner(id) : {id:'', code:'', name:'',
memberType:'directSeller', sponsorId:'', initiatorId:'', status:'active', joinedAt:''};
       if(!p.memberType) p.memberType = 'directSeller';
       if(!p.status) p.status = 'active';
       if(p.status === 'active' && !p.joinedAt && !id)
p.joinedAt = getLocalToday(); 
       
       const others = store.data.partners.filter(x=>x.id!==p.id);
       const inits = store.data.initiators;
 
       openModal(id?'ç·¨è¼¯å¤¥ä¼´':'æ–°å¢å¤¥ä¼´', `
           <form
onsubmit="savePartner(event, '${id||''}')">
               <div
class="row">
                   <div
class="col"><label>ç·¨è™Ÿ *</label><input name="code"
value="${p.code}" class="form-control"
required></div>
                   <div
class="col"><label>å§“å *</label><input name="name"
value="${p.name}" class="form-control"
required></div>
               </div>
               <div
class="form-group"><label>æœƒå“¡æ€§è³ª *</label>
                   <select
name="memberType" class="form-control" required>
                       <option
value="directSeller"
${p.memberType==='directSeller'?'selected':''}>ç›´éŠ·å•†</option>
                        <option
value="member" ${p.memberType==='member'?'selected':''}>ç”Ÿæ´»æœƒå“¡</option>
                   </select>
               </div>
               <div class="card"
style="background:#fdfdfd;border:1px solid #eee;padding:15px">
                   <div
style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                       <label style="margin:0">è¨ˆç•«ç‹€æ…‹</label>
                       <label
class="switch">
                           <input
type="checkbox" id="statusToggle"
${p.status==='active'?'checked':''}
onchange="toggleStatusUI(this)">
                           <span
class="slider"></span>
                       </label>
                       <span
id="statusLabel"
class="switch-label">${p.status==='active'?'åƒèˆ‡':'æœªåƒèˆ‡'}</span>
                   </div>
                   <div
id="joinedAtGroup" style="display:${p.status==='active'?'block':'none'}">
                       <label>åŠ å…¥è¨ˆç•«æ—¥æœŸ
*</label>
                       <input
type="date" name="joinedAt" id="joinedAtInput"
class="form-control" value="${p.joinedAt||''}"
${p.status==='active'?'required':''}>
                   </div>
               </div>
               <div
class="form-group"><label>æ¨è–¦äºº (ä¸Šç·š)</label>
                   <select
name="sponsorId" class="form-control"><option
value="">-- ç„¡ (é ‚å±¤) --</option>${others.map(o=>`<option
value="${o.id}" ${o.id===p.sponsorId?'selected':''}>${o.code}
${o.name}</option>`).join('')}</select>
               </div>
               <div
class="form-group"><label>æ‰€å±¬ç™¼èµ·äºº (çé‡‘ä¾†æº)</label>
                   <select
name="initiatorId" class="form-control"
required><option value="">-- è«‹é¸æ“‡
--</option>${inits.map(i=>`<option value="${i.id}"
${i.id===p.initiatorId?'selected':''}>${i.name}</option>`).join('')}</select>
               </div>
               <button class="btn
btn-primary" style="width:100%">å„²å­˜</button>
           </form>
       `);
       
       window.toggleStatusUI = function(el) {
            const label =
document.getElementById('statusLabel');
           const dateGroup = document.getElementById('joinedAtGroup');
           const dateInput = document.getElementById('joinedAtInput');
           if (el.checked) {
               label.innerText = "åƒèˆ‡";
dateGroup.style.display = "block"; dateInput.required = true;
               if (!dateInput.value)
dateInput.value = getLocalToday();
           } else {
               label.innerText = "æœªåƒèˆ‡";
dateGroup.style.display = "none"; dateInput.required = false;
           }
       };
    }
catch(e) { alert('é–‹å•Ÿå¤±æ•—: '+e.message); }
}
 
function savePartner(e, id) {
   e.preventDefault(); const fd = new FormData(e.target); const d =
Object.fromEntries(fd);
   const toggle = document.getElementById('statusToggle');
   d.status = toggle.checked ? 'active' : 'inactive';
   if(store.data.partners.some(x=>x.code===d.code && x.id!==id))
return alert('ç·¨è™Ÿé‡è¤‡');
    
   if(id) { 
       const i = store.data.partners.findIndex(x=>x.id===id); 
       store.data.partners[i] = {...store.data.partners[i], ...d}; 
    }
else { 
       store.data.partners.push({...d, id: uuid()}); 
    }
   store.save().then(() => { closeModal(); renderPartners();
}).catch(err => { console.error(err); alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
}
 
function deletePartner(id) {
   if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
   store.data.partners = store.data.partners.filter(x=>x.id!==id);
   store.data.partners.forEach(p => { if(p.sponsorId===id)
p.sponsorId=''; }); 
   store.data.records = store.data.records.filter(r=>r.partnerId!==id);
   store.save().then(() => renderPartners()).catch(err => {
console.error(err); alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
}
 
// --- RECORDS (C) ---
function renderRecords() {
   const m = localStorage.getItem('r_m') || new
Date().toISOString().slice(0,7);
   const q = localStorage.getItem('r_q') || '';
   const unpaidOnly = localStorage.getItem('r_unpaid') === 'true';
    
   let list = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
   if(q) list = list.filter(r=>r.partnerName.includes(q));
   if(unpaidOnly) list = list.filter(r=>r.payoutStatus!=='paid'
&& r.totalIncome>0);
    
   document.getElementById('app').innerHTML = `
       <header>${header('æœˆä»½æ¥­ç¸¾ç´€éŒ„')}</header>
       <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;align-items:center">
           <input type="month" value="${m}"
class="form-control" style="width:auto;margin:0"
onchange="localStorage.setItem('r_m',this.value);renderRecords()">
           <input placeholder="æœå°‹å¤¥ä¼´" value="${q}" class="form-control"
style="width:auto;margin:0"
oninput="localStorage.setItem('r_q',this.value);renderRecords()">
           ${getPvViewSelect('renderRecords')}
           <label
style="display:flex;align-items:center;gap:5px;cursor:pointer;background:white;padding:5px
10px;border:1px solid #ccc;border-radius:6px;margin:0">
               <input
type="checkbox" ${unpaidOnly?'checked':''}
onchange="localStorage.setItem('r_unpaid',this.checked);renderRecords()">
<small>æœªç™¼æ”¾</small>
           </label>
           <button class="btn btn-primary"
onclick="editRecord(null,'${m}')">ï¼‹ ç´€éŒ„</button>
       </div>
       <div
class="card"><table><thead><tr><th>å¤¥ä¼´</th><th>ç‹€æ…‹</th><th>PV/BV</th><th>çé‡‘ / ç”¢å“</th><th>ç™¼æ”¾</th><th>æ“ä½œ</th></tr></thead><tbody>
       ${list.map(r => {
           const pText = (r.products||[]).map(x=>`${x.name}Ã—${x.qty}`).join('ã€');
           const pDisplay = pText ? `<div
style="font-size:0.8rem;color:#7f8c8d;margin-top:4px">ğŸ“¦ ${pText}</div>` : '';
           const pvDisplay = formatPvBv(r.gpv, r.gbv);
           
           return `<tr>
           <td>${r.partnerName}</td>
           <td>${r.isGraduated?'<span class="status-badge
status-active">ğŸ“ ç•¢æ¥­</span>':r.isPartnerInactive?'<span
class="status-badge status-inactive">æœªåƒèˆ‡</span>':r.isMonthlyInactive?'<span
class="status-badge status-inactive">æœ¬æœˆä¸è¨ˆ</span>':'<span
class="status-badge status-active">åƒèˆ‡</span>'}</td>
           <td><div
style="font-weight:bold;color:#2c3e50;font-size:0.95rem">${pvDisplay}</div><div
style="font-size:0.8rem;color:#aaa">${r.createdAt||''}</div></td>
           <td><div
style="font-weight:bold;color:${r.totalIncome>0?'var(--success)':'#aaa'}">${money(r.totalIncome)}</div>${pDisplay}</td>
           <td><span class="status-badge ${r.payoutStatus==='paid'?'status-paid':'status-unpaid'}">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</span></td>
           <td><button class="btn btn-secondary"
style="font-size:0.8rem;padding:4px 10px"
onclick="editRecord('${r.id}')">ç·¨è¼¯</button></td>
       </tr>`}).join('')}
       </tbody></table></div>
   `;
}
 
let tempRec = null; let isDirty = false;
function markDirty() { isDirty = true; }
 
function editRecord(id, month) {
   try {
       isDirty = false;
       const existing = id ? store.getRecord(id) : null;
       if(existing && existing.payoutStatus==='paid' &&
!confirm('æ­¤ç´€éŒ„å·²ç™¼æ”¾ï¼Œç¢ºå®šè¦ä¿®æ”¹å—ï¼Ÿ')) return;
       
       // Init base structure
       const base = existing || { 
           id:'', partnerId:'', month, 
           ppv:0, pbv:0, gpv:0, gbv:0, // Ensure fields exist
           legs:[], newRecruits:[], products:[], learningDone:false, 
           participation:'active', payoutStatus:'unpaid', payoutDate:
getToday(month), 
           createdAt: getLocalToday(), 
           planVersionId: store.data.versions.find(v=>!v.archived)?.id, note:'' 
       };
       if(!base.createdAt) base.createdAt = getLocalToday();
 
       // Ensure cross-values exist for legacy data (normalization safety)
        if(base.pbv === undefined) base.pbv =
pvToBv(base.ppv);
       if(base.gbv === undefined) base.gbv = pvToBv(base.gpv);
 
       tempRec = JSON.parse(JSON.stringify(base));
       if (!Array.isArray(tempRec.legs)) tempRec.legs = [];
       if (!Array.isArray(tempRec.newRecruits)) tempRec.newRecruits = [];
       if (!Array.isArray(tempRec.products)) tempRec.products = [];
 
       const pOpts = store.data.partners.map(p => `<option
value="${p.id}" ${p.id===base.partnerId?'selected':''}
style="${p.status==='inactive'?'color:gray':''}">${p.code}
${p.name} ${p.status==='inactive'?'(æœªåƒèˆ‡)':''}</option>`).join('');
       const vOpts = store.data.versions.map(v => `<option
value="${v.id}" ${v.id===base.planVersionId?'selected':''} ${v.archived?'disabled':''}>${v.name}</option>`).join('');
 
       // ã€Aã€‘é›™æ¬„äº’è½‰ Helper (Inline)
       const syncScript = (type) => {
           if(type === 'ppv') return
`this.form.pbv.value=Math.round(this.value*${PV_RATE});
tempRec.ppv=Number(this.value); tempRec.pbv=Number(this.form.pbv.value);
markDirty();`;
           if(type === 'pbv') return
`this.form.ppv.value=parseFloat((this.value/${PV_RATE}).toFixed(2));
tempRec.pbv=Number(this.value); tempRec.ppv=Number(this.form.ppv.value);
markDirty();`;
           if(type === 'gpv') return
`this.form.gbv.value=Math.round(this.value*${PV_RATE});
tempRec.gpv=Number(this.value); tempRec.gbv=Number(this.form.gbv.value);
renderPreview(); markDirty();`;
           if(type === 'gbv') return `this.form.gpv.value=parseFloat((this.value/${PV_RATE}).toFixed(2));
tempRec.gbv=Number(this.value); tempRec.gpv=Number(this.form.gpv.value);
renderPreview(); markDirty();`;
       };
 
       openModal(id?'ç·¨è¼¯ç´€éŒ„':'æ–°å¢ç´€éŒ„', `
           <form id="recForm" onsubmit="saveRecord(event, '${id||''}')">
               <div
class="record-modal-grid">
                   <div
class="record-form-col">
                       <div
class="card">
                           <div
class="row">
                               <div
class="col"><label>å¤¥ä¼´</label><select name="partnerId"
class="form-control"
onchange="tempRec.partnerId=this.value;renderPreview();markDirty()"
required>${pOpts}</select></div>
                               <div
class="col"><label>ç‰ˆæœ¬</label><select name="planVersionId" class="form-control"
onchange="tempRec.planVersionId=this.value;renderPreview();markDirty()">${vOpts}</select></div>
                           </div>
                           <div
class="row">
                               <div
class="col"><label>è¼¸å…¥æ—¥æœŸ</label><input type="date"
name="createdAt" value="${base.createdAt}"
class="form-control" oninput="markDirty()"></div>
                           </div>
                       </div>
                       
                       <div
class="card" style="background:#f8f9fa">
                           <div
class="row" style="margin-bottom:10px">
                               <div
class="col">
                                   <label>å€‹äºº PV</label>
                                   <input
type="number" step="0.01" name="ppv"
value="${base.ppv}" class="form-control"
oninput="${syncScript('ppv')}">
                               </div>
                               <div
class="col">
                                   <label>å€‹äºº BV</label>
                                   <input
type="number" name="pbv" value="${base.pbv}"
class="form-control" oninput="${syncScript('pbv')}">
                                        </div>
                           </div>
                           <div
class="row">
                               <div
class="col">
                                   <label>å°çµ„ PV *</label>
                                   <input
type="number" step="0.01" name="gpv"
value="${base.gpv}" class="form-control" required
oninput="${syncScript('gpv')}">
                               </div>
                               <div
class="col">
                                   <label>å°çµ„ BV *</label>
                                   <input
type="number" name="gbv" value="${base.gbv}"
class="form-control" required
oninput="${syncScript('gbv')}">
                               </div>
                           </div>
                       </div>
 
                       <div
class="card">
                               <div
style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
                                   <label
style="margin:0">ç”¢å“åˆ†äº«</label>
                                   <button
type="button" class="btn btn-outline"
style="padding:6px 10px;font-size:0.85rem" 
     onclick="openAddCatalogModal()">
                                   ï¼‹ æ–°å¢åˆ°ç”¢å“è³‡æ–™åº«
                                   </button>
                               </div>
                               <div
id="productsArea"></div>
                              <button
type="button" class="btn btn-outline"
onclick="addProd()">+ ç”¢å“</button>
                        </div>
                       <div
class="card">
                           <label>è…¿ (æ‰£é™¤ç¨ç«‹æ¥­ç¸¾)</label>
                           <div
id="legsArea"></div>
                           <button
type="button" class="btn btn-outline"
onclick="addLeg()">+ è…¿</button>
                        </div>
                       <div
class="card">
                           <label>æ–°æ¨è–¦</label>
                           <div
id="recruitArea"></div>
                           <button
type="button" class="btn btn-outline"
onclick="addRec()">+ æ–°äºº</button>
                       </div>
                       <div
class="card">
                           <div
class="row">
                               <div
class="col"><label>ç‹€æ…‹</label><select name="participation"
class="form-control" onchange="tempRec.participation=this.value;renderPreview();markDirty()"><option
value="active" ${base.participation==='active'?'selected':''}>åƒèˆ‡</option><option
value="inactive" ${base.participation==='inactive'?'selected':''}>æœ¬æœˆä¸è¨ˆ</option></select></div>
                                <div class="col"
style="padding-top:25px"><label><input
type="checkbox" name="learningDone"
${base.learningDone?'checked':''} onchange="tempRec.learningDone=this.checked;renderPreview();markDirty()">å®Œæˆå­¸ç¿’ä»»å‹™</label></div>
                            </div>
                           <div
class="form-group"><label>å‚™è¨»</label><textarea
name="note" class="form-control"
oninput="markDirty()">${base.note}</textarea></div>
                           <div
class="row">
                               <div
class="col"><label>ç™¼æ”¾ç‹€æ…‹</label><select name="payoutStatus"
class="form-control" onchange="markDirty()"><option
value="unpaid" ${base.payoutStatus==='unpaid'?'selected':''}>æœªç™¼æ”¾</option><option
value="paid" ${base.payoutStatus==='paid'?'selected':''}>å·²ç™¼æ”¾</option></select></div>
                               <div
class="col"><label>ç™¼æ”¾æ—¥æœŸ</label><input type="date"
name="payoutDate" value="${base.payoutDate}"
class="form-control" oninput="markDirty()"></div>
                           </div>
                       </div>
                   </div>
                   <div
class="record-preview-col">
                       <div
id="previewBox"></div>
                       <div
class="modal-actions-bar">
                           <button
type="button" class="btn btn-secondary"
onclick="closeModalSafe()">å–æ¶ˆ</button>
                           ${id?`<button
type="button" class="btn btn-danger"
onclick="deleteRecord('${id}')">åˆªé™¤</button>`:''}
                          <button
class="btn btn-primary">å„²å­˜</button>
                       </div>
                   </div>
               </div>
           </form>
       `);
       
       requestAnimationFrame(() => {
           const form = document.getElementById('recForm');
           if (form) {
               const pSel =
form.querySelector('[name=partnerId]');
               const vSel =
form.querySelector('[name=planVersionId]');
               const gpvInput =
form.querySelector('[name=gpv]');
               const gbvInput =
form.querySelector('[name=gbv]');
               const ppvInput =
form.querySelector('[name=ppv]');
               const pbvInput =
form.querySelector('[name=pbv]');
               
               if (pSel) tempRec.partnerId =
pSel.value || '';
               if (vSel) tempRec.planVersionId
= vSel.value || tempRec.planVersionId;
               if (gpvInput) tempRec.gpv =
Number(gpvInput.value)||0;
               if (gbvInput) tempRec.gbv =
Number(gbvInput.value)||0;
               if (ppvInput) tempRec.ppv =
Number(ppvInput.value)||0;
               if (pbvInput) tempRec.pbv =
Number(pbvInput.value)||0;
           }
           renderPreview();
           renderProducts();
           renderLegs(); 
           renderRecs(); 
       });
 
    }
catch(e) { alert('ç´€éŒ„é éŒ¯èª¤: ' + e.message); }
}
function renderProducts() {
   const area = document.getElementById('productsArea');
   if(!area) return;
 
   const catalog = store.data.productCatalog || {};
   const catalogList =
Object.entries(catalog).map(([key, val]) => ({ key, ...val }));
 
   // âœ… å…ˆç®—ç¸½å°è¨ˆï¼ˆPV/BV/DPï¼‰
   const totals = (tempRec.products || []).reduce((acc, p) => {
       const qty = Number(p.qty) || 1;
       const pv = (p.pv == null) ? 0 : (Number(p.pv) || 0);
       const bv = (p.bv == null) ? 0 : (Number(p.bv) || 0);
       const dp = (p.dp == null) ? 0 : (Number(p.dp) || 0);
 
       acc.pv += pv * qty;
       acc.bv += bv * qty;
       acc.dp += dp * qty;
       return acc;
   }, { pv: 0, bv: 0, dp: 0 });
 
   const listHtml = (tempRec.products||[]).map((p,i)=>{
 
       return `
       <div style="border:1px solid
#eee;padding:10px;border-radius:8px;margin-bottom:10px;background:#fafafa">
           
           <div
style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
 
               <select
class="form-control"
style="flex:2;min-width:220px;margin:0"
                   onchange="pickCatalogProduct(${i},
this.value)">
                   <option
value="">-- é¸ç”¢å“(è³‡æ–™åº«) --</option>
                   ${catalogList.map(x=>`
                       <option
value="${x.key}" ${p.productId===x.key?'selected':''}>
                          ${x.id || x.key}ï½œ${x.name}ï½œPV:${x.pv}
BV:${x.bv} DP:${x.dp ?? ''}
                       </option>
                   `).join('')}
               </select>
 
               <input
placeholder="${p.productId ? 'å·²é¸è³‡æ–™åº«ç”¢å“ï¼ˆå¦‚éœ€æ”¹åè«‹å…ˆæ¸…ç©ºé¸å–®ï¼‰' : 'å“é …(å¯æ‰‹æ‰“)'}"
 value="${p.name||''}" class="form-control"
style="flex:2;min-width:180px;margin:0"
 ${p.productId ? 'disabled' : ''}
 oninput="tempRec.products[${i}].name=this.value;markDirty()">
 
               <input
type="number" placeholder="æ•¸é‡" value="${p.qty||1}" class="form-control"
style="width:90px;margin:0"
                   oninput="tempRec.products[${i}].qty=Number(this.value)||1;markDirty();renderProducts();renderPreview()">
 
               <button
type="button" class="btn btn-danger"
style="padding:6px 10px" 
                   onclick="tempRec.products.splice(${i},1);renderProducts();markDirty();renderPreview()">Ã—</button>
           </div>
 
                       <div style="display:flex;gap:12px;flex-wrap:wrap;font-size:0.85rem;color:#555">
               <div>å–®åƒ¹PVï¼š<b>${p.pv ??
'-'}</b></div>
               <div>å–®åƒ¹BVï¼š<b>${p.bv ??
'-'}</b></div>
               <div>å–®åƒ¹DPï¼š<b>${p.dp ??
'-'}</b></div>
               <div
style="margin-left:auto;color:#888">
                   å°è¨ˆPVï¼š<b>${(p.pv!=null)?((Number(p.pv)||0)*(p.qty||1)).toFixed(2):'-'}</b>ï½œ
                   å°è¨ˆBVï¼š<b>${(p.bv!=null)?((Number(p.bv)||0)*(p.qty||1)).toFixed(0):'-'}</b>ï½œ
                   å°è¨ˆDPï¼š<b>${(p.dp!=null)?((Number(p.dp)||0)*(p.qty||1)).toFixed(0):'-'}</b>
               </div>
           </div>
 
           <div style="margin-top:6px">
               <input
placeholder="å‚™è¨»" value="${p.note||''}"
class="form-control" style="margin:0"
                   oninput="tempRec.products[${i}].note=this.value;markDirty()">
           </div>
 
       </div>
       `;
   }).join('');
 
   // âœ… æœ€ä¸‹æ–¹ç¸½å°è¨ˆï¼ˆä½ è¦çš„ã€Œç‰™è†PV20 + æ²æµ´ä¹³PV10 = PV30ã€å°±åœ¨é€™ï¼‰
   const totalHtml = `
       <div style="margin-top:10px;padding:12px;border:1px dashed
#ccc;border-radius:10px;background:#fff;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
           <b style="color:#2c3e50">ğŸ“Œ æœ¬æ¬¡ç”¢å“å°è¨ˆ</b>
           <div>PVï¼š<b>${totals.pv.toFixed(2)}</b></div>
           <div>BVï¼š<b>${totals.bv.toFixed(0)}</b></div>
           <div>DPï¼š<b>${totals.dp.toFixed(0)}</b></div>
       </div>
   `;
 
   area.innerHTML = listHtml + ( (tempRec.products||[]).length ? totalHtml
: '' );
}
function renderLegs() {
   document.getElementById('legsArea').innerHTML =
tempRec.legs.map((l,i)=>`
       <div style="display:flex;gap:5px;margin-bottom:5px">
           <input placeholder="è…¿å"
value="${l.name}" class="form-control"
oninput="tempRec.legs[${i}].name=this.value;markDirty()">
           <input type="number" placeholder="BV"
value="${l.bv}" class="form-control"
oninput="tempRec.legs[${i}].bv=Number(this.value);renderPreview();markDirty()">
           <label
style="display:flex;align-items:center;font-size:0.8rem;white-space:nowrap"><input
type="checkbox" ${l.isIndependent?'checked':''}
onchange="tempRec.legs[${i}].isIndependent=this.checked;renderPreview();markDirty()">ç¨ç«‹</label>
           <button type="button" class="btn btn-danger"
onclick="tempRec.legs.splice(${i},1);renderLegs();renderPreview();markDirty()">Ã—</button>
       </div>
   `).join('');
}
function addLeg() {
tempRec.legs.push({name:'',bv:0,isIndependent:false}); renderLegs();
renderPreview(); markDirty(); }
function renderRecs() {
   document.getElementById('recruitArea').innerHTML =
tempRec.newRecruits.map((r,i)=>`
       <div style="display:flex;gap:5px;margin-bottom:5px;flex-wrap:wrap;">
           <input placeholder="ç·¨è™Ÿ" value="${r.code||''}"
class="form-control" style="flex:1"
oninput="tempRec.newRecruits[${i}].code=this.value;markDirty()">
           <input placeholder="å§“å" value="${r.name}" class="form-control"
style="flex:1.5"
oninput="tempRec.newRecruits[${i}].name=this.value;markDirty()">
           <select class="form-control" style="flex:1"
onchange="tempRec.newRecruits[${i}].memberType=this.value;markDirty()">
               <option
value="directSeller" ${(!r.memberType ||
r.memberType==='directSeller')?'selected':''}>ç›´éŠ·å•†</option>
               <option
value="member" ${r.memberType==='member'?'selected':''}>ç”Ÿæ´»æœƒå“¡</option>
           </select>
           <input type="number" placeholder="BV"
value="${r.bv}" class="form-control"
style="flex:1"
oninput="tempRec.newRecruits[${i}].bv=Number(this.value);renderPreview();markDirty()">
           <button type="button" class="btn btn-danger"
onclick="tempRec.newRecruits.splice(${i},1);renderRecs();renderPreview();markDirty()">Ã—</button>
       </div>
   `).join('');
}
function addRec() {
tempRec.newRecruits.push({code:'',name:'',memberType:'directSeller',bv:0});
renderRecs(); renderPreview(); markDirty(); }
function addProd(){
 if(!tempRec) return;
 if(!Array.isArray(tempRec.products)) tempRec.products = [];
 tempRec.products.push({ productId:'', name:'', qty:1, pv:null, bv:null,
dp:null, note:'' });
 renderProducts();
 markDirty();
 renderPreview();
}
function renderPreview() {
   try {
       const res = calculate(tempRec);
       const box = document.getElementById('previewBox');
       if(!box) return;
       
       if(!res) { 
           box.innerHTML = '<div class="preview-card"
style="display:flex;align-items:center;justify-content:center;color:#999">è«‹é¸æ“‡å¤¥ä¼´</div>'; 
           return; 
       }
       
       let tag = '<span class="status-badge status-active">ğŸŸ¢ å¯ç™¼æ”¾</span>';
       if(res.isGraduated) tag = '<span class="status-badge
status-active">ğŸ“ ç•¢æ¥­</span>';
       else if(res.isPartnerInactive) tag = '<span class="status-badge
status-inactive">æœªåƒèˆ‡</span>';
       else if(res.isMonthlyInactive) tag = '<span class="status-badge
status-inactive">æœ¬æœˆä¸è¨ˆ</span>';
       else if(!res.isEligible) tag = '<span class="status-badge
status-unpaid">ğŸš« ä¸é©ç”¨</span>';
 
       box.innerHTML = `
           <div class="preview-card">
               <div
style="display:flex;justify-content:space-between;margin-bottom:10px;color:#777"><span>æœ¬æœˆé ä¼°</span>
${tag}</div>
               <div
class="preview-amount"
style="color:${res.starTotal>0?'var(--success)':'#ccc'}">${money(res.starTotal)}</div>
               ${res.isEligible ? `
                   <div
class="preview-row"><span>è¨ˆç®—æ¯”ä¾‹</span><span>${res.appliedRateText}</span></div>
                   <div
class="preview-row"><span>åŸºç¤å›é¥‹</span><span>${money(res.baseBonus)}</span></div>
                  <div
class="preview-row"><span>æ¨è–¦å›é¥‹</span><span>${money(res.recruitBonus)}</span></div>
                   <div
class="preview-row"><span>å­¸ç¿’åŠ ç¢¼</span><span>${money(res.learningBonus)}</span></div>
               ` : `<div
style="text-align:center;color:#ccc;padding:10px">ç„¡çé‡‘ç”¢ç”Ÿ</div>`}
           </div>
       `;
    }
catch(e) { console.error('Preview error', e); }
}
function saveRecord(e, id) {
   e.preventDefault();
   const fd = new FormData(e.target);
   if(!id && store.data.records.some(r=>r.month===tempRec.month
&& r.partnerId===tempRec.partnerId)) return alert('æ­¤å¤¥ä¼´æœ¬æœˆå·²æœ‰ç´€éŒ„');
    
   // Check Partner Create
   const parent = store.getPartner(tempRec.partnerId);
   if(parent) {
       tempRec.newRecruits.forEach(rec => {
           if(!rec.code || !rec.name) return;
           let p = store.data.partners.find(x => x.code === rec.code);
           if(!p) {
               store.data.partners.push({
                   id: uuid(), code: rec.code,
name: rec.name,
                   memberType: rec.memberType
|| 'directSeller',
                   sponsorId: parent.id,
                   initiatorId:
parent.initiatorId || '',
                   status: 'active', joinedAt:
''
               });
           } else {
               if(!p.sponsorId) p.sponsorId =
parent.id;
               if(!p.initiatorId &&
parent.initiatorId) p.initiatorId = parent.initiatorId;
               if(!p.name) p.name = rec.name;
           }
       });
    }
 
   // Capture Base Fields
   const final = { ...tempRec, ...Object.fromEntries(fd) };
    
   // ã€Aã€‘Ensure Numeric & Complete PV/BV Logic
   final.ppv = Number(fd.get('ppv')) || 0;
   final.pbv = Number(fd.get('pbv')) || 0;
   final.gpv = Number(fd.get('gpv')) || 0;
   final.gbv = Number(fd.get('gbv')) || 0;
   if(final.gpv > 0 && final.gbv === 0) final.gbv =
pvToBv(final.gpv);
   if(final.gbv > 0 && final.gpv === 0) final.gpv =
bvToPv(final.gbv);
    
   final.learningDone = fd.get('learningDone')==='on';
   final.legs = tempRec.legs; 
   final.newRecruits = tempRec.newRecruits; 
   final.products = tempRec.products;
    
   if(id) { const i = store.data.records.findIndex(x=>x.id===id);
store.data.records[i] = final; }
   else { final.id = uuid(); store.data.records.push(final); }
   store.save().then(() => { isDirty=false; closeModal();
renderRecords(); }).catch(err => { console.error(err); alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
}
function deleteRecord(id) {
   if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
   store.data.records = store.data.records.filter(r=>r.id!==id);
   store.save().then(() => { isDirty=false; closeModal();
renderRecords(); }).catch(err => { console.error(err); alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
}
 
function renderPayout() {
   const m = localStorage.getItem('pay_m') || new
Date().toISOString().slice(0,7);
   const q = localStorage.getItem('pay_q') || '';
    
   let recs = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
   if(q) recs = recs.filter(r=>r.partnerName.includes(q) ||
(store.getInitiator(r.initiatorId)||{}).name?.includes(q));
    
   const groups = {};
   store.data.initiators.forEach(i => { groups[i.id] = { info: i, list:
[], sum:0, unpaid:0 }; });
   groups['none'] = { info:{name:'æœªæŒ‡å®š', code:'N/A'}, list:[], sum:0, unpaid:0 };
    
   recs.forEach(r => {
       const gid = groups[r.initiatorId] ? r.initiatorId : 'none';
       groups[gid].list.push(r);
       groups[gid].sum += r.totalIncome;
       if(r.payoutStatus!=='paid') groups[gid].unpaid += r.totalIncome;
   });
 
   document.getElementById('app').innerHTML = `
       <header>${header('æœ¬æœˆç™¼æ”¾')}</header>
       <div style="display:flex;gap:10px;margin-bottom:15px">
           <input type="month" value="${m}"
class="form-control" style="width:auto"
onchange="localStorage.setItem('pay_m',this.value);renderPayout()">
           <input placeholder="æœå°‹" value="${q}" class="form-control"
style="width:auto"
oninput="localStorage.setItem('pay_q',this.value);renderPayout()">
           <button class="btn
btn-primary" onclick="bulkPay('${m}')">æ‰¹æ¬¡ç™¼æ”¾</button>
           <button class="btn btn-secondary"
onclick="exportCSV('${m}')">åŒ¯å‡º CSV</button>
       </div>
       ${Object.values(groups).filter(g=>g.list.length>0).map(g => `
           <div class="card">
               <div
style="display:flex;justify-content:space-between;border-bottom:2px solid
var(--accent);padding-bottom:10px;margin-bottom:10px">
                   <h3
style="margin:0">${g.info.name}</h3>
                   <div
style="font-size:0.9rem">æ‡‰ä»˜ï¼š<span style="color:var(--danger)">${money(g.unpaid)}</span>
/ ç¸½è¨ˆï¼š${money(g.sum)}</div>
               </div>
              <table><thead><tr><th
width="30"><input type="checkbox"
onchange="toggleGrp(this,'${g.info.id}')"></th><th>å¤¥ä¼´</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th></tr></thead><tbody>
               ${g.list.map(r => `<tr>
                   <td><input
type="checkbox" class="chk-${g.info.id}"
value="${r.id}"
${r.payoutStatus==='paid'?'disabled':''}></td>
                  <td>${r.partnerName}</td>
                   <td
style="font-weight:bold">${money(r.totalIncome)}</td>
                   <td><button
class="btn ${r.payoutStatus==='paid'?'btn-primary':'btn-outline'}"
style="padding:4px 8px;font-size:0.8rem"
onclick="togglePay('${r.id}','${r.payoutStatus}','${m}')">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</button></td>
               </tr>`).join('')}
               </tbody></table>
           </div>
       `).join('')}
   `;
}
function toggleGrp(el, id) {
document.querySelectorAll('.chk-'+id).forEach(c => { if(!c.disabled)
c.checked = el.checked; }); }
function bulkPay(m) {
   const ids =
Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.value).filter(v=>v
&& v.length>10);
   if(!ids.length) return alert('æœªå‹¾é¸');
   if(!confirm('ç¢ºèªæ¨™è¨˜ç™¼æ”¾ï¼Ÿ')) return;
   const d = getToday(m);
   ids.forEach(id => { const r = store.getRecord(id); if(r) {
r.payoutStatus='paid'; r.payoutDate=d; } });
   store.save().then(() => renderPayout()).catch(err => {
console.error(err); alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
}
function togglePay(id, s, m) {
   const r = store.getRecord(id);
   if(s==='paid') { if(confirm('å–æ¶ˆç™¼æ”¾ï¼Ÿ')) r.payoutStatus='unpaid'; }
   else { r.payoutStatus='paid'; r.payoutDate=getToday(m); }
   store.save().then(() => renderPayout()).catch(err => { console.error(err);
alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
}
 
function exportCSV(m) {
   const mode = getPvViewMode();
   const recs = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
    
   let header = 'æœˆä»½,ç™¼èµ·äºº,å¤¥ä¼´';
   if(mode === 'both') header += ',PV,BV';
   else if(mode === 'pv') header += ',PV';
   else if(mode === 'bv') header += ',BV';
   header += ',é‡‘é¡,å‚™è¨»,ç‹€æ…‹,æ—¥æœŸ';

   // âœ… ä¿®æ­£ 7: CSV æ¬„ä½è™•ç† helper
   const escapeCSV = (str) => {
       if (str == null) return '';
       str = String(str);
       if (str.includes(',') || str.includes('\n') || str.includes('"')) {
           return '"' + str.replace(/"/g, '""') + '"';
       }
       return str;
   };
    
   const rows = recs.map(r => {
       const initName = store.getInitiator(r.initiatorId)?.name||'';
       const basic = `${escapeCSV(r.month)},${escapeCSV(initName)},${escapeCSV(r.partnerName)}`;
       let metric = '';
       if(mode === 'both') metric = `${r.gpv},${r.gbv}`;
       else if(mode === 'pv') metric = `${r.gpv}`;
       else if(mode === 'bv') metric = `${r.gbv}`;
       
       return `${basic},${metric},${r.starTotal},${escapeCSV(r.note||'')},${escapeCSV(r.payoutStatus)},${escapeCSV(r.payoutDate)}`;
   }).join('\n');
 
   const txt = `\uFEFF${header}\n${rows}`;
   const a = document.createElement('a'); a.href = URL.createObjectURL(new
Blob([txt],{type:'text/csv'})); a.download = `Payout_${m}_${mode}.csv`;
a.click();
}
 
function renderInitiators() {
   document.getElementById('app').innerHTML = `
       <header>${header('ç™¼èµ·äººç®¡ç†')} <button class="btn btn-primary"
onclick="editInit()">+ æ–°å¢</button></header>
       <div
class="card"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>æ€§è³ª</th><th>è¼”å°åå–® (æœ€å¤š3ä½)</th><th>æ“ä½œ</th></tr></thead><tbody>
       ${store.data.initiators.map(i => {
           const names = (i.coachedPartnerIds||[]).map(pid => {
               const p =
store.getPartner(pid);
               return p ? `${p.code}
${p.name}` : '?';
           }).join('ã€') || '-';
           return `<tr><td>${i.code}</td><td>${i.name}</td><td>${i.memberType
=== 'member' ? 'ç”Ÿæ´»æœƒå“¡' : 'ç›´éŠ·å•†'}</td><td>${names}</td><td>
               <button class="btn
btn-secondary" style="padding:4px 10px"
onclick="editInit('${i.id}')">ç·¨è¼¯</button>
               <button class="btn
btn-danger" style="padding:4px 10px"
onclick="delInit('${i.id}')">åˆªé™¤</button>
           </td></tr>`;
       }).join('')}
       </tbody></table></div>
   `;
}
function editInit(id) {
   try {
       const i = id ? store.getInitiator(id) : {id:'', code:'', name:'',
memberType:'directSeller', coachedPartnerIds:[]};
       if(!i.memberType) i.memberType = 'directSeller';
       
       const myPartners = store.data.partners.filter(p => p.initiatorId ===
id);
       const coachHTML = myPartners.map(p => {
            const checked =
(i.coachedPartnerIds||[]).includes(p.id) ? 'checked' : '';
           return `<div
style="margin-bottom:5px"><label><input
type="checkbox" class="coach-chk" value="${p.id}"
${checked} onchange="checkLimit(this)"> ${p.code} ${p.name}</label></div>`;
       }).join('') || '<div
style="color:#999;font-size:0.9rem">å°šç„¡ç¶å®šæ­¤ç™¼èµ·äººçš„å¤¥ä¼´</div>';
 
       openModal(id?'ç·¨è¼¯':'æ–°å¢', `
           <form onsubmit="saveInit(event, '${id||''}')">
               <div
class="row"><div class="col"><label>ç·¨è™Ÿ</label><input
name="code" value="${i.code}"
class="form-control" required></div>
               <div
class="col"><label>å§“å</label><input name="name"
value="${i.name}" class="form-control"
required></div></div>
               <div
class="form-group"><label>æœƒå“¡æ€§è³ª *</label>
                   <select
name="memberType" class="form-control" required>
                       <option
value="directSeller"
${i.memberType==='directSeller'?'selected':''}>ç›´éŠ·å•†</option>
                       <option
value="member" ${i.memberType==='member'?'selected':''}>ç”Ÿæ´»æœƒå“¡</option>
                   </select>
               </div>
               <div class="card"
style="margin-top:15px">
                   <h4 style="margin:0
0 10px 0;font-size:1rem">è¼”å°åå–® (æœ€å¤š3ä½)</h4>
                   <div
style="max-height:150px;overflow-y:auto;border:1px solid
#eee;padding:10px;border-radius:4px">${coachHTML}</div>
              </div>
               <button class="btn
btn-primary" style="width:100%;margin-top:15px">å„²å­˜</button>
           </form>
       `);
    }
catch(e) { alert(e.message); }
}
function saveInit(e, id) {
   e.preventDefault(); const fd = new FormData(e.target); const d =
Object.fromEntries(fd);
   if(store.data.initiators.some(x=>x.code===d.code &&
x.id!==id)) return alert('é‡è¤‡');
   const coached =
Array.from(document.querySelectorAll('.coach-chk:checked')).map(c=>c.value);
    
   if(id) { 
       const idx =
store.data.initiators.findIndex(x=>x.id===id); 
       store.data.initiators[idx] = {...store.data.initiators[idx], ...d,
coachedPartnerIds: coached}; 
    }
   else { store.data.initiators.push({...d, id:uuid(), coachedPartnerIds:
coached}); }
   store.save().then(() => { closeModal(); renderInitiators();
}).catch(err => { console.error(err); alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
}
function delInit(id) {
   if(!confirm('åˆªé™¤ï¼Ÿé€™æœƒå°‡å…¶ä¸‹å¤¥ä¼´è®Šç‚ºæœªæŒ‡å®šã€‚')) return;
   store.data.initiators = store.data.initiators.filter(i=>i.id!==id);
   store.data.partners.forEach(p => { if(p.initiatorId===id)
p.initiatorId=''; });
   store.save().then(() => renderInitiators()).catch(err => { console.error(err);
alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
}
 
// 7. ORG CHART - Fix D: PURE TREE + BADGES + PAN/ZOOM
let orgCollapseState =
JSON.parse(localStorage.getItem('org_collapseState') || '{}');
let orgZoom =
parseFloat(localStorage.getItem('org_zoom')) || 1;
 
function enableOrgPanZoom() {
   const container = document.querySelector('.org-container');
   const tree = document.querySelector('.tree');
   if (!container || !tree) return;
 
   if (container._pzAbort) {
       try { container._pzAbort.abort(); } catch(e) {}
    }
    
   const ac = new AbortController();
   const opt = { signal: ac.signal }; 
   container._pzAbort = ac;
 
   tree.style.transform = `scale(${orgZoom})`;
 
   // --- Zoom ---
   container.addEventListener('wheel', (e) => {
       e.preventDefault();
 
       const oldZoom = orgZoom;
       const delta = e.deltaY > 0 ? 0.9 : 1.1;
       
       let newZoom = Math.min(Math.max(oldZoom * delta, 0.5), 2.0);
 
       if (newZoom === oldZoom) return;
 
       const rect = container.getBoundingClientRect();
       const mouseX = e.clientX - rect.left;
       const mouseY = e.clientY - rect.top;
 
       const contentX = (container.scrollLeft + mouseX) / oldZoom;
       const contentY = (container.scrollTop + mouseY) / oldZoom;
 
       orgZoom = newZoom;
       tree.style.transform = `scale(${orgZoom})`;
       localStorage.setItem('org_zoom', orgZoom);
 
       container.scrollLeft = contentX * orgZoom - mouseX;
       container.scrollTop  = contentY *
orgZoom - mouseY;
 
   }, { passive: false, signal: ac.signal });
 
   // --- Pan ---
   let isDown = false;
   let startX = 0, startY = 0;
   let baseLeft = 0, baseTop = 0;
 
   const startDrag = (x, y) => {
       isDown = true;
       container.style.cursor = 'grabbing';
       startX = x;
       startY = y;
       baseLeft = container.scrollLeft;
       baseTop = container.scrollTop;
   };
 
   const moveDrag = (x, y) => {
       if (!isDown) return;
       const dx = (x - startX) * 1.5;
       const dy = (y - startY) * 1.5;
       container.scrollLeft = baseLeft - dx;
       container.scrollTop  = baseTop -
dy;
   };
 
   const stopDrag = () => {
       isDown = false;
       container.style.cursor = 'grab';
   };
 
   container.addEventListener('mousedown', (e) => startDrag(e.pageX,
e.pageY), opt);
    
   container.addEventListener('mousemove', (e) => {
       if (!isDown) return;
       e.preventDefault(); 
       moveDrag(e.pageX, e.pageY);
   }, { passive: false, signal: ac.signal });
 
   container.addEventListener('mouseup', stopDrag, opt);
   container.addEventListener('mouseleave', stopDrag, opt);
 
   container.addEventListener('touchstart', (e) => {
       if (!e.touches || !e.touches[0]) return;
       startDrag(e.touches[0].pageX, e.touches[0].pageY);
   }, { passive: true, signal: ac.signal });
 
   container.addEventListener('touchmove', (e) => {
       if (!isDown) return;
       if (!e.touches || !e.touches[0]) return;
       
       if(e.cancelable) e.preventDefault(); 
       
       moveDrag(e.touches[0].pageX, e.touches[0].pageY);
   }, { passive: false, signal: ac.signal });
 
   container.addEventListener('touchend', stopDrag, opt);
   container.addEventListener('touchcancel', stopDrag, opt);
}
 
function toggleNode(e, nodeId) {
   e.stopPropagation();
   orgCollapseState[nodeId] = !orgCollapseState[nodeId];
   localStorage.setItem('org_collapseState',
JSON.stringify(orgCollapseState));
    
   const li = document.getElementById(`li-${nodeId}`);
   if(li) {
       if(orgCollapseState[nodeId]) {
           li.classList.add('collapsed');
           const caret = li.querySelector('.caret'); if(caret) caret.innerText = 'â–¶';
           const count = li.querySelector('.count'); if(count) count.style.display
= 'block';
       } else {
           li.classList.remove('collapsed');
           const caret = li.querySelector('.caret'); if(caret) caret.innerText = 'â–¼';
           const count = li.querySelector('.count'); if(count) count.style.display
= 'none';
       }
    }
}
 
function renderOrgChart() {
   try {
       const m = localStorage.getItem('org_m') || new
Date().toISOString().slice(0,7);
       const partners = store.data.partners;
       const recs = store.getRecordsByMonth(m).map(calculate);
       const pMap = {};
       partners.forEach(p => { pMap[p.id] = { ...p, children:[], record:
recs.find(r=>r && r.partnerId===p.id) }; });
       const roots = [];
       partners.forEach(p => { if(p.sponsorId && pMap[p.sponsorId]
&& p.sponsorId !== p.id) { pMap[p.sponsorId].children.push(pMap[p.id]);
} else { roots.push(pMap[p.id]); } });
 
       if(!localStorage.getItem('org_inited')) {
           partners.forEach(p => { if(p.sponsorId) orgCollapseState[p.id] =
true; });
           localStorage.setItem('org_collapseState',
JSON.stringify(orgCollapseState));
           localStorage.setItem('org_inited', '1');
       }
 
       function renderNode(node) {
           const r = node.record;
           const hasChildren = node.children && node.children.length >
0;
           const isCollapsed = !!orgCollapseState[node.id];
           
           let toggleHtml = hasChildren 
               ? `<div
class="node-toggle" onclick="toggleNode(event,
'${node.id}')"><div class="caret">${isCollapsed?'â–¶':'â–¼'}</div><div
class="count" style="${isCollapsed?'':'display:none'}">(+${node.children.length})</div></div>`
               : `<div
class="node-toggle"
style="cursor:default;opacity:0"></div>`;
 
           let badgeBg = '#eee', badgeColor = '#aaa', badgeText = 'ç„¡ç´€éŒ„';
           let activeClass = 'node-inactive'; 
           if (node.status === 'active') activeClass = 'node-active';
 
           if (node.status === 'inactive') { badgeBg = '#95a5a6'; badgeColor =
'white'; badgeText = 'æœªåƒèˆ‡'; }
           else if (r) {
               badgeColor = 'white';
              if (r.isGraduated) {
badgeBg = '#16a085'; badgeText = 'ğŸ“ ç•¢æ¥­'; }
               else if (r.payoutStatus ===
'paid') { badgeBg = '#27ae60'; badgeText = 'âœ… å·²ç™¼æ”¾'; }
               else if (r.totalIncome > 0)
{ badgeBg = '#e74c3c'; badgeText = 'ğŸ”´ æœªç™¼æ”¾'; }
               else { badgeBg = '#bdc3c7';
badgeText = 'ç„¡çé‡‘'; }
           }
           const badgeHtml = `<div class="node-status"
style="background:${badgeBg};color:${badgeColor}">${badgeText}</div>`;
           
           let pvDisplay = '<div style="color:#ccc">â€”</div>';
           if (r) {
               const txt = formatPvBv(r.gpv,
r.gbv);
               pvDisplay = `<div
style="font-weight:bold;color:${r.totalIncome>0?'#27ae60':'#999'}">${txt}</div><div
style="font-size:0.85em;color:#7f8c8d">${money(r.totalIncome)}</div>`;
           }
 
           return `<li id="li-${node.id}" class="${isCollapsed
&& hasChildren ? 'collapsed' : ''}"><div class="node
${activeClass}">${toggleHtml}<div class="node-content"
onclick="showNode('${node.id}','${m}')">${badgeHtml}<div
class="name">${node.code} ${node.name}</div><div
class="type">${node.memberType === 'member' ? 'ç”Ÿæ´»æœƒå“¡' : 'ç›´éŠ·å•†'}</div><div
class="detail">${pvDisplay}</div></div></div><ul>${node.children.map(renderNode).join('')}</ul></li>`;
       }
 
       document.getElementById('app').innerHTML = `
           <header>${header('çµ„ç¹”é—œè¯åœ–')}</header>
           <div class="card"
style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
               <input
type="month" value="${m}" class="form-control"
style="width:auto;margin:0"
onchange="localStorage.setItem('org_m',this.value);renderOrgChart()">
              ${getPvViewSelect('renderOrgChart')}
               <div
style="font-size:0.8rem;color:#777;margin-left:auto">æ»¾è¼ªç¸®æ”¾ / æ‹–æ›³å¹³ç§» / é»æ“Š â–¶ å±•é–‹</div>
           </div>
           <div class="org-container"><div
class="tree"><ul>${roots.map(renderNode).join('')}</ul></div></div>
       `;
       enableOrgPanZoom();
    }
catch(e) { console.error(e); alert('çµ„ç¹”åœ–æ¸²æŸ“éŒ¯èª¤: ' + e.message); }
}
 
function showNode(partnerId, m) {
   const r = (store.data.records || []).find(x => x.partnerId === partnerId
&& x.month === m);
   if (r) { editRecord(r.id); } 
   else if (confirm('ç„¡æœ¬æœˆç´€éŒ„ï¼Œè¦å»ºç«‹å—ï¼Ÿ')) {
       editRecord(null, m);
       tempRec.partnerId = partnerId;
       setTimeout(() => {
           const sel = document.querySelector('[name=partnerId]');
           if (sel) { sel.value = partnerId; tempRec.partnerId = partnerId;
renderPreview(); markDirty(); }
       }, 50);
    }
}
 
function renderVersions() {
   document.getElementById('app').innerHTML = `
       <header>${header('ç‰ˆæœ¬æ§ç®¡')} <button class="btn btn-primary"
onclick="editVer()">+ æ–°å¢</button></header>
       <div
class="card"><table><thead><tr><th>åç¨±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>
       ${store.data.versions.map(v =>
`<tr><td>${v.name}</td><td>${v.archived?'å°å­˜':'ä½¿ç”¨ä¸­'}</td><td>
           <button class="btn btn-secondary" style="padding:4px
10px" onclick="editVer('${v.id}')">æŸ¥çœ‹</button>
           ${!v.archived ? `<button class="btn btn-danger"
style="padding:4px 10px" onclick="delVer('${v.id}')">åˆªé™¤</button>`:''}
       </td></tr>`).join('')}
       </tbody></table></div>
   `;
}
function editVer(id) {
   const v = id ? store.getVersion(id) : {id:'', name:'New', params:{...defaultParams}};
   const p = v.params;
   openModal(id?'ç‰ˆæœ¬':'æ–°å¢', `
       <form onsubmit="saveVer(event,'${id||''}')">
           <div class="form-group"><label>åç¨±</label><input
name="name" value="${v.name}"
class="form-control" required
${v.archived?'disabled':''}></div>
           <div class="row"><div
class="col"><label>0-3% åŸºç¤</label><input
type="number" step="0.01" name="rate_0_3_base"
value="${p.rate_0_3_base}" class="form-control"
${v.archived?'disabled':''}></div>
           <div class="col"><label>0-3% æ¨è–¦</label><input
type="number" step="0.01" name="rate_0_3_rec"
value="${p.rate_0_3_rec}" class="form-control" ${v.archived?'disabled':''}></div></div>
           <div class="row"><div
class="col"><label>6% åŸºç¤</label><input type="number"
step="0.01" name="rate_6_base"
value="${p.rate_6_base}" class="form-control"
${v.archived?'disabled':''}></div>
           <div class="col"><label>6% æ¨è–¦</label><input
type="number" step="0.01" name="rate_6_rec"
value="${p.rate_6_rec}" class="form-control"
${v.archived?'disabled':''}></div></div>
           <div class="row"><div
class="col"><label>æ–°äººå›é¥‹</label><input type="number" step="0.01"
name="rate_recruit_bv" value="${p.rate_recruit_bv}"
class="form-control" ${v.archived?'disabled':''}></div>
           <div class="col"><label>å­¸ç¿’åŠ ç¢¼</label><input
type="number" step="0.01" name="rate_learning"
value="${p.rate_learning}" class="form-control"
${v.archived?'disabled':''}></div></div>
           ${!v.archived ? '<button class="btn btn-primary"
style="width:100%;margin-top:15px">å„²å­˜</button>' : ''}
       </form>
   `);
}
function saveVer(e, id) {
   e.preventDefault(); const fd=new FormData(e.target);
   const p = { rate_0_3_base:Number(fd.get('rate_0_3_base')),
rate_0_3_rec:Number(fd.get('rate_0_3_rec')),
rate_6_base:Number(fd.get('rate_6_base')),
rate_6_rec:Number(fd.get('rate_6_rec')), rate_recruit_bv:Number(fd.get('rate_recruit_bv')),
rate_learning:Number(fd.get('rate_learning')) };
   if(id){ const idx=store.data.versions.findIndex(x=>x.id===id);
store.data.versions[idx] = {...store.data.versions[idx], name:fd.get('name'),
params:p}; }
    else
{ store.data.versions.unshift({id:uuid(), name:fd.get('name'), createdAt:new
Date().toISOString(), params:p}); }
   store.save().then(() => { closeModal(); renderVersions();
}).catch(err => { console.error(err); alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
}
function delVer(id) {
   if(!confirm('åˆªé™¤ï¼Ÿ')) return;
   if(store.data.records.some(r=>r.planVersionId===id)) {
       if(confirm('æ­¤ç‰ˆæœ¬å·²è¢«ä½¿ç”¨ï¼Œæ˜¯å¦æ”¹ç‚ºå°å­˜ï¼Ÿ')) { store.getVersion(id).archived=true; store.save().then(() =>
renderVersions()).catch(err => { console.error(err); alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); }); }
    }
else {
       store.data.versions = store.data.versions.filter(v=>v.id!==id); 
       store.save().then(() => renderVersions()).catch(err => {
console.error(err); alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯'); });
    }
}
 
function renderSettings() {
   document.getElementById('app').innerHTML = `
       <header>${header('ç³»çµ±è¨­å®š')}</header>
       <div class="card">
           <h3>ğŸ“¦ è³‡æ–™å‚™ä»½</h3>
           <button class="btn btn-primary"
onclick="dlBackup()">â¬‡ï¸ ä¸‹è¼‰å‚™ä»½ (JSON)</button>
           <button class="btn
btn-secondary"
onclick="document.getElementById('upFile').click()">â¬†ï¸ åŒ¯å…¥é‚„åŸ</button>
           <input type="file" id="upFile"
style="display:none" onchange="ulBackup(this)">
       </div>
       <div class="card">
           <h3>âš ï¸ å±éšªæ“ä½œ</h3>
           <button class="btn btn-danger"
onclick="resetAll()">ğŸ”¥ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
       </div>
   `;
}
function dlBackup() {
   const a = document.createElement('a'); a.href = URL.createObjectURL(new
Blob([JSON.stringify(store.data,null,2)],{type:'application/json'}));
a.download = `NewStar_${new Date().toISOString().slice(0,10)}.json`; a.click();
}
function ulBackup(el) {
    const
f=el.files[0]; if(!f)return;
   const r=new FileReader(); r.onload=e=>{
       try{ const d=JSON.parse(e.target.result); if(d.partners &&
confirm('ç¢ºå®šè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Ÿ')){ store.data=d; store.save().then(()=>location.reload()); } }
catch(err){alert('æ ¼å¼éŒ¯èª¤');}
   }; r.readAsText(f);
}
function resetAll() { if(prompt('è¼¸å…¥ DELETE ç¢ºèªæ¸…é™¤')==='DELETE') {
db.ref('AmwaySystem/v1').remove().then(() => location.reload()); } }
function pickCatalogProduct(i, pid){
   const catalog = store.data.productCatalog || {};
   const prod = catalog[pid];
   if(!prod) return;
 
   // âœ…ã€é˜²é‡è¤‡ã€‘å¦‚æœå…¶ä»–åˆ—å·²ç¶“é¸éåŒä¸€å€‹ productIdï¼Œå°±æŠŠæ•¸é‡+1ï¼Œä¸¦åˆªæ‰ç›®å‰é€™åˆ—
   const existIndex = (tempRec.products || []).findIndex((x, idx) => idx
!== i && x.productId === pid);
   if (existIndex !== -1) {
       const oldQty = Number(tempRec.products[existIndex].qty) || 1;
       tempRec.products[existIndex].qty = oldQty + 1;
 
       // åˆªæ‰ç›®å‰é€™åˆ—ï¼ˆé¿å…é‡è¤‡ï¼‰
       tempRec.products.splice(i, 1);
 
       markDirty();
       renderProducts();
       renderPreview();
       return;
    }
 
   // âœ… ä¿®æ­£ 6: åˆªé™¤ç„¡ä½œç”¨çš„ JS èªå¥ï¼Œä¿æŒç¨‹å¼ä¹¾æ·¨
   if(!tempRec.products[i]) tempRec.products[i] = { qty: 1 };
   tempRec.products[i].productId = pid;
   tempRec.products[i].name = prod.name;
   tempRec.products[i].pv = prod.pv;
   tempRec.products[i].bv = prod.bv;
   tempRec.products[i].dp = prod.dp;
 
   // æ²’å¡«æ•¸é‡å°±è£œ 1
   if(!tempRec.products[i].qty) tempRec.products[i].qty = 1;
 
   markDirty();
   renderProducts();
   renderPreview();
}
function openAddCatalogModal(){
 const catalog = store.data.productCatalog || {};
 
  // âœ… æƒææ‰€æœ‰ç”¢å“ç·¨è™Ÿï¼Œæ‰¾å‡ºæœ€å¤§çš„æµæ°´è™Ÿï¼ˆé¿å… uuid key é€ æˆè·³è™Ÿï¼‰
  let
maxNo = 0;
 Object.values(catalog).forEach(v => {
   const pid = (v?.id || '').trim();     // ä¾‹å¦‚ P0007
   const m = pid.match(/^P(\d+)$/i);     // æŠ“æ•¸å­—éƒ¨åˆ†
   if(m) maxNo = Math.max(maxNo, parseInt(m[1], 10));
  });
 
 const nextId = `P${String(maxNo + 1).padStart(4,'0')}`;
 
 openCatalogModal('æ–°å¢ç”¢å“åˆ°è³‡æ–™åº«', `
   <form onsubmit="saveCatalogProduct(event)">
     <div class="row">
       <div class="col">
         <label>ç”¢å“ç·¨è™Ÿ *</label>
         <input name="pid" class="form-control" required
value="${nextId}">
         <small style="color:#999">å»ºè­°æ ¼å¼ï¼šP0001ã€P0002...</small>
       </div>
       <div class="col">
         <label>ç”¢å“åç¨± *</label>
         <input name="name" class="form-control" required
placeholder="ä¾‹å¦‚ï¼šå®‰éº—ç‰™è†">
       </div>
     </div>
 
     <div class="row">
       <div class="col">
         <label>PV *</label>
         <input name="pv" type="number" step="0.01"
class="form-control" required>
       </div>
       <div class="col">
         <label>BV *</label>
         <input name="bv" type="number"
class="form-control" required>
       </div>
       <div class="col">
         <label>DP</label>
         <input name="dp" type="number"
class="form-control">
       </div>
     </div>
 
     <div style="display:flex;gap:10px;margin-top:15px">
       <button type="button" class="btn btn-secondary"
onclick="closeCatalogModal()">å–æ¶ˆ</button>
       <button class="btn btn-primary">å„²å­˜åˆ°è³‡æ–™åº«</button>
     </div>
   </form>
  `);
}
   
function saveCatalogProduct(e){
 e.preventDefault();
 const fd = new FormData(e.target);
 const pid = (fd.get('pid')||'').trim();
 const name = (fd.get('name')||'').trim();
 
 if(!pid || !name) return alert('è«‹å¡«å¯«ç·¨è™Ÿèˆ‡åç¨±');
 
  // é˜²å‘†ï¼šé¿å…é‡è¤‡ID
 const catalog = store.data.productCatalog || {};
 const exist = Object.entries(catalog).find(([k,v]) => (v?.id||k) ===
pid);
 if(exist) return alert('âŒ æ­¤ç”¢å“ç·¨è™Ÿå·²å­˜åœ¨ï¼Œè«‹æ›ä¸€å€‹');
 
 const key = uuid(); // ç”¨ uuid ç•¶ catalog keyï¼Œé¿å…è¢« P0001 ä¹‹é¡è¦†è“‹
 catalog[key] = {
   id: pid,
   name,
   pv: Number(fd.get('pv')) || 0,
   bv: Number(fd.get('bv')) || 0,
   dp: fd.get('dp')==='' ? null : (Number(fd.get('dp'))||0)
  };
 
 store.data.productCatalog = catalog;
 
 store.save().then(()=>{
   alert('âœ… å·²åŠ å…¥ç”¢å“è³‡æ–™åº«');
   closeCatalogModal();
   // é‡æ–° renderProducts è®“ä¸‹æ‹‰ç«‹å³å‡ºç¾
   renderProducts();
 }).catch(err=>{
   console.error(err);
   alert('âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
  });
}
 
function closeModalSafe() { if(isDirty
&& !confirm('æœ‰æœªå„²å­˜è®Šæ›´ï¼Œç¢ºå®šé›¢é–‹ï¼Ÿ')) return; closeModal(); }
function closeModal() {
document.getElementById('modal').style.display = 'none'; }
</script>
</body>
</html>
