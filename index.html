<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ± (v5.0 UIé‡æ§‹ç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #1abc9c;
            --accent-hover: #16a085;
            --danger: #e74c3c;
            --success: #27ae60;
            --bg: #f8f9fa;
            --border: #e0e0e0;
            --sidebar-width: 260px;
            --header-height: 60px;
            /* iOS 100vh fix */
            --vh: 1vh; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; }
        
        body { 
            margin: 0; 
            background-color: var(--bg); 
            color: #333; 
            overflow: hidden; /* Prevent body scroll by default, handle in main */
            height: 100vh; 
            height: calc(var(--vh, 1vh) * 100);
            display: flex;
        }

        /* --- Sidebar (Desktop Fixed / Mobile Drawer) --- */
        aside {
            width: var(--sidebar-width);
            background: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 1000;
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        aside h2 {
            padding: 0 20px;
            margin: 0;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            height: var(--header-height);
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        /* Sidebar Navigation (Accordion) */
        .sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px 0;
        }

        .nav-group-title {
            padding: 12px 20px;
            color: #bdc3c7;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: color 0.2s;
            user-select: none;
        }
        .nav-group-title:hover { color: white; }
        .nav-group-title::after {
            content: 'â€º';
            font-size: 1.2em;
            transition: transform 0.3s;
            transform: rotate(90deg); /* Default Expanded */
        }
        .nav-group.collapsed .nav-group-title::after {
            transform: rotate(0deg);
        }

        .nav-items {
            max-height: 500px; /* For transition */
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0,0,0,0.1);
        }
        .nav-group.collapsed .nav-items {
            max-height: 0;
        }

        .nav-item {
            display: block;
            padding: 10px 20px 10px 35px; /* Indent */
            color: #bdc3c7;
            text-decoration: none;
            font-size: 0.95rem;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active {
            color: white;
            background: rgba(255,255,255,0.1);
            border-left-color: var(--accent);
        }

        aside .footer {
            padding: 15px;
            font-size: 0.75rem;
            color: #95a5a6;
            text-align: center;
            border-top: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
        }

        /* --- Main Content --- */
        main {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOS Smooth Scroll */
            padding: 20px;
            position: relative;
            background-color: var(--bg);
        }

        /* Header in Main */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .menu-btn {
            display: none; /* Hidden on Desktop */
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
            padding: 5px;
            margin-right: 10px;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
        }

        /* --- Mobile / Tablet Styles (< 1024px) --- */
        @media (max-width: 1023px) {
            .menu-btn { display: block; } /* Show Hamburger */

            aside {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                transform: translateX(-100%); /* Hide by default */
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }

            aside.open {
                transform: translateX(0);
            }

            /* Overlay */
            #drawer-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s;
                backdrop-filter: blur(2px);
            }
            #drawer-overlay.visible {
                opacity: 1;
                visibility: visible;
            }
        }

        /* --- General UI Components (from v4.3) --- */
        .card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; color: white; user-select: none; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); }
        .btn-danger { background: var(--danger); }
        .btn-secondary { background: #95a5a6; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 5px; font-size: 1rem; }
        .row { display: flex; gap: 15px; flex-wrap: wrap; } .col { flex: 1; min-width: 150px; }
        
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; white-space: nowrap; }
        .status-active { background: #e8f8f5; color: var(--success); }
        .status-inactive { background: #f2f3f4; color: #95a5a6; }
        .status-paid { background: #d4efdf; color: var(--success); }
        .status-unpaid { background: #fce4ec; color: var(--danger); }

        .summary-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .summary-card { flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 5px solid transparent; }
        .summary-card.green { border-left-color: var(--success); }
        .summary-card.red { border-left-color: var(--danger); }
        .summary-val { font-size: 2rem; font-weight: 800; margin: 10px 0; color: #2c3e50; }
        .summary-label { color: #7f8c8d; font-weight: 600; font-size: 0.9rem; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #555; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 5vh auto; width: 95%; max-width: 1100px; border-radius: 12px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; background: #f9f9f9; -webkit-overflow-scrolling: touch; }
        
        .record-modal-grid { display: flex; gap: 20px; flex-direction: column-reverse; }
        @media (min-width: 769px) {
            .record-modal-grid { flex-direction: row; align-items: flex-start; }
            .record-form-col { flex: 1.5; }
            .record-preview-col { flex: 1; min-width: 280px; position: sticky; top: 0; }
        }
        
        .preview-card { background: white; padding: 20px; border-radius: 10px; border-top: 4px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.08); min-height: 150px; }
        .preview-amount { font-size: 2.2rem; font-weight: 800; color: var(--success); text-align: right; border-bottom: 1px solid #eee; margin-bottom: 15px; line-height: 1.2; }
        .preview-row { display: flex; justify-content: space-between; margin-bottom: 8px; color: #555; font-size: 0.9rem; }
        .modal-actions-bar { position: sticky; bottom: 0; background: white; padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; z-index: 50; }
        .modal-actions-bar button { flex: 1; padding: 12px; }

        /* Org Chart */
        .org-container { overflow: auto; padding: 40px; height: 650px; background: white; border-radius: 8px; box-shadow: inset 0 0 20px rgba(0,0,0,0.02); text-align: center; cursor: grab; -webkit-overflow-scrolling: touch; }
        .tree ul { padding-top: 20px; position: relative; transition: .5s; display: inline-flex; justify-content: center; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; transition: .5s; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #ccc; width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 1px solid #ccc; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 1px solid #ccc; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #ccc; width: 0; height: 20px; }
        .node { border: 2px solid #ccc; padding: 8px 12px; text-decoration: none; color: #333; font-size: 13px; display: inline-block; border-radius: 8px; transition: .3s; min-width: 130px; position: relative; background: white; z-index: 2; }
        .node.in-scope { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.3); background: #e8f8f5; }
        .node.out-scope { border-color: #ddd; background: #f9f9f9; color: #aaa; opacity: 0.8; border-style: dashed; }
        .node.breakaway { border-color: #8e44ad; background: #f4ecf7; color: #8e44ad; }
        .node-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); padding: 2px 6px; border-radius: 4px; font-size: 10px; color: white; background: #95a5a6; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .node.in-scope .node-badge { background: var(--accent); }
        .node.breakaway .node-badge { background: #8e44ad; }

        #loading { position: fixed; inset: 0; background: #f4f7f6; display: flex; justify-content: center; align-items: center; z-index: 3000; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading"><div class="spinner"></div><div>è¼‰å…¥ä¸­...</div></div>

<div id="drawer-overlay" onclick="closeDrawer()"></div>

<aside id="sidebar">
    <h2>ğŸš€ æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«</h2>
    <div class="sidebar-scroll" id="sidebar-scroll-area">
        <div class="nav-group" id="group-overview">
            <div class="nav-group-title" onclick="toggleGroup('group-overview')">ğŸ“Š ç‡Ÿé‹ç¸½è¦½</div>
            <div class="nav-items">
                <a onclick="router('dashboard')" id="nav-dashboard" class="nav-item">ç¸½è¦½å„€è¡¨æ¿</a>
                <a onclick="router('payout')" id="nav-payout" class="nav-item">æœ¬æœˆç™¼æ”¾ç¸½è¡¨</a>
            </div>
        </div>
        <div class="nav-group" id="group-records">
            <div class="nav-group-title" onclick="toggleGroup('group-records')">ğŸ“ æ¥­ç¸¾èˆ‡ç´€éŒ„</div>
            <div class="nav-items">
                <a onclick="router('records')" id="nav-records" class="nav-item">æœˆä»½æ¥­ç¸¾ç´€éŒ„</a>
            </div>
        </div>
        <div class="nav-group" id="group-partners">
            <div class="nav-group-title" onclick="toggleGroup('group-partners')">ğŸ‘¥ äººå“¡ç®¡ç†</div>
            <div class="nav-items">
                <a onclick="router('partners')" id="nav-partners" class="nav-item">å¤¥ä¼´åå–®ç®¡ç†</a>
                <a onclick="router('initiators')" id="nav-initiators" class="nav-item">ç™¼èµ·äººç®¡ç†</a>
            </div>
        </div>
        <div class="nav-group" id="group-org">
            <div class="nav-group-title" onclick="toggleGroup('group-org')">ğŸŒ³ çµ„ç¹”çµæ§‹</div>
            <div class="nav-items">
                <a onclick="router('org')" id="nav-org" class="nav-item">çµ„ç¹”é—œè¯åœ–</a>
            </div>
        </div>
        <div class="nav-group" id="group-settings">
            <div class="nav-group-title" onclick="toggleGroup('group-settings')">âš™ï¸ ç³»çµ±è¨­å®š</div>
            <div class="nav-items">
                <a onclick="router('versions')" id="nav-versions" class="nav-item">è¨ˆç•«ç‰ˆæœ¬æ§ç®¡</a>
                <a onclick="router('settings')" id="nav-settings" class="nav-item">ç³»çµ±è¨­å®š</a>
            </div>
        </div>
    </div>
    <div class="footer">v5.0 UIé‡æ§‹ç‰ˆ</div>
</aside>

<main id="app"></main>

<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="modal-title"></h2><span class="close" onclick="closeModalSafe()">&times;</span></div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<script>
// --- GLOBAL ERROR HANDLER ---
window.onerror = function(msg, url, line, col, error) {
    alert(`âš ï¸ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼š\n${msg}\n(è¡Œæ•¸: ${line})`);
    console.error(error);
    document.getElementById('loading').style.display = 'none';
};

// --- IOS SAFARI FIXES & UI LOGIC ---
// 1. VH Fix
function setVh() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
window.addEventListener('resize', setVh);
window.addEventListener('orientationchange', setVh);
setVh();

// 2. Drawer Logic
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('drawer-overlay');
let bodyScrollY = 0;

function openDrawer() {
    sidebar.classList.add('open');
    overlay.classList.add('visible');
    // Lock Body
    bodyScrollY = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${bodyScrollY}px`;
    document.body.style.width = '100%';
}

function closeDrawer() {
    sidebar.classList.remove('open');
    overlay.classList.remove('visible');
    // Unlock Body
    document.body.style.position = '';
    document.body.style.top = '';
    window.scrollTo(0, bodyScrollY);
}

// Legacy function mapping for existing render strings
function toggleSidebar() { openDrawer(); }

// 3. Accordion Logic
function toggleGroup(groupId) {
    const group = document.getElementById(groupId);
    group.classList.toggle('collapsed');
}

// 4. Swipe to Close Logic (Mobile)
let touchStartX = 0;
let touchStartY = 0;
const sidebarEl = document.getElementById('sidebar');

sidebarEl.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
}, {passive: true});

sidebarEl.addEventListener('touchend', e => {
    const touchEndX = e.changedTouches[0].screenX;
    const touchEndY = e.changedTouches[0].screenY;
    
    // Check if Swipe Left (Close)
    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;
    
    // Condition: Moved left > 50px AND vertical move is small
    if (deltaX < -50 && Math.abs(deltaY) < 50) {
        closeDrawer();
    }
}, {passive: true});


// --- FIREBASE CONFIG (UNCHANGED) ---
const firebaseConfig = {
    apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
    authDomain: "newstar-system.firebaseapp.com",
    projectId: "newstar-system",
    storageBucket: "newstar-system.firebasestorage.app",
    messagingSenderId: "889699172174",
    appId: "1:889699172174:web:0ff42757035a879cb3281f",
    databaseURL: "https://newstar-system-default-rtdb.asia-southeast1.firebasedatabase.app"
};

let isReady = false;
let db = null;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    isReady = true;
} catch (e) { document.getElementById('loading').innerHTML = '<h3 style="color:red">âš ï¸ Firebase é€£ç·šéŒ¯èª¤</h3>'; }

// --- UTILS (UNCHANGED) ---
function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random()*16|0, v = c=='x'?r:(r&0x3|0x8); return v.toString(16); }); }
function money(n) { return new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', minimumFractionDigits:0}).format(n||0); }
function getPercent(pv) { return pv>=10000?0.21:pv>=7000?0.18:pv>=4000?0.15:pv>=2000?0.12:pv>=1000?0.09:pv>=600?0.06:pv>=200?0.03:0; }
function getToday(m) { const d=new Date(); return (d.toISOString().slice(0,7)===m && d.getDate()<18) ? m+'-18' : d.toISOString().slice(0,10); }
function header(t) { return `<h1><button class="menu-btn" onclick="openDrawer()">â˜°</button> ${t}</h1>`; }
function openModal(title, content) {
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-body').innerHTML = content;
    document.getElementById('modal').style.display = 'block';
}
window.checkLimit = function(el) {
    if(document.querySelectorAll('.coach-chk:checked').length > 3) {
        alert('âŒ æœ€å¤šåªèƒ½é¸æ“‡ 3 ä½');
        el.checked = false;
    }
}

// --- DATA STORE (UNCHANGED) ---
const defaultParams = { rate_0_3_base: 0.03, rate_0_3_rec: 0.04, rate_6_base: 0.01, rate_6_rec: 0.02, rate_recruit_bv: 0.01, rate_learning: 0.03 };
let appData = { partners: [], initiators: [], records: [], versions: [] };
const store = {
    data: appData,
    init() {
        if(!isReady) return;
        setTimeout(() => {
            const l = document.getElementById('loading');
            if (l && l.style.display !== 'none') l.style.display = 'none';
        }, 8000);

        db.ref('AmwaySystem/v1').on('value', snap => {
            const val = snap.val();
            if(val) {
                this.data = val;
                ['partners','initiators','records','versions'].forEach(k => { if(!this.data[k]) this.data[k] = []; });
                (this.data.initiators || []).forEach(i => { if (!Array.isArray(i.coachedPartnerIds)) i.coachedPartnerIds = []; });
            } else {
                this.data.versions.push({id: uuid(), name:'é è¨­ç‰ˆæœ¬', params:{...defaultParams}});
                this.save();
            }
            document.getElementById('loading').style.display = 'none';
            const active = document.querySelector('.nav-item.active');
            router(active ? active.id.replace('nav-','') : 'dashboard');
        }, err => {
            console.error(err);
            document.getElementById('loading').style.display = 'none';
            alert('âš ï¸ è®€å–å¤±æ•—ï¼š' + err.message);
            router('dashboard');
        });
    },
    save() { if(isReady) db.ref('AmwaySystem/v1').set(this.data); },
    getPartner(id) { return (this.data.partners||[]).find(p=>p.id===id); },
    getInitiator(id) { return (this.data.initiators||[]).find(i=>i.id===id); },
    getRecord(id) { return (this.data.records||[]).find(r=>r.id===id); },
    getRecordsByMonth(m) { return (this.data.records||[]).filter(r=>r.month===m); },
    getVersion(id) { return (this.data.versions||[]).find(v=>v.id===id) || this.data.versions[0]; }
};
store.init();

// --- CALCULATION (UNCHANGED v4.1 Logic) ---
function calculate(r) {
    const p = store.getPartner(r.partnerId);
    if(!p) return null;
    
    const v = store.getVersion(r.planVersionId);
    const params = v ? v.params : defaultParams;
    const gpv = Number(r.gpv) || 0;
    const rate = getPercent(gpv);
    
    let res = { 
        ...r, 
        partnerName: p.code+' '+p.name, 
        initiatorId: p.initiatorId, 
        myRate: rate, 
        starTotal: 0, 
        totalIncome: 0, 
        isEligible: false, 
        isGraduated: rate >= 0.09, 
        isPartnerInactive: p.status==='inactive', 
        isMonthlyInactive: r.participation==='inactive' 
    };
    
    if(!res.isGraduated && !res.isPartnerInactive && !res.isMonthlyInactive) {
        let applied = 0, txt = '';
        const hasRec = (r.newRecruits||[]).length > 0;
        
        if(rate === 0 || rate === 0.03) { applied = hasRec ? params.rate_0_3_rec : params.rate_0_3_base; txt = '0-3%'; }
        else if(rate === 0.06) { applied = hasRec ? params.rate_6_rec : params.rate_6_base; txt = '6%'; }
        
        if(applied > 0) {
            res.isEligible = true;
            res.appliedRateText = txt + (hasRec?' (å«æ¨è–¦)':' (åŸºç¤)');
            const indepBV = (r.legs||[]).filter(l=>l.isIndependent).reduce((s,l)=>s+(Number(l.bv)||0),0);
            res.baseBonus = Math.max(0, (gpv*50)-indepBV) * applied;
            res.recruitBonus = (r.newRecruits||[]).reduce((s,n)=>s+(Number(n.bv)||0),0) * params.rate_recruit_bv;
            res.learningBonus = r.learningDone ? (res.baseBonus + res.recruitBonus) * params.rate_learning : 0;
            res.starTotal = res.baseBonus + res.recruitBonus + res.learningBonus;
            res.totalIncome = res.starTotal;
        }
    }
    return res;
}

// --- ROUTER (UPDATED for UI) ---
function router(pg) {
    try {
        // UI Reset
        document.querySelectorAll('.nav-item').forEach(a=>a.classList.remove('active'));
        
        const nav = document.getElementById('nav-'+pg);
        if(nav) {
            nav.classList.add('active');
            // Auto expand parent group
            const group = nav.closest('.nav-group');
            if(group) group.classList.remove('collapsed');
        }
        
        // Mobile Auto Close
        if(window.innerWidth < 1024) closeDrawer();

        document.getElementById('app').innerHTML = '';
        
        // Route Logic (UNCHANGED)
        if(pg==='dashboard') renderDashboard();
        else if(pg==='records') renderRecords();
        else if(pg==='payout') renderPayout();
        else if(pg==='partners') renderPartners();
        else if(pg==='initiators') renderInitiators();
        else if(pg==='org') renderOrgChart();
        else if(pg==='versions') renderVersions();
        else if(pg==='settings') renderSettings();
    } catch(e) { console.error(e); alert('é é¢è¼‰å…¥éŒ¯èª¤ï¼š' + e.message); }
}

// --- RENDER FUNCTIONS (UNCHANGED LOGIC) ---

function renderDashboard() {
    const m = new Date().toISOString().slice(0,7);
    const recs = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
    const total = recs.reduce((s,r)=>s+r.starTotal,0);
    const unpaid = recs.filter(r=>r.payoutStatus!=='paid' && r.totalIncome>0).length;
    document.getElementById('app').innerHTML = `
        <header>${header(`ç¸½è¦½ (${m})`)}</header>
        <div class="summary-row">
            <div class="summary-card green"><div class="summary-label">æœ¬æœˆé ä¼°</div><div class="summary-val">${money(total)}</div><div style="font-size:0.8rem;color:#aaa">æ–°æ˜Ÿåœ˜éšŠå›é¥‹åˆè¨ˆ</div></div>
            <div class="summary-card red"><div class="summary-label">å¾…ç™¼æ”¾</div><div class="summary-val">${unpaid} äºº</div><div style="font-size:0.8rem;color:#aaa">å°šæœ‰é‡‘é¡æœªçµæ¸…</div></div>
        </div>
    `;
}

function renderPartners() {
    const term = localStorage.getItem('p_search') || '';
    const list = store.data.partners.filter(p => p.code.includes(term)||p.name.includes(term));
    document.getElementById('app').innerHTML = `
        <header>${header('ä¼™ä¼´åå–®')} <button class="btn btn-primary" onclick="editPartner()">+ æ–°å¢</button></header>
        <input class="form-control" style="max-width:300px;margin-bottom:15px" placeholder="ğŸ” æœå°‹ ç·¨è™Ÿ/å§“å" value="${term}" oninput="localStorage.setItem('p_search',this.value);renderPartners()">
        <div class="card"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>æ¨è–¦äºº</th><th>ç™¼èµ·äºº</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>
        ${list.map(p => `<tr>
            <td>${p.code}</td><td>${p.name}</td>
            <td>${store.getPartner(p.sponsorId)?.name||'-'}</td>
            <td>${store.getInitiator(p.initiatorId)?.name||'<span style="color:red">æœªè¨­å®š</span>'}</td>
            <td><span class="status-badge ${p.status==='active'?'status-active':'status-inactive'}">${p.status==='active'?'å•Ÿç”¨':'åœç”¨'}</span></td>
            <td>
                <button class="btn btn-secondary" style="padding:4px 10px;font-size:0.8rem" onclick="editPartner('${p.id}')">ç·¨è¼¯</button>
                <button class="btn btn-danger" style="padding:4px 10px;font-size:0.8rem" onclick="deletePartner('${p.id}')">åˆªé™¤</button>
            </td>
        </tr>`).join('')}
        </tbody></table></div>
    `;
}
function editPartner(id) {
    try {
        const p = id ? store.getPartner(id) : {id:'', code:'', name:'', sponsorId:'', initiatorId:'', status:'active'};
        const others = store.data.partners.filter(x=>x.id!==p.id);
        const inits = store.data.initiators;
        openModal(id?'ç·¨è¼¯å¤¥ä¼´':'æ–°å¢å¤¥ä¼´', `
            <form onsubmit="savePartner(event, '${id||''}')">
                <div class="row">
                    <div class="col"><label>ç·¨è™Ÿ *</label><input name="code" value="${p.code}" class="form-control" required></div>
                    <div class="col"><label>å§“å *</label><input name="name" value="${p.name}" class="form-control" required></div>
                </div>
                <div class="form-group"><label>æ¨è–¦äºº (ä¸Šç·š)</label>
                    <select name="sponsorId" class="form-control"><option value="">-- ç„¡ (é ‚å±¤) --</option>${others.map(o=>`<option value="${o.id}" ${o.id===p.sponsorId?'selected':''}>${o.code} ${o.name}</option>`).join('')}</select>
                </div>
                <div class="form-group"><label>æ‰€å±¬ç™¼èµ·äºº (çé‡‘ä¾†æº)</label>
                    <select name="initiatorId" class="form-control" required><option value="">-- è«‹é¸æ“‡ --</option>${inits.map(i=>`<option value="${i.id}" ${i.id===p.initiatorId?'selected':''}>${i.name}</option>`).join('')}</select>
                </div>
                <div class="form-group"><label>ç‹€æ…‹</label>
                    <select name="status" class="form-control"><option value="active" ${p.status==='active'?'selected':''}>å•Ÿç”¨</option><option value="inactive" ${p.status==='inactive'?'selected':''}>åœç”¨</option></select>
                </div>
                <button class="btn btn-primary" style="width:100%">å„²å­˜</button>
            </form>
        `);
    } catch(e) { alert('é–‹å•Ÿå¤±æ•—: '+e.message); }
}
function savePartner(e, id) {
    e.preventDefault(); const fd = new FormData(e.target); const d = Object.fromEntries(fd);
    if(store.data.partners.some(x=>x.code===d.code && x.id!==id)) return alert('ç·¨è™Ÿé‡è¤‡');
    if(id) { const i = store.data.partners.findIndex(x=>x.id===id); store.data.partners[i] = {...store.data.partners[i], ...d}; }
    else { store.data.partners.push({...d, id: uuid()}); }
    store.save(); closeModal(); renderPartners();
}
function deletePartner(id) {
    if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
    store.data.partners = store.data.partners.filter(x=>x.id!==id);
    store.data.partners.forEach(p => { if(p.sponsorId===id) p.sponsorId=''; }); 
    store.data.records = store.data.records.filter(r=>r.partnerId!==id);
    store.save(); renderPartners();
}

function renderRecords() {
    const m = localStorage.getItem('r_m') || new Date().toISOString().slice(0,7);
    const q = localStorage.getItem('r_q') || '';
    const unpaidOnly = localStorage.getItem('r_unpaid') === 'true';
    
    let list = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
    if(q) list = list.filter(r=>r.partnerName.includes(q));
    if(unpaidOnly) list = list.filter(r=>r.payoutStatus!=='paid' && r.totalIncome>0);
    
    document.getElementById('app').innerHTML = `
        <header>${header('æœˆä»½æ¥­ç¸¾ç´€éŒ„')}</header>
        <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap">
            <input type="month" value="${m}" class="form-control" style="width:auto" onchange="localStorage.setItem('r_m',this.value);renderRecords()">
            <input placeholder="æœå°‹å¤¥ä¼´" value="${q}" class="form-control" style="width:auto" oninput="localStorage.setItem('r_q',this.value);renderRecords()">
            <label style="display:flex;align-items:center;gap:5px;cursor:pointer;background:white;padding:0 10px;border:1px solid #ccc;border-radius:6px">
                <input type="checkbox" ${unpaidOnly?'checked':''} onchange="localStorage.setItem('r_unpaid',this.checked);renderRecords()"> åªçœ‹æœªç™¼æ”¾
            </label>
            <button class="btn btn-primary" onclick="editRecord(null,'${m}')">ï¼‹ æ–°å¢ç´€éŒ„</button>
        </div>
        <div class="card"><table><thead><tr><th>å¤¥ä¼´</th><th>ç‹€æ…‹</th><th>PV / å›é¥‹</th><th>ç™¼æ”¾</th><th>æ“ä½œ</th></tr></thead><tbody>
        ${list.map(r => `<tr>
            <td>${r.partnerName}</td>
            <td>${r.isGraduated?'<span class="status-badge status-active">ğŸ“ ç•¢æ¥­</span>':r.isPartnerInactive?'<span class="status-badge status-inactive">åœç”¨</span>':r.isMonthlyInactive?'<span class="status-badge status-inactive">æœ¬æœˆä¸è¨ˆ</span>':'<span class="status-badge status-active">åƒèˆ‡</span>'}</td>
            <td><div>PV: ${r.gpv}</div><div style="font-weight:bold;color:${r.totalIncome>0?'var(--success)':'#aaa'}">${money(r.totalIncome)}</div></td>
            <td><span class="status-badge ${r.payoutStatus==='paid'?'status-paid':'status-unpaid'}">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</span></td>
            <td><button class="btn btn-secondary" style="font-size:0.8rem;padding:4px 10px" onclick="editRecord('${r.id}')">ç·¨è¼¯</button></td>
        </tr>`).join('')}
        </tbody></table></div>
    `;
}

let tempRec = null; let isDirty = false;
function markDirty() { isDirty = true; }
function editRecord(id, month) {
    try {
        isDirty = false;
        const existing = id ? store.getRecord(id) : null;
        if(existing && existing.payoutStatus==='paid' && !confirm('æ­¤ç´€éŒ„å·²ç™¼æ”¾ï¼Œç¢ºå®šè¦ä¿®æ”¹å—ï¼Ÿ')) return;
        
        const base = existing || { id:'', partnerId:'', month, ppv:0, pbv:0, gpv:0, legs:[], newRecruits:[], learningDone:false, participation:'active', payoutStatus:'unpaid', payoutDate: getToday(month), planVersionId: store.data.versions.find(v=>!v.archived)?.id, note:'' };
        tempRec = JSON.parse(JSON.stringify(base));
        
        // ğŸ”¥ FIX: Ensure arrays exist to prevent crash
        if (!Array.isArray(tempRec.legs)) tempRec.legs = [];
        if (!Array.isArray(tempRec.newRecruits)) tempRec.newRecruits = [];

        const pOpts = store.data.partners.map(p => `<option value="${p.id}" ${p.id===base.partnerId?'selected':''} style="${p.status==='inactive'?'color:gray':''}">${p.code} ${p.name} ${p.status==='inactive'?'(åœç”¨)':''}</option>`).join('');
        const vOpts = store.data.versions.map(v => `<option value="${v.id}" ${v.id===base.planVersionId?'selected':''} ${v.archived?'disabled':''}>${v.name}</option>`).join('');

        openModal(id?'ç·¨è¼¯ç´€éŒ„':'æ–°å¢ç´€éŒ„', `
            <form id="recForm" onsubmit="saveRecord(event, '${id||''}')">
                <div class="record-modal-grid">
                    <div class="record-form-col">
                        <div class="card">
                            <div class="row"><div class="col"><label>å¤¥ä¼´</label><select name="partnerId" class="form-control" onchange="tempRec.partnerId=this.value;renderPreview();markDirty()" required>${pOpts}</select></div>
                            <div class="col"><label>ç‰ˆæœ¬</label><select name="planVersionId" class="form-control" onchange="tempRec.planVersionId=this.value;renderPreview();markDirty()">${vOpts}</select></div></div>
                        </div>
                        <div class="card">
                            <div class="row">
                                <div class="col"><label>å€‹äºº PV</label><input type="number" name="ppv" value="${base.ppv}" class="form-control" oninput="markDirty()"></div>
                                <div class="col"><label>å°çµ„ PV *</label><input type="number" name="gpv" value="${base.gpv}" class="form-control" required oninput="tempRec.gpv=Number(this.value);renderPreview();markDirty()"></div>
                            </div>
                        </div>
                        <div class="card">
                            <label>è…¿ (ç”¨æ–¼æ‰£é™¤ç¨ç«‹æ¥­ç¸¾)</label>
                            <div id="legsArea"></div>
                            <button type="button" class="btn btn-outline" onclick="addLeg()">+ è…¿</button>
                        </div>
                        <div class="card">
                            <label>æ–°æ¨è–¦ (å¡«å…¥ç·¨è™Ÿæœƒè‡ªå‹•å»ºç«‹çµ„ç¹”é—œä¿‚)</label>
                            <div id="recruitArea"></div>
                            <button type="button" class="btn btn-outline" onclick="addRec()">+ æ–°äºº</button>
                        </div>
                        <div class="card">
                            <div class="row">
                                <div class="col"><label>ç‹€æ…‹</label><select name="participation" class="form-control" onchange="tempRec.participation=this.value;renderPreview();markDirty()"><option value="active" ${base.participation==='active'?'selected':''}>åƒèˆ‡</option><option value="inactive" ${base.participation==='inactive'?'selected':''}>æœ¬æœˆä¸è¨ˆ</option></select></div>
                                <div class="col" style="padding-top:25px"><label><input type="checkbox" name="learningDone" ${base.learningDone?'checked':''} onchange="tempRec.learningDone=this.checked;renderPreview();markDirty()"> å®Œæˆå­¸ç¿’ä»»å‹™</label></div>
                            </div>
                            <div class="form-group"><label>å‚™è¨»</label><textarea name="note" class="form-control" oninput="markDirty()">${base.note}</textarea></div>
                            <div class="row">
                                <div class="col"><label>ç™¼æ”¾ç‹€æ…‹</label><select name="payoutStatus" class="form-control" onchange="markDirty()"><option value="unpaid" ${base.payoutStatus==='unpaid'?'selected':''}>æœªç™¼æ”¾</option><option value="paid" ${base.payoutStatus==='paid'?'selected':''}>å·²ç™¼æ”¾</option></select></div>
                                <div class="col"><label>æ—¥æœŸ</label><input type="date" name="payoutDate" value="${base.payoutDate}" class="form-control" oninput="markDirty()"></div>
                            </div>
                        </div>
                    </div>
                    <div class="record-preview-col">
                        <div id="previewBox">
                            <div class="preview-card" style="display:flex;align-items:center;justify-content:center;color:#999">è¼‰å…¥ä¸­...</div>
                        </div>
                        <div class="modal-actions-bar" style="margin-top:20px;display:flex;gap:10px">
                            <button type="button" class="btn btn-secondary" onclick="closeModalSafe()">å–æ¶ˆ</button>
                            ${id?`<button type="button" class="btn btn-danger" onclick="deleteRecord('${id}')">åˆªé™¤</button>`:''}
                            <button class="btn btn-primary">å„²å­˜</button>
                        </div>
                    </div>
                </div>
            </form>
        `);
        // ğŸ”¥ FIX: Render preview first
        renderPreview();
        renderLegs(); 
        renderRecs(); 
    } catch(e) { alert('ç´€éŒ„é éŒ¯èª¤: ' + e.message); }
}
function renderLegs() {
    document.getElementById('legsArea').innerHTML = (tempRec.legs||[]).map((l,i)=>`
        <div style="display:flex;gap:5px;margin-bottom:5px">
            <input placeholder="è…¿å" value="${l.name}" class="form-control" oninput="tempRec.legs[${i}].name=this.value;markDirty()">
            <input type="number" placeholder="BV" value="${l.bv}" class="form-control" oninput="tempRec.legs[${i}].bv=Number(this.value);renderPreview();markDirty()">
            <label style="display:flex;align-items:center;font-size:0.8rem;white-space:nowrap"><input type="checkbox" ${l.isIndependent?'checked':''} onchange="tempRec.legs[${i}].isIndependent=this.checked;renderPreview();markDirty()"> ç¨ç«‹</label>
            <button type="button" class="btn btn-danger" onclick="tempRec.legs.splice(${i},1);renderLegs();renderPreview();markDirty()">Ã—</button>
        </div>
    `).join('');
}
function addLeg() { tempRec.legs.push({name:'',bv:0,isIndependent:false}); renderLegs(); renderPreview(); markDirty(); }
function renderRecs() {
    document.getElementById('recruitArea').innerHTML = (tempRec.newRecruits||[]).map((r,i)=>`
        <div style="display:flex;gap:5px;margin-bottom:5px">
            <input placeholder="ç·¨è™Ÿ" value="${r.code||''}" class="form-control" style="flex:1" oninput="tempRec.newRecruits[${i}].code=this.value;markDirty()">
            <input placeholder="å§“å" value="${r.name}" class="form-control" style="flex:1.5" oninput="tempRec.newRecruits[${i}].name=this.value;markDirty()">
            <input type="number" placeholder="BV" value="${r.bv}" class="form-control" style="flex:1" oninput="tempRec.newRecruits[${i}].bv=Number(this.value);renderPreview();markDirty()">
            <button type="button" class="btn btn-danger" onclick="tempRec.newRecruits.splice(${i},1);renderRecs();renderPreview();markDirty()">Ã—</button>
        </div>
    `).join('');
}
function addRec() { tempRec.newRecruits.push({code:'',name:'',bv:0}); renderRecs(); renderPreview(); markDirty(); }
function renderPreview() {
    try {
        const res = calculate(tempRec);
        const box = document.getElementById('previewBox');
        if(!box) return;
        
        if(!res) { 
            box.innerHTML = '<div class="preview-card" style="display:flex;align-items:center;justify-content:center;color:#999">è«‹é¸æ“‡å¤¥ä¼´</div>'; 
            return; 
        }
        
        let tag = '<span class="status-badge status-active">ğŸŸ¢ å¯ç™¼æ”¾</span>';
        if(res.isGraduated) tag = '<span class="status-badge status-active">ğŸ“ ç•¢æ¥­</span>';
        else if(res.isPartnerInactive) tag = '<span class="status-badge status-inactive">â¸ å¤¥ä¼´å·²åœç”¨</span>';
        else if(res.isMonthlyInactive) tag = '<span class="status-badge status-inactive">âšª æœ¬æœˆä¸è¨ˆ</span>';
        else if(!res.isEligible) tag = '<span class="status-badge status-unpaid">ğŸš« ä¸é©ç”¨</span>';

        box.innerHTML = `
            <div class="preview-card">
                <div style="display:flex;justify-content:space-between;margin-bottom:10px;color:#777"><span>æœ¬æœˆé ä¼°</span> ${tag}</div>
                <div class="preview-amount" style="color:${res.starTotal>0?'var(--success)':'#ccc'}">${money(res.starTotal)}</div>
                ${res.isEligible ? `
                    <div class="preview-row"><span>è¨ˆç®—æ¯”ä¾‹</span><span>${res.appliedRateText}</span></div>
                    <div class="preview-row"><span>åŸºç¤å›é¥‹</span><span>${money(res.baseBonus)}</span></div>
                    <div class="preview-row"><span>æ¨è–¦å›é¥‹</span><span>${money(res.recruitBonus)}</span></div>
                    <div class="preview-row"><span>å­¸ç¿’åŠ ç¢¼</span><span>${money(res.learningBonus)}</span></div>
                ` : `<div style="text-align:center;color:#ccc;padding:10px">ç„¡çé‡‘ç”¢ç”Ÿ</div>`}
            </div>
        `;
    } catch(e) { console.error('Preview error', e); }
}
function saveRecord(e, id) {
    e.preventDefault();
    const fd = new FormData(e.target);
    if(!id && store.data.records.some(r=>r.month===tempRec.month && r.partnerId===tempRec.partnerId)) return alert('æ­¤å¤¥ä¼´æœ¬æœˆå·²æœ‰ç´€éŒ„');
    
    // Upsert New Recruits
    const parent = store.getPartner(tempRec.partnerId);
    if(parent) {
        tempRec.newRecruits.forEach(rec => {
            if(!rec.code || !rec.name) return;
            let p = store.data.partners.find(x => x.code === rec.code);
            if(!p) {
                store.data.partners.push({
                    id: uuid(), code: rec.code, name: rec.name,
                    sponsorId: parent.id,
                    initiatorId: parent.initiatorId || '',
                    status: 'active'
                });
            } else {
                if(!p.sponsorId) p.sponsorId = parent.id;
                if(!p.initiatorId && parent.initiatorId) p.initiatorId = parent.initiatorId;
                if(!p.name) p.name = rec.name;
            }
        });
    }

    const final = { ...tempRec, ...Object.fromEntries(fd), 
        ppv: Number(fd.get('ppv')), gpv: Number(fd.get('gpv')), 
        learningDone: fd.get('learningDone')==='on' 
    };
    final.legs = tempRec.legs; final.newRecruits = tempRec.newRecruits;
    
    if(id) { const i = store.data.records.findIndex(x=>x.id===id); store.data.records[i] = final; }
    else { final.id = uuid(); store.data.records.push(final); }
    store.save(); isDirty=false; closeModal(); renderRecords();
}
function deleteRecord(id) {
    if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
    store.data.records = store.data.records.filter(r=>r.id!==id);
    store.save(); isDirty=false; closeModal(); renderRecords();
}

function renderPayout() {
    const m = localStorage.getItem('pay_m') || new Date().toISOString().slice(0,7);
    const q = localStorage.getItem('pay_q') || '';
    
    let recs = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
    if(q) recs = recs.filter(r=>r.partnerName.includes(q) || (store.getInitiator(r.initiatorId)||{}).name?.includes(q));
    
    const groups = {};
    store.data.initiators.forEach(i => { groups[i.id] = { info: i, list: [], sum:0, unpaid:0 }; });
    groups['none'] = { info:{name:'æœªæŒ‡å®š', code:'N/A'}, list:[], sum:0, unpaid:0 };
    
    recs.forEach(r => {
        const gid = groups[r.initiatorId] ? r.initiatorId : 'none';
        groups[gid].list.push(r);
        groups[gid].sum += r.totalIncome;
        if(r.payoutStatus!=='paid') groups[gid].unpaid += r.totalIncome;
    });

    document.getElementById('app').innerHTML = `
        <header>${header('æœ¬æœˆç™¼æ”¾')}</header>
        <div style="display:flex;gap:10px;margin-bottom:15px">
            <input type="month" value="${m}" class="form-control" style="width:auto" onchange="localStorage.setItem('pay_m',this.value);renderPayout()">
            <input placeholder="æœå°‹" value="${q}" class="form-control" style="width:auto" oninput="localStorage.setItem('pay_q',this.value);renderPayout()">
            <button class="btn btn-primary" onclick="bulkPay('${m}')">æ‰¹æ¬¡ç™¼æ”¾</button>
            <button class="btn btn-secondary" onclick="exportCSV('${m}')">åŒ¯å‡º CSV</button>
        </div>
        ${Object.values(groups).filter(g=>g.list.length>0).map(g => `
            <div class="card">
                <div style="display:flex;justify-content:space-between;border-bottom:2px solid var(--accent);padding-bottom:10px;margin-bottom:10px">
                    <h3 style="margin:0">${g.info.name}</h3>
                    <div style="font-size:0.9rem">æ‡‰ä»˜ï¼š<span style="color:var(--danger)">${money(g.unpaid)}</span> / ç¸½è¨ˆï¼š${money(g.sum)}</div>
                </div>
                <table><thead><tr><th width="30"><input type="checkbox" onchange="toggleGrp(this,'${g.info.id}')"></th><th>å¤¥ä¼´</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th></tr></thead><tbody>
                ${g.list.map(r => `<tr>
                    <td><input type="checkbox" class="chk-${g.info.id}" value="${r.id}" ${r.payoutStatus==='paid'?'disabled':''}></td>
                    <td>${r.partnerName}</td>
                    <td style="font-weight:bold">${money(r.totalIncome)}</td>
                    <td><button class="btn ${r.payoutStatus==='paid'?'btn-primary':'btn-outline'}" style="padding:4px 8px;font-size:0.8rem" onclick="togglePay('${r.id}','${r.payoutStatus}','${m}')">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</button></td>
                </tr>`).join('')}
                </tbody></table>
            </div>
        `).join('')}
    `;
}
function toggleGrp(el, id) { document.querySelectorAll('.chk-'+id).forEach(c => { if(!c.disabled) c.checked = el.checked; }); }
function bulkPay(m) {
    const ids = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.value).filter(v=>v && v.length>10);
    if(!ids.length) return alert('æœªå‹¾é¸');
    if(!confirm('ç¢ºèªæ¨™è¨˜ç™¼æ”¾ï¼Ÿ')) return;
    const d = getToday(m);
    ids.forEach(id => { const r = store.getRecord(id); if(r) { r.payoutStatus='paid'; r.payoutDate=d; } });
    store.save(); renderPayout();
}
function togglePay(id, s, m) {
    const r = store.getRecord(id);
    if(s==='paid') { if(confirm('å–æ¶ˆç™¼æ”¾ï¼Ÿ')) r.payoutStatus='unpaid'; }
    else { r.payoutStatus='paid'; r.payoutDate=getToday(m); }
    store.save(); renderPayout();
}
function exportCSV(m) {
    const recs = store.getRecordsByMonth(m).map(calculate).filter(x=>x);
    const txt = '\uFEFFæœˆä»½,ç™¼èµ·äºº,å¤¥ä¼´,é‡‘é¡,å‚™è¨»,ç‹€æ…‹,æ—¥æœŸ\n' + recs.map(r=>`${r.month},${store.getInitiator(r.initiatorId)?.name||''},${r.partnerName},${r.starTotal},${r.note||''},${r.payoutStatus},${r.payoutDate}`).join('\n');
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt],{type:'text/csv'})); a.download = `Payout_${m}.csv`; a.click();
}

function renderInitiators() {
    document.getElementById('app').innerHTML = `
        <header>${header('ç™¼èµ·äººç®¡ç†')} <button class="btn btn-primary" onclick="editInit()">+ æ–°å¢</button></header>
        <div class="card"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>è¼”å°åå–® (æœ€å¤š3ä½)</th><th>æ“ä½œ</th></tr></thead><tbody>
        ${store.data.initiators.map(i => {
            const names = (i.coachedPartnerIds||[]).map(pid => {
                const p = store.getPartner(pid);
                return p ? `${p.code} ${p.name}` : '?';
            }).join('ã€') || '-';
            return `<tr><td>${i.code}</td><td>${i.name}</td><td>${names}</td><td>
                <button class="btn btn-secondary" style="padding:4px 10px" onclick="editInit('${i.id}')">ç·¨è¼¯</button>
                <button class="btn btn-danger" style="padding:4px 10px" onclick="delInit('${i.id}')">åˆªé™¤</button>
            </td></tr>`;
        }).join('')}
        </tbody></table></div>
    `;
}
function editInit(id) {
    try {
        const i = id ? store.getInitiator(id) : {id:'', code:'', name:'', coachedPartnerIds:[]};
        const myPartners = store.data.partners.filter(p => p.initiatorId === id);
        const coachHTML = myPartners.map(p => {
            const checked = (i.coachedPartnerIds||[]).includes(p.id) ? 'checked' : '';
            return `<div style="margin-bottom:5px"><label><input type="checkbox" class="coach-chk" value="${p.id}" ${checked} onchange="checkLimit(this)"> ${p.code} ${p.name}</label></div>`;
        }).join('') || '<div style="color:#999;font-size:0.9rem">å°šç„¡ç¶å®šæ­¤ç™¼èµ·äººçš„å¤¥ä¼´</div>';

        openModal(id?'ç·¨è¼¯':'æ–°å¢', `
            <form onsubmit="saveInit(event, '${id||''}')">
                <div class="row"><div class="col"><label>ç·¨è™Ÿ</label><input name="code" value="${i.code}" class="form-control" required></div>
                <div class="col"><label>å§“å</label><input name="name" value="${i.name}" class="form-control" required></div></div>
                <div class="card" style="margin-top:15px">
                    <h4 style="margin:0 0 10px 0;font-size:1rem">è¼”å°åå–® (æœ€å¤š3ä½)</h4>
                    <div style="max-height:150px;overflow-y:auto;border:1px solid #eee;padding:10px;border-radius:4px">${coachHTML}</div>
                </div>
                <button class="btn btn-primary" style="width:100%;margin-top:15px">å„²å­˜</button>
            </form>
        `);
    } catch(e) { alert(e.message); }
}
function saveInit(e, id) {
    e.preventDefault(); const fd = new FormData(e.target); const d = Object.fromEntries(fd);
    if(store.data.initiators.some(x=>x.code===d.code && x.id!==id)) return alert('é‡è¤‡');
    const coached = Array.from(document.querySelectorAll('.coach-chk:checked')).map(c=>c.value);
    
    if(id) { 
        const idx = store.data.initiators.findIndex(x=>x.id===id); 
        store.data.initiators[idx] = {...store.data.initiators[idx], ...d, coachedPartnerIds: coached}; 
    }
    else { store.data.initiators.push({...d, id:uuid(), coachedPartnerIds: coached}); }
    store.save(); closeModal(); renderInitiators();
}
function delInit(id) {
    if(!confirm('åˆªé™¤ï¼Ÿé€™æœƒå°‡å…¶ä¸‹å¤¥ä¼´è®Šç‚ºæœªæŒ‡å®šã€‚')) return;
    store.data.initiators = store.data.initiators.filter(i=>i.id!==id);
    store.data.partners.forEach(p => { if(p.initiatorId===id) p.initiatorId=''; });
    store.save(); renderInitiators();
}

function renderOrgChart() {
    try {
        const m = localStorage.getItem('org_m') || new Date().toISOString().slice(0,7);
        const viewerId = localStorage.getItem('org_viewer');
        
        const partners = store.data.partners;
        const recs = store.getRecordsByMonth(m).map(calculate);
        const pMap = {};
        partners.forEach(p => { pMap[p.id] = { ...p, children:[], record: recs.find(r=>r && r.partnerId===p.id) }; });
        
        const roots = [];
        partners.forEach(p => {
            if(p.sponsorId && pMap[p.sponsorId] && p.sponsorId !== p.id) {
                pMap[p.sponsorId].children.push(pMap[p.id]);
            } else {
                roots.push(pMap[p.id]);
            }
        });

        const scopeStatus = {}; 
        const generations = {};

        if(viewerId) {
            const viewerInit = store.getInitiator(viewerId);
            const rootIds = viewerInit ? (viewerInit.coachedPartnerIds || []) : [];
            rootIds.forEach(rid => { if(pMap[rid]) traverseScope(pMap[rid], 1, true); });
        }

        function traverseScope(node, gen, isChainValid) {
            let currentStatus = null;
            const isBreakaway = !!node.initiatorId && node.initiatorId !== viewerId;

            if (isBreakaway) {
                currentStatus = 'breakaway';
                isChainValid = false;
            } else if (isChainValid) {
                currentStatus = gen <= 5 ? 'in' : 'out';
                generations[node.id] = gen;
            } else {
                currentStatus = 'out';
            }
            scopeStatus[node.id] = currentStatus;
            node.children.forEach(child => traverseScope(child, gen + 1, isChainValid && currentStatus !== 'breakaway'));
        }

        function renderNode(node) {
            const r = node.record;
            const st = scopeStatus[node.id];
            const gen = generations[node.id];
            let cls = ['node'];
            let badge = '';
            
            if(st === 'breakaway') { cls.push('breakaway'); badge = `<div class="node-badge" style="background:#8e44ad">ç¨ç«‹é«”ç³»</div>`; }
            else if(st === 'in') { cls.push('in-scope'); if(gen) badge = `<div class="node-badge" style="background:var(--accent)">ç™¼èµ·äººç¬¬${gen}ä»£</div>`; }
            else if(viewerId) { cls.push('out-scope'); } 

            let info = 'ç„¡ç´€éŒ„';
            if(node.status==='inactive') info = 'åœç”¨';
            else if(r) {
                if(r.isGraduated) info = 'ğŸ“ ç•¢æ¥­';
                else if(r.payoutStatus==='paid') info = 'âœ… å·²ç™¼æ”¾';
                else if(r.totalIncome>0) info = `<span style="color:#e74c3c">â— æœªç™¼æ”¾</span>`;
                else info = 'ç„¡çé‡‘';
            }

            return `<li>
                <div class="${cls.join(' ')}" onclick="showNode('${node.id}','${m}')">
                    ${badge}
                    <span class="name">${node.name}</span>
                    <span class="detail">${info}</span>
                    ${r ? `<div class="tooltip">PV: ${r.gpv}<br>é‡‘é¡: ${money(r.totalIncome)}</div>` : ''}
                </div>
                ${node.children.length ? `<ul>${node.children.map(renderNode).join('')}</ul>` : ''}
            </li>`;
        }

        document.getElementById('app').innerHTML = `
            <header>${header('çµ„ç¹”é—œè¯åœ–')}</header>
            <div class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <input type="month" value="${m}" class="form-control" style="width:auto" onchange="localStorage.setItem('org_m',this.value);renderOrgChart()">
                <select class="form-control" style="width:auto" onchange="localStorage.setItem('org_viewer',this.value);renderOrgChart()">
                    <option value="">ğŸ‘ï¸ é¸æ“‡è¦–è§’ (æŸ¥çœ‹è¼”å°ç¯„åœ)...</option>
                    ${store.data.initiators.map(i=>`<option value="${i.id}" ${i.id===viewerId?'selected':''}>${i.name}</option>`).join('')}
                </select>
                <div style="font-size:0.8rem;color:#777;margin-left:auto">
                    <span style="margin-right:10px"><span style="display:inline-block;width:10px;height:10px;background:#e8f8f5;border:1px solid var(--accent)"></span> è¼”å°å…§ (3å¯¬5æ·±)</span>
                    <span style="margin-right:10px"><span style="display:inline-block;width:10px;height:10px;background:#f4ecf7;border:1px solid #8e44ad"></span> ç¨ç«‹é«”ç³»</span>
                    <span><span style="display:inline-block;width:10px;height:10px;background:#f9f9f9;border:1px dashed #ccc"></span> è¶…å‡ºç¯„åœ</span>
                </div>
            </div>
            <div class="org-container"><div class="tree"><ul>${roots.map(renderNode).join('')}</ul></div></div>
        `;
    } catch(e) { alert('çµ„ç¹”åœ–æ¸²æŸ“éŒ¯èª¤: ' + e.message); }
}

function showNode(partnerId, m) {
    const r = (store.data.records || []).find(x => x.partnerId === partnerId && x.month === m);
    if (r) {
        editRecord(r.id);
    } else if (confirm('ç„¡æœ¬æœˆç´€éŒ„ï¼Œè¦å»ºç«‹å—ï¼Ÿ')) {
        editRecord(null, m);
        tempRec.partnerId = partnerId;
        setTimeout(() => {
            const sel = document.querySelector('[name=partnerId]');
            if (sel) { sel.value = partnerId; tempRec.partnerId = partnerId; renderPreview(); markDirty(); }
        }, 50);
    }
}

function renderVersions() {
    document.getElementById('app').innerHTML = `
        <header>${header('ç‰ˆæœ¬æ§ç®¡')} <button class="btn btn-primary" onclick="editVer()">+ æ–°å¢</button></header>
        <div class="card"><table><thead><tr><th>åç¨±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>
        ${store.data.versions.map(v => `<tr><td>${v.name}</td><td>${v.archived?'å°å­˜':'ä½¿ç”¨ä¸­'}</td><td>
            <button class="btn btn-secondary" style="padding:4px 10px" onclick="editVer('${v.id}')">æŸ¥çœ‹</button>
            ${!v.archived ? `<button class="btn btn-danger" style="padding:4px 10px" onclick="delVer('${v.id}')">åˆªé™¤</button>`:''}
        </td></tr>`).join('')}
        </tbody></table></div>
    `;
}
function editVer(id) {
    const v = id ? store.getVersion(id) : {id:'', name:'New', params:{...defaultParams}};
    const p = v.params;
    openModal(id?'ç‰ˆæœ¬':'æ–°å¢', `
        <form onsubmit="saveVer(event,'${id||''}')">
            <div class="form-group"><label>åç¨±</label><input name="name" value="${v.name}" class="form-control" required ${v.archived?'disabled':''}></div>
            <div class="row"><div class="col"><label>0-3% åŸºç¤</label><input type="number" step="0.01" name="rate_0_3_base" value="${p.rate_0_3_base}" class="form-control" ${v.archived?'disabled':''}></div>
            <div class="col"><label>0-3% æ¨è–¦</label><input type="number" step="0.01" name="rate_0_3_rec" value="${p.rate_0_3_rec}" class="form-control" ${v.archived?'disabled':''}></div></div>
            <div class="row"><div class="col"><label>6% åŸºç¤</label><input type="number" step="0.01" name="rate_6_base" value="${p.rate_6_base}" class="form-control" ${v.archived?'disabled':''}></div>
            <div class="col"><label>6% æ¨è–¦</label><input type="number" step="0.01" name="rate_6_rec" value="${p.rate_6_rec}" class="form-control" ${v.archived?'disabled':''}></div></div>
            <div class="row"><div class="col"><label>æ–°äººå›é¥‹</label><input type="number" step="0.01" name="rate_recruit_bv" value="${p.rate_recruit_bv}" class="form-control" ${v.archived?'disabled':''}></div>
            <div class="col"><label>å­¸ç¿’åŠ ç¢¼</label><input type="number" step="0.01" name="rate_learning" value="${p.rate_learning}" class="form-control" ${v.archived?'disabled':''}></div></div>
            ${!v.archived ? '<button class="btn btn-primary" style="width:100%;margin-top:15px">å„²å­˜</button>' : ''}
        </form>
    `);
}
function saveVer(e, id) {
    e.preventDefault(); const fd=new FormData(e.target);
    const p = { rate_0_3_base:Number(fd.get('rate_0_3_base')), rate_0_3_rec:Number(fd.get('rate_0_3_rec')), rate_6_base:Number(fd.get('rate_6_base')), rate_6_rec:Number(fd.get('rate_6_rec')), rate_recruit_bv:Number(fd.get('rate_recruit_bv')), rate_learning:Number(fd.get('rate_learning')) };
    if(id){ const idx=store.data.versions.findIndex(x=>x.id===id); store.data.versions[idx] = {...store.data.versions[idx], name:fd.get('name'), params:p}; }
    else { store.data.versions.unshift({id:uuid(), name:fd.get('name'), createdAt:new Date().toISOString(), params:p}); }
    store.save(); closeModal(); renderVersions();
}
function delVer(id) {
    if(!confirm('åˆªé™¤ï¼Ÿ')) return;
    if(store.data.records.some(r=>r.planVersionId===id)) {
        if(confirm('æ­¤ç‰ˆæœ¬å·²è¢«ä½¿ç”¨ï¼Œæ˜¯å¦æ”¹ç‚ºå°å­˜ï¼Ÿ')) { store.getVersion(id).archived=true; store.save(); renderVersions(); }
    } else {
        store.data.versions = store.data.versions.filter(v=>v.id!==id); store.save(); renderVersions();
    }
}

function renderSettings() {
    document.getElementById('app').innerHTML = `
        <header>${header('ç³»çµ±è¨­å®š')}</header>
        <div class="card">
            <h3>ğŸ“¦ è³‡æ–™å‚™ä»½</h3>
            <button class="btn btn-primary" onclick="dlBackup()">â¬‡ï¸ ä¸‹è¼‰å‚™ä»½ (JSON)</button>
            <button class="btn btn-secondary" onclick="document.getElementById('upFile').click()">â¬†ï¸ åŒ¯å…¥é‚„åŸ</button>
            <input type="file" id="upFile" style="display:none" onchange="ulBackup(this)">
        </div>
        <div class="card">
            <h3>âš ï¸ å±éšªæ“ä½œ</h3>
            <button class="btn btn-danger" onclick="resetAll()">ğŸ”¥ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
    `;
}
function dlBackup() {
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(store.data,null,2)],{type:'application/json'})); a.download = `NewStar_${new Date().toISOString().slice(0,10)}.json`; a.click();
}
function ulBackup(el) {
    const f=el.files[0]; if(!f)return;
    const r=new FileReader(); r.onload=e=>{
        try{ const d=JSON.parse(e.target.result); if(d.partners && confirm('ç¢ºå®šè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Ÿ')){ store.data=d; store.save(); location.reload(); } } catch(err){alert('æ ¼å¼éŒ¯èª¤');}
    }; r.readAsText(f);
}
function resetAll() { if(prompt('è¼¸å…¥ DELETE ç¢ºèªæ¸…é™¤')==='DELETE') { db.ref('AmwaySystem/v1').remove(); location.reload(); } }

function closeModalSafe() { if(isDirty && !confirm('æœ‰æœªå„²å­˜è®Šæ›´ï¼Œç¢ºå®šé›¢é–‹ï¼Ÿ')) return; closeModal(); }
function closeModal() { document.getElementById('modal').style.display = 'none'; }
</script>
</body>
</html>
