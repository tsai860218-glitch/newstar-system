<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«æ——è‰¦ç³»çµ± (2026 Cloud Pro v3.7)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0066cc;
            --primary-dark: #004c99;
            --secondary: #ff9900;
            --bg: #f0f2f5;
            --text: #333;
            --border: #e1e1e1;
            --success: #28a745;
            --purple: #6f42c1;
            --gold: #d4af37;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar & Layout */
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .logo { padding: 25px 20px; font-size: 1.3rem; font-weight: bold; color: var(--primary); border-bottom: 1px solid var(--border); background: #f8f9fa;}
        .nav-item { padding: 16px 20px; cursor: pointer; transition: 0.2s; color: #555; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .nav-item:hover { background: #eef7ff; color: var(--primary); }
        .nav-item.active { background: #eef7ff; color: var(--primary); border-right: 4px solid var(--primary); font-weight: bold; }
        .nav-divider { font-size: 0.8rem; color: #999; padding: 15px 20px 5px; text-transform: uppercase; font-weight: bold; margin-top: 10px;}
        
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .page-title { font-size: 1.6rem; font-weight: bold; color: #2c3e50; border-left: 5px solid var(--primary); padding-left: 15px; margin-bottom: 25px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.04); margin-bottom: 25px; border: 1px solid #f0f0f0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }

        /* Forms */
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 0.95rem; font-weight: 600; color: #4b5563; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .row-inputs { display: flex; gap: 15px; align-items: center; }
        .equal-sign { font-size: 1.5rem; color: #999; font-weight: bold; padding-top: 25px; }

        /* Input Sections */
        .input-section { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .is-sales { border-left: 4px solid #3b82f6; background: #f8fbff; }
        .is-newcomer { border-left: 4px solid #e67e22; background: #fffaf5; }
        .is-learning { border-left: 4px solid #10b981; background: #f0fff4; }
        .section-header { font-weight: bold; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }

        /* V3.7 Styles */
        .graduate-badge { background: linear-gradient(135deg, #FFD700, #DAA520); color: #fff; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        th { background: #f1f5f9; font-weight: 700; }

        /* Buttons */
        .btn { padding: 12px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        .instant-bonus-box { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 6px solid var(--secondary); }
        .ib-total { font-size: 1.8rem; font-weight: bold; color: var(--secondary); }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { 
                width: 100%; height: auto; position: sticky; top: 0; 
                display: grid; grid-template-columns: repeat(3, 1fr); 
                padding: 10px; background: #fff; border-bottom: 1px solid var(--border);
            }
            .logo, .nav-divider { display: none; }
            .nav-item { padding: 10px 5px; flex-direction: column; font-size: 0.75rem; border: 1px solid #f0f0f0; }
            .main { padding: 15px; padding-bottom: 100px; overflow: visible; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .action-bar-mobile { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); z-index: 100; }
        }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i><span>æˆ°æƒ…å®¤</span></div>
        <div class="nav-item" onclick="switchTab('network')"><i class="fas fa-project-diagram"></i><span>çµ„ç¹”åœ–</span></div>
        <div class="nav-item" onclick="switchTab('entry')"><i class="fas fa-pen"></i><span>è¨˜ä¸€ç­†</span></div>
        <div class="nav-item" onclick="switchTab('members')"><i class="fas fa-users"></i><span>åå–®</span></div>
        <div class="nav-item" onclick="switchTab('logs')"><i class="fas fa-list"></i><span>æ—¥èªŒ</span></div>
        <div class="nav-item" onclick="switchTab('sponsors')"><i class="fas fa-crown"></i><span>ç™¼èµ·äºº</span></div>
        <div class="nav-item" onclick="switchTab('calculator')"><i class="fas fa-calculator"></i><span>è©¦ç®—</span></div>
        <div class="nav-item" onclick="switchTab('settings')"><i class="fas fa-cog"></i><span>è¨­å®š</span></div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="section active">
            <div class="page-title">ç•¶æœˆæ¥­ç¸¾æˆ°æƒ…å®¤</div>
            <div class="grid-2">
                <div class="card" style="border-top: 4px solid var(--primary);">
                    <div style="color: #666; font-size: 0.9rem;">åœ˜éšŠç¸½ PV (å«æ­¸æˆ¶)</div>
                    <h1 id="totalPVDisplay" style="margin: 10px 0; color: var(--primary);">0</h1>
                    <select id="dashMonthSelect" onchange="renderDashboard()" style="width: 100%;"></select>
                </div>
                <div class="card" style="border-top: 4px solid var(--gold);">
                    <div style="color: #666; font-size: 0.9rem;">ğŸ“ æœ¬æœˆæ¦®è­½ç•¢æ¥­å¤¥ä¼´ (1000 PV ä»¥ä¸Š)</div>
                    <div id="graduationList" style="margin-top:10px; font-weight:bold; color:var(--gold);">å°šç„¡äººç•¢æ¥­</div>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ’° çé‡‘æ’è¡Œæ¦œ (å‰ 10 å)</h3>
                <div class="table-wrap">
                    <table id="rankingTable"><thead><tr><th>æ’å</th><th>æœƒå“¡</th><th>æœ‰æ•ˆ PV</th><th>è¨ˆç®—æ˜ç´°</th><th>é ä¼°çé‡‘</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="network" class="section">
            <div class="page-title">ğŸ§¬ çµ„ç¹”é—œä¿‚åœ–</div>
            <div class="card">
                <div id="treeContainer" style="overflow-x:auto;"></div>
            </div>
        </div>

        <div id="entry" class="section">
            <div class="page-title">ğŸ“ æ–°å¢ç¶œåˆç´€éŒ„</div>
            <div class="grid-2">
                <div>
                    <div class="card">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="entryDate" onchange="updateMemberSelects()"></div>
                        <div class="form-group">
                            <label>æ“ä½œæœƒå“¡ (é¸å–ç•¶æœˆåƒåŠ ä¸­ä¸”æœªæ»¿ 1000PV è€…)</label>
                            <select id="entryMember" onchange="checkMemberSelect(); updateNewcomerUplineSelect();"></select>
                            <div id="quickAddMemberBox" style="display:none; background:#f0f9ff; padding:15px; margin-top:10px; border-radius:8px; border:1px dashed #0066cc;">
                                <div style="display:flex; gap:10px;"><input type="text" id="quickNewMemName" placeholder="å§“å"><input type="text" id="quickNewMemID" placeholder="ç·¨è™Ÿ"></div>
                                <select id="quickNewMemSponsor" style="margin-top:10px;"></select>
                            </div>
                        </div>

                        <div class="input-section is-sales">
                            <div class="section-header"><i class="fas fa-shopping-cart" style="color:#3b82f6;"></i> æ¥­ç¸¾è¼¸å…¥</div>
                            <div class="row-inputs">
                                <div class="form-group"><label>PV</label><input type="number" id="entryPV" placeholder="0" oninput="autoConvert('pv', 'entry');"></div>
                                <div class="form-group"><label>BV</label><input type="number" id="entryBV" placeholder="0" oninput="autoConvert('bv', 'entry');"></div>
                            </div>
                            <div style="margin-top:10px;"><div id="productContainer"></div><button class="btn btn-outline" style="width:100%; border-style:dashed;" onclick="addProductRow()">+ æ–°å¢å“é … (éå¿…å¡«)</button></div>
                        </div>

                        <div class="input-section is-newcomer">
                            <div class="section-header"><i class="fas fa-user-plus" style="color:#e67e22;"></i> æ¨è–¦æ–°äºº</div>
                            <div class="form-group" style="background:#fffaf0; padding:10px; border-radius:6px;">
                                <label style="color:#d35400;">ç›´å±¬ä»‹ç´¹äºº (ä¸Šç·š)</label>
                                <select id="newcomerUpline"></select>
                                <small style="color:#888; display:block; margin-top:4px;">*æ„ç¾©ï¼šæ­¤æ–°äººçš„ã€ç›´å±¬æ¨è–¦äººã€‘æ˜¯èª°ï¼Ÿ(é è¨­ç‚ºä¸Šæ–¹æ“ä½œè€…)</small>
                            </div>
                            <div style="display:flex; gap:10px;"><input type="text" id="newcomerName" placeholder="æ–°äººå§“å"><input type="text" id="newcomerID" placeholder="æ–°äººç·¨è™Ÿ"></div>
                            <input type="number" id="newcomerBV" placeholder="æ–°äººé¦–è³¼ BV" style="margin-top:10px;">
                        </div>

                        <div class="input-section is-learning">
                            <div class="section-header"><i class="fas fa-graduation-cap" style="color:#10b981;"></i> å­¸ç¿’å¿ƒå¾—</div>
                            <textarea id="learningNote" rows="2" placeholder="å…§å®¹æ‘˜è¦..."></textarea>
                            <label style="display:flex; align-items:center; gap:8px; margin-top:10px;"><input type="checkbox" id="learningFileCheck" style="width:20px; height:20px;"> <span>å·²ç¹³äº¤è­‰æ˜</span></label>
                        </div>
                    </div>
                </div>

                <div class="action-bar-mobile">
                    <div class="card" style="margin:0; padding:15px;">
                        <button class="btn btn-primary" style="width:100%;" onclick="addCompositeLog()">
                            <i class="fas fa-save"></i> å„²å­˜ä»Šæ—¥æ‰€æœ‰ç´€éŒ„
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="members" class="section">
            <div class="page-title">ğŸ‘¥ æœƒå“¡è³‡æ–™åº«</div>
            <div class="grid-2">
                <div class="card">
                    <h3>æ–°å¢æœƒå“¡</h3>
                    <input type="text" id="newMemberID" placeholder="ç·¨è™Ÿ" style="margin-bottom:10px;">
                    <input type="text" id="newMemberName" placeholder="å§“å" style="margin-bottom:10px;">
                    <select id="newMemSponsor" style="margin-bottom:10px;"></select>
                    <button class="btn btn-primary" style="width:100%;" onclick="addMember()">åŠ å…¥è³‡æ–™åº«</button>
                </div>
                <div class="card">
                    <div class="table-wrap">
                        <table id="memberTable"><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>ç‹€æ…‹</th><th>ç™¼èµ·äºº</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="logs" class="section"><div class="page-title">ğŸ“‹ ç´€éŒ„æ˜ç´°</div><div class="card"><div class="grid-2" style="margin-bottom:15px;"><input type="month" id="filterMonth" onchange="renderLogs()"><select id="filterMember" onchange="renderLogs()"></select></div><div class="table-wrap"><table id="logTable"><thead><tr><th>æ—¥æœŸ</th><th>æœƒå“¡</th><th>é¡å‹</th><th>è©³ç´°å…§å®¹</th><th>é ä¼°çé‡‘</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div></div></div>
        <div id="sponsors" class="section"><div class="page-title">ğŸ‘‘ ç™¼èµ·äººè³‡æ–™åº«</div><div class="grid-2"><div class="card"><input type="text" id="newSponsorName" placeholder="å§“å" style="margin-bottom:10px;"><input type="text" id="newSponsorID" placeholder="ID" style="margin-bottom:10px;"><button class="btn btn-purple" style="width:100%;" onclick="addSponsor()">æ–°å¢</button></div><div class="card"><div class="table-wrap"><table id="sponsorTable"><thead><tr><th>ID</th><th>å§“å</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div></div></div></div>
        <div id="calculator" class="section"><div class="page-title">ğŸ§® çé‡‘æ¨¡æ“¬å™¨</div><div class="card"><div class="grid-2"><div><label>é ä¼° PV</label><input type="number" id="calcPV" oninput="autoConvert('pv','calc'); runSimulation()"><label>é ä¼° BV</label><input type="number" id="calcBV" oninput="autoConvert('bv','calc'); runSimulation()"><label>æ¨è–¦äººæ•¸</label><input type="number" id="calcPartners" oninput="runSimulation()"></div><div style="background:#2c3e50; color:white; padding:40px; border-radius:12px; text-align:center;">é ä¼°ç¸½çé‡‘ <h1 style="color:#ff9900; font-size:3rem;" id="simValTotal">$0</h1></div></div></div></div>
        <div id="settings" class="section"><div class="page-title">âš™ï¸ ç³»çµ±è¨­å®š</div><div class="card"><button class="btn btn-danger" style="width:100%;" onclick="clearAllData()">å¾¹åº•æ¸…é™¤æ‰€æœ‰è³‡æ–™ (ä¸å¯é‚„åŸ)</button></div></div>
    </div>

<script>
    // --- Firebase SDK ---
    const firebaseConfig = {
      apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
      authDomain: "newstar-system.firebaseapp.com",
      projectId: "newstar-system",
      storageBucket: "newstar-system.firebasestorage.app",
      messagingSenderId: "889699172174",
      appId: "1:889699172174:web:0ff42757035a879cb3281f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const TEAM_ID = "newstar_main";

    // --- Global Data ---
    let members = [];
    let logs = [];
    let sponsors = [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entryDate').valueAsDate = new Date();
        document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);
        populateMonthSelect();
        auth.signInAnonymously().then(() => startCloudSync());
    });

    function startCloudSync() {
      db.collection("newstar").doc(TEAM_ID).onSnapshot((snap) => {
        if (!snap.exists) { saveToCloud(); return; }
        const d = snap.data();
        members = d.members || [];
        logs = d.logs || [];
        sponsors = d.sponsors || [];
        refreshAllUI();
      });
    }

    function saveToCloud() {
      db.collection("newstar").doc(TEAM_ID).set({ members, logs, sponsors, updatedAt: new Date().toISOString() }, { merge: true });
    }

    function refreshAllUI() {
        renderMembers(); renderLogs(); renderSponsors(); renderNetwork(); renderDashboard(); runSimulation();
        updateMemberSelects(); updateSponsorSelects();
    }

    function switchTab(t) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const idx = {'dashboard':0,'network':1,'entry':2,'members':3,'logs':4,'sponsors':5,'calculator':6,'settings':7}[t];
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        window.scrollTo(0,0);
        if(t === 'entry') updateMemberSelects(); // æ¯é»ä¸€æ¬¡æ›´æ–°ä¸€æ¬¡ç•¢æ¥­åå–®
    }

    // --- Core Logic ---
    function addProductRow() {
        const div = document.createElement('div');
        div.className = 'product-row';
        div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
        div.innerHTML = `<input type="text" placeholder="ç”¢å“" class="p-name" style="flex:2;"><input type="number" placeholder="æ•¸é‡" class="p-qty" style="flex:1;"><button onclick="this.parentElement.remove()" class="btn btn-outline btn-sm"><i class="fas fa-times"></i></button>`;
        document.getElementById('productContainer').appendChild(div);
    }

    function addCompositeLog() {
        const date = document.getElementById('entryDate').value;
        let mid = document.getElementById('entryMember').value;
        if(!mid) return alert("è«‹é¸å–æœƒå“¡");

        if (mid === 'new_mode') {
            const nn = document.getElementById('quickNewMemName').value;
            const ni = document.getElementById('quickNewMemID').value;
            const ns = document.getElementById('quickNewMemSponsor').value;
            if(!nn || !ni || !ns) return alert("è«‹å¡«å¯«æ–°æœƒå“¡è³‡æ–™");
            members.push({id: ni, name: nn, sponsorId: ns, isNewStar: true});
            mid = ni;
        }

        let saved = 0;
        const pv = parseFloat(document.getElementById('entryPV').value) || 0;
        if(pv > 0) {
            let prods = [];
            document.querySelectorAll('.product-row').forEach(r => {
                const n = r.querySelector('.p-name').value;
                if(n) prods.push(`${n}x${r.querySelector('.p-qty').value || 1}`);
            });
            logs.push({id: Date.now()+1, date, memberId: mid, type: 'sales', pv, details: `éŠ·å”® BV:${pv*50} ${prods.length ? ' | ğŸ“¦ '+prods.join(', ') : ''}`});
            saved++;
        }
        const nName = document.getElementById('newcomerName').value;
        if(nName) {
            const nid = document.getElementById('newcomerID').value;
            const up = document.getElementById('newcomerUpline').value || mid;
            if(!members.find(m=>m.id===nid)) members.push({id: nid, name: nName, sponsorId: members.find(m=>m.id===up)?.sponsorId||"", isNewStar: true});
            logs.push({id: Date.now()+2, date, memberId: mid, type: 'newcomer', details: `æ¨è–¦: ${nName}`, newcomerData: {id: nid, name: nName, bv: parseFloat(document.getElementById('newcomerBV').value)||0, uplineId: up}});
            saved++;
        }
        if(document.getElementById('learningFileCheck').checked) {
            logs.push({id: Date.now()+3, date, memberId: mid, type: 'learning', details: "å­¸ç¿’å¿ƒå¾—è­‰æ˜"});
            saved++;
        }

        if(saved > 0) { saveToCloud(); alert("å„²å­˜æˆåŠŸ"); location.reload(); }
    }

    // --- Helpers ---
    function checkMemberSelect() { document.getElementById('quickAddMemberBox').style.display = (document.getElementById('entryMember').value === 'new_mode') ? 'block' : 'none'; }
    function autoConvert(s, c) {
        const p = document.getElementById(c==='entry'?'entryPV':'calcPV'), b = document.getElementById(c==='entry'?'entryBV':'calcBV');
        if(s==='pv') b.value=(parseFloat(p.value)||0)*50; else p.value=(parseFloat(b.value)||0)/50;
    }
    
    function updateNewcomerUplineSelect() {
        const sel = document.getElementById('newcomerUpline');
        sel.innerHTML = members.map(m => `<option value="${m.id}">${m.name} (${m.id})</option>`).join('');
        if(document.getElementById('entryMember').value !== 'new_mode') sel.value = document.getElementById('entryMember').value;
    }

    // V3.7: ç•¢æ¥­è·³è„«é¸å–®èˆ‡åˆ‡æ›
    function updateMemberSelects() {
        const month = document.getElementById('entryDate').value.slice(0,7);
        const stats = calculateMonthlyStats(month);
        const cur = document.getElementById('entryMember').value;

        // åƒ…é¸å–ï¼š1. åƒåŠ ä¸­ 2. ç•¶æœˆ PV < 1000
        const active = members.filter(m => {
            const stat = stats.find(s => s.id === m.id);
            return m.isNewStar && (!stat || stat.pv < 1000);
        });

        let h = '<option value="" disabled selected>-- é¸æ“‡æ“ä½œæœƒå“¡ --</option><option value="new_mode">+ æ–°å¢æœƒå“¡...</option>';
        h += active.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        document.getElementById('entryMember').innerHTML = h;
        
        document.getElementById('filterMember').innerHTML = '<option value="all">å…¨éƒ¨æœƒå“¡</option>' + members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        updateNewcomerUplineSelect();
    }

    function updateSponsorSelects() {
        let h = sponsors.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('newMemSponsor').innerHTML = h;
        document.getElementById('quickNewMemSponsor').innerHTML = h;
    }

    function toggleNewStar(id) {
        const m = members.find(m => m.id === id);
        if(m) { m.isNewStar = !m.isNewStar; saveToCloud(); }
    }

    // --- Renderers ---
    function renderMembers() {
        document.querySelector('#memberTable tbody').innerHTML = members.map(m => {
            const sp = sponsors.find(s=>s.id===m.sponsorId)?.name || '-';
            const ns = m.isNewStar ? '<span class="status-active">åƒåŠ ä¸­</span>' : '<span class="status-inactive">æœªåƒåŠ </span>';
            return `<tr><td>${m.id}</td><td>${m.name}</td><td>${ns}</td><td>${sp}</td><td><button class="btn btn-outline btn-sm" onclick="toggleNewStar('${m.id}')">åˆ‡æ›ç‹€æ…‹</button></td></tr>`;
        }).join('');
    }

    function renderLogs() {
        const m = document.getElementById('filterMonth').value;
        const mid = document.getElementById('filterMember').value;
        let d = logs.filter(l => (!m || l.date.startsWith(m)) && (mid==='all' || l.memberId===mid));
        d.sort((a,b) => new Date(b.date) - new Date(a.date));
        document.querySelector('#logTable tbody').innerHTML = d.map(l => `<tr><td>${l.date}</td><td>${members.find(x=>x.id===l.memberId)?.name||l.memberId}</td><td><span class="badge badge-${l.type}">${l.type}</span></td><td>${l.details}</td><td>${l.type==='newcomer'?'$'+Math.round(l.newcomerData.bv*0.01):'-'}</td><td><button onclick="deleteLog(${l.id})"><i class="fas fa-trash"></i></button></td></tr>`).join('');
    }

    function renderSponsors() {
        document.querySelector('#sponsorTable tbody').innerHTML = sponsors.map(s => `<tr><td>${s.id}</td><td>${s.name}</td><td><button onclick="deleteSponsor('${s.id}')">åˆªé™¤</button></td></tr>`).join('');
    }

    function renderNetwork() {
        const container = document.getElementById('treeContainer');
        function build(id, name) {
            let html = `<div class="tree-node"><div class="tree-content">#${id} ${name}</div>`;
            const children = logs.filter(l => l.type==='newcomer' && l.newcomerData.uplineId===id).map(l=>l.newcomerData);
            children.forEach(c => html += build(c.id, c.name));
            return html + '</div>';
        }
        let full = "";
        sponsors.forEach(s => {
            full += `<div class="tree-node tree-root"><div class="tree-content"><i class="fas fa-crown"></i> ${s.name}</div>`;
            members.filter(m => m.sponsorId === s.id).forEach(m => {
                if(!logs.some(l => l.type==='newcomer' && l.newcomerData.id === m.id)) full += build(m.id, m.name);
            });
            full += '</div>';
        });
        container.innerHTML = full || "å°šç„¡è³‡æ–™";
    }

    // --- Calculation Engine ---
    function calculateMonthlyStats(mStr) {
        let res = [];
        members.forEach(m => {
            const myLogs = logs.filter(l => l.date.startsWith(mStr) && l.memberId === m.id);
            let pv = myLogs.filter(l=>l.type==='sales').reduce((a,b)=>a+b.pv,0);
            let news = myLogs.filter(l=>l.type==='newcomer').map(l=>l.newcomerData);
            let bonus = Math.floor((pv*50*(pv>=600?0.01:0.03)) + news.reduce((a,b)=>a+(b.bv*0.01),0));
            res.push({id: m.id, name: m.name, pv, bonus, isNS: m.isNewStar});
        });
        return res;
    }

    function renderDashboard() {
        const stats = calculateMonthlyStats(document.getElementById('dashMonthSelect').value);
        const graduates = stats.filter(s => s.pv >= 1000);
        document.getElementById('graduationList').innerHTML = graduates.length ? graduates.map(g => `<span class="graduate-badge"><i class="fas fa-graduation-cap"></i> ${g.name} (${g.pv} PV)</span>`).join(' ') : "å°šç„¡äººç•¢æ¥­";
        
        document.getElementById('totalPVDisplay').innerText = stats.reduce((a,b)=>a+b.pv,0).toLocaleString();
        document.getElementById('totalBonusDisplay').innerText = "$"+stats.reduce((a,b)=>a+b.bonus,0).toLocaleString();
        document.getElementById('activeMembersDisplay').innerText = `${stats.filter(s=>s.isNS).length}/${members.length}`;
        
        document.querySelector('#rankingTable tbody').innerHTML = stats.filter(s=>s.isNS).sort((a,b)=>b.bonus-a.bonus).slice(0,10).map((s,i)=>`<tr><td>${i+1}</td><td>${s.name} ${s.pv>=1000?'ğŸ“':''}</td><td>${s.pv}</td><td>${s.pv>=600?'6%éšæ®µ':'èµ·æ­¥æœŸ'}</td><td>$${s.bonus}</td></tr>`).join('');
    }

    function runSimulation() {
        const pv = parseFloat(document.getElementById('calcPV').value)||0;
        document.getElementById('simValTotal').innerText = "$" + Math.floor(pv*50*(pv>=600?0.01:0.03)).toLocaleString();
    }

    function populateMonthSelect() {
        const s = document.getElementById('dashMonthSelect');
        for(let i=1;i<=12;i++) s.add(new Option(`2026-${i.toString().padStart(2,'0')}`, `2026-${i.toString().padStart(2,'0')}`));
        s.value = new Date().toISOString().slice(0,7);
    }
    function addSponsor() {
        const n = document.getElementById('newSponsorName').value, i = document.getElementById('newSponsorID').value;
        if(n&&i){ sponsors.push({id:i, name:n}); saveToCloud(); }
    }
    function deleteMember(id){ if(confirm("åˆª?")){members=members.filter(m=>m.id!==id); saveToCloud();} }
    function deleteLog(id){ if(confirm("åˆª?")){logs=logs.filter(l=>l.id!==id); saveToCloud();} }
    function clearAllData(){ if(prompt("DELETEç¢ºèª")==='DELETE'){db.collection("newstar").doc(TEAM_ID).set({members:[],logs:[],sponsors:[]}); location.reload();}}
    function exportPDF(){ const e=document.getElementById('dashboard'); html2pdf().set({margin:0.2,filename:'TeamReport.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'in',format:'a4',orientation:'landscape'}}).from(e).save(); }
</script>
</body>
</html>
