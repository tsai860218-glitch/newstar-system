<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ± (v3.5 é‚è¼¯æ ¸å¿ƒç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            /* æ ¸å¿ƒè‰²ç³» */
            --primary: #2c3e50;       
            --primary-light: #34495e; 
            --accent: #00b894;        
            --accent-hover: #00a884;
            
            /* ç‹€æ…‹è‰² */
            --success-bg: #e6f7ef; --success-text: #00b894;
            --danger-bg: #fff0f0;  --danger-text: #e15f5f;
            --warning-bg: #fff8e1; --warning-text: #f39c12;
            --gray-bg: #f1f3f5;    --gray-text: #adb5bd;
            --info-bg: #e3f2fd;    --info-text: #0984e3;
            
            /* ç¨ç«‹è¨ˆç•«å°ˆç”¨è‰² (é‡‘/ç´«) */
            --indep-border: #f1c40f;
            --indep-bg: #fef9e7;
            
            /* ä»‹é¢è‰² */
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --border: #dfe6e9;
            
            /* é™°å½±èˆ‡åœ“è§’ */
            --radius: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; display: flex; height: 100vh; background-color: var(--bg-body); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }

        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 600; color: var(--primary); }
        .text-sub { color: var(--text-sub); font-size: 0.9rem; }

        /* Sidebar */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: all 0.3s ease; z-index: 100; box-shadow: 4px 0 10px rgba(0,0,0,0.05); }
        aside.collapsed { width: 0; padding: 0; opacity: 0; overflow: hidden; }
        aside h2 { padding: 0 20px; height: 64px; display: flex; align-items: center; gap: 12px; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.1); color: #fff; letter-spacing: 0.5px; }
        aside nav { flex: 1; overflow-y: auto; padding: 15px 10px; }
        aside nav a { display: flex; align-items: center; padding: 12px 15px; color: #b2bec3; text-decoration: none; transition: 0.2s; border-radius: var(--radius); margin-bottom: 4px; font-size: 0.95rem; font-weight: 500; }
        aside nav a:hover { background: rgba(255,255,255,0.08); color: white; }
        aside nav a.active { background: var(--accent); color: white; box-shadow: 0 2px 8px rgba(0,184,148,0.3); }
        aside .footer { padding: 20px; font-size: 0.75rem; color: #636e72; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.1); }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 25px 30px; position: relative; transition: margin 0.3s; scroll-behavior: smooth; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; padding-bottom: 15px; border-bottom: 1px dashed var(--border); }
        .menu-btn { background: white; border: 1px solid var(--border); width: 36px; height: 36px; border-radius: var(--radius); cursor: pointer; color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s; box-shadow: var(--shadow-sm); }
        h1 { font-size: 1.5rem; letter-spacing: -0.5px; }
        .page-desc { display: block; margin-top: -10px; margin-bottom: 20px; color: var(--text-sub); font-size: 0.9rem; padding-left: 5px; }

        /* UI Components */
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 25px; margin-bottom: 25px; border: 1px solid var(--border); transition: 0.3s; }
        .btn { padding: 9px 18px; border: none; border-radius: var(--radius); cursor: pointer; font-size: 0.92rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; font-weight: 500; letter-spacing: 0.3px; line-height: 1.2; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 2px 6px rgba(0,184,148,0.25); } .btn-primary:hover { background: var(--accent-hover); }
        .btn-danger { background: #fff; color: var(--danger-text); border: 1px solid #fab1a0; } .btn-danger:hover { background: var(--danger-bg); border-color: var(--danger-text); }
        .btn-secondary { background: #fff; color: var(--text-sub); border: 1px solid var(--border); } .btn-secondary:hover { background: var(--gray-bg); color: var(--text-main); border-color: #ced6e0; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; transition: all 0.2s; background: #fff; color: var(--text-main); }
        .form-control:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,184,148,0.1); }
        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 220px; }

        /* Badges */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; min-width: 65px; border: 1px solid transparent; }
        .status-active { background: var(--success-bg); color: var(--success-text); border-color: rgba(0,184,148,0.2); }
        .status-inactive { background: var(--gray-bg); color: var(--text-sub); border-color: var(--border); }
        .status-paid { background: #d1f2eb; color: #0e6655; border-color: #a3e4d7; }
        .status-unpaid { background: var(--danger-bg); color: var(--danger-text); border-color: #fadbd8; }
        .status-month-inactive { background: var(--warning-bg); color: var(--warning-text); border-color: #ffe0b2; }
        .status-indep { background: var(--indep-bg); color: #f39c12; border: 1px solid #f1c40f; }

        /* Tables */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 5px; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--text-sub); text-transform: uppercase; font-size: 0.8rem; padding: 12px 15px; border-bottom: 2px solid var(--border); text-align: left; letter-spacing: 0.5px; }
        td { padding: 16px 15px; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text-main); font-size: 0.95rem; }
        tr:hover td { background-color: #fcfcfc; }

        /* Dashboard & Toolbar */
        .summary-row { display: flex; gap: 25px; margin-bottom: 25px; flex-wrap: wrap; }
        .summary-card { flex: 1; min-width: 240px; background: white; padding: 25px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); display: flex; flex-direction: column; justify-content: space-between; border-top: 4px solid transparent; position: relative; overflow: hidden; }
        .summary-card.green { border-top-color: var(--accent); }
        .summary-card.red { border-top-color: var(--danger); }
        .summary-val { font-size: 2.2rem; font-weight: 700; color: var(--primary); letter-spacing: -1px; }
        .summary-label { font-size: 0.9rem; color: var(--text-sub); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        
        .toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; background: white; padding: 15px 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); margin-bottom: 25px; border: 1px solid var(--border); }
        .toolbar input, .toolbar select { width: auto; min-width: 140px; flex: 1; border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 12px; }

        /* Modal & Preview */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(44, 62, 80, 0.6); backdrop-filter: blur(3px); }
        .modal-content { background-color: #fff; margin: 2vh auto; padding: 0; border: none; width: 95%; max-width: 1000px; border-radius: var(--radius-lg); max-height: 96vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 18px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; background: #fcfcfc; }
        
        .record-modal-grid { display: flex; gap: 30px; align-items: flex-start; }
        .record-form-col { flex: 1.5; min-width: 320px; }
        .record-preview-col { flex: 1; min-width: 300px; position: sticky; top: 0; }
        fieldset { border: 1px solid var(--border); background: white; padding: 20px 25px; margin-bottom: 20px; border-radius: var(--radius); box-shadow: var(--shadow-sm); }
        legend { font-weight: 700; color: var(--primary); font-size: 1rem; padding: 0 10px; margin-left: -10px; margin-bottom: 15px; display: inline-block; width: auto; }

        .preview-card { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 25px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .preview-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: var(--accent); }
        .preview-amount-big { font-size: 2.8rem; font-weight: 700; color: var(--accent); text-align: right; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; line-height: 1; letter-spacing: -1px; }
        .preview-amount-big.zero { color: #dcdde1; }
        .preview-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: var(--text-main); }
        .preview-details { margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--border); background: #fafafa; padding: 15px; border-radius: var(--radius); font-size: 0.85rem; color: var(--text-sub); }

        /* FAQ Accordion */
        .faq-item { border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 12px; overflow: hidden; background: white; }
        .faq-question { padding: 18px 20px; background: #fff; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center; color: var(--primary); transition: 0.2s; }
        .faq-question:hover { background: #f8f9fa; }
        .faq-answer { display: none; padding: 20px; border-top: 1px solid #eee; color: #555; font-size: 0.95rem; line-height: 1.7; background: #fff; }
        .faq-item.active .faq-answer { display: block; } .faq-item.active .faq-question { color: var(--accent); }

        /* Org Chart Nodes */
        .org-container { overflow: auto; padding: 50px 20px; height: 650px; background: white; border-radius: var(--radius-lg); box-shadow: inset 0 0 30px rgba(0,0,0,0.02); border: 1px solid var(--border); text-align: center; }
        .tree ul { padding-top: 20px; position: relative; display: inline-flex; justify-content: center; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #ccc; width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 1px solid #ccc; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 1px solid #ccc; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #ccc; width: 0; height: 20px; }

        .node { border: 2px solid #ddd; padding: 10px 15px; text-decoration: none; color: var(--text-main); display: inline-block; border-radius: 10px; transition: all 0.3s; min-width: 140px; position: relative; cursor: pointer; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .node:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); z-index: 20; border-color: var(--accent); }
        .node .name { font-weight: 700; font-size: 14px; margin-bottom: 5px; display: block; }
        .node .status { font-size: 12px; font-weight: 600; color: var(--text-sub); }
        .node .icon { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.15); border: 2px solid white; }
        .node .owner-tag { display: block; font-size: 10px; color: #aaa; margin-top: 4px; padding-top: 4px; border-top: 1px dashed #eee; }
        
        .node.unpaid { border-color: var(--danger-text); background: #fff5f5; } .node.unpaid .status { color: var(--danger-text); } .node.unpaid .icon { background-color: var(--danger-text); }
        .node.paid { border-color: var(--accent); background: #f0fffa; } .node.paid .status { color: var(--accent); } .node.paid .icon { background-color: var(--accent); }
        .node.inactive { border-color: #dfe6e9; background: #f8f9fa; opacity: 0.8; } .node.inactive .name { color: #b2bec3; text-decoration: line-through; }
        .node.graduate { border-color: #0984e3; background: #eaf6ff; } .node.graduate .icon { background: #0984e3; }
        .node.month-inactive { border: 2px dashed #95a5a6; background-color: #fff; } .node.month-inactive .status { color: #95a5a6; font-weight: normal; }
        .node.independent { box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.3); border-color: #f1c40f; } .node.independent .icon { background: #f1c40f; }
        .node.out-scope { opacity: 0.5; border-style: dotted; }

        .node .tooltip { visibility: hidden; width: 220px; background-color: rgba(44, 62, 80, 0.95); color: #fff; text-align: left; border-radius: 6px; padding: 12px; position: absolute; z-index: 100; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: 0.3s; font-size: 0.85rem; line-height: 1.5; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .node:hover .tooltip { visibility: visible; opacity: 1; bottom: 135%; }
        .node .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: rgba(44, 62, 80, 0.95) transparent transparent transparent; }

        /* Loading */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .spinner { border: 4px solid rgba(0,0,0,0.05); width: 48px; height: 48px; border-radius: 50%; border-left-color: var(--accent); animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            aside { width: 100%; height: 60px; position: sticky; top: 0; flex-direction: row; padding: 0 15px; }
            aside nav { display: none; position: absolute; top: 60px; left: 0; right: 0; background: var(--primary); padding: 10px; }
            aside.mobile-open nav { display: block; }
            main { padding: 15px; height: auto; }
            .record-modal-grid { flex-direction: column-reverse; }
            .record-preview-col { position: static; width: 100%; margin-bottom: 20px; }
            .modal-actions-bar { position: sticky; bottom: 0; background: white; padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; z-index: 100; box-shadow: 0 -4px 15px rgba(0,0,0,0.05); }
            .modal-actions-bar .btn { flex: 1; }
            .desktop-actions { display: none; }
        }
    </style>
</head>
<body>

<div id="loading-screen"><div class="spinner"></div></div>

<aside id="sidebar">
    <h2>ğŸš€ æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«</h2>
    <button class="menu-btn" style="color:white;border:none;background:transparent" onclick="document.getElementById('sidebar').classList.toggle('mobile-open')">â˜°</button>
    <nav>
        <a onclick="router('dashboard')" id="nav-dashboard">ğŸ“Š ç¸½è¦½å„€è¡¨æ¿</a>
        <a onclick="router('records')" id="nav-records">ğŸ“ æœˆä»½æ¥­ç¸¾ç´€éŒ„</a>
        <a onclick="router('payout')" id="nav-payout">ğŸ’° æœ¬æœˆç™¼æ”¾ç¸½è¡¨</a>
        <a onclick="router('partners')" id="nav-partners">ğŸ‘¥ å¤¥ä¼´åå–®ç®¡ç†</a>
        <a onclick="router('initiators')" id="nav-initiators">ğŸ‘” ç™¼èµ·äººç®¡ç†</a>
        <a onclick="router('org')" id="nav-org">ğŸŒ³ çµ„ç¹”é—œè¯åœ–</a>
        <a onclick="router('versions')" id="nav-versions">âš™ï¸ è¨ˆç•«ç‰ˆæœ¬æ§ç®¡</a>
        <a onclick="router('settings')" id="nav-settings">ğŸ› ï¸ ç³»çµ±è¨­å®š</a>
        <a onclick="router('faq')" id="nav-faq">â“ ç³»çµ±èªªæ˜ (FAQ)</a>
    </nav>
    <div class="footer">v3.5 é‚è¼¯æ ¸å¿ƒç‰ˆ</div>
</aside>

<main id="app"></main>

<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="modal-title"></h2><span class="close" onclick="closeModalSafe()">Ã—</span></div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<script>
/** FIREBASE CONFIG */
const firebaseConfig = { apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4", authDomain: "newstar-system.firebaseapp.com", projectId: "newstar-system", storageBucket: "newstar-system.firebasestorage.app", messagingSenderId: "889699172174", appId: "1:889699172174:web:0ff42757035a879cb3281f", databaseURL: "https://newstar-system-default-rtdb.asia-southeast1.firebasedatabase.app" };
try { firebase.initializeApp(firebaseConfig); var db = firebase.database(); var isFirebaseReady = true; } catch(e) { document.getElementById('loading-screen').innerHTML = '<h3 style="color:#e74c3c">âš ï¸ é€£ç·šéŒ¯èª¤</h3>'; }

const defaultPlanParams = { rate_0_3_base: 0.03, rate_0_3_rec: 0.04, rate_6_base: 0.01, rate_6_rec: 0.02, rate_recruit_bv: 0.01, rate_learning: 0.03 };
let appData = { partners: [], initiators: [], records: [], versions: [], coachingScopes: [] };

const store = {
    data: appData,
    init() {
        if (!isFirebaseReady) return;
        db.ref('AmwaySystem/v1').on('value', (snapshot) => {
            const val = snapshot.val();
            if (val) {
                this.data = val;
                ['partners','initiators','records','versions','coachingScopes'].forEach(k => { if(!this.data[k]) this.data[k] = []; });
            } else {
                this.data.versions.push({ id: generateUUID(), name: 'é è¨­ç‰ˆæœ¬', createdAt: new Date().toISOString(), params: { ...defaultPlanParams } });
                this.save();
            }
            document.getElementById('loading-screen').style.display = 'none';
            const activeNav = document.querySelector('aside nav a.active');
            router(activeNav ? activeNav.id.replace('nav-', '') : 'dashboard');
        });
    },
    save() { if(isFirebaseReady) db.ref('AmwaySystem/v1').set(this.data); },
    getPartner(id) { return this.data.partners.find(p => p.id === id); },
    getInitiator(id) { return this.data.initiators.find(i => i.id === id); },
    getRecord(id) { return this.data.records.find(r => r.id === id); },
    getRecordsByMonth(month) { return this.data.records.filter(r => r.month === month); },
    getVersion(id) { return this.data.versions.find(v => v.id === id) || this.data.versions[0]; },
    getCoachingScope(initiatorId) { return this.data.coachingScopes.find(c => c.initiatorId === initiatorId) || { initiatorId, roots: [], depth: 5 }; }
};
store.init();

/* Logic: 3-Wide 5-Deep & Independent Plan */
function getAttribution(partnerId) {
    let current = partnerId;
    let depth = 0;
    let ownerId = null;
    let isIndependent = false;
    let path = [];

    // 1. Trace up to find owner (Cut Rule)
    while (current) {
        const p = store.getPartner(current);
        if (!p) break;
        path.push(p);
        if (p.planRole === 'initiator_root') {
            ownerId = p.id;
            isIndependent = true;
            break;
        }
        current = p.sponsorId;
        depth++;
    }
    
    // Fallback to system initiator
    if (!ownerId) {
        const target = store.getPartner(partnerId);
        ownerId = target ? target.initiatorId : null;
        isIndependent = false;
    }

    // 2. Check Scope
    let isWithinScope = false;
    if (ownerId) {
        // If owner is a partner (Independent), they are the root.
        // If owner is system initiator, check configured roots.
        const ownerPartner = store.getPartner(ownerId);
        let roots = [];
        
        if (ownerPartner) {
            roots = [ownerId]; // Independent partner is their own root
        } else {
            const scope = store.getCoachingScope(ownerId);
            roots = scope.roots || [];
        }

        // Check if partnerId is descendant of any root within 5 levels
        // Simplified check: since we already traced up in 'path', check if any node in path is a root
        // and if distance <= 5
        
        // However, 'path' only goes up to the cut. 
        // We need to see if the top of the path connects to a root.
        
        // Correct approach:
        // Find if partnerId is under any of the 'roots' with distance <= 5
        // AND ensuring no other 'initiator_root' is in between (already handled by step 1 finding nearest owner)
        
        // Traverse up from partnerId again
        let p = store.getPartner(partnerId);
        let d = 1;
        while(p && d <= 5) {
            if (roots.includes(p.id)) {
                isWithinScope = true;
                break;
            }
            if (p.id !== partnerId && p.planRole === 'initiator_root') break; // Cut
            p = store.getPartner(p.sponsorId);
            d++;
        }
    }

    return { ownerId, isIndependentOwner: !!store.getPartner(ownerId), isWithinScope };
}

function calculateCore(r, partner) {
    if (!partner) return null;
    const version = store.getVersion(r.planVersionId);
    const params = version.params;
    const myRate = (r.gpv>=10000?0.21:r.gpv>=7000?0.18:r.gpv>=4000?0.15:r.gpv>=2000?0.12:r.gpv>=1000?0.09:r.gpv>=600?0.06:r.gpv>=200?0.03:0);
    
    // Attribution
    const attr = getAttribution(partner.id);
    const planOwnerId = attr.ownerId;
    const isWithinScope = attr.isWithinScope;

    let starTotal=0, baseBonus=0, recruitBonus=0, learningBonus=0;
    let isGraduated = r.gpv >= 1000;
    let isPartnerInactive = partner.status === 'inactive';
    let isMonthlyInactive = r.participation === 'inactive';
    
    // ğŸ”¥ Eligibility: Must be Active + Not Graduated + Within Scope
    let isEligible = !isGraduated && !isMonthlyInactive && !isPartnerInactive && isWithinScope;
    let appliedRateText = '0%', calcBaseBV = 0;

    if (isEligible) {
        const hasRecruit = (r.newRecruits||[]).length > 0;
        let appliedRate = 0;
        if (myRate <= 0.03) { appliedRate = hasRecruit ? params.rate_0_3_rec : params.rate_0_3_base; appliedRateText = hasRecruit ? 'å«æ¨è–¦ (0-3%)' : 'åŸºç¤ (0-3%)'; }
        else if (myRate === 0.06) { appliedRate = hasRecruit ? params.rate_6_rec : params.rate_6_base; appliedRateText = hasRecruit ? 'å«æ¨è–¦ (6%)' : 'åŸºç¤ (6%)'; }
        else { isEligible = false; }

        if (isEligible) {
            const legDetails = (r.legs||[]).map(l=>({...l}));
            const independentLegsBV = legDetails.filter(l => l.isIndependent).reduce((sum, l) => sum + (Number(l.bv)||0), 0);
            calcBaseBV = Math.max(0, (r.gpv * 50) - independentLegsBV);
            baseBonus = calcBaseBV * appliedRate;
            const newRecruitTotalBV = (r.newRecruits||[]).reduce((sum, nr) => sum + (Number(nr.bv)||0), 0);
            recruitBonus = newRecruitTotalBV * params.rate_recruit_bv;
            if (r.learningDone) learningBonus = (baseBonus + recruitBonus) * params.rate_learning;
            starTotal = baseBonus + recruitBonus + learningBonus;
        }
    }
    
    return { ...r, partnerName: partner.name+' '+partner.code, initiatorId: partner.initiatorId, myRate, isGraduated, isPartnerInactive, isMonthlyInactive, isEligible, appliedRateText, calcBaseBV, baseBonus, recruitBonus, learningBonus, starTotal, totalIncome: starTotal, planOwnerId, isWithinScope };
}
function calculateRecord(r) { return calculateCore(r, store.getPartner(r.partnerId)); }
function calculatePreview(r) { let p = store.getPartner(r.partnerId) || { name:'', code:'', initiatorId:'', status:'active' }; return calculateCore(r, p); }

/* Routing */
function router(page) {
    document.querySelectorAll('aside nav a').forEach(a => a.classList.remove('active'));
    if(document.getElementById('nav-'+page)) document.getElementById('nav-'+page).classList.add('active');
    document.getElementById('sidebar').classList.remove('mobile-menu-open');
    app.innerHTML = '';
    window['render'+page.charAt(0).toUpperCase()+page.slice(1)]();
}

/* 1. Dashboard */
function renderDashboard() {
    const month = new Date().toISOString().slice(0, 7);
    const records = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x); 
    const total = records.reduce((s, r) => s + r.starTotal, 0);
    const unpaid = records.filter(r => r.payoutStatus !== 'paid' && r.totalIncome > 0).length;
    app.innerHTML = `<header>${getHeaderHtml(`ç¸½è¦½å„€è¡¨æ¿ (${month})`)}</header>
        <div class="summary-row">
            <div class="summary-card green"><div class="summary-label">æœ¬æœˆé ä¼°å›é¥‹</div><div class="summary-val">${formatMoney(total)}</div></div>
            <div class="summary-card red"><div class="summary-label">å¾…ç™¼æ”¾äººæ•¸</div><div class="summary-val">${unpaid} äºº</div></div>
        </div>`;
}

/* 2. Partners (Add Role Setting) */
function renderPartners() {
    const term = localStorage.getItem('p_search') || '';
    const list = store.data.partners.filter(p => p.code.includes(term)||p.name.includes(term));
    app.innerHTML = `<header>${getHeaderHtml('å¤¥ä¼´åå–®')}</header>
    <div class="toolbar"><input type="text" placeholder="ğŸ” æœå°‹" value="${term}" oninput="localStorage.setItem('p_search',this.value);renderPartners()">
    <button class="btn btn-primary" onclick="editPartner()">+ æ–°å¢</button></div>
    <div class="card"><table><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>è§’è‰²</th><th>ä¸Šç·š</th><th>ç™¼èµ·äºº(é è¨­)</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>
    ${list.map(p => `<tr><td>${p.code}</td><td>${p.name}</td>
    <td>${p.planRole==='initiator_root'?'<span class="status-badge status-indep">â­ ç¨ç«‹è¨ˆç•«</span>':'ä¸€èˆ¬å¤¥ä¼´'}</td>
    <td>${store.getPartner(p.sponsorId)?.name||'-'}</td><td>${store.getInitiator(p.initiatorId)?.name||'-'}</td>
    <td><span class="status-badge ${p.status==='inactive'?'status-inactive':'status-active'}">${p.status==='active'?'å•Ÿç”¨':'åœç”¨'}</span></td>
    <td><button class="btn btn-secondary btn-sm" onclick="editPartner('${p.id}')">ç·¨è¼¯</button></td></tr>`).join('')}</tbody></table></div>`;
}
function editPartner(id) {
    const p = id ? store.getPartner(id) : {id:'', code:'', name:'', sponsorId:'', initiatorId:'', status:'active', planRole:'none'};
    const partners = store.data.partners.filter(x => x.id !== p.id); const initiators = store.data.initiators;
    openModal(id?'ç·¨è¼¯å¤¥ä¼´':'æ–°å¢å¤¥ä¼´', `<form onsubmit="savePartner(event,'${id||''}')">
    <div class="row"><div class="col"><label>ç·¨è™Ÿ</label><input class="form-control" name="code" value="${p.code}" required></div><div class="col"><label>å§“å</label><input class="form-control" name="name" value="${p.name}" required></div></div>
    <div class="form-group"><label>è¨ˆç•«è§’è‰²</label><select class="form-control" name="planRole"><option value="none" ${p.planRole!=='initiator_root'?'selected':''}>ä¸€èˆ¬å¤¥ä¼´</option><option value="initiator_root" ${p.planRole==='initiator_root'?'selected':''}>â­ ç¨ç«‹è¨ˆç•«åƒèˆ‡è€… (è‡ªå·±æ‰¿æ“”ç™¼æ”¾)</option></select><small class="text-sub">è‹¥è¨­ç‚ºç¨ç«‹ï¼Œå…¶ä¸‹ç·šæ¥­ç¸¾å°‡æ­¸å±¬æ–¼ä»–ï¼Œä¸å†ä¸Šç¹³ã€‚</small></div>
    <div class="row"><div class="col"><label>æ¨è–¦äºº</label><select class="form-control" name="sponsorId"><option value="">-- ç„¡ --</option>${partners.map(o=>`<option value="${o.id}" ${o.id===p.sponsorId?'selected':''}>${o.code} ${o.name}</option>`).join('')}</select></div><div class="col"><label>ç™¼èµ·äºº(è‹¥ç„¡ç¨ç«‹ä¸Šç·šæ™‚)</label><select class="form-control" name="initiatorId" required><option value="">-- è«‹é¸æ“‡ --</option>${initiators.map(o=>`<option value="${o.id}" ${o.id===p.initiatorId?'selected':''}>${o.name}</option>`).join('')}</select></div></div>
    <div class="form-group"><label>ç‹€æ…‹</label><select class="form-control" name="status"><option value="active" ${p.status==='active'?'selected':''}>å•Ÿç”¨</option><option value="inactive" ${p.status==='inactive'?'selected':''}>åœç”¨</option></select></div>
    <button type="submit" class="btn btn-primary" style="width:100%">å„²å­˜</button></form>`);
}
function savePartner(e,id) { e.preventDefault(); const d = Object.fromEntries(new FormData(e.target)); if(id){const i=store.data.partners.findIndex(x=>x.id===id);store.data.partners[i]={...store.data.partners[i],...d}}else{store.data.partners.push({...d,id:generateUUID()})} store.save(); closeModal(); }

/* 3. Records (Show Owner) */
function renderRecords() {
    const month = localStorage.getItem('r_month') || new Date().toISOString().slice(0, 7);
    const list = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x);
    app.innerHTML = `<header>${getHeaderHtml('æœˆä»½æ¥­ç¸¾ç´€éŒ„')}</header>
    <div class="toolbar"><input type="month" value="${month}" onchange="localStorage.setItem('r_month',this.value);renderRecords()"><button class="btn btn-primary" onclick="editRecord(null,'${month}')">ï¼‹ ç´€éŒ„</button></div>
    <div class="card"><table><thead><tr><th>å¤¥ä¼´</th><th>æ­¸å±¬ç™¼èµ·äºº</th><th>å›é¥‹</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>
    ${list.map(r => {
        const owner = store.getInitiator(r.planOwnerId) || store.getPartner(r.planOwnerId);
        const ownerName = owner ? owner.name : '<span style="color:red">ç„¡</span>';
        return `<tr><td>${r.partnerName}</td><td>${ownerName}</td><td style="font-weight:bold;color:var(--primary)">${formatMoney(r.totalIncome)}</td>
        <td>${!r.isEligible ? '<span class="status-badge status-inactive">ä¸è¨ˆ</span>' : '<span class="status-badge status-active">è¨ˆç®—ä¸­</span>'}</td>
        <td><button class="btn btn-secondary btn-sm" onclick="editRecord('${r.id}')">ç·¨è¼¯</button></td></tr>`;
    }).join('')}</tbody></table></div>`;
}

let isModalDirty = false;
let tempRecord = {};
function markDirty() { isModalDirty = true; }

function editRecord(id, month) {
    isModalDirty = false;
    const r = id ? store.getRecord(id) : { id:'', partnerId:'', month, ppv:0, pbv:0, gpv:0, legs:[], newRecruits:[], learningDone:false, participation:'active', payoutStatus:'unpaid', payoutDate: '', planVersionId: store.data.versions.find(v=>!v.archived)?.id, note:'' };
    tempRecord = JSON.parse(JSON.stringify(r));
    const partners = store.data.partners.filter(p => p.status === 'active');
    const versionOptions = store.data.versions.filter(v => !v.archived || v.id === r.planVersionId).map(v => `<option value="${v.id}" ${v.id===r.planVersionId?'selected':''}>${v.name}</option>`).join('');

    openModal(id?'ç·¨è¼¯':'æ–°å¢', `
        <form id="recordForm" onsubmit="saveRecord(event, '${id||''}')">
            <div class="record-modal-grid">
                <div class="record-form-col">
                    <fieldset><legend>åŸºæœ¬</legend>
                        <div class="row"><div class="col"><label>å¤¥ä¼´</label><select class="form-control" name="partnerId" required onchange="tempRecord.partnerId=this.value;renderPreview()"><option value="">--</option>${partners.map(p => `<option value="${p.id}" ${p.id===r.partnerId?'selected':''}>${p.code} ${p.name}</option>`).join('')}</select></div>
                        <div class="col"><label>ç‰ˆæœ¬</label><select class="form-control" name="planVersionId" onchange="tempRecord.planVersionId=this.value;renderPreview()">${versionOptions}</select></div></div>
                    </fieldset>
                    <fieldset><legend>æ¥­ç¸¾</legend>
                        <div class="row"><div class="col"><label>å°çµ„PV</label><input type="number" class="form-control" name="gpv" value="${r.gpv}" required oninput="tempRecord.gpv=Number(this.value);renderPreview()"></div></div>
                    </fieldset>
                    <fieldset><legend>è…¿</legend><div id="legs-container"></div><button type="button" class="btn btn-outline btn-sm" style="margin-top:5px" onclick="addLeg()">+ è…¿</button></fieldset>
                    <fieldset><legend>æ¢ä»¶</legend>
                        <div class="row"><div class="col"><label>ç‹€æ…‹</label><select class="form-control" onchange="tempRecord.participation=this.value;renderPreview()"><option value="active" ${r.participation==='active'?'selected':''}>åƒèˆ‡</option><option value="inactive" ${r.participation==='inactive'?'selected':''}>æœ¬æœˆä¸è¨ˆ</option></select></div>
                        <div class="col"><label style="padding-top:30px"><input type="checkbox" ${r.learningDone?'checked':''} onchange="tempRecord.learningDone=this.checked;renderPreview()"> å­¸ç¿’</label></div></div>
                        <div><label>æ–°äºº</label><div id="recruits-container"></div><button type="button" class="btn btn-outline btn-sm" style="margin-top:5px" onclick="addRecruit()">+ æ–°äºº</button></div>
                    </fieldset>
                </div>
                <div class="record-preview-col"><div id="preview-box" class="preview-card"></div><div class="desktop-actions" style="margin-top:15px;"><button type="submit" class="btn btn-primary" style="width:100%">å„²å­˜</button></div></div>
            </div>
            <div class="modal-actions-bar"><button type="button" class="btn btn-secondary" onclick="closeModalSafe()">é—œé–‰</button><button type="submit" class="btn btn-primary">å„²å­˜</button></div>
        </form>`);
    
    document.getElementById('recordForm').addEventListener('input', markDirty);
    renderLegs(); renderRecruits(); renderPreview();
}

function renderPreview() {
    const res = calculatePreview(tempRecord);
    const box = document.getElementById('preview-box');
    if(!box || !res) return;
    
    // Owner Info
    const owner = store.getInitiator(res.planOwnerId) || store.getPartner(res.planOwnerId);
    const ownerName = owner ? owner.name : 'ç„¡';
    const scopeMsg = res.isWithinScope ? '' : '<div style="color:#e74c3c;font-weight:bold;margin-top:5px;">âŒ è¶…å‡ºè¼”å°ç¯„åœ (3å¯¬5æ·±)</div>';

    let statusHtml = '<span class="status-badge status-active">ğŸŸ¢ å¯ç™¼æ”¾</span>';
    if(!res.isEligible) statusHtml = '<span class="status-badge status-inactive">ğŸš« ä¸è¨ˆ</span>';

    box.innerHTML = `<div class="preview-header"><span>æœ¬æœˆé ä¼°</span> ${statusHtml}</div>
    <div class="preview-amount-big ${res.starTotal===0?'zero':''}">${formatMoney(res.starTotal)}</div>
    <div class="preview-details">
        <div><span>æ­¸å±¬ç™¼èµ·äºº</span><span>${ownerName}</span></div>
        ${scopeMsg}
        ${res.isEligible ? `<div><span>æ¯”ä¾‹</span><span>${res.appliedRateText}</span></div>
        <div><span>åŸºç¤</span><span>${formatMoney(res.baseBonus)}</span></div>
        <div><span>æ–°äºº</span><span>${formatMoney(res.recruitBonus)}</span></div>
        <div><span>å­¸ç¿’</span><span>${formatMoney(res.learningBonus)}</span></div>` : 
        `<div style="color:#999;text-align:center;margin-top:10px">${res.isGraduated?'å·²ç•¢æ¥­':res.isMonthlyInactive?'æœ¬æœˆåœç”¨':'æ¢ä»¶ä¸ç¬¦'}</div>`}
    </div>`;
}

function renderLegs() { document.getElementById('legs-container').innerHTML = tempRecord.legs.map((l, i) => `<div style="display:flex;gap:5px;margin-bottom:5px;"><input style="flex:2" class="form-control" placeholder="è…¿å" value="${l.name}" oninput="tempRecord.legs[${i}].name=this.value"><input style="flex:1.5" type="number" class="form-control" placeholder="PV" value="${l.pv}" oninput="tempRecord.legs[${i}].pv=Number(this.value)"><input style="flex:1.5" type="number" class="form-control" placeholder="BV" value="${l.bv}" oninput="tempRecord.legs[${i}].bv=Number(this.value);renderPreview()"><label style="flex:1;display:flex;align-items:center;font-size:0.8rem"><input type="checkbox" ${l.isIndependent?'checked':''} onchange="tempRecord.legs[${i}].isIndependent=this.checked;renderPreview()"> ç¨ç«‹</label><button type="button" class="btn btn-danger btn-sm" onclick="tempRecord.legs.splice(${i},1);renderLegs();renderPreview();markDirty()">Ã—</button></div>`).join(''); }
function addLeg() { tempRecord.legs.push({ name: '', pv: 0, bv: 0, isIndependent: false }); renderLegs(); renderPreview(); markDirty(); }
function renderRecruits() { document.getElementById('recruits-container').innerHTML = tempRecord.newRecruits.map((r, i) => `<div style="display:flex;gap:5px;margin-bottom:5px;"><input style="flex:2" class="form-control" placeholder="å§“å" value="${r.name}" oninput="tempRecord.newRecruits[${i}].name=this.value"><input style="flex:1.5" type="number" class="form-control" placeholder="BV" value="${r.bv}" oninput="tempRecord.newRecruits[${i}].bv=Number(this.value);renderPreview()"><button type="button" class="btn btn-danger btn-sm" onclick="tempRecord.newRecruits.splice(${i},1);renderRecruits();renderPreview();markDirty()">Ã—</button></div>`).join(''); }
function addRecruit() { tempRecord.newRecruits.push({ name: '', bv: 0 }); renderRecruits(); renderPreview(); markDirty(); }

function saveRecord(e, id) {
    e.preventDefault(); const fd = new FormData(e.target);
    const record = { ...tempRecord, partnerId: fd.get('partnerId'), planVersionId: fd.get('planVersionId'), month: tempRecord.month, ppv: Number(fd.get('ppv')), pbv: Number(fd.get('pbv')), gpv: Number(fd.get('gpv')), note: fd.get('note'), payoutDate: fd.get('payoutDate'), payoutStatus: fd.get('payoutStatus') };
    if(id) { const idx = store.data.records.findIndex(r => r.id === id); store.data.records[idx] = record; }
    else { record.id = generateUUID(); store.data.records.push(record); }
    isModalDirty = false; store.save(); closeModal();
}

/* 5. Payout (Group by Real Owner) */
function renderPayout() {
    const month = localStorage.getItem('pay_month') || new Date().toISOString().slice(0, 7);
    let records = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x);
    
    // Grouping Logic: By planOwnerId
    const groups = {};
    
    records.forEach(r => {
        const ownerId = r.planOwnerId;
        if (!ownerId) { // Orphan
            if (!groups['none']) groups['none'] = { name: 'æœªæŒ‡å®š/ç•°å¸¸', records: [], total:0, paid:0, unpaid:0 };
            groups['none'].records.push(r);
        } else {
            if (!groups[ownerId]) {
                const init = store.getInitiator(ownerId);
                const part = store.getPartner(ownerId);
                const name = init ? `ğŸ‘” ${init.name} (åˆä»£)` : (part ? `â­ ${part.name} (ç¨ç«‹)` : 'æœªçŸ¥');
                groups[ownerId] = { name: name, records: [], total:0, paid:0, unpaid:0 };
            }
            groups[ownerId].records.push(r);
        }
    });

    Object.values(groups).forEach(g => { 
        g.records.forEach(r => { 
            g.total += r.totalIncome; 
            if(r.payoutStatus === 'paid') g.paid += r.totalIncome; else g.unpaid += r.totalIncome; 
        }); 
    });
    
    app.innerHTML = `<header>${getHeaderHtml('æœ¬æœˆç™¼æ”¾ç¸½è¡¨')}</header>
    <div class="toolbar"><input type="month" value="${month}" onchange="localStorage.setItem('pay_month',this.value);renderPayout()">
    <button class="btn btn-secondary" onclick="exportPayoutCSV('${month}')">åŒ¯å‡º CSV</button></div>
    ${Object.values(groups).map(g => `<div class="card">
        <h3 style="border-bottom:2px solid var(--accent);padding-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
        <span>${g.name}</span> <span class="text-sub">æ‡‰ä»˜ï¼š${formatMoney(g.unpaid)} / å·²ä»˜ï¼š${formatMoney(g.paid)}</span></h3>
        <table><thead><tr><th>å¤¥ä¼´</th><th>å›é¥‹</th><th>ç‹€æ…‹</th><th>ç™¼æ”¾</th></tr></thead><tbody>
        ${g.records.map(r => `<tr><td>${r.partnerName}</td><td style="font-weight:bold">${formatMoney(r.totalIncome)}</td>
        <td>${!r.isWithinScope ? '<span class="status-badge status-inactive">è¶…å‡ºç¯„åœ</span>' : (!r.isEligible ? '<span class="status-badge status-inactive">ä¸è¨ˆ</span>' : '<span class="status-badge status-active">å¯ç™¼</span>')}</td>
        <td><button class="btn ${r.payoutStatus==='paid'?'btn-primary':'btn-outline'} btn-sm" onclick="togglePaid('${r.id}','${r.payoutStatus}')">${r.payoutStatus==='paid'?'å·²ç™¼æ”¾':'æœªç™¼æ”¾'}</button></td></tr>`).join('')}</tbody></table></div>`).join('')}`;
}
function togglePaid(id, status) { const r = store.getRecord(id); r.payoutStatus = status==='unpaid'?'paid':'unpaid'; store.save(); renderPayout(); }
function exportPayoutCSV(month) { const records = store.getRecordsByMonth(month).map(calculateRecord).filter(x=>x); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob(['\uFEFFæœˆä»½,ç™¼èµ·äºº,å¤¥ä¼´,é‡‘é¡,ç‹€æ…‹\n'+records.map(r=>`${r.month},${r.planOwnerId},${r.partnerName},${r.starTotal},${r.payoutStatus}`).join('\n')], { type: 'text/csv;charset=utf-8;' })); link.download = `Payout_${month}.csv`; link.click(); }

/* 6. Org Chart (Logic Updated) */
function renderOrgChart() {
    const month = localStorage.getItem('org_month') || new Date().toISOString().slice(0, 7);
    const partners = store.data.partners; const records = store.getRecordsByMonth(month).map(calculateRecord);
    const partnerMap = {}; partners.forEach(p => { partnerMap[p.id] = { ...p, children: [], record: records.find(r => r && r.partnerId === p.id) }; });
    const roots = []; partners.forEach(p => { if(p.sponsorId && partnerMap[p.sponsorId]) partnerMap[p.sponsorId].children.push(partnerMap[p.id]); else roots.push(partnerMap[p.id]); });
    const activeScopeId = localStorage.getItem('active_scope_initiator');
    
    function renderNode(node) {
        const r = node.record;
        let classes = ['node']; 
        let label = r ? formatMoney(r.totalIncome) : 'ç„¡';
        let tooltip = '';

        // Style logic
        if (node.planRole === 'initiator_root') classes.push('independent');
        if (r && !r.isWithinScope) classes.push('out-scope');
        
        // Owner Check (Visual Aid)
        let ownerTag = '';
        if (r && r.planOwnerId) {
            const owner = store.getInitiator(r.planOwnerId) || store.getPartner(r.planOwnerId);
            if (owner) ownerTag = `<span class="owner-tag">æ­¸å±¬: ${owner.name}</span>`;
        }

        return `<li><div class="${classes.join(' ')}" onclick="showNodeDetails('${node.id}','${month}')">
            ${node.planRole==='initiator_root' ? '<div class="icon">â­</div>' : ''}
            <div class="name">${node.name}</div>
            <div class="status">${label}</div>
            ${ownerTag}
        </div>${node.children.length>0 ? `<ul>${node.children.map(renderNode).join('')}</ul>` : ''}</li>`;
    }

    app.innerHTML = `<header>${getHeaderHtml('çµ„ç¹”é—œè¯åœ–')}</header>
    <div class="toolbar"><input type="month" value="${month}" onchange="localStorage.setItem('org_month',this.value);renderOrgChart();">
    <select onchange="localStorage.setItem('active_scope_initiator',this.value);renderOrgChart();"><option value="">-- å…¨è¦½ --</option>${store.data.initiators.map(i=>`<option value="${i.id}" ${i.id===activeScopeId?'selected':''}>${i.name}</option>`).join('')}</select></div>
    <div class="org-container"><div class="tree"><ul>${roots.map(renderNode).join('')}</ul></div></div>`;
}
function showNodeDetails(pid, month) {
    const r = store.data.records.find(r => r.partnerId === pid && r.month === month);
    const p = store.getPartner(pid);
    if(!r) return confirm('ç„¡ç´€éŒ„ï¼Œå»ºç«‹ï¼Ÿ') ? (closeModal(), router('records'), setTimeout(() => editRecord(null, month), 100)) : null;
    const calc = calculateRecord(r);
    openModal(`${p.name} - ${month}`, `<table class="table"><tr><th>PV</th><td>${calc.gpv}</td></tr><tr><th>æ­¸å±¬</th><td>${calc.planOwnerId}</td></tr><tr><th>ç‹€æ…‹</th><td>${calc.isWithinScope?'ç¯„åœå…§':'âŒ è¶…å‡ºç¯„åœ'}</td></tr></table>`);
}

/* Other Pages */
function renderInitiators() { app.innerHTML = `<header>${getHeaderHtml('ç™¼èµ·äººç®¡ç†')} <button class="btn btn-primary" onclick="editInitiator()">+ æ–°å¢</button></header><div class="card"><table><thead><tr><th>å§“å</th><th>æ“ä½œ</th></tr></thead><tbody>${store.data.initiators.map(i=>`<tr><td>${i.name}</td><td><button class="btn btn-sm btn-secondary" onclick="editInitiator('${i.id}')">ç·¨è¼¯</button></td></tr>`).join('')}</tbody></table></div>`; }
function editInitiator(id) { const i = id?store.getInitiator(id):{id:'',code:'',name:''}; openModal(id?'ç·¨è¼¯':'æ–°å¢', `<form onsubmit="saveInitiator(event,'${id||''}')"><div class="form-group"><label>å§“å</label><input class="form-control" name="name" value="${i.name}" required></div><button class="btn btn-primary" style="width:100%">å„²å­˜</button></form>`); }
function saveInitiator(e,id) { e.preventDefault(); const d=Object.fromEntries(new FormData(e.target)); if(id){const x=store.data.initiators.findIndex(k=>k.id===id);store.data.initiators[x]={...store.data.initiators[x],...d}}else{store.data.initiators.push({...d,id:generateUUID()})} store.save(); closeModal(); }
function renderVersions() { app.innerHTML = `<header>${getHeaderHtml('ç‰ˆæœ¬æ§ç®¡')}</header><div class="card"><p>ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½èˆ‡åƒæ•¸è¨­å®š</p></div>`; }
function renderSettings() { app.innerHTML = `<header>${getHeaderHtml('ç³»çµ±è¨­å®š')}</header><div class="card"><button class="btn btn-danger" onclick="if(confirm('æ¸…ç©ºï¼Ÿ')) db.ref('AmwaySystem/v1').remove();">æ¸…ç©ºè³‡æ–™</button></div>`; }
function renderFAQ() { app.innerHTML = `<header>${getHeaderHtml('èªªæ˜')}</header><div class="card"><p>é‚è¼¯èªªæ˜ï¼š3å¯¬5æ·±ã€ç¨ç«‹è¨ˆç•«åˆ‡å‰²ã€‚</p></div>`; }

function openModal(title, content) { document.getElementById('modal-title').innerText = title; document.getElementById('modal-body').innerHTML = content; document.getElementById('modal').style.display = 'block'; }
function closeModalSafe() { if(isModalDirty && !confirm('æœ‰æœªå„²å­˜è®Šæ›´ï¼Œç¢ºå®šé›¢é–‹ï¼Ÿ')) return; isModalDirty = false; document.getElementById('modal').style.display = 'none'; }
function closeModal() { document.getElementById('modal').style.display = 'none'; }
function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
function getHeaderHtml(title) { return `<h1><button class="menu-btn" onclick="toggleSidebar()">â˜°</button> ${title}</h1>`; }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
</script>
</body>
</html>
