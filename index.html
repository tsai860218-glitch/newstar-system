<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«ç³»çµ± (v6.1 Product Edition)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0066cc;
            --primary-dark: #004c99;
            --secondary: #ff9900;
            --bg: #f0f2f5;
            --text: #333;
            --border: #e1e1e1;
            --success: #28a745;
            --danger: #dc3545;
            --purple: #6f42c1;
            --gray: #6c757d;
        }

        body { font-family: "Microsoft JhengHei", 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 10;}
        .logo { padding: 25px 20px; font-size: 1.3rem; font-weight: bold; color: var(--primary); border-bottom: 1px solid var(--border); background: #f8f9fa;}
        .nav-item { padding: 16px 20px; cursor: pointer; transition: 0.2s; color: #555; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .nav-item:hover { background: #eef7ff; color: var(--primary); }
        .nav-item.active { background: #eef7ff; color: var(--primary); border-right: 4px solid var(--primary); font-weight: bold; }
        .nav-divider { font-size: 0.8rem; color: #999; padding: 15px 20px 5px; text-transform: uppercase; font-weight: bold; margin-top: 10px;}
        
        /* Main */
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }
        .page-title { font-size: 1.6rem; font-weight: bold; color: #2c3e50; border-left: 5px solid var(--primary); padding-left: 15px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.04); margin-bottom: 25px; border: 1px solid #f0f0f0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }

        /* Inputs */
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 0.95rem; font-weight: 600; color: #4b5563; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .row-inputs { display: flex; gap: 15px; align-items: center; }
        .row-inputs > div { flex: 1; }
        .equal-sign { font-size: 1.5rem; color: #999; font-weight: bold; padding-top: 25px; }

        /* Product Row Styles (New) */
        .prod-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; animation: fadeIn 0.2s; }
        .prod-row input { margin: 0; }

        /* Tree View Styles */
        .tree-node { margin-left: 30px; border-left: 2px dashed #ccc; padding-left: 15px; margin-top: 12px; position: relative; }
        .tree-node::before { content: ""; position: absolute; left: 0; top: 14px; width: 15px; height: 2px; background: #ccc; }
        .tree-content { display: inline-flex; align-items: center; gap: 8px; background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; color: white; font-weight: bold; }
        .tag.in-scope { background: var(--success); }
        .tag.out-scope { background: var(--gray); }
        .tag.cut { background: var(--secondary); color: white; border-radius: 4px; margin-left: 5px; font-size: 0.7rem; padding: 1px 5px; } 
        
        .scope-status { font-size: 0.8rem; color: #666; margin-left: 5px; }
        .scope-status.out { color: var(--danger); font-weight: bold; }
        
        /* View Switcher */
        .view-switch { display:flex; background:#e9ecef; border-radius:8px; padding:4px; margin-bottom:15px; width:fit-content;}
        .view-option { padding:8px 16px; cursor:pointer; border-radius:6px; font-size:0.9rem; font-weight:bold; color:#666; transition:0.2s;}
        .view-option.active { background:white; color:var(--primary); box-shadow:0 2px 4px rgba(0,0,0,0.1); }

        /* Coach Leg Selector */
        .coach-leg-item { display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee; font-size:0.9rem;}
        .coach-leg-item:last-child { border-bottom:none; }
        .cl-check { transform: scale(1.2); cursor: pointer; }

        /* Instant Bonus Box */
        .instant-bonus-box {
            background: #2c3e50; color: white; padding: 20px; border-radius: 10px; 
            margin-top: 20px; border-left: 6px solid var(--secondary); box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .ib-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 10px;}
        .ib-total { font-size: 1.8rem; font-weight: bold; color: var(--secondary); }

        /* Buttons & Table */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: #dc3545; color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        th { background: #f1f5f9; font-weight: 700; color: #475569; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; color: white; font-weight: bold; }
        .badge-sales { background: #3b82f6; }
        .badge-new { background: #e67e22; }
        .badge-learn { background: #10b981; }

        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; min-height: 100vh; }
            .sidebar { width: 100%; flex-direction: row; overflow-x: auto; height: auto; border-bottom: 1px solid var(--border); border-right: none; }
            .nav-item { padding: 15px; white-space: nowrap; }
            .nav-divider, .logo { display: none; }
            .main { padding: 15px; overflow: visible; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .row-inputs { flex-direction: column; gap: 5px; }
            .equal-sign { transform: rotate(90deg); padding: 5px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-gem"></i> æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•« <small style="font-size:0.6em; color:#ff9900;">(v6.1 Product)</small></div>
        
        <div class="nav-divider">æ•¸æ“šç®¡ç†</div>
        <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-chart-pie"></i> æˆ°æƒ…å®¤ (ç¯€é»åˆ‡å‰²)</div>
        <div class="nav-item" onclick="switchTab('network')"><i class="fas fa-sitemap"></i> çµ„ç¹”èˆ‡è¼”å°åœˆ</div>
        <div class="nav-item" onclick="switchTab('entry')"><i class="fas fa-pen"></i> æ¥­ç¸¾ç™»éŒ„</div>
        <div class="nav-item" onclick="switchTab('members')"><i class="fas fa-users"></i> æœƒå“¡èˆ‡è¼”å°è¨­å®š</div>
        <div class="nav-item" onclick="switchTab('logs')"><i class="fas fa-list"></i> æ—¥èªŒæ˜ç´°</div>

        <div class="nav-divider">å·¥å…·èˆ‡ç³»çµ±</div>
        <div class="nav-item" onclick="switchTab('calculator')"><i class="fas fa-calculator"></i> çé‡‘æ¨¡æ“¬å™¨</div>
        <div class="nav-item" onclick="switchTab('settings')"><i class="fas fa-cog"></i> è¨­å®šèˆ‡å‚™ä»½</div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="section active">
            <div class="header">
                <div class="page-title">ç•¶æœˆæ¥­ç¸¾æˆ°æƒ…å®¤</div>
                <div style="display:flex; gap:10px;">
                    <select id="dashMonthSelect" onchange="renderDashboard()" style="width: auto; cursor:pointer; font-weight:bold; color:var(--primary);"></select>
                    <button class="btn btn-outline" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
            </div>
            <div class="grid-3">
                <div class="card" style="border-top: 4px solid var(--primary);">
                    <div style="color: #666; font-size: 0.9rem;">åœ˜éšŠç¸½ PV (æ–°æ˜Ÿåˆ‡å‰²åˆ¶)</div>
                    <h1 id="totalPVDisplay" style="margin: 10px 0; color: var(--primary);">0</h1>
                </div>
                <div class="card" style="border-top: 4px solid var(--secondary);">
                    <div style="color: #666; font-size: 0.9rem;">é ä¼°ç™¼æ”¾ç¸½çé‡‘</div>
                    <h1 id="totalBonusDisplay" style="margin: 10px 0; color: var(--secondary);">$0</h1>
                </div>
                <div class="card" style="border-top: 4px solid var(--success);">
                    <div style="color: #666; font-size: 0.9rem;">æ´»èºæ–°æ˜Ÿå¤¥ä¼´</div>
                    <h1 id="activeMembersDisplay" style="margin: 10px 0; color: var(--success);">0</h1>
                </div>
            </div>
            <div class="card">
                <h3>ğŸ’° çé‡‘æ’è¡Œæ¦œ (Hard Cut-off)</h3>
                <div style="overflow-x: auto;">
                    <table id="rankingTable">
                        <thead><tr><th>æ’å</th><th>æœƒå“¡</th><th>æœ‰æ•ˆ PV (åˆ‡å‰²å¾Œ)</th><th>ç‹€æ…‹</th><th>é ä¼°çé‡‘</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="network" class="section">
            <div class="page-title">ğŸ§¬ çµ„ç¹”åœ–èˆ‡è¼”å°åœˆæª¢æ¸¬</div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:15px;">
                    <div class="view-switch">
                        <div class="view-option active" id="viewNet" onclick="setNetworkView('network')">é¡¯ç¤ºçµ„ç¹”æ¶æ§‹</div>
                        <div class="view-option" id="viewScope" onclick="setNetworkView('scope')">é¡¯ç¤ºè¼”å°ç¯„åœ (3x5)</div>
                    </div>
                </div>

                <div id="scopeLegend" style="display:none; background:#fff3cd; color:#856404; padding:15px; border-radius:6px; font-size:0.9rem; margin-bottom:15px;">
                    <i class="fas fa-exclamation-circle"></i> <b>è¼”å°ç¯„åœæª¢æ¸¬æ¨¡å¼ï¼š</b><br>
                    1. <b>æ©«å‘ (Coaching Legs)</b>ï¼šåƒ…é¡¯ç¤ºç™¼èµ·äººã€Œäººå·¥å‹¾é¸ã€çš„ 3 ä½ç›´å±¬é‡é»ç·š (âœ…)ã€‚<br>
                    2. <b>ç¸±å‘ (Depth)</b>ï¼šè‡ªé‡é»ç·šå‘ä¸‹è¨ˆç®—è‡³ç¬¬ 5 ä»£ (Gen 5)ã€‚<br>
                    3. <b>è‡ªç«‹</b>ï¼šæœªè¢«å‹¾é¸çš„ç·šã€æˆ–æ·±åº¦è¶…éç¬¬ 5 ä»£è€…æ¨™ç¤ºç‚º âŒ (éœ€è‡ªç«‹ç™¼èµ·)ã€‚
                </div>
                <div id="treeContainer" style="overflow-x:auto;"></div>
            </div>
        </div>

        <div id="entry" class="section">
            <div class="page-title">ğŸ“ æ¥­ç¸¾èˆ‡æ¨è–¦ç™»éŒ„</div>
            <div class="grid-2">
                <div>
                    <div class="card">
                        <div class="form-group">
                            <label>æ—¥æœŸ</label>
                            <input type="date" id="entryDate" onchange="updateInstantCalc()">
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œæœƒå“¡ (ä¸Šç·š/æ¥­ç¸¾æ­¸å±¬äºº)</label>
                            <select id="entryMember" onchange="checkMemberSelect(); updateInstantCalc();"></select>
                            
                            <div id="quickAddMemberBox" style="display:none; background:#f0f9ff; padding:10px; margin-top:10px; border-radius:6px; border:1px dashed #0066cc;">
                                <small style="color:#0066cc; font-weight:bold;">â• å»ºç«‹æ–°æœƒå“¡ (é è¨­æ–°æ˜Ÿ)</small>
                                <div style="display:flex; gap:10px; margin-top:5px;">
                                    <input type="text" id="quickNewMemName" placeholder="å§“å">
                                    <input type="text" id="quickNewMemID" placeholder="ç·¨è™Ÿ">
                                </div>
                                <select id="quickNewSponsor" style="margin-top:5px;"><option value="">é¸æ“‡ç™¼èµ·äºº(éå¿…è¦)</option></select>
                            </div>
                        </div>
                        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                        
                        <div class="input-section" style="background:#f8fbff; border-left:4px solid #3b82f6; padding:15px; border-radius:8px; margin-bottom:15px;">
                            <div class="section-header" style="font-weight:bold; margin-bottom:10px;"><i class="fas fa-shopping-cart"></i> å€‹äººæ¥­ç¸¾è¼¸å…¥</div>
                            <div class="row-inputs">
                                <div class="form-group" style="margin:0;"><label style="font-size:0.8rem;">PV</label><input type="number" id="entryPV" placeholder="0" oninput="autoConvert('pv', 'entry'); updateInstantCalc();" onfocus="this.select()"></div>
                                <div class="equal-sign">=</div>
                                <div class="form-group" style="margin:0;"><label style="font-size:0.8rem;">BV (1:50)</label><input type="number" id="entryBV" placeholder="0" oninput="autoConvert('bv', 'entry'); updateInstantCalc();" onfocus="this.select()" style="background:#fff;"></div>
                            </div>
                            
                            <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #ccc;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                    <label style="margin:0; font-size:0.9rem; color:#555;">åˆ†äº«ç”¢å“æ˜ç´° (é¸å¡«)</label>
                                    <button class="btn btn-outline" style="padding:2px 8px; font-size:0.8rem;" onclick="addProductRow()">
                                        <i class="fas fa-plus"></i> æ–°å¢å“é …
                                    </button>
                                </div>
                                <div id="productRowsContainer">
                                    </div>
                            </div>
                        </div>

                        <div class="input-section" style="background:#fffaf5; border-left:4px solid #e67e22; padding:15px; border-radius:8px; margin-bottom:15px;">
                            <div class="section-header" style="font-weight:bold; margin-bottom:10px;"><i class="fas fa-user-plus"></i> æ¨è–¦æ–°äºº (å»ºç«‹ä¸‹ç·š)</div>
                            <div style="background:rgba(255,255,255,0.7); padding:8px; border-radius:4px; margin-bottom:10px;">
                                <label style="display:flex; align-items:center; cursor:pointer; font-size:0.9rem;">
                                    <input type="checkbox" id="exceptionMemoCheck" style="width:auto; margin-right:8px;" onchange="toggleExceptionMemo()">
                                    <span>ä¾‹å¤–ï¼šå¯¦éš›ä¸Šç·šéæ“ä½œæœƒå“¡ (åƒ…å‚™è¨»)</span>
                                </label>
                                <input type="text" id="exceptionMemoText" placeholder="è¼¸å…¥å¯¦éš›ä¸Šç·šå§“åèˆ‡ç·¨è™Ÿ..." style="display:none; margin-top:5px; font-size:0.9rem;">
                            </div>
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <input type="text" id="newcomerName" placeholder="æ–°äººå§“å" oninput="updateInstantCalc()">
                                <input type="text" id="newcomerID" placeholder="æ–°äººç·¨è™Ÿ (é‡è¦:å»ºæª”ç”¨)">
                            </div>
                            <div class="form-group" style="margin:0;"><label style="font-size:0.8rem;">æ–°äººç•¶æœˆæ¶ˆè²» BV</label><input type="number" id="newcomerBV" placeholder="0" oninput="updateInstantCalc()"></div>
                        </div>

                        <div class="input-section" style="background:#f0fff4; border-left:4px solid #10b981; padding:15px; border-radius:8px;">
                            <div class="section-header" style="font-weight:bold; margin-bottom:10px;"><i class="fas fa-graduation-cap"></i> å­¸ç¿’å¿ƒå¾—</div>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;"><input type="checkbox" id="learningFileCheck" style="width:auto;" onchange="updateInstantCalc()"> <span>å·²ç¹³äº¤è­‰æ˜ (è§¸ç™¼ +3% çå‹µ)</span></label>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="card" style="position:sticky; top:20px;">
                        <h3>ğŸ“Š é è¦½è©¦ç®—</h3>
                        <p style="font-size:0.9rem; color:#666;">åŸºæ–¼åˆ‡å‰²åˆ¶èˆ‡ç•¶æœˆç´¯ç©ï¼š</p>
                        <div class="instant-bonus-box">
                            <div class="ib-header"><div class="ib-title">é è¨ˆçé‡‘å¢åŠ </div><div class="ib-total" id="ibTotalVal">$0</div></div>
                            <div style="text-align:center; opacity:0.8; font-size:0.9rem;" id="ibDetailText">--</div>
                        </div>
                        <button class="btn btn-primary" style="width:100%; margin-top:20px; padding:15px; font-size:1.1rem;" onclick="addCompositeLog()"><i class="fas fa-save"></i> ç¢ºèªå„²å­˜ç´€éŒ„</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="members" class="section">
            <div class="page-title">ğŸ‘¥ æœƒå“¡èˆ‡è¼”å°è¨­å®š</div>
            <div class="grid-2">
                <div class="card">
                    <h3>ç™¼èµ·äººèˆ‡è¼”å°ç·šè¨­å®š</h3>
                    <div style="background:#eef7ff; padding:10px; border-radius:6px; margin-bottom:10px; font-size:0.85rem; color:#0066cc;">
                        <i class="fas fa-info-circle"></i> <b>è¨­å®šè¦å‰‡ï¼š</b> è«‹æ–¼ä¸‹æ–¹åˆ—è¡¨å‹¾é¸è©²ç™¼èµ·äººçš„ã€Œè¼”å°é‡é»ç·šã€ã€‚(æœ€å¤š3ä½)
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" id="spId" placeholder="ID">
                        <input type="text" id="spName" placeholder="å§“å">
                        <button class="btn btn-primary" onclick="addSponsor()">æ–°å¢</button>
                    </div>
                    <div id="sponsorListContainer" style="display:flex; flex-direction:column; gap:15px;"></div>
                </div>
                <div class="card">
                    <h3>æ–°æ˜Ÿæœƒå“¡åˆ—è¡¨</h3>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" id="manualMemId" placeholder="ID">
                        <input type="text" id="manualMemName" placeholder="å§“å">
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <select id="manualMemSponsor"><option value="">æŒ‡å®šä¸Šç·š (é¸å¡«)</option></select>
                        <button class="btn btn-primary" onclick="addMemberManual()">æ–°å¢</button>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table id="memberTable"><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>ä¸Šç·š</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="logs" class="section">
            <div class="page-title">ğŸ“‹ è©³ç´°ç´€éŒ„æ˜ç´°</div>
            <div class="card">
                <div class="grid-3">
                    <div class="form-group"><label>æœˆä»½</label><input type="month" id="filterMonth" onchange="renderLogs()"></div>
                    <div class="form-group"><label>æœƒå“¡</label><select id="filterMember" onchange="renderLogs()"><option value="all">å…¨éƒ¨</option></select></div>
                    <div class="form-group"><label style="visibility:hidden">R</label><button class="btn btn-outline" style="width:100%" onclick="resetLogFilter()">é‡ç½®</button></div>
                </div>
                <table id="logTable"><thead><tr><th>æ—¥æœŸ</th><th>æœƒå“¡</th><th>é¡å‹</th><th>è©³ç´°å…§å®¹</th><th>PV/BV</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="calculator" class="section">
            <div class="page-title">ğŸ§® çé‡‘æ¨¡æ“¬å™¨</div>
            <div class="card">
                <div class="grid-2">
                    <div style="background:#f0f9ff; padding:20px; border-radius:8px;">
                        <div class="form-group"><label>é ä¼° PV</label><input type="number" id="calcPV" oninput="autoConvert('pv','calc'); runSimulation()"></div>
                        <div class="form-group"><label>é ä¼° BV</label><input type="number" id="calcBV" oninput="autoConvert('bv','calc'); runSimulation()"></div>
                        <div class="form-group"><label>æ¨è–¦äººæ•¸ (åƒ…ç®—æ¯”ä¾‹)</label><input type="number" id="calcPartners" oninput="runSimulation()"></div>
                        <div class="form-group"><label>æ–°äººç¸½ BV</label><input type="number" id="calcNewcomerBV" oninput="runSimulation()"></div>
                        <div class="form-group"><label><input type="checkbox" id="calcHasLearned" onchange="runSimulation()"> å·²å­¸ç¿’ (+3%)</label></div>
                    </div>
                    <div style="background:#2c3e50; color:white; padding:20px; border-radius:8px; display:flex; flex-direction:column; justify-content:center; text-align:center;">
                        <div id="simGraduateMsg" style="display:none; color:#28a745; margin-bottom:10px; font-size:1.2rem;">ğŸ† ç•¢æ¥­ (Core+)</div>
                        <div>æ¨¡æ“¬ç¸½çé‡‘</div>
                        <div style="font-size:2.5rem; font-weight:bold; color:#ff9900;" id="simValTotal">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings" class="section">
            <div class="page-title">âš™ï¸ è¨­å®š</div>
            <div class="card">
                <button class="btn btn-primary" onclick="exportData()">ä¸‹è¼‰å‚™ä»½ JSON</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
                <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">é‚„åŸå‚™ä»½</button>
                <button class="btn btn-danger" onclick="clearAllData()" style="margin-left:20px;">æ¸…é™¤æ‰€æœ‰è³‡æ–™ (Reset)</button>
            </div>
        </div>

    </div>

<script>
    // ================================
    // 1. Firebase Configuration & Sync
    // ================================
    const firebaseConfig = {
      apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
      authDomain: "newstar-system.firebaseapp.com",
      projectId: "newstar-system",
      storageBucket: "newstar-system.firebasestorage.app",
      messagingSenderId: "889699172174",
      appId: "1:889699172174:web:0ff42757035a879cb3281f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const TEAM_ID = "newstar_v5_5_index"; // Keep same ID to maintain data

    // Global Data
    let members = JSON.parse(localStorage.getItem('ns55_mems')) || [];
    let logs = JSON.parse(localStorage.getItem('ns55_logs')) || [];
    let sponsors = JSON.parse(localStorage.getItem('ns55_spons')) || [];

    // Current View Mode for Network ('network' or 'scope')
    let currentNetworkView = 'network';

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entryDate').valueAsDate = new Date();
        document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);
        populateMonthSelect();
        
        // Login & Sync
        auth.signInAnonymously().then(() => startCloudSync()).catch(e => console.error(e));
        
        // Initial Render
        refreshUI();
    });

    function startCloudSync() {
      db.collection("newstar").doc(TEAM_ID).onSnapshot((snap) => {
        if (!snap.exists) { saveToCloud(); return; } 
        const data = snap.data();
        if(data) {
            members = data.members || [];
            logs = data.logs || [];
            sponsors = data.sponsors || [];
            // Migration for old data without coachingLegs
            sponsors.forEach(s => { if(!s.coachingLegs) s.coachingLegs = []; });
            saveToLocal(false); 
            refreshUI();
        }
      });
    }

    function saveToCloud() {
        db.collection("newstar").doc(TEAM_ID).set({ members, logs, sponsors, updatedAt: new Date().toISOString() }, { merge: true });
    }
    
    function saveToLocal(triggerCloud = true) {
        localStorage.setItem('ns55_mems', JSON.stringify(members));
        localStorage.setItem('ns55_logs', JSON.stringify(logs));
        localStorage.setItem('ns55_spons', JSON.stringify(sponsors));
        if(triggerCloud) saveToCloud();
    }

    // ================================
    // 2. Logic: Hard Cut & PV Calculation
    // ================================
    
    function getPersonalPV(memId, monthStr) {
        return logs.filter(l => l.memberId === memId && l.date.startsWith(monthStr) && l.type === 'sales')
                   .reduce((acc, l) => acc + l.pv, 0);
    }

    function calculateEffectivePV(memId, monthStr, isRoot = true) {
        const me = members.find(m => m.id === memId);
        if (!me) return 0;

        if (!isRoot && me.isNewStar) return 0;

        let totalPV = getPersonalPV(memId, monthStr);
        const directDownlines = members.filter(m => m.sponsorId === memId);
        directDownlines.forEach(downline => {
            totalPV += calculateEffectivePV(downline.id, monthStr, false);
        });

        return totalPV;
    }

    function calcBonus(pv, bv, isRec, newcomers, hasLearn) {
        if (pv >= 1000) return { total: 0, isGraduated: true, text: "ç•¢æ¥­ (Core+)" };
        let rate = (pv >= 600) ? (isRec ? 0.02 : 0.01) : (isRec ? 0.04 : 0.03);
        let rateTxt = (pv >= 600) ? (isRec ? "6%+2%" : "6%+1%") : (isRec ? "4%" : "3%");
        let base = bv * rate;
        let nBonus = 0;
        if (newcomers) newcomers.forEach(n => nBonus += n.bv * 0.01);
        let sub = base + nBonus;
        let lBonus = hasLearn ? sub * 0.03 : 0;
        return { total: Math.floor(sub + lBonus), isGraduated: false, text: `R:${rateTxt}`, breakdown: { base, new: nBonus, learn: lBonus }};
    }

    // ================================
    // 3. UI Actions & Entry
    // ================================

    function switchTab(tabId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        refreshUI();
    }

    function refreshUI() {
        updateMemberSelects();
        renderMembers();
        renderSponsors();
        renderDashboard();
        renderNetwork();
        renderLogs();
    }

    function checkMemberSelect() {
        const val = document.getElementById('entryMember').value;
        document.getElementById('quickAddMemberBox').style.display = (val === 'new_mode') ? 'block' : 'none';
    }

    function toggleExceptionMemo() {
        const chk = document.getElementById('exceptionMemoCheck').checked;
        document.getElementById('exceptionMemoText').style.display = chk ? 'block' : 'none';
    }

    function autoConvert(source, context) {
        let pvId = context==='entry'?'entryPV':'calcPV';
        let bvId = context==='entry'?'entryBV':'calcBV';
        const pvEl = document.getElementById(pvId), bvEl = document.getElementById(bvId);
        if(source==='pv') bvEl.value = (parseFloat(pvEl.value)||0) * 50;
        else pvEl.value = (parseFloat(bvEl.value)||0) / 50;
    }

    // [New] Product Row Helpers
    function addProductRow() {
        const div = document.createElement('div');
        div.className = 'prod-row';
        div.innerHTML = `
            <input type="text" class="p-name" placeholder="å“é …åç¨± (å¦‚:ç‰™è†)" style="flex:2; font-size:0.9rem;">
            <input type="number" class="p-qty" placeholder="æ•¸é‡" value="1" style="flex:1; font-size:0.9rem;">
            <button onclick="this.parentElement.remove()" style="border:none; background:none; color:#dc3545; cursor:pointer; padding:5px;">
                <i class="fas fa-times"></i>
            </button>
        `;
        document.getElementById('productRowsContainer').appendChild(div);
    }

    function clearProductRows() {
        document.getElementById('productRowsContainer').innerHTML = '';
    }

    function updateInstantCalc() {
        const memId = document.getElementById('entryMember').value;
        if (!memId || memId === 'new_mode') {
            document.getElementById('ibTotalVal').innerText = "$ -";
            document.getElementById('ibDetailText').innerText = "--";
            return;
        }

        const month = document.getElementById('entryDate').value.slice(0, 7);
        const curEffPV = calculateEffectivePV(memId, month, true);
        const addPV = parseFloat(document.getElementById('entryPV').value) || 0;
        const addNBV = parseFloat(document.getElementById('newcomerBV').value) || 0;
        
        const existLogs = logs.filter(l => l.memberId === memId && l.date.startsWith(month));
        const existNews = existLogs.filter(l => l.type === 'newcomer').map(l => l.newcomerData);
        const existLearn = existLogs.some(l => l.type === 'learning');
        
        let simPV = curEffPV + addPV;
        let simNews = [...existNews];
        if (addNBV > 0) simNews.push({ bv: addNBV });
        
        const isRecNow = document.getElementById('newcomerName').value.trim() !== "" || existNews.length > 0;
        const isLearnNow = document.getElementById('learningFileCheck').checked || existLearn;

        const oldRes = calcBonus(curEffPV, curEffPV * 50, existNews.length > 0, existNews, existLearn);
        const newRes = calcBonus(simPV, simPV * 50, isRecNow, simNews, isLearnNow);

        if (newRes.isGraduated) {
            document.getElementById('ibTotalVal').innerHTML = "<span style='font-size:0.6em; color:orange;'>ğŸ† é”ç•¢æ¥­é–€æª»</span>";
            document.getElementById('ibDetailText').innerText = "Core+ åˆ¶åº¦å•Ÿå‹•";
        } else {
            const diff = newRes.total - oldRes.total;
            document.getElementById('ibTotalVal').innerText = (diff >= 0 ? "+$" : "-$") + Math.abs(diff).toLocaleString();
            document.getElementById('ibDetailText').innerText = `é ä¼°ç¸½ PV: ${simPV.toLocaleString()}`;
        }
    }

    function addCompositeLog() {
        const date = document.getElementById('entryDate').value;
        let memberId = document.getElementById('entryMember').value;

        if (!date) return alert("è«‹é¸æ“‡æ—¥æœŸ");
        if (!memberId) return alert("è«‹é¸æ“‡æœƒå“¡");

        if (memberId === 'new_mode') {
            const newName = document.getElementById('quickNewMemName').value.trim();
            const newID = document.getElementById('quickNewMemID').value.trim();
            const spID = document.getElementById('quickNewSponsor').value;
            if(!newName || !newID) return alert("è«‹è¼¸å…¥æ–°æœƒå“¡è³‡æ–™");
            if(members.find(m=>m.id===newID)) return alert("ç·¨è™Ÿé‡è¤‡");
            members.push({ id: newID, name: newName, sponsorId: spID, isNewStar: true });
            memberId = newID;
            saveToLocal(true);
            refreshUI();
            document.getElementById('entryMember').value = memberId;
            document.getElementById('quickNewMemName').value = '';
            document.getElementById('quickNewMemID').value = '';
            checkMemberSelect();
        }

        let savedCount = 0;
        
        // 1. Sales with Products
        const pvVal = parseFloat(document.getElementById('entryPV').value) || 0;
        if (pvVal > 0) {
            const bvVal = parseFloat(document.getElementById('entryBV').value) || 0;
            
            // Collect Products
            let productsShared = [];
            document.querySelectorAll('#productRowsContainer .prod-row').forEach(row => {
                const name = row.querySelector('.p-name').value.trim();
                const qty = row.querySelector('.p-qty').value;
                if(name) productsShared.push({ name, qty });
            });

            logs.push({ 
                id: Date.now(), 
                date, 
                memberId, 
                type: 'sales', 
                pv: pvVal, 
                details: `ä¸€èˆ¬æ¥­ç¸¾ (BV: ${bvVal})`,
                productsShared: productsShared 
            });
            clearProductRows();
            savedCount++;
        }

        const nName = document.getElementById('newcomerName').value.trim();
        if (nName) {
            const nID = document.getElementById('newcomerID').value.trim();
            const nBV = parseFloat(document.getElementById('newcomerBV').value) || 0;
            if (!nID) return alert("è«‹è¼¸å…¥æ–°äººç·¨è™Ÿ");
            if (!members.find(m => m.id === nID)) members.push({ id: nID, name: nName, sponsorId: memberId, isNewStar: true });
            let detailsTxt = `æ¨è–¦: ${nName} (${nID})`;
            if (document.getElementById('exceptionMemoCheck').checked) {
                const memo = document.getElementById('exceptionMemoText').value.trim();
                if(memo) detailsTxt += ` [å‚™è¨»å¯¦éš›æ¨è–¦: ${memo}]`;
            }
            logs.push({ id: Date.now() + 1, date, memberId, type: 'newcomer', pv: 0, details: detailsTxt, newcomerData: { name: nName, id: nID, bv: nBV } });
            savedCount++;
        }

        if (document.getElementById('learningFileCheck').checked) {
            logs.push({ id: Date.now() + 2, date, memberId, type: 'learning', pv: 0, details: "å·²ç¹³äº¤å­¸ç¿’è­‰æ˜", isLearning: true });
            savedCount++;
        }

        if (savedCount === 0) return alert("æœªè¼¸å…¥ä»»ä½•æ•¸å€¼");
        saveToLocal(true);
        alert(`æˆåŠŸå„²å­˜ ${savedCount} ç­†ç´€éŒ„`);
        document.getElementById('entryPV').value = ''; document.getElementById('entryBV').value = '';
        document.getElementById('newcomerName').value = ''; document.getElementById('newcomerID').value = ''; document.getElementById('newcomerBV').value = '';
        document.getElementById('exceptionMemoCheck').checked = false; toggleExceptionMemo();
        document.getElementById('learningFileCheck').checked = false;
        updateInstantCalc();
    }

    // ================================
    // 4. Dashboard
    // ================================

    function renderDashboard() {
        const month = document.getElementById('dashMonthSelect').value;
        const tbody = document.querySelector('#rankingTable tbody');
        let stats = [];

        members.filter(m => m.isNewStar).forEach(m => {
            const effPV = calculateEffectivePV(m.id, month, true);
            const myLogs = logs.filter(l => l.memberId === m.id && l.date.startsWith(month));
            const hasRec = myLogs.some(l => l.type === 'newcomer');
            const hasLearn = myLogs.some(l => l.type === 'learning');
            const news = myLogs.filter(l => l.type === 'newcomer').map(l => l.newcomerData);

            const res = calcBonus(effPV, effPV * 50, hasRec, news, hasLearn);
            let statusBadge = res.isGraduated ? '<span class="tag cut">å·²ç•¢æ¥­</span>' : (effPV >= 600 ? '<span class="tag in-scope">6%</span>' : 'èµ·æ­¥æœŸ');

            stats.push({ name: m.name, pv: effPV, bonus: res.total, status: statusBadge, text: res.text });
        });

        stats.sort((a, b) => b.pv - a.pv);
        document.getElementById('totalPVDisplay').innerText = stats.reduce((a, b) => a + b.pv, 0).toLocaleString();
        document.getElementById('totalBonusDisplay').innerText = "$" + stats.reduce((a, b) => a + b.bonus, 0).toLocaleString();
        document.getElementById('activeMembersDisplay').innerText = stats.length;
        tbody.innerHTML = stats.length ? stats.map((s, i) => `<tr><td>${i + 1}</td><td>${s.name}</td><td style="color:#0066cc; font-weight:bold;">${s.pv.toLocaleString()}</td><td>${s.status}</td><td style="color:#ff9900; font-weight:bold;">${s.bonus > 0 ? '$'+s.bonus.toLocaleString() : '-'}</td></tr>`).join('') : '<tr><td colspan="5" style="text-align:center">ç„¡è³‡æ–™</td></tr>';
    }

    // ================================
    // 5. Network (INDEX 5.5 Logic)
    // ================================

    function setNetworkView(mode) {
        currentNetworkView = mode;
        document.getElementById('viewNet').classList.toggle('active', mode === 'network');
        document.getElementById('viewScope').classList.toggle('active', mode === 'scope');
        document.getElementById('scopeLegend').style.display = (mode === 'scope') ? 'block' : 'none';
        renderNetwork();
    }

    function renderNetwork() {
        const container = document.getElementById('treeContainer');
        let html = "";
        if (sponsors.length === 0) {
            container.innerHTML = "<div style='padding:20px; text-align:center; color:#999;'>è«‹å…ˆæ–°å¢ç™¼èµ·äºº</div>";
            return;
        }

        sponsors.forEach(sp => {
            html += `<div style="background:#f8f9fa; padding:12px; border-left:4px solid var(--purple); margin-bottom:10px;">
                        <i class="fas fa-crown" style="color:var(--purple);"></i> <b>ç™¼èµ·äººï¼š${sp.name}</b>
                        <small style="color:#666">(${sp.id})</small>
                     </div>`;
            const legs = members.filter(m => m.sponsorId === sp.id);
            if(legs.length === 0) {
                html += "<div style='color:#999; margin-left:20px;'>ç„¡ä¸‹ç·šçµ„ç¹”</div>";
            } else {
                legs.forEach((leg) => {
                    html += buildTreeHtml(leg, 1, sp); 
                });
            }
        });
        container.innerHTML = html;
    }

    // Recursive Tree Builder with 2 modes
    function buildTreeHtml(member, currentGen, rootSponsor) {
        if (currentNetworkView === 'network') {
            return buildNodeHtml(member, null, null, currentGen, rootSponsor);
        }
        return buildScopeNode(member, currentGen, rootSponsor, true);
    }

    // Helper for recursion state
    function buildScopeNode(member, gen, rootSponsor, isParentValid) {
        if (currentNetworkView === 'network') {
            let html = buildNodeHtml(member, false, null, gen);
            const children = members.filter(m => m.sponsorId === member.id);
            children.forEach(c => { html += buildScopeNode(c, gen + 1, rootSponsor, true); });
            html += "</div>";
            return html;
        }

        // Scope Mode Logic
        let isNodeValid = false;
        let statusText = "";

        if (gen === 1) {
            // Direct Leg Check
            if (rootSponsor.coachingLegs && rootSponsor.coachingLegs.includes(member.id)) {
                isNodeValid = true;
            } else {
                isNodeValid = false;
                statusText = "è‡ªè¡Œç™¼èµ· (æœªåˆ—å…¥è¼”å°)";
            }
        } else {
            // Deep Check
            if (isParentValid) {
                if (gen <= 5) {
                    isNodeValid = true;
                } else {
                    isNodeValid = false;
                    statusText = "è‡ªè¡Œè¼”å° (è¶…å‡º5ä»£)";
                }
            } else {
                isNodeValid = false; // Parent was already out
            }
        }

        let html = buildNodeHtml(member, true, isNodeValid, gen, statusText);
        
        const children = members.filter(m => m.sponsorId === member.id);
        children.forEach(c => {
            html += buildScopeNode(c, gen + 1, rootSponsor, isNodeValid);
        });
        html += "</div>";
        return html;
    }

    function buildNodeHtml(member, isScopeMode, isValid, gen, statusText="") {
        const cutTag = member.isNewStar ? '<span class="tag cut">NewStar</span>' : '';
        
        let visual = "";
        if (isScopeMode) {
            const icon = isValid ? "âœ…" : "âŒ";
            const cls = isValid ? "in-scope" : "out-scope";
            const genLabel = isValid ? `Gen ${gen}` : `Gen ${gen}`;
            const sText = statusText ? `<span class="scope-status out">${statusText}</span>` : `<span class="scope-status">è¼”å°åœˆ</span>`;
            visual = `<span class="tag ${cls}">${icon} ${genLabel}</span> ${sText}`;
        } else {
            visual = `<span class="tag out-scope" style="background:#ddd; color:#555;">Gen ${gen}</span>`;
        }

        return `<div class="tree-node">
                    <div class="tree-content" style="${(isScopeMode && !isValid) ? 'opacity:0.6; background:#f0f0f0;' : ''}">
                        ${visual}
                        <b style="margin-left:5px;">${member.name}</b> <small style="color:#999">(${member.id})</small>
                        ${cutTag}
                    </div>`;
    }

    // ================================
    // 6. Data & Sponsors Management
    // ================================

    function addSponsor() {
        const id = document.getElementById('spId').value.trim();
        const name = document.getElementById('spName').value.trim();
        if(id && name) {
            sponsors.push({id, name, coachingLegs: []}); // Init coachingLegs
            saveToLocal(true);
            document.getElementById('spId').value=''; document.getElementById('spName').value='';
            refreshUI();
        }
    }

    function renderSponsors() {
        const container = document.getElementById('sponsorListContainer');
        container.innerHTML = sponsors.map(sp => {
            // Find direct downlines
            const directs = members.filter(m => m.sponsorId === sp.id);
            
            // Build list of checkboxes for direct downlines
            let legListHtml = "";
            if(directs.length === 0) {
                legListHtml = "<div style='padding:10px; color:#999; font-size:0.85rem;'>å°šç„¡ç›´å±¬ä¸‹ç·šå¯è¨­å®š</div>";
            } else {
                legListHtml = directs.map(d => {
                    const isChecked = (sp.coachingLegs && sp.coachingLegs.includes(d.id)) ? "checked" : "";
                    return `<div class="coach-leg-item">
                                <span>${d.name} (${d.id})</span>
                                <input type="checkbox" class="cl-check" ${isChecked} onchange="toggleCoachingLeg('${sp.id}', '${d.id}', this)">
                            </div>`;
                }).join('');
            }

            return `<div style="border:1px solid #ddd; border-radius:8px; overflow:hidden;">
                        <div style="background:#f8f9fa; padding:10px; display:flex; justify-content:space-between; align-items:center;">
                            <b>ğŸ‘‘ ${sp.name}</b>
                            <button class="btn btn-outline" style="padding:2px 6px; font-size:0.7rem; color:red;" onclick="deleteSponsor('${sp.id}')">ç§»é™¤</button>
                        </div>
                        <div style="background:white;">
                            <div style="padding:8px; font-size:0.8rem; background:#fffbf0; border-bottom:1px solid #eee; color:#856404;">
                                å‹¾é¸åˆ—å…¥è¼”å°åœˆ (æœ€å¤š3ä½)
                            </div>
                            ${legListHtml}
                        </div>
                    </div>`;
        }).join('');

        // Update Selects
        let opts = '<option value="">æŒ‡å®šä¸Šç·š (é¸å¡«)</option>';
        sponsors.forEach(s => opts += `<option value="${s.id}">ğŸ‘‘ ${s.name}</option>`);
        members.forEach(m => opts += `<option value="${m.id}">${m.name}</option>`);
        document.getElementById('manualMemSponsor').innerHTML = opts;
        document.getElementById('quickNewSponsor').innerHTML = opts;
    }

    function toggleCoachingLeg(sponsorId, memberId, checkbox) {
        const sp = sponsors.find(s => s.id === sponsorId);
        if(!sp) return;
        if(!sp.coachingLegs) sp.coachingLegs = [];

        if(checkbox.checked) {
            if(sp.coachingLegs.length >= 3) {
                alert("æ¯å€‹ç™¼èµ·äººæœ€å¤šåªèƒ½è¨­å®š 3 æ¢è¼”å°é‡é»ç·šï¼");
                checkbox.checked = false;
                return;
            }
            sp.coachingLegs.push(memberId);
        } else {
            sp.coachingLegs = sp.coachingLegs.filter(id => id !== memberId);
        }
        saveToLocal(true);
        if(document.getElementById('network').classList.contains('active')) renderNetwork();
    }

    function addMemberManual() {
        const id = document.getElementById('manualMemId').value.trim();
        const name = document.getElementById('manualMemName').value.trim();
        const sp = document.getElementById('manualMemSponsor').value;
        if(id && name) {
            if(members.find(m=>m.id===id)) return alert("ID é‡è¤‡");
            members.push({id, name, sponsorId: sp, isNewStar: true});
            saveToLocal(true);
            refreshUI();
            alert("æ–°å¢æˆåŠŸ");
            document.getElementById('manualMemId').value=''; document.getElementById('manualMemName').value='';
        }
    }

    function deleteMember(id) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤æœƒå“¡ï¼Ÿ")) {
            members = members.filter(m => m.id !== id);
            // Also remove from coaching legs if present
            sponsors.forEach(s => {
                if(s.coachingLegs) s.coachingLegs = s.coachingLegs.filter(lid => lid !== id);
            });
            saveToLocal(true);
            refreshUI();
        }
    }

    function deleteSponsor(id) {
        if(confirm("ç§»é™¤ç™¼èµ·äººï¼Ÿ")) {
            sponsors = sponsors.filter(s => s.id !== id);
            saveToLocal(true);
            refreshUI();
        }
    }

    function renderMembers() {
        const tb = document.querySelector('#memberTable tbody');
        tb.innerHTML = members.map(m => {
            const up = members.find(u => u.id === m.sponsorId)?.name || sponsors.find(s => s.id === m.sponsorId)?.name || '-';
            return `<tr><td>${m.id}</td><td>${m.name}</td><td>${up}</td><td><button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deleteMember('${m.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
        }).join('');
    }

    function updateMemberSelects() {
        let html = '<option value="" disabled selected>-- é¸æ“‡æ“ä½œæœƒå“¡ --</option>';
        html += '<option value="new_mode" style="color:blue; font-weight:bold;">â• æ–°å¢æœƒå“¡...</option>';
        members.forEach(m => { html += `<option value="${m.id}">${m.name} (${m.id})</option>`; });
        const cur = document.getElementById('entryMember').value;
        document.getElementById('entryMember').innerHTML = html;
        if(cur && members.find(m=>m.id===cur)) document.getElementById('entryMember').value = cur;
        const f = document.getElementById('filterMember');
        f.innerHTML = '<option value="all">å…¨éƒ¨</option>' + members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
    }

    function renderLogs() {
        const m = document.getElementById('filterMonth').value;
        const mem = document.getElementById('filterMember').value;
        let d = logs.filter(l => (!m || l.date.startsWith(m)) && (mem === 'all' || l.memberId === mem));
        d.sort((a,b) => new Date(b.date) - new Date(a.date));
        document.querySelector('#logTable tbody').innerHTML = d.map(l => {
            const name = members.find(x => x.id === l.memberId)?.name || l.memberId;
            let badge = l.type === 'sales' ? 'badge-sales' : (l.type === 'newcomer' ? 'badge-new' : 'badge-learn');
            
            // Product Display
            let detailsDisplay = l.details;
            if (l.type === 'sales' && l.productsShared && l.productsShared.length > 0) {
                const prodStr = l.productsShared.map(p => `${p.name}Ã—${p.qty}`).join('ã€');
                detailsDisplay += `<div style="font-size:0.85rem; color:#666; margin-top:4px; background:#f1f5f9; padding:2px 6px; border-radius:4px; display:inline-block;"><i class="fas fa-box-open" style="margin-right:4px;"></i>åˆ†äº«ï¼š${prodStr}</div>`;
            }

            return `<tr><td>${l.date}</td><td>${name}</td><td><span class="badge ${badge}">${l.type}</span></td><td>${detailsDisplay}</td><td>${l.pv || '-'}</td><td><button onclick="deleteLog(${l.id})" style="color:red;border:none;background:none"><i class="fas fa-trash"></i></button></td></tr>`;
        }).join('');
    }
    
    function deleteLog(id) {
        if(confirm("åˆªé™¤æ­¤ç´€éŒ„?")) {
            logs = logs.filter(l => l.id !== id);
            saveToLocal(true);
            refreshUI();
        }
    }

    function populateMonthSelect() {
        const s = document.getElementById('dashMonthSelect'); s.innerHTML='';
        const now = new Date();
        for(let i=0; i<12; i++) {
            let d = new Date(now.getFullYear(), now.getMonth() - i + 2, 1);
            let v = d.toISOString().slice(0, 7);
            let opt = document.createElement('option'); opt.value = v; opt.text = v;
            s.appendChild(opt);
        }
        s.value = new Date().toISOString().slice(0,7);
    }
    
    function runSimulation() {
        let pv=parseFloat(document.getElementById('calcPV').value)||0;
        let bv=parseFloat(document.getElementById('calcBV').value)||0;
        let nbv=parseFloat(document.getElementById('calcNewcomerBV').value)||0;
        let learn=document.getElementById('calcHasLearned').checked;
        let news=[]; if(nbv>0) news.push({bv:nbv});
        let partners = parseFloat(document.getElementById('calcPartners').value)||0;
        let res = calcBonus(pv, bv, partners > 0 || news.length > 0, news, learn);
        if(res.isGraduated) {
            document.getElementById('simGraduateMsg').style.display='block';
            document.getElementById('simValTotal').innerText="ç•¢æ¥­";
        } else {
            document.getElementById('simGraduateMsg').style.display='none';
            document.getElementById('simValTotal').innerText=res.total.toLocaleString();
        }
    }

    function exportPDF(){ const e=document.getElementById('dashboard'); html2pdf().from(e).save(); }
    
    function exportData(){
        const d = {members, logs, sponsors, version:"Index_v6.1_Product"};
        const url = URL.createObjectURL(new Blob([JSON.stringify(d)],{type:"application/json"}));
        const a=document.createElement('a'); a.href=url; a.download=`NS_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
    }
    
    function importData(inp){
        const f=inp.files[0]; if(!f)return;
        const r=new FileReader(); r.onload=e=>{
            try{ 
                const d=JSON.parse(e.target.result); 
                if(confirm("ç¢ºå®šé‚„åŸ?")) {
                    members=d.members||[]; logs=d.logs||[]; sponsors=d.sponsors||[];
                    sponsors.forEach(s => { if(!s.coachingLegs) s.coachingLegs = []; });
                    saveToLocal(true); location.reload();
                } 
            }catch(e){alert("æ ¼å¼éŒ¯èª¤");}
        }; r.readAsText(f);
    }

    function clearAllData() {
        if(prompt("è¼¸å…¥ DELETE ç¢ºèªæ¸…é™¤æ‰€æœ‰è³‡æ–™") === 'DELETE') {
            members=[]; logs=[]; sponsors=[];
            saveToLocal(true);
            alert("å·²é‡ç½®");
            location.reload();
        }
    }
    
    function resetLogFilter() {
        document.getElementById('filterMember').value = 'all';
        renderLogs();
    }
</script>
</body>
</html>
