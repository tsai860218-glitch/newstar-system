<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ˜Ÿå•Ÿå‹•è¨ˆç•«æ——è‰¦ç³»çµ± (2026 Cloud Pro v3.5)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0066cc;
            --primary-dark: #004c99;
            --secondary: #ff9900;
            --bg: #f0f2f5;
            --text: #333;
            --border: #e1e1e1;
            --success: #28a745;
            --purple: #6f42c1;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 10;}
        .logo { padding: 25px 20px; font-size: 1.3rem; font-weight: bold; color: var(--primary); border-bottom: 1px solid var(--border); background: #f8f9fa;}
        .nav-item { padding: 16px 20px; cursor: pointer; transition: 0.2s; color: #555; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .nav-item:hover { background: #eef7ff; color: var(--primary); }
        .nav-item.active { background: #eef7ff; color: var(--primary); border-right: 4px solid var(--primary); font-weight: bold; }
        .nav-divider { font-size: 0.8rem; color: #999; padding: 15px 20px 5px; text-transform: uppercase; font-weight: bold; margin-top: 10px;}
        
        /* Main */
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .page-title { font-size: 1.6rem; font-weight: bold; color: #2c3e50; border-left: 5px solid var(--primary); padding-left: 15px; margin-bottom: 25px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.04); margin-bottom: 25px; border: 1px solid #f0f0f0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }

        /* Form Elements */
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 0.95rem; font-weight: 600; color: #4b5563; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .row-inputs { display: flex; gap: 15px; align-items: center; }
        .row-inputs > div { flex: 1; }
        .equal-sign { font-size: 1.5rem; color: #999; font-weight: bold; padding-top: 25px; }

        /* Input Sections */
        .input-section { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .is-sales { border-left: 4px solid #3b82f6; background: #f8fbff; }
        .is-newcomer { border-left: 4px solid #e67e22; background: #fffaf5; }
        .is-learning { border-left: 4px solid #10b981; background: #f0fff4; }
        .section-header { font-weight: bold; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; color: #555; }

        /* Product Rows V3.5 */
        .product-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .product-row input { padding: 8px; font-size: 0.9rem; }
        .btn-remove-prod { color: #dc3545; background: none; border: none; cursor: pointer; }

        /* Tree View */
        .tree-node { margin-left: 25px; border-left: 2px dashed #ccc; padding-left: 20px; position: relative; margin-top: 15px; }
        .tree-node::before { content: ""; position: absolute; left: 0; top: 18px; width: 18px; height: 2px; background: #ccc; }
        .tree-content { display: flex; align-items: center; gap: 10px; background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 6px; width: fit-content; }
        .tree-root { margin-left: 0; border-left: none; padding-left: 0; margin-bottom: 30px; }
        .tree-root > .tree-content { background: #f3e5f5; border: 1px solid #d1c4e9; border-left: 5px solid var(--purple); width: 100%; box-sizing: border-box; }

        /* Tables & Badges */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        th { background: #f1f5f9; font-weight: 700; color: #475569; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: white; }
        .badge-sales { background: #3b82f6; }
        .badge-new { background: #e67e22; }
        .badge-learn { background: #10b981; }
        .badge-sponsor { background: var(--purple); }

        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: #dc3545; color: white; }

        .instant-bonus-box { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 6px solid var(--secondary); }
        .ib-total { font-size: 1.8rem; font-weight: bold; color: var(--secondary); }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; }
            .sidebar { width: 100%; flex-direction: row; overflow-x: auto; height: auto; }
            .main { padding: 15px; }
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-gem"></i> æ–°æ˜Ÿå•Ÿå‹•ç³»çµ± <small style="font-size:0.6em; color:#28a745;">(V3.5 Cloud)</small></div>
        <div class="nav-divider">æ•¸æ“šç®¡ç†</div>
        <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i> æ¥­ç¸¾æˆ°æƒ…å®¤</div>
        <div class="nav-item" onclick="switchTab('network')"><i class="fas fa-project-diagram"></i> çµ„ç¹”é—œä¿‚åœ–</div>
        <div class="nav-item" onclick="switchTab('entry')"><i class="fas fa-pen"></i> æ–°å¢ç¶œåˆç´€éŒ„</div>
        <div class="nav-item" onclick="switchTab('members')"><i class="fas fa-users"></i> æœƒå“¡è³‡æ–™åº«</div>
        <div class="nav-item" onclick="switchTab('logs')"><i class="fas fa-list"></i> æ—¥èªŒæ˜ç´°</div>
        <div class="nav-divider">æ ¸å¿ƒè¨­å®š</div>
        <div class="nav-item" onclick="switchTab('sponsors')"><i class="fas fa-crown"></i> ç™¼èµ·äººè³‡æ–™åº«</div>
        <div class="nav-divider">å·¥å…·</div>
        <div class="nav-item" onclick="switchTab('calculator')"><i class="fas fa-calculator"></i> çé‡‘æ¨¡æ“¬å™¨</div>
        <div class="nav-item" onclick="switchTab('settings')"><i class="fas fa-cog"></i> è¨­å®š</div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="section active">
            <div class="page-title">ç•¶æœˆæ¥­ç¸¾æˆ°æƒ…å®¤</div>
            <div class="grid-3">
                <div class="card" style="border-top: 4px solid var(--primary);">
                    <div style="color: #666; font-size: 0.9rem;">åœ˜éšŠç¸½ PV (å« Roll-up)</div>
                    <h1 id="totalPVDisplay" style="margin: 10px 0; color: var(--primary);">0</h1>
                    <select id="dashMonthSelect" onchange="renderDashboard()" style="width: auto; padding:5px; font-size:0.8rem;"></select>
                </div>
                <div class="card" style="border-top: 4px solid var(--secondary);">
                    <div style="color: #666; font-size: 0.9rem;">é ä¼°ç™¼æ”¾ç¸½çé‡‘</div>
                    <h1 id="totalBonusDisplay" style="margin: 10px 0; color: var(--secondary);">$0</h1>
                </div>
                <div class="card" style="border-top: 4px solid var(--success);">
                    <div style="color: #666; font-size: 0.9rem;">æ´»èºæ–°æ˜Ÿ / ç¸½äººæ•¸</div>
                    <h1 id="activeMembersDisplay" style="margin: 10px 0; color: var(--success);">0 / 0</h1>
                </div>
            </div>
            <div class="card">
                <h3>ğŸ’° çé‡‘æ’è¡Œæ¦œ (Top 10)</h3>
                <div style="overflow-x: auto;">
                    <table id="rankingTable"><thead><tr><th>æ’å</th><th>æœƒå“¡</th><th>æœ‰æ•ˆç¸½ PV</th><th>çé‡‘æ˜ç´°</th><th>é ä¼°çé‡‘</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="network" class="section">
            <div class="page-title">ğŸ§¬ çµ„ç¹”é—œä¿‚åœ–</div>
            <div class="grid-2">
                <div class="card">
                    <h3><i class="fas fa-sitemap"></i> çµ„ç¹”éšå±¤æ¨¹ç‹€åœ–</h3>
                    <div id="treeContainer" style="overflow-x:auto;"></div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-history"></i> æ¨è–¦æ­·å²</h3>
                    <table id="referralTable"><thead><tr><th>æ—¥æœŸ</th><th>æ¨è–¦äºº</th><th>æ–°äºº</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="entry" class="section">
            <div class="page-title">ğŸ“ æ–°å¢ç¶œåˆç´€éŒ„</div>
            <div class="grid-2">
                <div>
                    <div class="card">
                        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="entryDate" onchange="updateInstantCalc()"></div>
                        <div class="form-group">
                            <label>æ“ä½œæœƒå“¡ (åƒ…é™åƒåŠ ä¸­)</label>
                            <select id="entryMember" onchange="checkMemberSelect(); updateInstantCalc(); updateNewcomerUplineSelect();"></select>
                            <div id="quickAddMemberBox" style="display:none; background:#f0f9ff; padding:15px; margin-top:10px; border-radius:8px; border:1px dashed #0066cc;">
                                <div style="display:flex; gap:10px;">
                                    <input type="text" id="quickNewMemName" placeholder="å§“å">
                                    <input type="text" id="quickNewMemID" placeholder="ç·¨è™Ÿ">
                                </div>
                                <select id="quickNewMemSponsor" style="margin-top:10px;"></select>
                            </div>
                        </div>
                        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                        
                        <div class="input-section is-sales">
                            <div class="section-header"><i class="fas fa-shopping-cart"></i> æ¥­ç¸¾è¼¸å…¥</div>
                            <div class="row-inputs">
                                <div class="form-group"><label>PV</label><input type="number" id="entryPV" placeholder="0" oninput="autoConvert('pv', 'entry'); updateInstantCalc();"></div>
                                <div class="equal-sign">=</div>
                                <div class="form-group"><label>BV (1:50)</label><input type="number" id="entryBV" placeholder="0" oninput="autoConvert('bv', 'entry'); updateInstantCalc();"></div>
                            </div>
                            
                            <div style="margin-top:10px; border-top:1px dashed #ddd; padding-top:10px;">
                                <label style="font-size:0.85rem; color:#666;">ğŸ“¦ åˆ†äº«ç”¢å“æ˜ç´° (éå¿…å¡«)</label>
                                <div id="productContainer"></div>
                                <button class="btn btn-outline" style="font-size:0.8rem; margin-top:5px; border-style:dashed;" onclick="addProductRow()">+ æ–°å¢å“é …</button>
                            </div>
                        </div>

                        <div class="input-section is-newcomer">
                            <div class="section-header"><i class="fas fa-user-plus"></i> æ¨è–¦æ–°äºº</div>
                            <select id="newcomerUpline" style="margin-bottom:10px; border-color:#e67e22;"></select>
                            <div style="display:flex; gap:10px;"><input type="text" id="newcomerName" placeholder="æ–°äººå§“å"><input type="text" id="newcomerID" placeholder="æ–°äººç·¨è™Ÿ"></div>
                            <input type="number" id="newcomerBV" placeholder="æ–°äººé¦–è³¼ BV" style="margin-top:10px;">
                        </div>

                        <div class="input-section is-learning">
                            <div class="section-header"><i class="fas fa-graduation-cap"></i> å­¸ç¿’å¿ƒå¾—</div>
                            <textarea id="learningNote" rows="2" placeholder="å…§å®¹æ‘˜è¦..."></textarea>
                            <label style="display:flex; align-items:center; gap:5px; margin-top:5px;"><input type="checkbox" id="learningFileCheck" style="width:auto;"> <span>å·²ç¹³äº¤è­‰æ˜</span></label>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="card" style="position:sticky; top:20px;">
                        <h3>ğŸ“Š é è¨ˆçé‡‘å¢åŠ </h3>
                        <div class="instant-bonus-box">
                            <div class="ib-total" id="ibTotalVal">$0</div>
                            <div class="ib-breakdown" style="margin-top:10px; font-size:0.85rem; opacity:0.8;">
                                æ¥­ç¸¾: <span id="ibDiffBase">+0</span> | æ¨è–¦: <span id="ibDiffNew">+0</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="width:100%; margin-top:20px; padding:15px;" onclick="addCompositeLog()"><i class="fas fa-save"></i> å„²å­˜æ‰€æœ‰ç´€éŒ„</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="members" class="section">
            <div class="page-title">ğŸ‘¥ æœƒå“¡è³‡æ–™åº«</div>
            <div class="grid-2">
                <div class="card">
                    <h3>æ–°å¢æœƒå“¡</h3>
                    <input type="text" id="newMemberID" placeholder="ç·¨è™Ÿ" style="margin-bottom:10px;">
                    <input type="text" id="newMemberName" placeholder="å§“å" style="margin-bottom:10px;">
                    <select id="newMemSponsor" style="margin-bottom:10px;"></select>
                    <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="newMemIsNewStar" checked style="width:auto;"> <span>åƒåŠ æ–°æ˜Ÿè¨ˆç•«</span></label>
                    <button class="btn btn-primary" style="margin-top:15px; width:100%;" onclick="addMember()">åŠ å…¥è³‡æ–™åº«</button>
                </div>
                <div class="card">
                    <h3>æœƒå“¡åˆ—è¡¨</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table id="memberTable"><thead><tr><th>ç·¨è™Ÿ</th><th>å§“å</th><th>ç‹€æ…‹</th><th>ç™¼èµ·äºº</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="sponsors" class="section">
            <div class="page-title">ğŸ‘‘ ç™¼èµ·äººè³‡æ–™åº«</div>
            <div class="grid-2">
                <div class="card">
                    <h3>æ–°å¢ç™¼èµ·äºº (çé‡‘ä¾†æº)</h3>
                    <input type="text" id="newSponsorName" placeholder="å§“å" style="margin-bottom:10px;">
                    <input type="text" id="newSponsorID" placeholder="ä»£è™Ÿ (å¦‚ BOSS_A)" style="margin-bottom:10px;">
                    <button class="btn btn-purple" style="width:100%;" onclick="addSponsor()">æ–°å¢ç™¼èµ·äºº</button>
                </div>
                <div class="card">
                    <table id="sponsorTable"><thead><tr><th>ID</th><th>å§“å</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="logs" class="section">
            <div class="page-title">ğŸ“‹ ç´€éŒ„æ˜ç´°</div>
            <div class="card">
                <div class="grid-3">
                    <input type="month" id="filterMonth" onchange="renderLogs()">
                    <select id="filterMember" onchange="renderLogs()"></select>
                    <button class="btn btn-outline" onclick="resetLogFilter()">é‡ç½®ç¯©é¸</button>
                </div>
                <table id="logTable"><thead><tr><th>æ—¥æœŸ</th><th>æœƒå“¡</th><th>é¡å‹</th><th>è©³ç´°å…§å®¹ (å«å“é …)</th><th>é ä¼°çé‡‘</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="calculator" class="section">
            <div class="page-title">ğŸ§® çé‡‘æ¨¡æ“¬å™¨</div>
            <div class="card"><div class="grid-2">
                <div>
                    <label>é ä¼° PV</label><input type="number" id="calcPV" oninput="autoConvert('pv','calc'); runSimulation()">
                    <label>é ä¼° BV</label><input type="number" id="calcBV" oninput="autoConvert('bv','calc'); runSimulation()">
                    <label>æ¨è–¦äººæ•¸</label><input type="number" id="calcPartners" oninput="runSimulation()">
                </div>
                <div style="background:#2c3e50; color:white; padding:20px; border-radius:8px; text-align:center;">
                    æ¨¡æ“¬ç¸½çé‡‘ <h1 style="color:#ff9900;" id="simValTotal">$0</h1>
                </div>
            </div></div>
        </div>

        <div id="settings" class="section">
            <div class="page-title">âš™ï¸ è¨­å®š</div>
            <div class="card">
                <button class="btn btn-danger" onclick="clearAllData()">å¾¹åº•æ¸…é™¤æ‰€æœ‰è³‡æ–™ (å«é›²ç«¯)</button>
            </div>
        </div>

    </div>

<script>
    // --- Firebase Init ---
    const firebaseConfig = {
      apiKey: "AIzaSyCanDeinCJyZFeHUGnYVEmalCYxjwaIw-4",
      authDomain: "newstar-system.firebaseapp.com",
      projectId: "newstar-system",
      storageBucket: "newstar-system.firebasestorage.app",
      messagingSenderId: "889699172174",
      appId: "1:889699172174:web:0ff42757035a879cb3281f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const TEAM_ID = "newstar_main";

    // --- Global Data ---
    let members = JSON.parse(localStorage.getItem('amway_members')) || [];
    let logs = JSON.parse(localStorage.getItem('amway_logs')) || [];
    let sponsors = JSON.parse(localStorage.getItem('amway_sponsors')) || [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entryDate').valueAsDate = new Date();
        document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);
        populateMonthSelect();
        auth.signInAnonymously().then(() => startCloudSync());
    });

    function startCloudSync() {
      const ref = db.collection("newstar").doc(TEAM_ID);
      ref.onSnapshot((snap) => {
        if (!snap.exists) { saveToCloud(); return; }
        const data = snap.data();
        members = data.members || [];
        logs = data.logs || [];
        sponsors = data.sponsors || [];
        localStorage.setItem("amway_members", JSON.stringify(members));
        localStorage.setItem("amway_logs", JSON.stringify(logs));
        localStorage.setItem("amway_sponsors", JSON.stringify(sponsors));
        refreshAllUI();
      });
    }

    function saveToCloud() {
      db.collection("newstar").doc(TEAM_ID).set({ members, logs, sponsors, updatedAt: new Date().toISOString() }, { merge: true });
    }

    function saveToLocal() { saveToCloud(); }

    function refreshAllUI() {
        renderMembers(); renderLogs(); renderSponsors(); renderNetwork(); runSimulation();
        updateMemberSelects(); updateSponsorSelects();
    }

    function switchTab(t) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const idx = {'dashboard':0, 'network':1, 'entry':2, 'members':3, 'logs':4, 'sponsors':5, 'calculator':6, 'settings':7}[t];
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
    }

    // --- V3.5 Product Detail Logic ---
    function addProductRow() {
        const div = document.createElement('div');
        div.className = 'product-row';
        div.innerHTML = `
            <input type="text" placeholder="å“é …" class="prod-name" style="flex:2;">
            <input type="number" placeholder="æ•¸é‡" class="prod-qty" style="flex:1;">
            <button onclick="this.parentElement.remove()" class="btn-remove-prod"><i class="fas fa-times"></i></button>
        `;
        document.getElementById('productContainer').appendChild(div);
    }

    // --- Core Action: Add Record ---
    function addCompositeLog() {
        const date = document.getElementById('entryDate').value;
        let memberId = document.getElementById('entryMember').value;
        if(!memberId) return alert("è«‹é¸å–æœƒå“¡");

        if (memberId === 'new_mode') {
            const nn = document.getElementById('quickNewMemName').value;
            const ni = document.getElementById('quickNewMemID').value;
            const ns = document.getElementById('quickNewMemSponsor').value;
            if(!nn || !ni || !ns) return alert("è«‹å¡«å¯«å®Œæ•´æ–°æœƒå“¡è³‡æ–™");
            members.push({id: ni, name: nn, sponsorId: ns, isNewStar: document.getElementById('quickNewMemStatus').checked});
            memberId = ni;
        }

        let saved = 0;
        // Sales
        const pv = parseFloat(document.getElementById('entryPV').value) || 0;
        if(pv > 0) {
            let products = [];
            document.querySelectorAll('.product-row').forEach(row => {
                const pname = row.querySelector('.prod-name').value;
                if(pname) products.push({name: pname, qty: row.querySelector('.prod-qty').value || 1});
            });
            let detail = `éŠ·å”® (BV: ${document.getElementById('entryBV').value})`;
            if(products.length) detail += ` | ğŸ“¦ ${products.map(p=>p.name+'x'+p.qty).join(', ')}`;
            logs.push({id: Date.now()+1, date, memberId, type: 'sales', pv, details: detail});
            saved++;
        }
        // Referral
        const nName = document.getElementById('newcomerName').value;
        if(nName) {
            const nID = document.getElementById('newcomerID').value;
            const nBV = parseFloat(document.getElementById('newcomerBV').value) || 0;
            const upline = document.getElementById('newcomerUpline').value || memberId;
            if(!nID) return alert("è«‹å¡«å…¥æ–°äººç·¨è™Ÿ");
            if(!members.find(m=>m.id===nID)) {
                const upObj = members.find(m=>m.id===upline);
                members.push({id: nID, name: nName, sponsorId: upObj?upObj.sponsorId:"", isNewStar: true});
            }
            logs.push({id: Date.now()+2, date, memberId, type: 'newcomer', details: `æ¨è–¦æ–°äºº: ${nName}`, newcomerData: {id: nID, name: nName, bv: nBV, uplineId: upline}});
            saved++;
        }
        // Learning
        if(document.getElementById('learningFileCheck').checked) {
            logs.push({id: Date.now()+3, date, memberId, type: 'learning', details: "å®Œæˆå­¸ç¿’å¿ƒå¾—"});
            saved++;
        }

        if(saved > 0) {
            saveToLocal(); alert("å„²å­˜æˆåŠŸ");
            location.reload();
        }
    }

    // --- Helper Functions ---
    function checkMemberSelect() {
        document.getElementById('quickAddMemberBox').style.display = (document.getElementById('entryMember').value === 'new_mode') ? 'block' : 'none';
    }
    function autoConvert(s, c) {
        const p = document.getElementById(c === 'entry' ? 'entryPV' : 'calcPV');
        const b = document.getElementById(c === 'entry' ? 'entryBV' : 'calcBV');
        if(s === 'pv') b.value = (parseFloat(p.value)||0) * 50; else p.value = (parseFloat(b.value)||0) / 50;
    }
    function updateNewcomerUplineSelect() {
        const sel = document.getElementById('newcomerUpline');
        sel.innerHTML = members.map(m => `<option value="${m.id}">${m.name} (${m.id})</option>`).join('');
        if(document.getElementById('entryMember').value !== 'new_mode') sel.value = document.getElementById('entryMember').value;
    }
    function updateMemberSelects() {
        const active = members.filter(m => m.isNewStar);
        let h = '<option value="" disabled selected>-- é¸æ“‡æœƒå“¡ --</option><option value="new_mode" style="color:blue;">â• æ–°å¢æœƒå“¡</option>';
        h += active.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        document.getElementById('entryMember').innerHTML = h;
        document.getElementById('filterMember').innerHTML = '<option value="all">å…¨éƒ¨æœƒå“¡</option>' + members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        updateNewcomerUplineSelect();
    }
    function updateSponsorSelects() {
        let h = '<option value="" disabled selected>-- é¸æ“‡ç™¼èµ·äºº --</option>';
        h += sponsors.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('newMemSponsor').innerHTML = h;
        document.getElementById('quickNewMemSponsor').innerHTML = h;
    }

    // --- Renderers ---
    function renderMembers() {
        const tb = document.querySelector('#memberTable tbody');
        tb.innerHTML = members.map(m => {
            const sp = sponsors.find(s=>s.id===m.sponsorId)?.name || '-';
            const ns = m.isNewStar ? '<span class="status-active">åƒåŠ ä¸­</span>' : 'æœªåƒåŠ ';
            return `<tr><td>${m.id}</td><td>${m.name}</td><td>${ns}</td><td>${sp}</td><td><button class="btn btn-outline" style="color:red" onclick="deleteMember('${m.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
        }).join('');
    }
    function renderLogs() {
        const month = document.getElementById('filterMonth').value;
        const mid = document.getElementById('filterMember').value;
        let d = logs.filter(l => (!month || l.date.startsWith(month)) && (mid==='all' || l.memberId===mid));
        d.sort((a,b) => new Date(b.date) - new Date(a.date));
        const tb = document.querySelector('#logTable tbody');
        tb.innerHTML = d.map(l => {
            const m = members.find(x=>x.id===l.memberId)?.name || l.memberId;
            let cls = {'sales':'badge-sales','newcomer':'badge-new','learning':'badge-learn'}[l.type];
            let val = '-';
            if(l.type==='sales') val = `${l.pv} PV`;
            if(l.type==='newcomer' && l.newcomerData) val = `$${Math.round(l.newcomerData.bv*0.01)}`;
            if(l.type==='learning') val = '+3%';
            return `<tr><td>${l.date}</td><td>${m}</td><td><span class="badge ${cls}">${l.type}</span></td><td>${l.details}</td><td>${val}</td><td><button onclick="deleteLog(${l.id})"><i class="fas fa-trash"></i></button></td></tr>`;
        }).join('');
    }
    function renderSponsors() {
        const tb = document.querySelector('#sponsorTable tbody');
        tb.innerHTML = sponsors.map(s => `<tr><td>${s.id}</td><td>${s.name}</td><td><button onclick="deleteSponsor('${s.id}')">åˆªé™¤</button></td></tr>`).join('');
    }
    function renderNetwork() {
        const container = document.getElementById('treeContainer');
        // Simple recursive tree logic
        function build(id, name, depth) {
            let html = `<div class="tree-node"><div class="tree-content">#${id} ${name}</div>`;
            const children = logs.filter(l => l.type==='newcomer' && l.newcomerData.uplineId===id).map(l=>l.newcomerData);
            children.forEach(c => { html += build(c.id, c.name, depth+1); });
            return html + '</div>';
        }
        let full = "";
        sponsors.forEach(s => {
            full += `<div class="tree-node tree-root"><div class="tree-content"><i class="fas fa-crown"></i> ${s.name}</div>`;
            members.filter(m => m.sponsorId === s.id).forEach(m => {
                const hasUpline = logs.some(l => l.type==='newcomer' && l.newcomerData.id === m.id);
                if(!hasUpline) full += build(m.id, m.name, 1);
            });
            full += '</div>';
        });
        container.innerHTML = full || "å°šç„¡é—œä¿‚åœ–";
    }

    // --- Bonus Engine ---
    function calculateBonusLogic(pv, bv, isRec, news, hasLearn) {
        if(pv>=1000) return {total:0, isGraduated:true};
        let rate = (pv>=600) ? (isRec?0.02:0.01) : (isRec?0.04:0.03);
        let base = bv * rate;
        let nBonus = 0; if(news) news.forEach(n=> nBonus += n.bv*0.01);
        let sub = base + nBonus;
        let lBonus = hasLearn ? sub*0.03 : 0;
        return {total: Math.floor(sub+lBonus)};
    }
    function renderDashboard() {
        const stats = calculateMonthlyStats(document.getElementById('dashMonthSelect').value);
        document.getElementById('totalPVDisplay').innerText = stats.reduce((a,b)=>a+b.pv,0).toLocaleString();
        document.getElementById('totalBonusDisplay').innerText = "$"+stats.reduce((a,b)=>a+b.bonus,0).toLocaleString();
        const tb = document.querySelector('#rankingTable tbody');
        tb.innerHTML = stats.slice(0,10).map((s,i)=>`<tr><td>${i+1}</td><td>${s.name}</td><td>${s.pv}</td><td>${s.detailsText}</td><td>$${s.bonus}</td></tr>`).join('');
    }
    function calculateMonthlyStats(mStr) {
        let res = [];
        members.forEach(m => {
            if(!m.isNewStar) return;
            // Simplified Roll-up logic for V3.5
            let pv = logs.filter(l=>l.date.startsWith(mStr) && l.memberId===m.id && l.type==='sales').reduce((a,b)=>a+b.pv,0);
            let news = logs.filter(l=>l.date.startsWith(mStr) && l.memberId===m.id && l.type==='newcomer').map(l=>l.newcomerData);
            let learn = logs.some(l=>l.date.startsWith(mStr) && l.memberId===m.id && l.type==='learning');
            let c = calculateBonusLogic(pv, pv*50, news.length>0, news, learn);
            res.push({name: m.name, pv, bonus: c.total, detailsText: pv>=600?'6%éšæ®µ':'èµ·æ­¥æœŸ'});
        });
        return res.sort((a,b)=>b.bonus-a.bonus);
    }
    function runSimulation() {
        const pv = parseFloat(document.getElementById('calcPV').value)||0;
        const res = calculateBonusLogic(pv, pv*50, parseFloat(document.getElementById('calcPartners').value)>0, [], false);
        document.getElementById('simValTotal').innerText = "$" + res.total.toLocaleString();
    }
    function populateMonthSelect() {
        const s = document.getElementById('dashMonthSelect');
        for(let i=1;i<=12;i++) {
            let v = `2026-${i.toString().padStart(2,'0')}`;
            s.add(new Option(`2026-${i}`, v));
        }
        s.value = new Date().toISOString().slice(0,7);
    }
    function addSponsor() {
        const name = document.getElementById('newSponsorName').value;
        const id = document.getElementById('newSponsorID').value;
        if(name && id) { sponsors.push({id, name}); saveToLocal(); refreshAllUI(); }
    }
    function deleteMember(id) { if(confirm("ç¢ºå®šåˆªé™¤?")) { members=members.filter(m=>m.id!==id); saveToLocal(); refreshAllUI(); } }
    function deleteLog(id) { if(confirm("ç¢ºå®šåˆªé™¤?")) { logs=logs.filter(l=>l.id!==id); saveToLocal(); refreshAllUI(); } }
    function clearAllData() { if(prompt("è¼¸å…¥ DELETE ç¢ºèª")==='DELETE') { members=[]; logs=[]; sponsors=[]; saveToCloud(); location.reload(); } }
</script>

</body>
</html>
